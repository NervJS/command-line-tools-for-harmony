"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ArkTSVersion=exports.ArkTSLinterMode=void 0,exports.doArkTSLinter=doArkTSLinter;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),ts=_interopRequireWildcard(require("typescript")),_main=require("../main"),_utils=require("./utils");function _getRequireWildcardCache(e){var r,t;return"function"!=typeof WeakMap?null:(r=new WeakMap,t=new WeakMap,(_getRequireWildcardCache=function(e){return e?t:r})(e))}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};r=_getRequireWildcardCache(r);if(r&&r.has(e))return r.get(e);var t,i,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&((i=o?Object.getOwnPropertyDescriptor(e,t):null)&&(i.get||i.set)?Object.defineProperty(n,t,i):n[t]=e[t]);return n.default=e,r&&r.set(e,n),n}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,r){if(e!==r)throw new TypeError("Cannot instantiate an arrow function")}const arkTSDir="ArkTS",arkTSLinterOutputFileName="ArkTSLinter_output.json",spaceNumBeforeJsonLine=2;let ArkTSLinterMode=function(e){return e[e.NOT_USE=0]="NOT_USE",e[e.COMPATIBLE_MODE=1]="COMPATIBLE_MODE",e[e.STANDARD_MODE=2]="STANDARD_MODE",e}({}),ArkTSVersion=(exports.ArkTSLinterMode=ArkTSLinterMode,function(e){return e[e.ArkTS_1_0=0]="ArkTS_1_0",e[e.ArkTS_1_1=1]="ArkTS_1_1",e}({}));function getArkTSVersionString(e){return e===ArkTSVersion.ArkTS_1_0?"ArkTS_1_0":"ArkTS_1_1"}function doArkTSLinter(e,r,t,i,n=!0,o){if(r===ArkTSLinterMode.NOT_USE)return[];let a=[];return a=(e===ArkTSVersion.ArkTS_1_0?ts.ArkTSLinter_1_0:ts.ArkTSLinter_1_1).runArkTSLinter(t,void 0,o,getArkTSVersionString(e)),removeOutputFile(),0===a.length?[]:(r===ArkTSLinterMode.COMPATIBLE_MODE?processArkTSLinterReportAsWarning(a,i,n):processArkTSLinterReportAsError(a,i),a)}function processArkTSLinterReportAsError(e,r){var t=this;e.forEach(function(e){_newArrowCheck(this,t),r(e)}.bind(this)),printArkTSLinterFAQ(e,r)}function processArkTSLinterReportAsWarning(e,t,r){var i=this,r=r?writeOutputFile(e):void 0;void 0===r?e.forEach(function(e){_newArrowCheck(this,i);var r=e.category;e.category=ts.DiagnosticCategory.Warning,t(e),e.category=r}.bind(this)):(r={file:void 0,start:void 0,length:void 0,messageText:`Has ${e.length} ArkTS Linter Error. You can get the output in `+r,category:ts.DiagnosticCategory.Warning,code:-1,reportsUnnecessary:void 0,reportsDeprecated:void 0},t(r)),printArkTSLinterFAQ(e,t)}function writeOutputFile(r){var i=this,t=(0,_utils.toUnixPath)(_main.projectConfig.cachePath);if(_fs.default.existsSync(t)){t=(0,_utils.toUnixPath)(_path.default.join(t,arkTSDir)),_fs.default.existsSync(t)||_fs.default.mkdirSync(t),t=(0,_utils.toUnixPath)(_path.default.join(t,arkTSLinterOutputFileName));const n=[];r.forEach(function(e){_newArrowCheck(this,i);var{line:r,character:t}=e.file.getLineAndCharacterOfPosition(e.start);n.push({categoryInfo:e.category===ts.DiagnosticCategory.Error?"Error":"Warning",fileName:e.file?.fileName,line:r+1,character:t+1,messageText:e.messageText})}.bind(this));let e=t;try{_fs.default.writeFileSync(t,JSON.stringify(n,void 0,spaceNumBeforeJsonLine))}catch{e=void 0}return e}}function removeOutputFile(){var e=(0,_utils.toUnixPath)(_main.projectConfig.cachePath);_fs.default.existsSync(e)&&(e=(0,_utils.toUnixPath)(_path.default.join(e,arkTSDir)),_fs.default.existsSync(e))&&(e=(0,_utils.toUnixPath)(_path.default.join(e,arkTSLinterOutputFileName)),_fs.default.existsSync(e))&&_fs.default.rmSync(e)}function printArkTSLinterFAQ(e,r){void 0===e||void 0===e.length||e.length<=0||r({file:void 0,start:void 0,length:void 0,messageText:"For details about ArkTS syntax errors, see FAQs",category:ts.DiagnosticCategory.Warning,code:-1,reportsUnnecessary:void 0,reportsDeprecated:void 0})}exports.ArkTSVersion=ArkTSVersion;