"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SourceMapGenerator=void 0;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_ark_utils=require("../../ark_utils"),_ark_define=require("./common/ark_define"),_utils=require("./utils"),_utils2=require("../../utils"),_ob_config_resolver=require("./common/ob_config_resolver");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}class SourceMapGenerator{constructor(e){_defineProperty(this,"projectConfig",void 0),_defineProperty(this,"sourceMapPath",void 0),_defineProperty(this,"cacheSourceMapPath",void 0),_defineProperty(this,"triggerAsync",void 0),_defineProperty(this,"triggerEndSignal",void 0),_defineProperty(this,"throwArkTsCompilerError",void 0),_defineProperty(this,"sourceMaps",{}),_defineProperty(this,"isNewSourceMap",!0),_defineProperty(this,"keyCache",new Map),_defineProperty(this,"logger",void 0),_defineProperty(this,"sourceMapKeyMappingForObf",new Map),this.projectConfig=Object.assign(e.share.arkProjectConfig,e.share.projectConfig),this.throwArkTsCompilerError=e.share.throwArkTsCompilerError,this.sourceMapPath=this.getSourceMapSavePath(),this.cacheSourceMapPath=_path.default.join(this.projectConfig.cachePath,_ark_define.SOURCEMAPS_JSON),this.triggerAsync=e.async,this.triggerEndSignal=e.signal,this.logger=e.share.getLogger(_ark_define.GEN_ABC_PLUGIN_NAME)}static init(e){SourceMapGenerator.rollupObject=e,SourceMapGenerator.instance=new SourceMapGenerator(SourceMapGenerator.rollupObject),SourceMapGenerator.instance.projectConfig.entryPackageName&&SourceMapGenerator.instance.projectConfig.entryModuleVersion||(SourceMapGenerator.instance.isNewSourceMap=!1)}static getInstance(){return SourceMapGenerator.instance||(SourceMapGenerator.instance=new SourceMapGenerator(SourceMapGenerator.rollupObject)),SourceMapGenerator.instance}getAdaptedModuleId(e){return e.replace(/\//g,_path.default.sep)}getPkgInfoByModuleId(e,t=!1){e=this.getAdaptedModuleId(e);var r=SourceMapGenerator.rollupObject.getModuleInfo(e),r=(r||this.throwArkTsCompilerError("ArkTS:INTERNAL ERROR: Failed to get ModuleInfo,\nmoduleId: "+e),r.meta),i=(r||this.throwArkTsCompilerError("ArkTS:INTERNAL ERROR: Failed to get ModuleInfo properties 'meta',\nmoduleId: "+e),r.pkgPath),o=(i||this.throwArkTsCompilerError("ArkTS:INTERNAL ERROR: Failed to get ModuleInfo properties 'meta.pkgPath',\nmoduleId: "+e),r.dependencyPkgInfo);let a=this.getIntermediateModuleId(e,r).replace(i+_path.default.sep,"");return t&&(a=(0,_ob_config_resolver.mangleFilePath)(a)),{entry:{name:this.projectConfig.entryPackageName,version:this.projectConfig.entryModuleVersion},dependency:o?{name:o.pkgName,version:o.pkgVersion}:void 0,modulePath:(0,_utils2.toUnixPath)(a)}}setNewSoureMaps(e){this.isNewSourceMap=e}isNewSourceMaps(){return this.isNewSourceMap}genKey(e,t=!1){e=this.getAdaptedModuleId(e);let r=this.keyCache.get(e);var i;return r&&!t||(i=this.getPkgInfoByModuleId(e,t),(r=i.dependency?`${i.entry.name}|${i.dependency.name}|${i.dependency.version}|`+i.modulePath:`${i.entry.name}|${i.entry.name}|${i.entry.version}|`+i.modulePath)&&!t&&this.keyCache.set(e,r)),r}getSourceMapSavePath(){return this.projectConfig.compileHar&&this.projectConfig.sourceMapDir&&!this.projectConfig.byteCodeHar?_path.default.join(this.projectConfig.sourceMapDir,_ark_define.SOURCEMAPS):(0,_utils.isDebug)(this.projectConfig)?_path.default.join(this.projectConfig.aceModuleBuild,_ark_define.SOURCEMAPS):_path.default.join(this.projectConfig.cachePath,_ark_define.SOURCEMAPS)}buildModuleSourceMapInfo(e){var i=this;if(!this.projectConfig.widgetCompile){var t=(0,_ark_utils.createAndStartEvent)(e,"update cached source maps");(0,_utils.isDebug)(this.projectConfig)&&!this.projectConfig.byteCodeHar&&this.projectConfig.byteCodeHarInfo&&Object.keys(this.projectConfig.byteCodeHarInfo).forEach(function(e){_newArrowCheck(this,i);var t=this.projectConfig.byteCodeHarInfo[e].sourceMapsPath;!t&&this.logger&&this.logger.warn&&this.logger.warn(_ark_define.yellow,`ArkTS:WARN Property 'sourceMapsPath' not found in '${e}'.`,_ark_define.reset),t&&(e=JSON.parse(_fs.default.readFileSync((0,_utils2.toUnixPath)(t)).toString()),Object.assign(this.sourceMaps,e))}.bind(this));const o=this.updateCachedSourceMaps();(0,_ark_utils.stopEvent)(t),this.triggerAsync(function(){var t=this;_newArrowCheck(this,i);const r=(0,_ark_utils.createAndStartEvent)(e,"write source map (async)",!0);_fs.default.writeFile(this.sourceMapPath,JSON.stringify(o,null,2),"utf-8",function(e){_newArrowCheck(this,t),e&&this.throwArkTsCompilerError("ArkTS:INTERNAL ERROR: Failed to write sourceMaps.\n"+`File: ${this.sourceMapPath}
`+"Error message: "+e.message),_fs.default.copyFileSync(this.sourceMapPath,this.cacheSourceMapPath),(0,_ark_utils.stopEvent)(r,!0),this.triggerEndSignal()}.bind(this))}.bind(this))}}updateCachedSourceMaps(){var e,t,r,i,o=this;this.isNewSourceMap||this.modifySourceMapKeyToCachePath(this.sourceMaps);let a;if(_fs.default.existsSync(this.cacheSourceMapPath)){a=JSON.parse(_fs.default.readFileSync(this.cacheSourceMapPath).toString());let r=[],i=new Set;for(var n of SourceMapGenerator.rollupObject.getModuleIds())!(0,_utils.isCommonJsPluginVirtualFile)(n)&&(0,_utils.isCurrentProjectFiles)(n,this.projectConfig)&&(this.isNewSourceMap?(e=(0,_utils2.isPackageModulesFile)(n,this.projectConfig),(0,_ob_config_resolver.enableObfuscateFileName)(e,this.projectConfig)?i.add(this.genKey(n,!0)):i.add(this.genKey(n))):(e=(0,_utils2.getProjectRootPath)(n,this.projectConfig,this.projectConfig?.rootPathSet),t=this.getIntermediateModuleId((0,_utils2.toUnixPath)(n)).replace((0,_utils2.toUnixPath)(e),(0,_utils2.toUnixPath)(this.projectConfig.cachePath)),n=(0,_utils2.isPackageModulesFile)(n,this.projectConfig),(0,_ob_config_resolver.enableObfuscateFileName)(n,this.projectConfig)?i.add((0,_ob_config_resolver.mangleFilePath)(t)):i.add(t)));Object.keys(a).forEach(function(e){_newArrowCheck(this,o);let t=e;this.isNewSourceMap||(t=(0,_utils2.toUnixPath)(_path.default.join(this.projectConfig.projectRootPath,e))),i.has(t)||r.push(e)}.bind(this)),r.forEach(function(e){_newArrowCheck(this,o),delete a[e]}.bind(this)),Object.keys(this.sourceMaps).forEach(function(e){_newArrowCheck(this,o),a[e]=this.sourceMaps[e]}.bind(this))}else a=this.sourceMaps;for([r,i]of this.sourceMapKeyMappingForObf)this.updateSourceMapKeyWithObf(a,r,i);return a}getSourceMaps(){return this.sourceMaps}getSourceMap(e){return this.getSpecifySourceMap(this.sourceMaps,e)}getSpecifySourceMap(e,t){t=this.isNewSourceMap?this.genKey(t):t;if(e&&e[t])return e[t]}updateSourceMap(e,t){this.sourceMaps||(this.sourceMaps={}),this.updateSpecifySourceMap(this.sourceMaps,e,t)}updateSpecifySourceMap(e,t,r){e[this.isNewSourceMap?this.genKey(t):t]=r}fillSourceMapPackageInfo(e,t){this.isNewSourceMap&&(e=this.getPkgInfoByModuleId(e),t["entry-package-info"]=e.entry.name+"|"+e.entry.version,e.dependency)&&(t["package-info"]=e.dependency.name+"|"+e.dependency.version)}getIntermediateModuleId(e,t){let r="";switch(_path.default.extname(e)){case _ark_define.EXTNAME_ETS:r=(0,_utils.shouldETSOrTSFileTransformToJS)(e,this.projectConfig,t)?_ark_define.EXTNAME_JS:_ark_define.EXTNAME_TS;break;case _ark_define.EXTNAME_TS:r=(0,_utils.shouldETSOrTSFileTransformToJS)(e,this.projectConfig,t)?_ark_define.EXTNAME_JS:"";break;case _ark_define.EXTNAME_JS:case _ark_define.EXTNAME_MJS:case _ark_define.EXTNAME_CJS:r=e.endsWith(_ark_define.EXTNAME_MJS)||e.endsWith(_ark_define.EXTNAME_CJS)?_ark_define.EXTNAME_JS:""}return 0!==r.length?(0,_utils.changeFileExtension)(e,r):e}setSourceMapPath(e){this.sourceMapPath=e}modifySourceMapKeyToCachePath(i){var o=this,e=this.projectConfig;const a=(0,_utils2.toUnixPath)(e.cachePath.replace(e.projectRootPath+_path.default.sep,""));Object.keys(i).forEach(function(e){_newArrowCheck(this,o);let t=a+"/"+e;t.endsWith(_ark_define.EXTNAME_JS)||(r=this.projectConfig.projectRootPath+_path.default.sep+e,r=(0,_utils.shouldETSOrTSFileTransformToJS)(r,this.projectConfig)?_ark_define.EXTNAME_JS:_ark_define.EXTNAME_TS,t=(0,_utils.changeFileExtension)(t,r));var r=e.startsWith("oh_modules");t=(0,_ob_config_resolver.handleObfuscatedFilePath)(t,r,this.projectConfig),i[t]=i[e],delete i[e]}.bind(this))}static cleanSourceMapObject(){this.instance&&(this.instance.keyCache.clear(),this.instance.sourceMaps=void 0,this.instance=void 0),this.rollupObject&&(this.rollupObject=void 0)}updateSourceMapKeyWithObf(e,t,r){e.hasOwnProperty(t)&&t!==r&&(e[r]=e[t],delete e[t])}saveKeyMappingForObfFileName(e){this.sourceMapKeyMappingForObf.set(this.genKey(e),this.genKey(e,!0))}static initInstance(e){return SourceMapGenerator.instance||SourceMapGenerator.init(e),SourceMapGenerator.getInstance()}}_defineProperty(exports.SourceMapGenerator=SourceMapGenerator,"instance",void 0),_defineProperty(SourceMapGenerator,"rollupObject",void 0);