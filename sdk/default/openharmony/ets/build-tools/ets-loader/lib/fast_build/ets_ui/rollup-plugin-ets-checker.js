"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.etsChecker=etsChecker,exports.tsWatchEndPromise=exports.tsWatchEmitter=void 0;var _path=_interopRequireDefault(require("path")),_events=require("events"),ts=_interopRequireWildcard(require("typescript")),_main=require("../../../main"),_ets_checker=require("../../ets_checker"),_pre_define=require("../../pre_define"),_utils=require("../../utils"),_api_check_utils=require("../system_api/api_check_utils");function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,i,s={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((i=o?Object.getOwnPropertyDescriptor(e,r):null)&&(i.get||i.set)?Object.defineProperty(s,r,i):s[r]=e[r]);return s.default=e,t&&t.set(e,s),s}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}let tsWatchEmitter=void 0;exports.tsWatchEmitter=tsWatchEmitter;let tsWatchEndPromise;function etsChecker(){let n=!1;return{name:"etsChecker",buildStart(){var e,r=this,t=new _utils.CompilationTimeStatistics(this.share,"etsChecker","buildStart"),i=("true"===process.env.watchMode&&"true"===process.env.triggerTsWatch&&(exports.tsWatchEmitter=tsWatchEmitter=new _events.EventEmitter,exports.tsWatchEndPromise=tsWatchEndPromise=new Promise(function(e){var t=this;_newArrowCheck(this,r),tsWatchEmitter.on(_pre_define.TS_WATCH_END_MSG,function(){_newArrowCheck(this,t),e()}.bind(this))}.bind(this))),this.share.projectConfig.deviceTypes&&(0,_api_check_utils.configureSyscapInfo)(this.share.projectConfig),this.share.projectConfig.permission&&(0,_api_check_utils.configurePermission)(this.share.projectConfig),this.share.projectConfig.integratedHsp&&(_main.projectConfig.integratedHsp=this.share.projectConfig.integratedHsp,_main.projectConfig.resetBundleName=this.share.projectConfig.integratedHsp),Object.assign(_main.projectConfig,this.share.projectConfig),Object.assign(this.share.projectConfig,{compileHar:_main.projectConfig.compileHar,compileShared:_main.projectConfig.compileShared,moduleRootPath:_main.projectConfig.moduleRootPath,buildPath:_main.projectConfig.buildPath,isCrossplatform:_main.projectConfig.isCrossplatform,requestPermissions:_main.projectConfig.requestPermissions,definePermissions:_main.projectConfig.definePermissions,syscapIntersectionSet:_main.projectConfig.syscapIntersectionSet,syscapUnionSet:_main.projectConfig.syscapUnionSet,deviceTypesMessage:_main.projectConfig.deviceTypesMessage,compileSdkVersion:_main.projectConfig.compileSdkVersion,compatibleSdkVersion:_main.projectConfig.compatibleSdkVersion,runtimeOS:_main.projectConfig.runtimeOS}),this.share.getLogger("etsChecker")),s=[],o=[];rootFileNamesCollect(s),this.share&&this.share.projectConfig&&this.share.projectConfig.resolveModulePaths&&Array.isArray(this.share.projectConfig.resolveModulePaths)&&o.push(...this.share.projectConfig.resolveModulePaths),"true"===process.env.watchMode?(n||(0,_ets_checker.serviceChecker)(s,i,o,t,this.share),(0,_utils.startTimeStatisticsLocation)(t?t.diagnosticTime:void 0),n&&((e=ts.ArkTSLinterTimePrinter.getInstance()).setArkTSTimePrintSwitch(!1),e.appendTime(ts.TimePhase.START),_main.globalProgram.builderProgram=_ets_checker.languageService.getBuilderProgram(!0),_main.globalProgram.program=_main.globalProgram.builderProgram.getProgram(),e.appendTime(ts.TimePhase.GET_PROGRAM),(0,_ets_checker.collectFileToIgnoreDiagnostics)(s),(0,_ets_checker.runArkTSLinter)()),n=!0,e=_main.globalProgram.builderProgram.getSyntacticDiagnostics().concat(_main.globalProgram.builderProgram.getSemanticDiagnostics()),(0,_utils.stopTimeStatisticsLocation)(t?t.diagnosticTime:void 0),(0,_ets_checker.emitBuildInfo)(),e.forEach(function(e){_newArrowCheck(this,r),(0,_ets_checker.printDiagnostic)(e)}.bind(this)),_ets_checker.fastBuildLogger.debug(_pre_define.TS_WATCH_END_MSG),tsWatchEmitter.emit(_pre_define.TS_WATCH_END_MSG)):(0,_ets_checker.serviceChecker)(s,i,o,t,this.share),(0,_utils.setChecker)()},shouldInvalidCache(){return _ets_checker.targetESVersionChanged}}}function rootFileNamesCollect(t){var r=this;(_main.projectConfig.widgetCompile?Object.values(_main.projectConfig.cardEntryObj):Object.values(_main.projectConfig.entryObj)).forEach(function(e){_newArrowCheck(this,r),t.push(_path.default.resolve(e))}.bind(this))}exports.tsWatchEndPromise=tsWatchEndPromise;