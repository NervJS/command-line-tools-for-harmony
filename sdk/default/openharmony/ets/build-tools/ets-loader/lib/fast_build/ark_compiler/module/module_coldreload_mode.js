"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleColdreloadMode=void 0;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_module_mode=require("./module_mode"),_ark_define=require("../common/ark_define"),_utils=require("../utils"),_utils2=require("../../../utils"),_ark_utils=require("../../../ark_utils"),_generate_sourcemap=require("../generate_sourcemap");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);i=i.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}let isFirstBuild=!0;class ModuleColdreloadMode extends _module_mode.ModuleMode{constructor(e){super(e),_defineProperty(this,"symbolMapFilePath",void 0),this.projectConfig.oldMapFilePath?this.symbolMapFilePath=_path.default.join(this.projectConfig.oldMapFilePath,_ark_define.SYMBOLMAP):this.throwArkTsCompilerError("ArkTS:INTERNAL ERROR: Coldreload failed, symbolMap file is not correctly configured.")}generateAbc(e,t){(isFirstBuild=this.projectConfig.isFirstBuild)?this.compileAllFiles(e,t):this.compileChangeListFiles(e,t)}addColdReloadArgs(){isFirstBuild?(this.cmdArgs.push("--dump-symbol-table"),this.cmdArgs.push(`"${this.symbolMapFilePath}"`)):(this.addCacheFileArgs(),this.cmdArgs.push("--input-symbol-table"),this.cmdArgs.push(`"${this.symbolMapFilePath}"`),this.cmdArgs.push("--cold-reload"))}compileAllFiles(e,t){this.prepareForCompilation(e,t),_generate_sourcemap.SourceMapGenerator.getInstance().buildModuleSourceMapInfo(t),this.generateAbcByEs2abc(t,!!this.projectConfig.byteCodeHarInfo)}compileChangeListFiles(e,i){var r=this;if(_fs.default.existsSync(this.projectConfig.changedFileList)){var o=_fs.default.readFileSync(this.projectConfig.changedFileList).toString(),o=JSON.parse(o).modifiedFiles;if(void 0===o||0===o.length)this.logger.debug(_ark_define.blue,"ArkTS: No changed files found, skip cold reload build",_ark_define.reset);else{let t=!0;var s,a=o.map(function(e){return _newArrowCheck(this,r),(0,_utils.isJsonSourceFile)(e)&&(this.logger.debug(_ark_define.blue,`ARKTS: json source file: ${e} changed, skip cold reload build!`,_ark_define.reset),t=!1),_path.default.join(this.projectConfig.projectPath,e)}.bind(this));t&&(s=(0,_ark_utils.createAndStartEvent)(i,"collect module file list"),this.collectModuleFileList(e,a[Symbol.iterator]()),(0,_ark_utils.stopEvent)(s),_fs.default.existsSync(this.projectConfig.patchAbcPath)||(0,_utils2.mkdirsSync)(this.projectConfig.patchAbcPath),this.updateSourceMapFromFileList(_generate_sourcemap.SourceMapGenerator.getInstance().isNewSourceMaps()?a:o,i),e=_path.default.join(this.projectConfig.patchAbcPath,_ark_define.MODULES_ABC),(0,_utils2.validateFilePathLength)(e,this.logger),this.moduleAbcPath=e,this.generateAbcByEs2abc(i,!1))}}else this.logger.debug(_ark_define.blue,`ArkTS: Cannot find file: ${this.projectConfig.changedFileList}, skip cold reload build`,_ark_define.reset)}updateSourceMapFromFileList(e,t){var i,t=(0,_ark_utils.createAndStartEvent)(t,"update source map from file list"),r=_generate_sourcemap.SourceMapGenerator.getInstance(),o=this.projectConfig.projectPath.slice(this.projectConfig.projectRootPath.length+_path.default.sep.length),s={};for(const a of e)r.isNewSourceMaps()?((0,_utils2.validateFilePathLength)(a,this.logger),s[r.genKey(a)]=r.getSourceMap(a)):(i=(0,_utils2.toUnixPath)(_path.default.join(o,a)),(0,_utils2.validateFilePathLength)(i,this.logger),s[i]=r.getSourceMap(i));r.isNewSourceMaps()||r.modifySourceMapKeyToCachePath(s);e=_path.default.join(this.projectConfig.patchAbcPath,_ark_define.SOURCEMAPS);(0,_utils2.validateFilePathLength)(e,this.logger),_fs.default.writeFileSync(e,JSON.stringify(s,null,2),"utf-8"),(0,_ark_utils.stopEvent)(t)}generateAbcByEs2abc(e,t){this.generateEs2AbcCmd(),this.addColdReloadArgs(),this.genDescriptionsForMergedEs2abc(t),this.generateMergedAbcOfEs2Abc(e)}}exports.ModuleColdreloadMode=ModuleColdreloadMode;