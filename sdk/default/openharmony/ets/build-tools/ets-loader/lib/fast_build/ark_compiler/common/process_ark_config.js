"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initArkConfig=initArkConfig,exports.initArkProjectConfig=initArkProjectConfig,exports.readProjectAndLibsSource=readProjectAndLibsSource,exports.utProcessArkConfig=void 0;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_arkguard=require("arkguard"),_ark_define=require("./ark_define"),_utils=require("../utils"),_utils2=require("../../../utils"),_ark_utils=require("../../../ark_utils"),_gen_aot=require("../../../gen_aot"),_main=require("../../../../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,a){if(e!==a)throw new TypeError("Cannot instantiate an arrow function")}function initArkConfig(e){let a=_path.default.join(__dirname,"..","..","..","..","bin","ark");e.arkFrontendDir&&(a=e.arkFrontendDir);var o={arkRootPath:"",ts2abcPath:"",js2abcPath:"",mergeAbcPath:"",es2abcPath:"",aotCompilerPath:"",nodePath:"",isDebug:!1,isBranchElimination:!1,optTryCatchFunc:!1};return o.nodePath="node",e.nodeJs&&(o.nodePath=e.nodePath),o.isDebug=(0,_utils.isDebug)(e),o.isBranchElimination=(0,_utils.isBranchElimination)(e),o.optTryCatchFunc=_main.projectConfig.optTryCatchFunc,o.arkRootPath=a,processPlatformInfo(o),processCompatibleVersion(e,o),o}function initArkProjectConfig(a){var o=this,e=a.projectConfig,t={},r=a.projectConfig.entryPackageName||"",i=a.projectConfig.entryModuleVersion||"";return t.entryPackageInfo=r+"|"+i,t.projectRootPath=a.projectConfig.projectTopDir,e.aceBuildJson&&_fs.default.existsSync(e.aceBuildJson)&&(r=JSON.parse(_fs.default.readFileSync(e.aceBuildJson).toString()),t.projectRootPath=r.projectRootPath,t.modulePathMap=r.modulePathMap,t.isOhosTest=r.isOhosTest,t.arkRouterMap=r.routerMap,t.declarationEntry=r.declarationEntry,r.patchConfig&&(t.oldMapFilePath=r.patchConfig.oldMapFilePath),(0,_gen_aot.checkAotConfig)(e.compileMode,r,function(e){_newArrowCheck(this,o),a.throwArkTsCompilerError(e)}.bind(this))?(t.processTs=!0,t.pandaMode=_ark_define.TS2ABC,t.anBuildOutPut=r.anBuildOutPut,t.anBuildMode=r.anBuildMode,t.apPath=r.apPath):(t.processTs=!1,t.pandaMode=r.pandaMode),e.compileMode===_ark_define.ESMODULE&&(t.nodeModulesPath=r.nodeModulesPath,t.harNameOhmMap=r.harNameOhmMap,t.hspNameOhmMap=r.hspNameOhmMap,e.packageDir="ohpm"===r.packageManagerType?_ark_define.OH_MODULES:_ark_define.NODE_MODULES),r.dynamicImportLibInfo&&(t.dynamicImportLibInfo=r.dynamicImportLibInfo),r.byteCodeHarInfo)&&(t.byteCodeHarInfo=r.byteCodeHarInfo),e.aceManifestPath&&_fs.default.existsSync(e.aceManifestPath)&&(i=JSON.parse(_fs.default.readFileSync(e.aceManifestPath).toString())).minPlatformVersion&&(t.minPlatformVersion=i.minPlatformVersion),e.aceModuleJsonPath&&_fs.default.existsSync(e.aceModuleJsonPath)&&((r=JSON.parse(_fs.default.readFileSync(e.aceModuleJsonPath).toString())).app.minAPIVersion&&(t.minPlatformVersion=r.app.minAPIVersion),r.module&&(t.moduleName=r.module.name),r.app)&&(t.bundleName=r.app.bundleName),t.hotReload=_main.projectConfig.hotReload,t.coldReload=_main.projectConfig.coldReload,t.isFirstBuild=_main.projectConfig.isFirstBuild,t.patchAbcPath=_main.projectConfig.patchAbcPath,t.changedFileList=_main.projectConfig.changedFileList,(_main.projectConfig.es2abcCompileTsInAotMode||_main.projectConfig.es2abcCompileTsInNonAotMode)&&(t.pandaMode=_main.projectConfig.pandaMode,t.processTs=_main.projectConfig.processTs),t.compileMode=e.compileMode,t.entryObj=_main.projectConfig.entryObj,t.entryArrayForObf=_main.projectConfig.entryArrayForObf,t.cardEntryObj=_main.projectConfig.cardEntryObj,_main.projectConfig.updateVersionInfo&&(t.updateVersionInfo=_main.projectConfig.updateVersionInfo),(0,_utils.isDebug)(e)?(0,_arkguard.blockPrinter)():(t.useTsHar=_main.projectConfig.useTsHar,i=a.getLogger(_ark_define.OBFUSCATION_TOOL),(0,_arkguard.startFilesEvent)(_arkguard.EventList.OBFUSCATION_INITIALIZATION,_arkguard.performancePrinter.timeSumPrinter),(0,_arkguard.initObfuscationConfig)(e,t,i),(0,_arkguard.endFilesEvent)(_arkguard.EventList.OBFUSCATION_INITIALIZATION,_arkguard.performancePrinter.timeSumPrinter)),t}function initTerserConfig(e,a,o,t){var t={format:{beautify:!(e.obfuscationOptions?o.options.compact:t),indent_level:2},compress:{join_vars:!1,sequences:0,directives:!1,drop_console:o.options.removeLog},mangle:{reserved:o.reservedNames,toplevel:o.options.enableToplevelObfuscation}},r=o.options.applyNameCache;return r&&0<r.length?_fs.default.existsSync(r)?t.nameCache=JSON.parse(_fs.default.readFileSync(r,"utf-8")):a.error(`ArkTS:ERROR Namecache file ${r} does not exist`):e.obfuscationOptions&&e.obfuscationOptions.obfuscationCacheDir&&(a=_path.default.join(e.obfuscationOptions.obfuscationCacheDir,"nameCache.json"),_fs.default.existsSync(a)?t.nameCache=JSON.parse(_fs.default.readFileSync(a,"utf-8")):t.nameCache={}),o.options.enablePropertyObfuscation&&(t.mangle.properties={reserved:o.reservedPropertyNames,keep_quoted:!o.options.enableStringPropertyObfuscation}),t}function readProjectAndLibsSource(e,a,o,t,r){void 0===a?.options||a.options.disableObfuscation||0===e.size||(a=a.options,e=(0,_arkguard.readProjectPropertiesByCollectedPaths)(e,{mNameObfuscation:{mEnable:!0,mReservedProperties:[],mRenameProperties:a.enablePropertyObfuscation,mKeepStringProperty:!a.enableStringPropertyObfuscation},mExportObfuscation:a.enableExportObfuscation,mKeepFileSourceCode:{mKeepSourceOfPaths:new Set,mkeepFilesAndDependencies:r}},t),a.enablePropertyObfuscation&&o.addReservedSetForPropertyObf(e),a.enableExportObfuscation&&o.addReservedSetForDefaultObf(e))}function processPlatformInfo(e){var a=(0,_ark_utils.getArkBuildDir)(e.arkRootPath);(0,_utils2.isWindows)()?(e.es2abcPath=_path.default.join(a,"bin","es2abc.exe"),e.ts2abcPath=_path.default.join(a,"src","index.js"),e.mergeAbcPath=_path.default.join(a,"bin","merge_abc.exe"),e.js2abcPath=_path.default.join(a,"bin","js2abc.exe"),e.aotCompilerPath=_path.default.join(a,"bin","ark_aot_compiler.exe")):(0,_utils2.isLinux)()||(0,_utils2.isMac)()?(e.es2abcPath=_path.default.join(a,"bin","es2abc"),e.ts2abcPath=_path.default.join(a,"src","index.js"),e.mergeAbcPath=_path.default.join(a,"bin","merge_abc"),e.js2abcPath=_path.default.join(a,"bin","js2abc"),e.aotCompilerPath=_path.default.join(a,"bin","ark_aot_compiler")):(0,_utils2.isHarmonyOs)()&&(e.es2abcPath=_path.default.join(a,"bin","es2abc"))}function processCompatibleVersion(e,a){var o=(0,_ark_utils.getArkBuildDir)(a.arkRootPath);e.minPlatformVersion&&"8"===e.minPlatformVersion.toString()&&(a.ts2abcPath=_path.default.join(o,"legacy_api8","src","index.js"),e.pandaMode=_ark_define.TS2ABC)}const utProcessArkConfig={processCompatibleVersion:processCompatibleVersion,initTerserConfig:initTerserConfig};exports.utProcessArkConfig=utProcessArkConfig;