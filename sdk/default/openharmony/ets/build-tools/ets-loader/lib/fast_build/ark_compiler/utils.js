"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.changeFileExtension=changeFileExtension,exports.cleanUpFilesList=cleanUpFilesList,exports.compilingEtsOrTsFiles=void 0,exports.genCachePath=genCachePath,exports.genTemporaryModuleCacheDirectoryForBundle=genTemporaryModuleCacheDirectoryForBundle,exports.getEs2abcFileThreadNumber=getEs2abcFileThreadNumber,exports.hasArkDecorator=hasArkDecorator,exports.hasTsNoCheckOrTsIgnoreFiles=void 0,exports.isAotMode=isAotMode,exports.isBranchElimination=isBranchElimination,exports.isCommonJsPluginVirtualFile=isCommonJsPluginVirtualFile,exports.isCurrentProjectFiles=isCurrentProjectFiles,exports.isDebug=isDebug,exports.isJsSourceFile=isJsSourceFile,exports.isJsonSourceFile=isJsonSourceFile,exports.isMasterOrPrimary=isMasterOrPrimary,exports.isSpecifiedExt=isSpecifiedExt,exports.isTsOrEtsSourceFile=isTsOrEtsSourceFile,exports.needAotCompiler=needAotCompiler,exports.shouldETSOrTSFileTransformToJS=shouldETSOrTSFileTransformToJS,exports.shouldETSOrTSFileTransformToJSWithoutRemove=shouldETSOrTSFileTransformToJSWithoutRemove,exports.updateSourceMap=updateSourceMap,exports.utUtils=void 0,exports.writeFileContentToTempDir=writeFileContentToTempDir;var _cluster=_interopRequireDefault(require("cluster")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_typescript=_interopRequireDefault(require("typescript")),_os=_interopRequireDefault(require("os")),_sourceMap=_interopRequireDefault(require("source-map")),_ark_define=require("./common/ark_define"),_utils=require("../../utils"),_ark_utils=require("../../ark_utils"),_pre_define=require("../../pre_define"),_generate_sourcemap=require("./generate_sourcemap"),_ob_config_resolver=require("./common/ob_config_resolver");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,r){if(e!==r)throw new TypeError("Cannot instantiate an arrow function")}let hasTsNoCheckOrTsIgnoreFiles=[],compilingEtsOrTsFiles=(exports.hasTsNoCheckOrTsIgnoreFiles=hasTsNoCheckOrTsIgnoreFiles,[]);function cleanUpFilesList(){exports.hasTsNoCheckOrTsIgnoreFiles=hasTsNoCheckOrTsIgnoreFiles=[],exports.compilingEtsOrTsFiles=compilingEtsOrTsFiles=[]}function needAotCompiler(e){return e.compileMode===_ark_define.ESMODULE&&(e.anBuildMode===_pre_define.AOT_FULL||e.anBuildMode===_pre_define.AOT_PARTIAL)}function isAotMode(e){return e.compileMode===_ark_define.ESMODULE&&(e.anBuildMode===_pre_define.AOT_FULL||e.anBuildMode===_pre_define.AOT_PARTIAL||e.anBuildMode===_pre_define.AOT_TYPE)}function isDebug(e){return e.buildMode.toLowerCase()===_ark_define.DEBUG}function isBranchElimination(e){return e.branchElimination}function isMasterOrPrimary(){return(0,_utils.nodeLargeOrEqualTargetVersion)(16)&&_cluster.default.isPrimary||!(0,_utils.nodeLargeOrEqualTargetVersion)(16)&&_cluster.default.isMaster}function changeFileExtension(e,r,t=""){t=0===t.length?_path.default.extname(e):t;return e.substring(0,e.lastIndexOf(t))+r}function removeCacheFile(e,r){e=(0,_utils.toUnixPath)(changeFileExtension(e,r));_fs.default.existsSync(e)&&_fs.default.rmSync(e)}function shouldETSOrTSFileTransformToJS(e,r,t){var i,t=(0,_utils.genTemporaryPath)(e,r.projectPath,r.cachePath,r,t);return r.processTs?-1!==compilingEtsOrTsFiles.indexOf(e)?(removeCacheFile(t,(i=-1!==hasTsNoCheckOrTsIgnoreFiles.indexOf(e))?_ark_define.EXTNAME_TS:_ark_define.EXTNAME_JS),i):(t=updateCacheFilePathIfEnableObuscatedFilePath(e,t,r),t=(0,_utils.toUnixPath)(changeFileExtension(t,_ark_define.EXTNAME_JS)),_fs.default.existsSync(t)):(removeCacheFile(t,_ark_define.EXTNAME_TS),!0)}function shouldETSOrTSFileTransformToJSWithoutRemove(e,r,t){return!r.processTs||(-1!==compilingEtsOrTsFiles.indexOf(e)?-1!==hasTsNoCheckOrTsIgnoreFiles.indexOf(e):(e=updateCacheFilePathIfEnableObuscatedFilePath(e,e=(0,_utils.genTemporaryPath)(e,r.projectPath,r.cachePath,r,t),r),e=(0,_utils.toUnixPath)(changeFileExtension(e,_ark_define.EXTNAME_JS)),_fs.default.existsSync(e)))}function updateCacheFilePathIfEnableObuscatedFilePath(e,r,t){e=(0,_utils.isPackageModulesFile)(e,t);return(0,_ob_config_resolver.enableObfuscatedFilePathConfig)(e,t)&&(0,_ob_config_resolver.enableObfuscateFileName)(e,t)?(0,_ob_config_resolver.handleObfuscatedFilePath)(r,e,t):r}async function writeFileContentToTempDir(r,t,i,o,n,a){if(!isCommonJsPluginVirtualFile(r)&&isCurrentProjectFiles(r,i)){let e;e=i.compileHar?(0,_utils.genTemporaryPath)(r,i.compileShared?i.projectRootPath:i.moduleRootPath,i.compileShared?_path.default.resolve(i.aceModuleBuild,"../etsFortgz"):i.cachePath,i,a,i.compileShared):(0,_utils.genTemporaryPath)(r,i.projectPath,i.cachePath,i,a);n=(0,_ark_utils.createAndStartEvent)(n,"write file content");switch(_path.default.extname(r)){case _ark_define.EXTNAME_ETS:case _ark_define.EXTNAME_TS:case _ark_define.EXTNAME_JS:case _ark_define.EXTNAME_MJS:case _ark_define.EXTNAME_CJS:await writeFileContent(r,e,t,i,o,a);break;case _ark_define.EXTNAME_JSON:var s=(0,_ark_utils.tryMangleFileName)(e,i,r);(0,_utils.mkdirsSync)(_path.default.dirname(s)),_fs.default.writeFileSync(s,t??"")}(0,_ark_utils.stopEvent)(n)}}async function writeFileContent(e,r,t,i,o,n){isSpecifiedExt(e,_ark_define.EXTNAME_JS)||(r=changeFileExtension(r,_ark_define.EXTNAME_JS)),isDebug(i)?((0,_utils.mkdirsSync)(_path.default.dirname(r)),_fs.default.writeFileSync(r,t,"utf-8")):(n=(0,_ob_config_resolver.getRelativeSourcePath)(e,i.projectRootPath,n?.belongProjectPath),await(0,_ark_utils.writeObfuscatedSourceCode)({content:t,buildFilePath:r,relativeSourceFilePath:n,originSourceFilePath:e,rollupModuleId:e},o,i,_generate_sourcemap.SourceMapGenerator.getInstance().getSourceMaps()))}function getEs2abcFileThreadNumber(){return _os.default.cpus().length<16?_os.default.cpus().length:16}function isCommonJsPluginVirtualFile(e){return e.includes("\0")}function isCurrentProjectFiles(e,r){if(r.rootPathSet){for(const t of r.rootPathSet)if((0,_utils.isFileInProject)(e,t))return!0;return!1}return(0,_utils.isFileInProject)(e,r.projectRootPath)}function genTemporaryModuleCacheDirectoryForBundle(e){var r=e.aceModuleBuild.split(_path.default.sep),r=r[r.length-1],e=_path.default.join(e.cachePath,_ark_define.TEMPORARY,r);return(0,_utils.mkdirsSync)(e),e}function isSpecifiedExt(e,r){return _path.default.extname(e)===r}function genCachePath(e,r,t){r=void 0!==r.cachePath?_path.default.join(r.cachePath,_ark_define.TEMPORARY,e):_path.default.join(r.aceModuleBuild,e);return(0,_utils.mkdirsSync)(_path.default.dirname(r)),(0,_utils.validateFilePathLength)(r,t),r}function isTsOrEtsSourceFile(e){return/(?<!\.d)\.[e]?ts$/.test(e)}function isJsSourceFile(e){return/\.[cm]?js$/.test(e)}function isJsonSourceFile(e){return/\.json$/.test(e)}async function updateSourceMap(e,r){var t=this;if(!e)return r;if(!r)return e;const i=await new _sourceMap.default.SourceMapConsumer(e);r=await new _sourceMap.default.SourceMapConsumer(r);const o=[];r.eachMapping(function(e){var r;_newArrowCheck(this,t),null!=e.originalLine&&null!=(r=i.originalPositionFor({line:e.originalLine,column:e.originalColumn})).source&&(e.originalLine=r.line,e.originalColumn=r.column,o.push(e))}.bind(this));r=_sourceMap.default.SourceMapGenerator.fromSourceMap(r);return r._file=e.file,r._mappings._array=o,JSON.parse(r.toString())}function hasArkDecorator(e,r){var t=_typescript.default.getAllDecorators(e);if(t&&t.length)for(let e=0;e<t.length;e++)return t[e].getText().replace(/\(.*\)$/,"").replace(/\s*/g,"").trim()===r;return!1}exports.compilingEtsOrTsFiles=compilingEtsOrTsFiles;const utUtils={writeFileContent:writeFileContent};exports.utUtils=utUtils;