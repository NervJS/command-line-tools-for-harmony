"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.apiTransform=apiTransform,exports.appImportModuleCollection=void 0,exports.collectKitModules=collectKitModules,exports.kitModules=void 0;var _magicString=_interopRequireDefault(require("magic-string")),_pluginutils=require("@rollup/pluginutils"),_path=_interopRequireDefault(require("path")),_pre_define=require("../../pre_define"),_main=require("../../../main"),_utils=require("../../utils"),_ets_checker=require("../../ets_checker"),_utils2=require("../ark_compiler/utils"),_rollupPluginEtsTypescript=require("../ets_ui/rollup-plugin-ets-typescript");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,i){if(e!==i)throw new TypeError("Cannot instantiate an arrow function")}const filterCrossplatform=(0,_pluginutils.createFilter)(/(?<!\.d)\.(ets|ts|js)$/),filter=(0,_pluginutils.createFilter)(/(?<!\.d)\.(ets|ts)$/),allFiles=new Set,appImportModuleCollection=new Map,kitModules=(exports.appImportModuleCollection=appImportModuleCollection,new Map);function apiTransform(){const r=new Set;let i=!1,e=!1;return{name:"apiTransform",load(e){allFiles.add(_path.default.join(e))},buildStart(){this.share.projectConfig.isCrossplatform?(i=!0,e=!0):this.share.projectConfig.widgetCompile&&(i=!1,e=!0)},transform(e,i){let t=this.share.projectConfig.needCompleteSourcesMap;var o=i.endsWith(".js")||(0,_rollupPluginEtsTypescript.shouldEmitJsFlagById)(i)||"esmodule"!==_main.projectConfig.compileMode;return(o||this.share.projectConfig.isCrossplatform||this.share.projectConfig.widgetCompile)&&((_main.projectConfig.isCrossplatform?filterCrossplatform:filter)(i)&&(t="esmodule"===_main.projectConfig.compileMode?(e=processSystemApiAndLibso(e,i,r),!(!t&&!_utils2.hasTsNoCheckOrTsIgnoreFiles.includes(i))):(e=processLibso(e=processSystemApi(e,i),i,r),!0)),o)?{code:e,map:new _magicString.default(e).generateMap({hires:t})}:null},beforeBuildEnd(){if(this.share.allFiles=allFiles,"true"!==process.env.watchMode&&!_main.projectConfig.xtsMode&&e){let e;_main.projectConfig.widgetCompile&&(e=_path.default.resolve(_main.projectConfig.aceModuleBuild,"widget")),this.share.allComponents=(0,_utils.getAllComponentsOrModules)(allFiles,"component_collection.json"),(0,_utils.writeCollectionFile)(_main.projectConfig.cachePath,_ets_checker.appComponentCollection,this.share.allComponents,"component_collection.json",this.share.allFiles,e)}},buildEnd(){var e;_main.projectConfig.isPreview&&_main.projectConfig.aceSoPath&&r&&0<r.size&&(0,_utils.writeUseOSFiles)(r),"true"!==process.env.watchMode&&!_main.projectConfig.xtsMode&&i&&(replaceKitModules(),e=(0,_utils.getAllComponentsOrModules)(allFiles,"module_collection.json"),(0,_utils.writeCollectionFile)(_main.projectConfig.cachePath,appImportModuleCollection,e,"module_collection.json"))},cleanUp(){allFiles.clear(),appImportModuleCollection.clear(),r.clear(),kitModules.clear()}}}function processSystemApi(e,l){var a=this,i=new RegExp(`import\\s+(.+)\\s+from\\s+['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]|import\\s+(.+)\\s*=\\s*require\\(\\s*['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]\\s*\\)`,"g");return appImportModuleCollection.set(_path.default.join(l),new Set),e.replace(i,function(e,i,t,o,r,s,n){_newArrowCheck(this,a);t=t||s,s=o||n,o=i||r,n=t+"."+s,appImportModuleCollection.get(_path.default.join(l)).add(n),checkModuleExist(n,l),i=isExtendModuleType(t)&&t!==_pre_define.ARKUI_X_PLUGIN?`, false, '', '${t}'`:"";return _pre_define.NATIVE_MODULE.has(n)?e=`var ${o} = ${_pre_define.GLOBAL_THIS_REQUIRE_NATIVE_MODULE}('${t}.${s}')`:checkModuleType(t)&&(e=`var ${o} = ${_pre_define.GLOBAL_THIS_REQUIRE_NAPI}('${s}'${i})`),e}.bind(this))}function isExtendModuleType(i){for(let e=0;e<_main.extendSdkConfigs.length;e++)if(_main.extendSdkConfigs[e].prefix==="@"+i)return!0;return!1}function checkModuleType(i){for(let e=0;e<_main.sdkConfigs.length;e++)if(_main.sdkConfigs[e].prefix==="@"+i)return!0;return!1}function checkModuleExist(e,i){e=`@${e.trim()}.d.ts`;/\.js$/.test(i)&&!_main.systemModules.includes(e)&&console.error(`BUILDERROR File: ${i}
 `+`Cannot find module '${e}' or its corresponding type declarations.`)}function processLibso(e,s,n){var l=this;return e.replace(/import\s+(.+)\s+from\s+['"]lib(\S+)\.so['"]|import\s+(.+)\s*=\s*require\(\s*['"]lib(\S+)\.so['"]\s*\)/g,function(e,i,t,o,r){_newArrowCheck(this,l),n.add(s);i=i||o,o=t||r;return _main.projectConfig.bundleName&&_main.projectConfig.moduleName?`var ${i} = globalThis.requireNapi("${o}", true, "${_main.projectConfig.bundleName}/${_main.projectConfig.moduleName}");`:`var ${i} = globalThis.requireNapi("${o}", true);`}.bind(this))}function processSystemApiAndLibso(e,l,s){var a=this,i=new RegExp(`import\\s+(.+)\\s*=\\s*require\\(\\s*['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]\\s*\\)`,"g"),t=new RegExp(`import\\s+(.+)\\s+from\\s+['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]`,"g");return appImportModuleCollection.set(_path.default.join(l),new Set),e.replace(t,function(e,i,t,o,r,s,n){_newArrowCheck(this,a);t=(t||s)+"."+(o||n);return appImportModuleCollection.get(_path.default.join(l)).add(t),e}.bind(this)),e.replace(i,function(e,i,t,o,r,s,n){_newArrowCheck(this,a);t=t||s,s=o||n,o=i||r,n=t+"."+s;return appImportModuleCollection.get(_path.default.join(l)).add(n),checkModuleExist(n,l),`import ${o} from '@${t}.${s}'`}.bind(this)).replace(/import\s+(.+)\s+from\s+['"]lib(\S+)\.so['"]|import\s+(.+)\s*=\s*require\(\s*['"]lib(\S+)\.so['"]\s*\)/g,function(e,i,t,o,r){return _newArrowCheck(this,a),s.add(l),`import ${i||o} from 'lib${t||r}.so'`}.bind(this))}function collectKitModules(e,i,t){i=i.replace("@",""),t=t.replace("@","");var o,r=kitModules.get(e);r?(o=r.get(i))&&!o.has(t)?(o.add(t),r.set(i,o)):o||(o=new Set,r.set(i,o.add(t))):(r=new Map,o=new Set,r.set(i,o.add(t)),kitModules.set(e,r))}function compareKitModules(e,i,t){var o=this;const r=new Set;e.forEach(function(e){var i=this;_newArrowCheck(this,o),t.get(e)?t.get(e).forEach(function(e){_newArrowCheck(this,i),r.add(e.replace(/\.d\.e?ts$/,""))}.bind(this)):r.add(e)}.bind(this)),appImportModuleCollection.set(i,r)}function replaceKitModules(){var e=this;appImportModuleCollection.forEach(function(t,o){var r=this;_newArrowCheck(this,e),kitModules.forEach(function(e,i){_newArrowCheck(this,r),o===i&&t&&0<t.size&&compareKitModules(t,i,e)}.bind(this))}.bind(this))}exports.kitModules=kitModules;