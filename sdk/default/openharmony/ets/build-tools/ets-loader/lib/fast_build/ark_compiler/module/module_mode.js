"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageEntryInfo=exports.ModuleMode=exports.ModuleInfo=void 0;var _child_process=_interopRequireDefault(require("child_process")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_cluster=_interopRequireDefault(require("cluster")),_ark_define=require("../common/ark_define"),_utils=require("../utils"),_common_mode=require("../common/common_mode"),_ob_config_resolver=require("../common/ob_config_resolver"),_utils2=require("../../../utils"),_ark_utils=require("../../../ark_utils"),_gen_aot=require("../../../gen_aot"),_pre_define=require("../../../pre_define"),_check_shared_module=require("../check_shared_module"),_generate_sourcemap=require("../generate_sourcemap");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);i=i.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}class ModuleInfo{constructor(e,t,i,o,r,s){_defineProperty(this,"filePath",void 0),_defineProperty(this,"cacheFilePath",void 0),_defineProperty(this,"recordName",void 0),_defineProperty(this,"isCommonJs",void 0),_defineProperty(this,"sourceFile",void 0),_defineProperty(this,"packageName",void 0),this.filePath=e,this.cacheFilePath=t,this.recordName=o,this.isCommonJs=i,this.sourceFile=r,this.packageName=s}}exports.ModuleInfo=ModuleInfo;class PackageEntryInfo{constructor(e,t){_defineProperty(this,"pkgEntryPath",void 0),_defineProperty(this,"pkgBuildPath",void 0),this.pkgEntryPath=e,this.pkgBuildPath=t}}exports.PackageEntryInfo=PackageEntryInfo;class ModuleMode extends _common_mode.CommonMode{constructor(e){super(e),_defineProperty(this,"moduleInfos",void 0),_defineProperty(this,"pkgEntryInfos",void 0),_defineProperty(this,"hashJsonObject",void 0),_defineProperty(this,"filesInfoPath",void 0),_defineProperty(this,"npmEntriesInfoPath",void 0),_defineProperty(this,"moduleAbcPath",void 0),_defineProperty(this,"sourceMapPath",void 0),_defineProperty(this,"cacheFilePath",void 0),_defineProperty(this,"cacheSourceMapPath",void 0),_defineProperty(this,"workerNumber",void 0),_defineProperty(this,"npmEntriesProtoFilePath",void 0),_defineProperty(this,"protoFilePath",void 0),_defineProperty(this,"filterModuleInfos",void 0),_defineProperty(this,"symlinkMap",void 0),_defineProperty(this,"useNormalizedOHMUrl",void 0),_defineProperty(this,"compileContextInfoPath",void 0),_defineProperty(this,"abcPaths",[]),_defineProperty(this,"byteCodeHar",void 0),this.moduleInfos=new Map,this.pkgEntryInfos=new Map,this.hashJsonObject={},this.filesInfoPath=_path.default.join(this.projectConfig.cachePath,_ark_define.FILESINFO_TXT),this.npmEntriesInfoPath=_path.default.join(this.projectConfig.cachePath,_ark_define.NPMENTRIES_TXT);var t=this.projectConfig.widgetCompile?_ark_define.WIDGETS_ABC:_ark_define.MODULES_ABC;if(this.moduleAbcPath=_path.default.join(this.projectConfig.aceModuleBuild,t),this.sourceMapPath=this.arkConfig.isDebug?_path.default.join(this.projectConfig.aceModuleBuild,_ark_define.SOURCEMAPS):_path.default.join(this.projectConfig.cachePath,_ark_define.SOURCEMAPS),this.cacheFilePath=_path.default.join(this.projectConfig.cachePath,_ark_define.MODULES_CACHE),this.cacheSourceMapPath=_path.default.join(this.projectConfig.cachePath,_ark_define.SOURCEMAPS_JSON),this.workerNumber=_ark_define.MAX_WORKER_NUMBER,this.npmEntriesProtoFilePath=_path.default.join(this.projectConfig.cachePath,_ark_define.PROTOS,_ark_define.NPM_ENTRIES_PROTO_BIN),this.protoFilePath=_path.default.join(this.projectConfig.cachePath,_ark_define.PROTOS,_ark_define.PROTO_FILESINFO_TXT),this.hashJsonObject={},this.filterModuleInfos=new Map,this.symlinkMap=e.share.symlinkMap,this.useNormalizedOHMUrl=this.isUsingNormalizedOHMUrl(),Object.prototype.hasOwnProperty.call(this.projectConfig,"byteCodeHarInfo")){var i=this.projectConfig.byteCodeHarInfo;for(const r in i){var o=(0,_utils2.toUnixPath)(i[r].abcPath);this.abcPaths.push(o)}}this.byteCodeHar=!!this.projectConfig.byteCodeHar,this.useNormalizedOHMUrl&&(this.compileContextInfoPath=this.generateCompileContextInfo(e))}generateCompileContextInfo(e){var t=_path.default.join(this.projectConfig.cachePath,_ark_define.COMPILE_CONTEXT_INFO_JSON),i={},o=[];for(const h in this.projectConfig.hspNameOhmMap){let e=h;this.projectConfig.dependencyAliasMap.has(h)&&(e=this.projectConfig.dependencyAliasMap.get(h)),o.push((0,_utils2.toUnixPath)(e))}i.hspPkgNames=o;var r=new Set;let s=this.projectConfig.entryObj;for(const l in s=this.projectConfig.widgetCompile?this.projectConfig.cardEntryObj:s){var n=s[l],a=e.getModuleInfo(n),a=(a||this.throwArkTsCompilerError(`ArkTS:INTERNAL ERROR: Failed to find module info.
`+`Error Message: Failed to find module info with '${n}' from the context information.`),a.meta),a=(a||this.throwArkTsCompilerError(`ArkTS:INTERNAL ERROR: Failed to find meta info.
`+`Error Message: Failed to find meta info with '${n}' from the module info.`),{pkgName:a.pkgName,pkgPath:a.pkgPath,isRecordName:!0}),n=(0,_ark_utils.getNormalizedOhmUrlByFilepath)(n,this.projectConfig,this.logger,a,void 0);r.add(n)}return this.collectDeclarationFilesEntry(r,o),i.compileEntries=Array.from(r),this.projectConfig.updateVersionInfo?i.updateVersionInfo=this.projectConfig.updateVersionInfo:this.projectConfig.pkgContextInfo&&(i.pkgContextInfo=this.projectConfig.pkgContextInfo),"shared"===this.projectConfig.bundleType&&(i.needModifyRecord=!0,i.bundleName=this.projectConfig.bundleName),_fs.default.writeFileSync(t,JSON.stringify(i),"utf-8"),t}collectDeclarationFilesEntry(i,o){var r=this;this.projectConfig.arkRouterMap&&this.collectRouterMapEntries(i,o),this.projectConfig.declarationEntry&&this.projectConfig.declarationEntry.forEach(function(e){_newArrowCheck(this,r);var t=(0,_ark_utils.transformOhmurlToPkgName)(e);o.includes(t)||(t=(0,_ark_utils.transformOhmurlToRecordName)(e),i.add(t))}.bind(this))}collectRouterMapEntries(i,o){var r=this;this.projectConfig.arkRouterMap.forEach(function(e){var t;_newArrowCheck(this,r),e.ohmurl&&(t=(0,_ark_utils.transformOhmurlToPkgName)(e.ohmurl),o.includes(t)||(t=(0,_ark_utils.transformOhmurlToRecordName)(e.ohmurl),i.add(t)))}.bind(this))}prepareForCompilation(e,t){t=(0,_ark_utils.createAndStartEvent)(t,"preparation for compilation");this.collectModuleFileList(e,e.getModuleIds()),this.removeCacheInfo(e),(0,_ark_utils.stopEvent)(t)}collectModuleFileList(e,t){var i,o=new Map,r=new Map;for(const s of t)!(0,_utils.isCommonJsPluginVirtualFile)(s)&&(0,_utils.isCurrentProjectFiles)(s,this.projectConfig)&&((i=e.getModuleInfo(s)).meta.isNodeEntryFile&&!this.useNormalizedOHMUrl&&this.getPackageEntryInfo(s,i.meta,r),this.processModuleInfos(s,o,i.meta));this.useNormalizedOHMUrl||this.getDynamicImportEntryInfo(r),this.getNativeModuleEntryInfo(r),this.moduleInfos=o,this.pkgEntryInfos=r}isUsingNormalizedOHMUrl(){return!!this.projectConfig.useNormalizedOHMUrl}updatePkgEntryInfos(e,t,i){e.has(t)||e.set(t,new PackageEntryInfo(t,i))}getDynamicImportEntryInfo(t){var i=this;if(this.projectConfig.dynamicImportLibInfo){var o,r,e=/lib(.+)\.so/;for([o,r]of Object.entries(this.projectConfig.dynamicImportLibInfo))if(e.test(o)){var s=o.replace(e,function(e,t){return _newArrowCheck(this,i),`@app.${this.projectConfig.bundleName}/${this.projectConfig.moduleName}/`+t}.bind(this));this.updatePkgEntryInfos(t,o,s)}else{let e=(0,_ark_utils.getOhmUrlByExternalPackage)(o,this.projectConfig,this.logger,this.useNormalizedOHMUrl);void 0!==e?(e=e.replace(/^@(\w+):(.*)/,"@$1.$2"),this.updatePkgEntryInfos(t,o,e)):(s=r.entryFilePath,this.getPackageEntryInfo(s,r,t))}}}getNativeModuleEntryInfo(e){for(const i of _pre_define.NATIVE_MODULE){var t="@"+i;this.updatePkgEntryInfos(e,t,"@native."+i)}}getPackageEntryInfo(i,o,r){var s=this;if(o.isLocalDependency){var e=o.hostModulesInfo;const l=(0,_ark_utils.getOhmUrlByFilepath)(i,this.projectConfig,this.logger,o.moduleName);void e.forEach(function(e){_newArrowCheck(this,s);var t=e.hostDependencyName,e=e.hostModuleName,e=(0,_utils2.toUnixPath)(_path.default.join(_ark_define.PACKAGES+"@"+e,t));r.has(e)||r.set(e,new PackageEntryInfo(e,l)),this.updatePkgEntryInfos(r,t,"@bundle."+l)}.bind(this))}else if(o.pkgPath){var n,a,h=o.pkgPath;let e=(0,_utils2.toUnixPath)(i.replace(h,""));e.startsWith("/")&&(e=e.slice(1,e.length));const c=(0,_utils2.toUnixPath)(this.getPkgModulesFilePkgName(h));let t=_path.default.join(c,e);if(t=(0,_utils2.toUnixPath)(t.substring(0,t.lastIndexOf("."))),r.has(c)||r.set(c,new PackageEntryInfo(c,t)),this.projectConfig.packageDir==_ark_define.OH_MODULES&&this.symlinkMap)for([n,a]of Object.entries(this.symlinkMap))if(n===h){a.forEach(function(e){_newArrowCheck(this,s);e=(0,_utils2.toUnixPath)(this.getPkgModulesFilePkgName(e));r.has(e)||r.set(e,new PackageEntryInfo(e,c))}.bind(this));break}}else this.logger.debug("ArkTS:INTERNAL ERROR: Failed to get 'pkgPath' from metaInfo. File: ",i)}processModuleInfos(e,t,i){switch(_path.default.extname(e)){case _ark_define.EXTNAME_ETS:var o=(0,_utils.shouldETSOrTSFileTransformToJS)(e,this.projectConfig,i)?_ark_define.EXTNAME_JS:_ark_define.EXTNAME_TS;this.addModuleInfoItem(e,!1,o,i,t);break;case _ark_define.EXTNAME_TS:o=(0,_utils.shouldETSOrTSFileTransformToJS)(e,this.projectConfig,i)?_ark_define.EXTNAME_JS:"";this.addModuleInfoItem(e,!1,o,i,t);break;case _ark_define.EXTNAME_JS:case _ark_define.EXTNAME_MJS:case _ark_define.EXTNAME_CJS:var o=e.endsWith(_ark_define.EXTNAME_MJS)||e.endsWith(_ark_define.EXTNAME_CJS)?_ark_define.EXTNAME_JS:"",r=i&&i.commonjs&&i.commonjs.isCommonJS;this.addModuleInfoItem(e,r,o,i,t);break;case _ark_define.EXTNAME_JSON:this.addModuleInfoItem(e,!1,"",i,t)}}handleFileNameObfuscationInModuleInfo(e,t,i,o,r){return(0,_ob_config_resolver.enableObfuscateFileName)(t,this.projectConfig)?(r=(o=(0,_ob_config_resolver.handleObfuscatedFilePath)(i,t,this.projectConfig)).replace((0,_utils2.toUnixPath)(this.projectConfig.projectRootPath)+"/",""),e.isNewSourceMaps()&&(r=e.genKey(i),e.sourceMapKeyMappingForObf.get(r)||e.saveKeyMappingForObfFileName(i),r=e.sourceMapKeyMappingForObf.get(r)),{filePath:o,sourceFile:r}):{filePath:o,sourceFile:r=e.isNewSourceMaps()?e.genKey(i):r}}addModuleInfoItem(e,t,i,o,r){var s=_generate_sourcemap.SourceMapGenerator.getInstance(),n=(0,_utils2.isPackageModulesFile)(e,this.projectConfig);let a=e,h=a.replace(this.projectConfig.projectRootPath+_path.default.sep,"");(0,_ob_config_resolver.enableObfuscatedFilePathConfig)(n,this.projectConfig)?(l=this.handleFileNameObfuscationInModuleInfo(s,n,e,a,h),a=l.filePath,h=l.sourceFile):s.isNewSourceMaps()&&(h=s.genKey(e));var l=o.moduleName;let c="",f=this.genFileCachePath(a,this.projectConfig.projectRootPath,this.projectConfig.cachePath,o),d="";this.useNormalizedOHMUrl?(e={pkgName:d=o.pkgName,pkgPath:o.pkgPath,isRecordName:!0},c=(0,_ark_utils.getNormalizedOhmUrlByFilepath)(a,this.projectConfig,this.logger,e,void 0)):(c=(0,_ark_utils.getOhmUrlByFilepath)(a,this.projectConfig,this.logger,l),d=n?this.getPkgModulesFilePkgName(o.pkgPath):o.isLocalDependency?l:(0,_ark_utils.getPackageInfo)(this.projectConfig.aceModuleJsonPath)[1]),0!==i.length&&(f=(0,_utils.changeFileExtension)(f,i)),f=(0,_utils2.toUnixPath)(f),c=(0,_utils2.toUnixPath)(c),d=(0,_utils2.toUnixPath)(d),s.isNewSourceMaps()||(h=f.replace((0,_utils2.toUnixPath)(this.projectConfig.projectRootPath)+"/","")),a=(0,_utils2.toUnixPath)(a),r.set(a,new ModuleInfo(a,f,t,c,h,d))}generateEs2AbcCmd(){var e=(0,_utils.getEs2abcFileThreadNumber)();this.cmdArgs.push(`"@${this.filesInfoPath}"`),this.byteCodeHar||(this.cmdArgs.push("--npm-module-entry-list"),this.cmdArgs.push(`"${this.npmEntriesInfoPath}"`)),this.cmdArgs.push("--output"),this.cmdArgs.push(`"${this.moduleAbcPath}"`),this.cmdArgs.push("--file-threads"),this.cmdArgs.push(`"${e}"`),this.cmdArgs.push("--merge-abc"),this.cmdArgs.push(`"--target-api-version=${this.projectConfig.compatibleSdkVersion}"`),this.projectConfig.compatibleSdkVersionStage&&this.cmdArgs.push(`"--target-api-sub-version=${this.projectConfig.compatibleSdkVersionStage}"`),this.arkConfig.isBranchElimination&&this.cmdArgs.push("--branch-elimination"),this.projectConfig.transformLib&&(this.cmdArgs.push("--transform-lib"),this.cmdArgs.push(`"${this.projectConfig.transformLib}"`)),void 0!==this.compileContextInfoPath&&(this.cmdArgs.push("--compile-context-info"),this.cmdArgs.push(`"${this.compileContextInfoPath}"`)),0<this.abcPaths.length&&!this.byteCodeHar&&(this.cmdArgs.push("--enable-abc-input"),this.cmdArgs.push("--remove-redundant-file")),this.arkConfig.optTryCatchFunc||this.cmdArgs.push("--opt-try-catch-func=false")}addCacheFileArgs(){this.cmdArgs.push("--cache-file"),this.cmdArgs.push(`"@${this.cacheFilePath}"`)}generateCompileFilesInfo(e){var o=this;let r="";this.moduleInfos.forEach(function(e){_newArrowCheck(this,o);var t=e.isCommonJs?_ark_define.COMMONJS:_ark_define.ESM,i=_check_shared_module.sharedModuleSet.has(e.filePath);r+=`${e.cacheFilePath};${e.recordName};${t};${e.sourceFile};${e.packageName};`+i+`
`}.bind(this)),e&&Object.entries(this.projectConfig.byteCodeHarInfo).forEach(function([e,t]){_newArrowCheck(this,o);t=(0,_utils2.toUnixPath)(t.abcPath);r+=t+`;;;;${e};
`}.bind(this)),_fs.default.writeFileSync(this.filesInfoPath,r,"utf-8")}generateNpmEntriesInfo(){let e="";for(const t of this.pkgEntryInfos.values())e+=`${t.pkgEntryPath}:${t.pkgBuildPath}\n`;_fs.default.writeFileSync(this.npmEntriesInfoPath,e,"utf-8")}generateAbcCacheFilesInfo(){var i=this;let o="";this.moduleInfos.forEach(function(e){_newArrowCheck(this,i);var t=(0,_utils.changeFileExtension)(e.cacheFilePath,_ark_define.EXTNAME_PROTO_BIN);o+=e.cacheFilePath+`;${t}
`}.bind(this));var e=(0,_utils.changeFileExtension)(this.npmEntriesInfoPath,_ark_define.EXTNAME_PROTO_BIN);o+=this.npmEntriesInfoPath+`;${e}
`,_fs.default.writeFileSync(this.cacheFilePath,o,"utf-8")}genDescriptionsForMergedEs2abc(e){this.generateCompileFilesInfo(e),this.byteCodeHar||this.generateNpmEntriesInfo(),this.generateAbcCacheFilesInfo()}generateMergedAbcOfEs2Abc(e){var i=this;let o="";var t=(0,_ark_utils.createAndStartEvent)(e,"generate descriptions for merged es2abc");(0,_ark_utils.stopEvent)(t);const r=this.cmdArgs.join(" ");try{let t;var s=this.triggerAsync(function(){return _newArrowCheck(this,i),t=(0,_ark_utils.createAndStartEvent)(e,"generate merged abc by es2abc (async)",!0),_child_process.default.exec(r,{windowsHide:!0})}.bind(this));s.on("close",function(e){_newArrowCheck(this,i),e!==_ark_define.SUCCESS&&this.throwArkTsCompilerError("ArkTS:ERROR Failed to execute es2abc.\nError Message: "+o),(0,_ark_utils.stopEvent)(t,!0),this.triggerEndSignal(),this.processAotIfNeeded()}.bind(this)),s.on("error",function(e){_newArrowCheck(this,i),(0,_ark_utils.stopEvent)(t,!0),this.throwArkTsCompilerError(e.toString())}.bind(this)),s.stderr.on("data",function(e){_newArrowCheck(this,i),o+=e.toString()}.bind(this))}catch(e){this.throwArkTsCompilerError(`ArkTS:ERROR Failed to execute es2abc.
Error message: ${e.toString()}
`)}}filterModulesByHashJson(){if(0!==this.hashJsonFilePath.length&&_fs.default.existsSync(this.hashJsonFilePath)){var e,t,i={};if(_fs.default.existsSync(this.hashJsonFilePath)){t=_fs.default.readFileSync(this.hashJsonFilePath).toString(),e=JSON.parse(t),this.filterModuleInfos=new Map;for(var[o,r]of this.moduleInfos){var s=r.cacheFilePath,n=(0,_utils.changeFileExtension)(s,_ark_define.EXTNAME_PROTO_BIN);if(_fs.default.existsSync(s)||this.throwArkTsCompilerError(`ArkTS:INTERNAL ERROR: Failed to get module cache abc from ${s} in incremental build.`+"Please try to rebuild the project."),_fs.default.existsSync(n)){var a=(0,_utils2.toHashData)(s),h=(0,_utils2.toHashData)(n);if(e[s]===a&&e[n]===h){i[s]=s,i[n]=n;continue}}this.filterModuleInfos.set(o,r)}}this.hashJsonObject=i}else for(const l of this.moduleInfos.keys())this.filterModuleInfos.set(l,this.moduleInfos.get(l))}getSplittedModulesByNumber(){var t=[];if(this.filterModuleInfos.size<this.workerNumber)for(const e of this.filterModuleInfos.values())t.push([e]);else{for(let e=0;e<this.workerNumber;++e)t.push([]);let e=0;for(const i of this.filterModuleInfos.values())t[e%this.workerNumber].push(i),e++}return t}invokeTs2AbcWorkersToGenProto(t){var i=this,o=this.cmdArgs.slice(0);if(o.push("--output-proto"),o.push("--merge-abc"),o.push("--input-file"),(0,_utils.isMasterOrPrimary)()){this.setupCluster(_cluster.default),this.workerNumber=t.length;for(let e=0;e<this.workerNumber;++e){var r=e+1,r=_ark_define.FILESINFO+"_"+r+_ark_define.EXTNAME_TXT;const s={inputs:JSON.stringify(t[e]),cmd:o.join(" "),workerFileName:r,mode:_ark_define.ESMODULE,cachePath:this.projectConfig.cachePath};this.triggerAsync(function(){var t=this;_newArrowCheck(this,i),_cluster.default.fork(s).on("message",function(e){_newArrowCheck(this,t),this.logger.error(_ark_define.red,e.data.toString(),_ark_define.reset),this.throwArkTsCompilerError("ArkTS:ERROR Failed to execute ts2abc.")}.bind(this))}.bind(this))}}}processTs2abcWorkersToGenAbc(){var o=this;this.generateNpmEntriesInfo();let r=0;(0,_utils.isMasterOrPrimary)()&&(_cluster.default.on("exit",function(e,t,i){_newArrowCheck(this,o),t===_ark_define.FAIL&&this.throwArkTsCompilerError("ArkTS:ERROR Failed to execute ts2abc"),++r===this.workerNumber&&(this.generateNpmEntryToGenProto(),this.generateProtoFilesInfo(),this.mergeProtoToAbc(),this.processAotIfNeeded(),this.afterCompilationProcess()),this.triggerEndSignal()}.bind(this)),0===this.workerNumber)&&this.processAotIfNeeded()}processAotIfNeeded(){var e,t=this;(0,_utils.needAotCompiler)(this.projectConfig)&&(e=function(e){_newArrowCheck(this,t),this.throwArkTsCompilerError(e)}.bind(this),(0,_gen_aot.generateAot)(this.arkConfig.arkRootPath,this.moduleAbcPath,this.projectConfig,this.logger,e))}genFileCachePath(e,t,i,o){e=(0,_utils2.toUnixPath)(e);let r="";return r=o?o.isLocalDependency?e.replace((0,_utils2.toUnixPath)(o.belongModulePath),o.moduleName):e.replace((0,_utils2.toUnixPath)(o.belongProjectPath),""):e.replace((0,_utils2.toUnixPath)(t),""),_path.default.join(i,r)}getPkgModulesFilePkgName(e){e=(0,_utils2.toUnixPath)(e);var t=this.projectConfig.packageDir,i=(0,_utils2.toUnixPath)(this.projectConfig.projectRootPath),o=(0,_utils2.toUnixPath)(_path.default.join(i,t));let r="";if(e.includes(o))r=_path.default.join(_ark_define.PACKAGES,e.replace(o,""));else for(const n in this.projectConfig.modulePathMap){var s=this.projectConfig.modulePathMap[n],s=(0,_utils2.toUnixPath)(_path.default.resolve(s,t));if(-1!==e.indexOf(s)){s=e.replace(i,"");r=_path.default.join(_ark_define.PACKAGES+"@"+n,s.substring(s.indexOf(t)+t.length+1));break}}return r.replace(new RegExp(t,"g"),_ark_define.PACKAGES)}generateProtoFilesInfo(){(0,_utils2.validateFilePathLength)(this.protoFilePath,this.logger),(0,_utils2.mkdirsSync)(_path.default.dirname(this.protoFilePath));let e="";for(const i of new Map([...this.moduleInfos].sort()).values()){var t=(0,_utils.changeFileExtension)(i.cacheFilePath,_ark_define.EXTNAME_PROTO_BIN);e+=(0,_utils2.toUnixPath)(t)+`
`}0<this.pkgEntryInfos.size&&(e+=(0,_utils2.toUnixPath)(this.npmEntriesProtoFilePath)+`
`),_fs.default.writeFileSync(this.protoFilePath,e,"utf-8")}mergeProtoToAbc(){(0,_utils2.mkdirsSync)(this.projectConfig.aceModuleBuild);var e=`"${this.arkConfig.mergeAbcPath}" --input "@${this.protoFilePath}" --outputFilePath "${this.projectConfig.aceModuleBuild}" --output ${_ark_define.MODULES_ABC} --suffix protoBin`;try{_child_process.default.execSync(e,{windowsHide:!0})}catch(e){this.throwArkTsCompilerError("ArkTS:INTERNAL ERROR: Failed to merge proto file to abc.\nError message:"+e.toString())}}afterCompilationProcess(){this.writeHashJson()}writeHashJson(){if(0!==this.hashJsonFilePath.length){for(const r of this.filterModuleInfos.values()){var e=r.cacheFilePath,t=(0,_utils.changeFileExtension)(e,_ark_define.EXTNAME_PROTO_BIN),i=(_fs.default.existsSync(e)&&_fs.default.existsSync(t)||this.throwArkTsCompilerError(`ArkTS:ERROR ${e} or  ${t} is lost`),(0,_utils2.toHashData)(e)),o=(0,_utils2.toHashData)(t);this.hashJsonObject[e]=i,this.hashJsonObject[t]=o}_fs.default.writeFileSync(this.hashJsonFilePath,JSON.stringify(this.hashJsonObject))}}generateNpmEntryToGenProto(){if(!(this.pkgEntryInfos.size<=0)){(0,_utils2.mkdirsSync)(_path.default.dirname(this.npmEntriesProtoFilePath));var e=`"${this.arkConfig.js2abcPath}" --compile-npm-entries "${this.npmEntriesInfoPath}" "${this.npmEntriesProtoFilePath}"`;try{_child_process.default.execSync(e,{windowsHide:!0})}catch(e){this.throwArkTsCompilerError("ArkTS:ERROR failed to generate npm proto file to abc. Error message: "+e.toString())}}}removeCompilationCache(){(0,_ark_utils.isEs2Abc)(this.projectConfig)?this.removeEs2abcCompilationCache():(0,_ark_utils.isTs2Abc)(this.projectConfig)?this.removeTs2abcCompilationCache():this.throwArkTsCompilerError(`Invalid projectConfig.pandaMode for module build, should be either
      "${_ark_define.TS2ABC}" or "${_ark_define.ES2ABC}"`)}removeEs2abcCompilationCache(){var t=this;_fs.default.existsSync(this.cacheFilePath)&&(_fs.default.readFileSync(this.cacheFilePath,"utf-8").split(/\r?\n/).forEach(function(e){_newArrowCheck(this,t);var[,e]=e.split(";");_fs.default.existsSync(e)&&_fs.default.unlinkSync(e)}.bind(this)),_fs.default.unlinkSync(this.cacheFilePath))}removeTs2abcCompilationCache(){var t=this;_fs.default.existsSync(this.hashJsonFilePath)&&_fs.default.unlinkSync(this.hashJsonFilePath),_fs.default.existsSync(this.protoFilePath)&&(_fs.default.readFileSync(this.protoFilePath,"utf-8").split(/\r?\n/).forEach(function(e){_newArrowCheck(this,t);_fs.default.existsSync(e)&&_fs.default.unlinkSync(e)}.bind(this)),_fs.default.unlinkSync(this.protoFilePath))}}exports.ModuleMode=ModuleMode;