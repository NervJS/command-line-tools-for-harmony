"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformForModule=transformForModule;var _path=_interopRequireDefault(require("path")),_ark_define=require("./common/ark_define"),_module_source_file=require("./module/module_source_file"),_utils=require("./utils"),_utils2=require("../../utils"),_ark_utils=require("../../ark_utils"),_process_lazy_import=require("../../process_lazy_import"),_generate_sourcemap=require("./generate_sourcemap");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function transformForModule(e,r){var o=(0,_ark_utils.getHookEventFactory)(this.share,"genAbc","transform"),o=(0,_ark_utils.createAndStartEvent)(o,"transform for module"),{autoLazyImport:t,reExportCheckMode:s}={autoLazyImport:this.share.projectConfig?.autoLazyImport??!1,reExportCheckMode:this.share.projectConfig?.reExportCheckMode??_process_lazy_import.reExportNoCheckMode};if(this.share.projectConfig.compileMode===_ark_define.ESMODULE){var i=this.getModuleInfo(r).meta,a=Object.assign(this.share.arkProjectConfig,this.share.projectConfig);if((0,_utils.isTsOrEtsSourceFile)(r)&&(0,_utils.shouldETSOrTSFileTransformToJS)(r,a,i)&&(preserveSourceMap(r,this.getCombinedSourcemap(),a,i,o),e=(0,_process_lazy_import.processJsCodeLazyImport)(r,e,t,s),_module_source_file.ModuleSourceFile.newSourceFile(r,e,i,a.singleFileEmit)),(0,_utils.isJsSourceFile)(r)||(0,_utils.isJsonSourceFile)(r)){let e=this.getModuleInfo(r).originalCode;(0,_utils.isJsSourceFile)(r)&&(e=(0,_process_lazy_import.processJsCodeLazyImport)(r,e,t,s),a.compatibleSdkVersion<=10?(t=transformJsByBabelPlugin(e,o),e=t.code,preserveSourceMap(r,t.map,a,i,o)):preserveSourceMap(r,this.getCombinedSourcemap(),a,i,o)),_module_source_file.ModuleSourceFile.newSourceFile(r,e,i,a.singleFileEmit)}}return(0,_ark_utils.stopEvent)(o),_process_lazy_import.reExportCheckLog&&_process_lazy_import.reExportCheckLog.errors.length&&s!==_process_lazy_import.reExportNoCheckMode&&!this.share.projectConfig.ignoreWarning&&((0,_utils2.emitLogInfo)(this.share.getLogger(_ark_define.GEN_ABC_PLUGIN_NAME),[...(0,_utils2.getTransformLog)(_process_lazy_import.reExportCheckLog)],!0,r),(0,_process_lazy_import.resetReExportCheckLog)()),e}function preserveSourceMap(e,r,o,t,s){(0,_utils.isCommonJsPluginVirtualFile)(e)||(s=(0,_ark_utils.createAndStartEvent)(s,"preserve source map for ts/ets files"),o=e.startsWith(o.projectRootPath)?(0,_utils2.toUnixPath)(e.replace(o.projectRootPath+_path.default.sep,"")):(0,_utils2.toUnixPath)(e.replace(t.belongProjectPath+_path.default.sep,"")),r.sources=[o],r.file=_path.default.basename(o),r.sourcesContent&&delete r.sourcesContent,o=(t=_generate_sourcemap.SourceMapGenerator.getInstance()).isNewSourceMaps()?e:o,t.fillSourceMapPackageInfo(e,r),t.updateSourceMap(o,r),(0,_ark_utils.stopEvent)(s))}function transformJsByBabelPlugin(e,r){r=(0,_ark_utils.createAndStartEvent)(r,"transform Js by babel plugin"),e=require("@babel/core").transformSync(e,{plugins:[[require("@babel/plugin-proposal-class-properties"),{loose:!0}]],compact:!1,sourceMaps:!0});return(0,_ark_utils.stopEvent)(r),e}