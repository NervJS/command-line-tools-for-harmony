"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkPermissionValue=checkPermissionValue,exports.checkSyscapAbility=checkSyscapAbility,exports.checkTypeReference=checkTypeReference,exports.configurePermission=configurePermission,exports.configureSyscapInfo=configureSyscapInfo,exports.getJsDocNodeCheckConfig=getJsDocNodeCheckConfig,exports.getJsDocNodeConditionCheckResult=getJsDocNodeConditionCheckResult,exports.getRealModulePath=getRealModulePath,exports.isCardFile=isCardFile,exports.moduleRequestCallback=moduleRequestCallback,exports.validateModuleSpecifier=validateModuleSpecifier;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_main=require("../../../main"),_utils=require("../../utils"),_api_check_define=require("./api_check_define"),_api_check_permission=require("./api_check_permission");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,i){if(e!==i)throw new TypeError("Cannot instantiate an arrow function")}function parseOhmBundle(e){var e=_fs.default.readFileSync(e,{encoding:"utf-8"}).match(/@bundle.+/g),i={bundlePath:"",bundleVersion:""};return e&&e.length>_api_check_define.CONSTANT_STEP_0&&(e=e[_api_check_define.CONSTANT_STEP_0].split(" ")).length===_api_check_define.CONSTANT_STEP_3&&(i.bundlePath=e[_api_check_define.CONSTANT_STEP_1],i.bundleVersion=e[_api_check_define.CONSTANT_STEP_2]),i}function checkBundleVersion(e){var i=_main.projectConfig.compatibleSdkVersion;let t=0;var n=e.match(/(?<=\().*(?=\))/g);return t=n&&1===n.length?Number(n[_api_check_define.CONSTANT_STEP_0]):Number(e),!(!e||""===e||isNaN(t)||isNaN(Number(i))||!(Number(i)>=t))}function getRealModulePath(i,t,n){var a={modulePath:"",isEts:!0};for(let e=0;e<i.length;e++){var s=i[e];for(let e=0;e<n.length;e++){var c=n[e],o=_path.default.resolve(s,t+c);if(_fs.default.existsSync(o)){a.modulePath=o,".d.ts"===c&&(a.isEts=!1);break}}}return a}function moduleRequestCallback(i,e,t,n){for(const s of _main.extendSdkConfigs.values())if("@arkui-x"!==s.prefix&&i.startsWith(s.prefix+".")){let e=s.prefix+":"+n;var a=getRealModulePath(s.apiPath,i,[".d.ts",".d.ets"]).modulePath;return e=_fs.default.existsSync(a)&&checkBundleVersion((a=parseOhmBundle(a)).bundleVersion)?"@bundle:"+a.bundlePath:e}return""}function checkTypeReference(i,t){var n=t.sourceFile.fileName,a=i.getText();if(/(?<!\.d)\.ts$/g.test(n)){n=_main.globalProgram.checker;if(n){var n=n.getTypeAtLocation(i);let e;n&&n.aliasSymbol&&n.aliasSymbol.declarations&&0<n.aliasSymbol.declarations.length?e=_typescript.default.getSourceFileOfNode(n.aliasSymbol.declarations[0]):n&&n.symbol&&n.symbol.declarations&&0<n.symbol.declarations.length&&(e=_typescript.default.getSourceFileOfNode(n.symbol.declarations[0])),e&&(n=_path.default.basename(e.fileName),isArkuiDependence(e.fileName)&&"common_ts_ets_api.d.ts"!==n&&"global.d.ts"!==n||_api_check_define.GLOBAL_DECLARE_WHITE_LIST.has(a)&&_main.ohosSystemModulePaths.includes(e.fileName.replace(/\//g,"\\")))&&t.errors.push({type:_utils.LogType.WARN,message:`Cannot find name '${a}'.`,pos:i.getStart()})}}}function getJsDocNodeCheckConfigItem(e,i,t,n,a,s,c,o){return{tagName:e,message:i,needConditionCheck:t,type:n,specifyCheckConditionFuncName:a,tagNameShouldExisted:s,checkValidCallback:c,checkJsDocSpecialValidCallback:o}}function isCardFile(e){for(const i in _main.projectConfig.cardEntryObj)if(_path.default.normalize(_main.projectConfig.cardEntryObj[i])===_path.default.normalize(e))return!0;return!1}const jsDocNodeCheckConfigCache=new Map;let permissionsArray=[];function getJsDocNodeCheckConfig(i,t){let n=jsDocNodeCheckConfigCache.get(i);void 0===n&&(n=new Map,jsDocNodeCheckConfigCache.set(i,n));var a=n.get(t);if(void 0===a){let e=!1;var s=[],c=_path.default.basename(i),o=_path.default.basename(t);/(?<!\.d)\.ts$/g.test(i)&&isArkuiDependence(t)&&"common_ts_ets_api.d.ts"!==o&&"global.d.ts"!==o&&s.push(getJsDocNodeCheckConfigItem([],_api_check_define.FIND_MODULE_WARNING,!1,_typescript.default.DiagnosticCategory.Warning,"",!0)),_main.systemModules.includes(c)||!_main.allModulesPaths.includes(_path.default.normalize(t))&&!isArkuiDependence(t)||(permissionsArray=_main.projectConfig.requestPermissions,s.push(getJsDocNodeCheckConfigItem([_api_check_define.DEPRECATED_TAG_CHECK_NAME],_api_check_define.DEPRECATED_TAG_CHECK_WARNING,!1,_typescript.default.DiagnosticCategory.Warning,"",!1)),s.push(getJsDocNodeCheckConfigItem([_api_check_define.SYSTEM_API_TAG_CHECK_NAME],_api_check_define.SYSTEM_API_TAG_CHECK_WARNING,!1,_typescript.default.DiagnosticCategory.Warning,"",!1)),s.push(getJsDocNodeCheckConfigItem([_api_check_define.SYSCAP_TAG_CHECK_NAME],_api_check_define.SYSCAP_TAG_CHECK_WARNING,!1,_typescript.default.DiagnosticCategory.Warning,_api_check_define.CANIUSE_FUNCTION_NAME,!1,void 0,checkSyscapAbility)),_main.projectConfig.projectRootPath&&(o=_typescript.default.sys.resolvePath(_path.default.join(_main.projectConfig.projectRootPath,"entry","src","ohosTest")),_typescript.default.sys.resolvePath(i).startsWith(o)||(permissionsArray=_main.projectConfig.requestPermissions,s.push(getJsDocNodeCheckConfigItem([_api_check_define.TEST_TAG_CHECK_NAME],_api_check_define.TEST_TAG_CHECK_ERROR,!1,_typescript.default.DiagnosticCategory.Warning,"",!1)))),s.push(getJsDocNodeCheckConfigItem([_api_check_define.PERMISSION_TAG_CHECK_NAME],_api_check_define.PERMISSION_TAG_CHECK_ERROR,!1,_typescript.default.DiagnosticCategory.Warning,"",!1,void 0,checkPermissionValue)),isCardFile(i)&&(e=!0,s.push(getJsDocNodeCheckConfigItem([_api_check_define.FORM_TAG_CHECK_NAME],_api_check_define.FORM_TAG_CHECK_ERROR,!1,_typescript.default.DiagnosticCategory.Error,"",!0))),_main.projectConfig.isCrossplatform&&(e=!0,s.push(getJsDocNodeCheckConfigItem([_api_check_define.CROSSPLATFORM_TAG_CHECK_NAME],_api_check_define.CROSSPLATFORM_TAG_CHECK_ERROER,!1,_typescript.default.DiagnosticCategory.Error,"",!0))),process.env.compileMode===_api_check_define.STAGE_COMPILE_MODE?(e=!0,s.push(getJsDocNodeCheckConfigItem([_api_check_define.FA_TAG_CHECK_NAME,_api_check_define.FA_TAG_HUMP_CHECK_NAME],_api_check_define.FA_TAG_CHECK_ERROR,!1,_typescript.default.DiagnosticCategory.Error,"",!1))):""!==process.env.compileMode&&(e=!0,s.push(getJsDocNodeCheckConfigItem([_api_check_define.STAGE_TAG_CHECK_NAME,_api_check_define.STAGE_TAG_HUMP_CHECK_NAME],_api_check_define.STAGE_TAG_CHECK_ERROR,!1,_typescript.default.DiagnosticCategory.Error,"",!1))),_main.projectConfig.bundleType===_api_check_define.ATOMICSERVICE_BUNDLE_TYPE&&_main.projectConfig.compileSdkVersion>=_api_check_define.ATOMICSERVICE_TAG_CHECK_VERSION&&(e=!0,s.push(getJsDocNodeCheckConfigItem([_api_check_define.ATOMICSERVICE_TAG_CHECK_NAME],_api_check_define.ATOMICSERVICE_TAG_CHECK_ERROER,!1,_typescript.default.DiagnosticCategory.Error,"",!0)))),a={nodeNeedCheck:e,checkConfig:s},n.set(t,a)}return a}const arkuiDependenceMap=new Map;function isArkuiDependence(e){var i,t,n,a=arkuiDependenceMap.get(e);return void 0===a&&(i=_path.default.dirname(e),t=_path.default.resolve(__dirname,"../../../declarations").replace(/\\/g,"/"),n=_path.default.resolve(__dirname,"../../../../../component").replace(/\\/g,"/"),a=i===t||i===n,arkuiDependenceMap.set(e,a)),a}function validateModuleSpecifier(e,i){var t=this;const n=e.getText().replace(/'|"/g,"");_main.ohosSystemModuleSubDirPaths.some(function(e){return _newArrowCheck(this,t),e===n}.bind(this))&&(e={type:_utils.LogType.WARN,message:`Cannot find module '${n}' or its corresponding type declarations.`,pos:e.getStart()},i.push(e))}function configureSyscapInfo(e){var i=this;e.deviceTypesMessage=e.deviceTypes.join(",");const t=_path.default.resolve(__dirname,"../../../../../api/device-define/"),n=new Map,a=[];let s=[];e.deviceTypes.forEach(function(e){_newArrowCheck(this,i),collectOhSyscapInfos(e,t,n)}.bind(this)),e.runtimeOS!==_api_check_define.RUNTIME_OS_OH&&collectExternalSyscapInfos(e.externalApiPaths,e.deviceTypes,n),n.forEach(function(e){_newArrowCheck(this,i),a.push(e),s=s.concat(e)}.bind(this));var c=function(e){return _newArrowCheck(this,i),e.reduce(function(i,e){var t=this;return Array.from(new Set(e.filter(function(e){return _newArrowCheck(this,t),i.includes(e)}.bind(this))))})}.bind(this);let o=[];1===e.deviceTypes.length||1===a.length?o=a[0]:1<a.length&&(o=c(a)),e.syscapIntersectionSet=new Set(o),e.syscapUnionSet=new Set(s)}function collectOhSyscapInfos(e,i,t){let n="";n="phone"===e?_path.default.resolve(i,"default.json"):_path.default.resolve(i,e+".json"),_fs.default.existsSync(n)&&(i=JSON.parse(_fs.default.readFileSync(n,"utf-8")),t.get(e)?t.set(e,t.get(e).concat(i.SysCaps)):t.set(e,i.SysCaps))}function collectExternalSyscapInfos(e,i,s){var t=this;const n=[];e.forEach(function(e){_newArrowCheck(this,t);e=_path.default.resolve(e,"./api/device-define");_fs.default.existsSync(e)&&n.push(e)}.bind(this)),n.forEach(function(a){var e=this;_newArrowCheck(this,t),i.forEach(function(i){var t=this;_newArrowCheck(this,e);let n;_fs.default.readdirSync(a).forEach(function(e){_newArrowCheck(this,t),e.startsWith(i)&&(n=_path.default.resolve(a,e),_fs.default.existsSync(n))&&(e=JSON.parse(_fs.default.readFileSync(n,"utf-8")),s.get(i)?s.set(i,s.get(i).concat(e.SysCaps)):s.set(i,e.SysCaps))}.bind(this))}.bind(this))}.bind(this))}function checkSyscapAbility(i,e){let t="";for(let e=0;e<i.length;e++){var n=i[e];if(n&&n.tagName.escapedText.toString()===_api_check_define.SYSCAP_TAG_CHECK_NAME){t=n.comment;break}}return _main.projectConfig.syscapIntersectionSet&&!_main.projectConfig.syscapIntersectionSet.has(t)}function configurePermission(e){var i=e.permission;e.requestPermissions=[],e.definePermissions=[],i.requestPermissions&&(e.requestPermissions=getNameFromArray(i.requestPermissions)),i.definePermissions&&(e.definePermissions=getNameFromArray(i.definePermissions))}function getNameFromArray(e){var i=this;return e.map(function(e){return _newArrowCheck(this,i),String(e.name)}.bind(this))}function checkPermissionValue(e,i){var t=this,e=e.find(function(e){return _newArrowCheck(this,t),e.tagName.getText()===_api_check_define.PERMISSION_TAG_CHECK_NAME}.bind(this));return!!e&&(e="string"==typeof e.comment?e.comment:_typescript.default.getTextOfJSDocComment(e.comment),i.message=i.message.replace("$DT",e),""!==e)&&!_api_check_permission.JsDocCheckService.validPermission(e,permissionsArray)}function getJsDocNodeConditionCheckResult(e,i){var t={valid:!0};let n="";for(let e=0;e<i.length;e++){var a=i[e];if(a.name===_api_check_define.SYSCAP_TAG_CHECK_NAME){n=a.text;break}}return _main.projectConfig.syscapIntersectionSet&&_main.projectConfig.syscapUnionSet&&(!_main.projectConfig.syscapIntersectionSet.has(n)&&_main.projectConfig.syscapUnionSet.has(n)?(t.valid=!1,t.type=_typescript.default.DiagnosticCategory.Warning,t.message=_api_check_define.SYSCAP_TAG_CONDITION_CHECK_WARNING):_main.projectConfig.syscapUnionSet.has(n)||(t.valid=!1,t.type=_typescript.default.DiagnosticCategory.Warning,t.message=_api_check_define.SYSCAP_TAG_CHECK_WARNING.replace("$DT",_main.projectConfig.deviceTypesMessage))),t}