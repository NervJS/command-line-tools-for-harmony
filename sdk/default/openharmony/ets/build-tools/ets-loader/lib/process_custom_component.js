"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.assignComponentParams=assignComponentParams,exports.assignmentFunction=assignmentFunction,exports.createConditionParent=createConditionParent,exports.isRecycle=isRecycle,exports.processCustomComponent=processCustomComponent;var _typescript=_interopRequireDefault(require("typescript")),_pre_define=require("./pre_define"),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_member=require("./process_component_member"),_utils=require("./utils"),_process_component_build=require("./process_component_build"),_main=require("../main"),_component_map=require("./component_map"),_process_component_class=require("./process_component_class"),_process_struct_componentV=_interopRequireWildcard(require("./process_struct_componentV2")),_constant_define=_interopRequireDefault(require("./constant_define")),_create_ast_node_utils=_interopRequireDefault(require("./create_ast_node_utils"));function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,i,a={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((i=n?Object.getOwnPropertyDescriptor(e,r):null)&&(i.get||i.set)?Object.defineProperty(a,r,i):a[r]=e[r]);return a.default=e,t&&t.set(e,a),a}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}let decoractorMap;function processCustomComponent(n,o,s,c,p=!1,l=!1,_=void 0,d=null){var f=this,u=(decoractorMap=new Map([[_pre_define.COMPONENT_STATE_DECORATOR,_validate_ui_syntax.stateCollection],[_pre_define.COMPONENT_LINK_DECORATOR,_validate_ui_syntax.linkCollection],[_pre_define.COMPONENT_PROP_DECORATOR,_validate_ui_syntax.propCollection],[_pre_define.COMPONENT_NON_DECORATOR,_validate_ui_syntax.regularCollection],[_pre_define.COMPONENT_PROVIDE_DECORATOR,_validate_ui_syntax.provideCollection],[_pre_define.COMPONENT_OBJECT_LINK_DECORATOR,_validate_ui_syntax.objectLinkCollection]]),getCustomComponentNode(n));if(u){var y=isRecycle(c),m=u.parent&&_typescript.default.isPropertyAccessExpression(u.parent);let r=!1,e=(0,_process_component_member.createCustomComponentNewExpression)(u,c,p,l),i;var C,E,O={reuseId:null,hasIdAttr:!1,attrCount:0};isHasChild(u)&&((i=u.arguments[0].properties.slice()).forEach(function(e,t){_newArrowCheck(this,f),isToChange(e,c)&&(r=!0,e=_typescript.default.factory.updatePropertyAssignment(e,e.name,changeNodeFromCallToArrow(e.initializer)),i.splice(t,1,e))}.bind(this)),r)&&(C=_typescript.default.factory.updateExpressionStatement(n,_typescript.default.factory.createNewExpression(u.expression,u.typeArguments,[_typescript.default.factory.createObjectLiteralExpression(i,!0)])),e=(0,_process_component_member.createCustomComponentNewExpression)(C.expression,c,p));let t,a=(_main.partialUpdateConfig.partialUpdateMode&&_&&(t=o.length),!1);m&&(_main.partialUpdateConfig.partialUpdateMode?(C=[_typescript.default.factory.createExpressionStatement((0,_process_component_build.createFunction)(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_COMMON),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_FUNCTION),null))],E=[],(0,_process_component_build.bindComponentAttr)(n,_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_COMMON),C,s,!0,!1,E,!1,O),a=1<C.length||0<E.length,O.hasIdAttr&&1===O.attrCount&&(C[0]=createCommonIdAttrNode()),a&&o.push((0,_process_component_build.createComponentCreationStatement)(componentAttributes(_pre_define.COMPONENT_COMMON),C,_pre_define.COMPONENT_COMMON,l,!1,void 0,E,d,y))):(o.push(_typescript.default.factory.createExpressionStatement((0,_process_component_build.createFunction)(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_COMMON),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_FUNCTION),null))),(0,_process_component_build.bindComponentAttr)(n,_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_COMMON),o,s))),y&&_main.partialUpdateConfig.partialUpdateMode&&o.push(createRecycleComponent(l)),addCustomComponent(n,o,e,s,c,u,p,l,y,O,d),!m||_main.partialUpdateConfig.partialUpdateMode&&!a||o.push(_typescript.default.factory.createExpressionStatement((0,_process_component_build.createFunction)(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_COMMON),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_POP_FUNCTION),null))),y&&_main.partialUpdateConfig.partialUpdateMode&&o.push(componentAttributes(_pre_define.COMPONENT_RECYCLE)),_main.partialUpdateConfig.partialUpdateMode&&_&&o.splice(t,o.length-t,(0,_process_component_build.ifRetakeId)(o.slice(t),_))}}function createCommonIdAttrNode(){return _typescript.default.factory.createExpressionStatement((0,_process_component_build.createFunction)(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_COMMON),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_FUNCTION),[_typescript.default.factory.createTrue()]))}function isRecycle(e){return _utils.storedFileInfo.getCurrentArkTsFile().recycleComponents.has(e)}function createRecycleComponent(e){return(0,_process_component_build.createComponentCreationStatement)(componentAttributes(_pre_define.COMPONENT_RECYCLE),[_typescript.default.factory.createExpressionStatement((0,_process_component_build.createFunction)(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_RECYCLE),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_FUNCTION),null))],_pre_define.COMPONENT_RECYCLE,e)}function componentAttributes(e){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_POP_FUNCTION)),void 0,[]))}function isHasChild(e){return e.arguments&&e.arguments[0]&&_typescript.default.isObjectLiteralExpression(e.arguments[0])&&e.arguments[0].properties&&0<e.arguments[0].properties.length}function isToChange(e,t){t=_validate_ui_syntax.builderParamObjectCollection.get(t);return!(!(e.initializer&&_typescript.default.isCallExpression(e.initializer)&&t&&t.has(e.name.getText()))||/\.(bind|call|apply)/.test(e.initializer.getText()))}function changeNodeFromCallToArrow(e){let t=_typescript.default.factory.createExpressionStatement(e);return _typescript.default.isCallExpression(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)&&_component_map.GLOBAL_CUSTOM_BUILDER_METHOD.has(e.expression.escapedText.toString())&&(t=(0,_process_component_build.transferBuilderCall)(_typescript.default.factory.createExpressionStatement(e),e.expression.escapedText.toString())),changeNodeFromCallToArrowDetermine(e,t)}function changeNodeFromCallToArrowDetermine(e,t){if(_typescript.default.isCallExpression(e))return _typescript.default.factory.createConditionalExpression(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createTypeOfExpression(e),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsEqualsToken),_typescript.default.factory.createStringLiteral(_pre_define.FUNCTION)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),e,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ColonToken),_typescript.default.factory.createArrowFunction(void 0,void 0,[],void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock([t],!0)))}function addCustomComponent(e,t,r,i,a,n,o,s,c,p,l){var _;_typescript.default.isNewExpression(r)&&(validateCustomComponentPrams(n,a,_=[],i,o),addCustomComponentStatements(e,t,r,a,_,n,o,s,c,p,l,i))}function addCustomComponentStatements(e,t,r,i,a,n,o,s,c,p,l,_){_main.partialUpdateConfig.partialUpdateMode?t.push(createCustomComponent(r,i,n,s,o,c,p,l,_)):(n=_utils.componentInfo.id.toString(),t.push(createFindChildById(n,i,o),createCustomComponentIfStatement(n,_typescript.default.factory.updateExpressionStatement(e,(0,_process_component_member.createViewCreate)(r)),_typescript.default.factory.createObjectLiteralExpression(a,!0),i)))}function createChildElmtId(e,t,r){var i=[],a=[];return _validate_ui_syntax.propCollection.get(t)&&a.push(..._validate_ui_syntax.propCollection.get(t)),_validate_ui_syntax.objectLinkCollection.get(t)&&a.push(..._validate_ui_syntax.objectLinkCollection.get(t)),_main.projectConfig.optLazyForEach&&_utils.storedFileInfo.processLazyForEach&&_validate_ui_syntax.stateCollection.get(t)&&a.push(..._validate_ui_syntax.stateCollection.get(t)),parseChildProperties(t,e,i,a,r),i}class ChildAndParentComponentInfo{constructor(e,t,r){_defineProperty(this,"childStructInfo",void 0),_defineProperty(this,"parentStructInfo",void 0),_defineProperty(this,"paramDecoratorMap",void 0),_defineProperty(this,"updatePropsDecoratorsV2",void 0),_defineProperty(this,"propsAndObjectLinks",void 0),_defineProperty(this,"childName",void 0),_defineProperty(this,"forbiddenInitPropsV2",void 0),_defineProperty(this,"updatePropsForV1Parent",void 0),_defineProperty(this,"updatePropsForV2Parent",void 0),this.childName=e,this.propsAndObjectLinks=r,this.childStructInfo=_process_struct_componentV.default.getAliasStructInfo(t)||_process_struct_componentV.default.getOrCreateStructInfo(e),this.paramDecoratorMap=this.childStructInfo.paramDecoratorMap,this.updatePropsDecoratorsV2=[...this.childStructInfo.eventDecoratorSet,...this.paramDecoratorMap.keys()],this.parentStructInfo=_validate_ui_syntax.componentCollection.currentClassName?_process_struct_componentV.default.getOrCreateStructInfo(_validate_ui_syntax.componentCollection.currentClassName):new _process_struct_componentV.StructInfo,this.forbiddenInitPropsV2=[...this.childStructInfo.localDecoratorSet,...this.childStructInfo.providerDecoratorSet,...this.childStructInfo.consumerDecoratorSet,...this.childStructInfo.regularSet],this.updatePropsForV1Parent=getUpdatePropsForV1Parent(),this.updatePropsForV2Parent=[...this.parentStructInfo.localDecoratorSet,...this.parentStructInfo.paramDecoratorMap.keys(),...this.parentStructInfo.providerDecoratorSet,...this.parentStructInfo.consumerDecoratorSet]}}function getUpdatePropsForV1Parent(){var e,t=this,r=[_validate_ui_syntax.stateCollection,_validate_ui_syntax.linkCollection,_validate_ui_syntax.propCollection,_validate_ui_syntax.provideCollection,_validate_ui_syntax.consumeCollection,_validate_ui_syntax.objectLinkCollection,_validate_ui_syntax.storagePropCollection,_validate_ui_syntax.storageLinkCollection];const i=[];return _validate_ui_syntax.componentCollection.currentClassName&&(e=new Set,(0,_validate_ui_syntax.getLocalStorageCollection)(_validate_ui_syntax.componentCollection.currentClassName,e),i.push(...e),r.forEach(function(e){_newArrowCheck(this,t);e=e.get(_validate_ui_syntax.componentCollection.currentClassName);e&&i.push(...e)}.bind(this))),i}function parseChildProperties(e,t,r,i,a){var n=this;const o=new ChildAndParentComponentInfo(e,t,i);t.arguments[0].properties&&t.arguments[0].properties.forEach(function(e){var t;_newArrowCheck(this,n),_typescript.default.isIdentifier(e.name)&&(t=e.name.escapedText.toString(),validateChildProperty(e,t,r,a,o))}.bind(this))}function validateChildProperty(e,t,r,i,a){a.childStructInfo.isComponentV2?a.forbiddenInitPropsV2.includes(t)?i.push({type:_utils.LogType.ERROR,message:`Property '${t}' in the custom component '${a.childName}'`+" cannot be initialized here (forbidden to specify).",pos:e.getStart()}):(a.paramDecoratorMap.has(t)&&r.push(e),isForbiddenAssignToComponentV2(e,t,a)&&i.push({type:_utils.LogType.ERROR,message:`Property '${t}' in the @ComponentV2 component '${a.childName}' are not allowed to be assigned values here.`,pos:e.getStart()})):(a.propsAndObjectLinks.includes(t)&&r.push(e),isForbiddenAssignToComponentV1(e,t,a)&&i.push({type:_utils.LogType.ERROR,message:`Property '${t}' in the @Component component '${a.childName}' are not allowed to be assigned values here.`,pos:e.getStart()}))}function isForbiddenAssignToComponentV1(e,t,r){return!!(r.parentStructInfo.isComponentV2&&r.childStructInfo.updatePropsDecoratorsV1.includes(t)&&isObervedProperty(e.initializer,r,!1)&&_main.globalProgram.checker)&&isForbiddenTypeToComponentV1(_main.globalProgram.checker.getTypeAtLocation(e.initializer))}function isForbiddenTypeToComponentV1(e){var t=this;return e.types&&e.types.length?!e.types.some(function(e){return _newArrowCheck(this,t),!isForbiddenTypeToComponentV1(e)}.bind(this)):!(!(e=e?.getSymbol()?.getName())||!["Set","Map","Date","Array"].includes(e))}function isForbiddenAssignToComponentV2(e,t,r){return!(r.parentStructInfo.isComponentV2||!r.updatePropsDecoratorsV2.includes(t)||!isObervedProperty(e.initializer,r)||!_main.globalProgram.strictChecker||isAllowedTypeToComponentV2(_main.globalProgram.strictChecker.getTypeAtLocation(e.initializer)))}function isObervedProperty(e,t,r=!0){return!!(e&&_typescript.default.isPropertyAccessExpression(e)&&e.expression.kind===_typescript.default.SyntaxKind.ThisKeyword&&_typescript.default.isIdentifier(e.name))&&(e=e.name.escapedText.toString(),(r?t.updatePropsForV1Parent:t.updatePropsForV2Parent).includes(e))}function isAllowedTypeToComponentV2(e){var t=this;if(e){if(e.types&&e.types.length)return e.types.some(function(e){return _newArrowCheck(this,t),isAllowedTypeToComponentV2(e)}.bind(this));if(isAllowedTypeForBasic(e.flags))return!0}return!1}function isAllowedTypeForBasic(e){return!!((0,_process_component_member.isBasicType)(e)||e&(_typescript.default.TypeFlags.Null|_typescript.default.TypeFlags.Undefined))}function validateInitParam(e,t,r,i,a){var n=this,e=_process_struct_componentV.default.getAliasStructInfo(r)||_process_struct_componentV.default.getOrCreateStructInfo(e),o=e.paramDecoratorMap;if(e.isComponentV2){var s=[];for(const c of o)c[1].hasRequire&&s.push(c[0]);s.forEach(function(e){_newArrowCheck(this,n),t.has(e)||i.push({type:_utils.LogType.ERROR,message:`Property '${e}' must be initialized through the component constructor.`,pos:r.getStart()})}.bind(this))}else a.isComponentV2&&e.linkDecoratorsV1.length&&i.push({type:_utils.LogType.ERROR,message:"The @ComponentV2 struct must not contain any @Component with an @Link decorated variable",pos:r.getStart()})}function createCustomComponent(e,t,r,i,a,n,o,s,c){let p;p=r.arguments&&r.arguments.length?_typescript.default.factory.createObjectLiteralExpression(createChildElmtId(r,t,c),!0):_typescript.default.factory.createObjectLiteralExpression([],!1);var l=[_typescript.default.factory.createParameterDeclaration(void 0,void 0,_typescript.default.factory.createIdentifier(_pre_define.ELMTID)),_typescript.default.factory.createParameterDeclaration(void 0,void 0,_typescript.default.factory.createIdentifier(_pre_define.ISINITIALRENDER))],e=[_main.projectConfig.optLazyForEach&&_utils.storedFileInfo.processLazyForEach?(0,_process_component_build.createCollectElmtIdNode)():void 0,createIfCustomComponent(e,r,p,t,i,a,n,o,c)],a=(n?l.push(_typescript.default.factory.createParameterDeclaration(void 0,void 0,_typescript.default.factory.createIdentifier(_pre_define.RECYCLE_NODE),void 0,void 0,_typescript.default.factory.createNull())):_main.partialUpdateConfig.optimizeComponent&&i&&s&&s.firstParam&&(r=s.firstParam.name,l.push(_typescript.default.factory.createParameterDeclaration(void 0,void 0,r,void 0,void 0,_typescript.default.factory.createIdentifier(`__${r.escapedText.toString()}__`)))),!n&&_main.partialUpdateConfig.optimizeComponent||(e.unshift((0,_process_component_build.createViewStackProcessorStatement)(_pre_define.STARTGETACCESSRECORDINGFOR,_pre_define.ELMTID)),e.push((0,_process_component_build.createViewStackProcessorStatement)(_pre_define.STOPGETACCESSRECORDING))),[_typescript.default.factory.createArrowFunction(void 0,void 0,l,void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock(e,!0))]);return n?o.reuseId?a.unshift(o.reuseId):a.unshift(_typescript.default.factory.createStringLiteral(t)):_main.partialUpdateConfig.optimizeComponent&&a.push(componentPop(t)),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(i?_typescript.default.factory.createParenthesizedExpression((0,_process_component_build.parentConditionalExpression)()):_typescript.default.factory.createThis(),n?_typescript.default.factory.createIdentifier(_pre_define.OBSERVE_RECYCLE_COMPONENT_CREATION):_typescript.default.factory.createIdentifier(_main.partialUpdateConfig.optimizeComponent?_pre_define.OBSERVECOMPONENTCREATION2:_pre_define.OBSERVECOMPONENTCREATION)),void 0,a))],!0)}function componentPop(e){return _typescript.default.factory.createObjectLiteralExpression([_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier(_pre_define.NAME),_typescript.default.factory.createStringLiteral(e))],!1)}function assignComponentParams(e,t=!1){var[t,r]=splitComponentParams(e,t,!0);let i=!1;return!t.length&&e.arguments&&0<e.arguments.length&&e.arguments[0]&&(i=!0),_typescript.default.factory.createVariableStatement(void 0,_typescript.default.factory.createVariableDeclarationList([_typescript.default.factory.createVariableDeclaration(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_PARAMS_LAMBDA_FUNCTION),void 0,void 0,_typescript.default.factory.createArrowFunction(void 0,void 0,[],void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock([_typescript.default.factory.createReturnStatement(i?paramsLambdaCallBack(e):_typescript.default.factory.createObjectLiteralExpression(reWriteComponentParams(t,r),!0))],!0)))],_typescript.default.NodeFlags.Let))}function paramsLambdaCallBack(e){return _main.partialUpdateConfig.partialUpdateMode&&1===e.arguments.length&&(0,_process_component_member.isLocalStorageParameter)(e)?_typescript.default.factory.createObjectLiteralExpression([],!0):e.arguments[0]}function reWriteComponentParams(e,r){var i=this;const a=[];return e.forEach(function(e,t){_newArrowCheck(this,i),r[t]?a.push(_typescript.default.factory.createPropertyAssignment(e,r[t])):a.push(_typescript.default.factory.createShorthandPropertyAssignment(e,void 0))}.bind(this)),a}function splitComponentParams(e,t,r){var i=this;const a=[],n=[];return e.arguments&&0<e.arguments.length&&_typescript.default.isObjectLiteralExpression(e.arguments[0])&&e.arguments[0].properties&&e.arguments[0].properties.forEach(function(e){_newArrowCheck(this,i);e=(0,_process_component_class.isProperty)(e)?(0,_process_component_class.createReference)(e,[],t,r):e;a.push(e.name),n.push(e.initializer)}.bind(this)),[a,n]}function createIfCustomComponent(e,t,r,i,a,n,o,s,c){return _typescript.default.factory.createIfStatement(_typescript.default.factory.createIdentifier(_pre_define.ISINITIALRENDER),_typescript.default.factory.createBlock([componentParamDetachment(e,o,i,c,t),o?createNewRecycleComponent(e,t,i,s):createNewComponent(_pre_define.COMPONENT_CALL,i,t),assignComponentParams(t,n),assignmentFunction(_pre_define.COMPONENT_CALL)],!0),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(a?_typescript.default.factory.createParenthesizedExpression((0,_process_component_build.parentConditionalExpression)()):_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(_pre_define.UPDATE_STATE_VARS_OF_CHIND_BY_ELMTID)),void 0,[_typescript.default.factory.createIdentifier(_pre_define.ELMTID),r]))],!0))}function assignmentFunction(e){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_PARAMS_FUNCTION)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_PARAMS_LAMBDA_FUNCTION)))}function traverseChildComponentArgs(e,t,r,i){var a=this;const n=_process_struct_componentV.default.getAliasStructInfo(i)||_process_struct_componentV.default.getOrCreateStructInfo(t);if(n.isComponentV2)if(2<e.length&&_typescript.default.isObjectLiteralExpression(e[1])&&e[1].properties){const o=[];if(e[1].properties.forEach(function(e){var t;_newArrowCheck(this,a),e.name&&_typescript.default.isIdentifier(e.name)&&(t=e.name.escapedText.toString(),updatePropertyAssignment(o,t,e,n,r))}.bind(this)),o.length)return getNewArgsForCustomComponent(e,o)}return e}function getNewArgsForCustomComponent(e,t){var r=this;const i=[],a=_typescript.default.factory.updateObjectLiteralExpression(e[1],[...e[1].properties,...t]);return e.forEach(function(e,t){_newArrowCheck(this,r),1===t?i.push(a):i.push(e)}.bind(this)),i}function updatePropertyAssignment(e,t,r,i,a){if(isDoubleNonNullExpression(r.initializer)){var n;if(isLeftHandExpression(r.initializer.expression.expression))return traverseExpressionNode(r.initializer.expression.expression,n={hasQuestionToken:!1}),n.hasQuestionToken?void a.push({type:_utils.LogType.ERROR,message:`The optional character can not be used in the initial value of property '${t}'.`,pos:r.getStart()}):i.paramDecoratorMap.has(t)&&i.eventDecoratorSet.has("$"+t)?void e.push(createUpdateTwoWayNode(t,r.initializer.expression.expression)):void a.push({type:_utils.LogType.ERROR,message:"When the two-way binding syntax is used, "+`the variable '${t}' must be decorated with @Param, `+"and the @Event variable '$"+t+"' "+`must be defined in the ${i.structName}.`,pos:r.getStart()});a.push({type:_utils.LogType.ERROR,message:"When the two-way binding syntax is used, "+`the initial value of property '${t}' must be a variable.`,pos:r.getStart()})}}function createUpdateTwoWayNode(e,t){return _typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier("$"+e),_typescript.default.factory.createArrowFunction(void 0,void 0,[_create_ast_node_utils.default.createParameterDeclaration("value")],void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(t,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createIdentifier("value")))],!1)))}function isDoubleNonNullExpression(e){return e&&_typescript.default.isNonNullExpression(e)&&_typescript.default.isNonNullExpression(e.expression)}function isLeftHandExpression(e){return e&&(_typescript.default.isIdentifier(e)||_typescript.default.isPropertyAccessExpression(e))}function traverseExpressionNode(e,t){var r=this;_typescript.default.isOptionalChain(e)&&!_typescript.default.isNonNullExpression(e)&&e.questionDotToken&&(t.hasQuestionToken=!0),t.hasQuestionToken||_typescript.default.forEachChild(e,function(e){return _newArrowCheck(this,r),traverseExpressionNode(e,t)}.bind(this))}function componentParamDetachment(e,t,r,i,a){var n=e.arguments.length?e.arguments:[],n=_typescript.default.factory.updateNewExpression(e,e.expression,e.typeArguments,traverseChildComponentArgs(n,r,i,a));return _typescript.default.factory.createVariableStatement(void 0,_typescript.default.factory.createVariableDeclarationList([_typescript.default.factory.createVariableDeclaration(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CALL),void 0,void 0,t?_typescript.default.factory.createConditionalExpression(_typescript.default.factory.createIdentifier(_pre_define.RECYCLE_NODE),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),_typescript.default.factory.createIdentifier(_pre_define.RECYCLE_NODE),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ColonToken),e):n)],_typescript.default.NodeFlags.Let))}function createNewComponent(e,t,r){r=_process_struct_componentV.default.getAliasStructInfo(r)||_process_struct_componentV.default.getOrCreateStructInfo(t);return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(r.isComponentV2?_constant_define.default.STRUCT_PARENT:_pre_define.BASE_COMPONENT_NAME_PU),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_FUNCTION)),void 0,[_typescript.default.factory.createIdentifier(e)]))}function createNewRecycleComponent(e,t,r,i){var a=this;let n=[];const o=[];n=t.arguments&&0<t.arguments.length&&_typescript.default.isObjectLiteralExpression(t.arguments[0])&&t.arguments[0].properties?(t.arguments[0].properties.forEach(function(e){_newArrowCheck(this,a);e=(0,_process_component_class.isProperty)(e)?(0,_process_component_class.createReference)(e,[],!1,!1,!0):e;o.push(e)}.bind(this)),[_typescript.default.factory.createObjectLiteralExpression(o,!1)]):[_typescript.default.factory.createObjectLiteralExpression([],!1)];t=_typescript.default.factory.createCallExpression(createRecyclePropertyNode(_pre_define.ABOUT_TO_REUSE),void 0,n);return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.BASE_COMPONENT_NAME_PU),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_RECYCLE)),void 0,[_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CALL),_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createIdentifier(_pre_define.RECYCLE_NODE),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ExclamationEqualsEqualsToken),_typescript.default.factory.createNull()),i.reuseId||_typescript.default.factory.createStringLiteral(r),_typescript.default.factory.createArrowFunction(void 0,void 0,[],void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock([_typescript.default.factory.createIfStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createIdentifier(_pre_define.RECYCLE_NODE),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.AmpersandAmpersandToken),_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createTypeOfExpression(createRecyclePropertyNode(_pre_define.COMPONENT_ABOUTTOREUSEINTERNAL_FUNCTION)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsEqualsToken),_typescript.default.factory.createStringLiteral(_pre_define.FUNCTION))),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(createRecyclePropertyNode(_pre_define.COMPONENT_ABOUTTOREUSEINTERNAL_FUNCTION),void 0,[]))],!0),_typescript.default.factory.createBlock([_typescript.default.factory.createIfStatement(_typescript.default.factory.createBinaryExpression(createRecyclePropertyNode(_pre_define.ABOUT_TO_REUSE),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.AmpersandAmpersandToken),_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createTypeOfExpression(createRecyclePropertyNode(_pre_define.ABOUT_TO_REUSE)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsEqualsToken),_typescript.default.factory.createStringLiteral(_pre_define.FUNCTION))),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(t)],!0)),_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(createRecyclePropertyNode(_pre_define.COMPONENT_RERENDER_FUNCTION),void 0,[]))],!0))],!0))]))}function createRecyclePropertyNode(e){return _typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.RECYCLE_NODE),_typescript.default.factory.createIdentifier(e))}function validateCustomComponentPrams(e,t,r,i,a){var n=this;const o=new Set([]);var s=e.arguments;const c=getCollectionSet(t,_validate_ui_syntax.linkCollection);s&&1<=s.length&&_typescript.default.isObjectLiteralExpression(s[0])&&s[0].properties.forEach(function(e){_newArrowCheck(this,n),e.name&&_typescript.default.isIdentifier(e.name)&&o.add(e.name.escapedText.toString()),validateStateManagement(e,t,i,a),isNonThisProperty(e,c)&&(isToChange(e,t)&&(e=_typescript.default.factory.updatePropertyAssignment(e,e.name,changeNodeFromCallToArrow(e.initializer))),r.push(e))}.bind(this));s=_validate_ui_syntax.componentCollection.currentClassName?_process_struct_componentV.default.getOrCreateStructInfo(_validate_ui_syntax.componentCollection.currentClassName):new _process_struct_componentV.StructInfo;validateInitDecorator(e,t,o,i),validateMandatoryToInitViaParam(e,t,o,i,s),validateInitParam(t,o,e,i,s)}function getCustomComponentNode(e){let t=e.expression,r=null,i=null;for(;t;){if(_typescript.default.isIdentifier(t)){r=t;break}t=t.expression}if(r){let e=r.parent;for(;e&&!_typescript.default.isExpressionStatement(e);){if(_typescript.default.isCallExpression(e)||_typescript.default.isEtsComponentExpression(e)){i=e;break}e=e.parent}}return i}function getCollectionSet(e,t){return t&&t.get(e)||new Set([])}function isThisProperty(e,t){return!!(_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(e.name)&&t.has(e.name.escapedText.toString()))}function isNonThisProperty(e,t){return!(_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(e.name)&&(e.initializer.escapedText&&e.initializer.escapedText.includes("$")||_typescript.default.isPropertyAccessExpression(e.initializer)&&e.initializer.expression&&e.initializer.expression.kind===_typescript.default.SyntaxKind.ThisKeyword&&_typescript.default.isIdentifier(e.initializer.name)&&e.initializer.name.escapedText.toString().includes("$"))||!_typescript.default.isPropertyAssignment(e)||!_typescript.default.isIdentifier(e.name)||t.has(e.name.escapedText.toString()))}function validateStateManagement(e,t,r,i){if((validateForbiddenToInitViaParam(e,t,r),_validate_ui_syntax.componentCollection.currentClassName)&&_process_struct_componentV.default.getOrCreateStructInfo(_validate_ui_syntax.componentCollection.currentClassName).isComponentV2)return;checkFromParentToChild(e,t,r,i)}function checkFromParentToChild(e,t,r,i){let a;var n,t=getPropertyDecoratorKind(a=_typescript.default.isIdentifier(e.name)?e.name.escapedText.toString():a,t);let o;t&&(isInitFromParent(e)?(o=getParentPropertyName(e,t,r),(n=_process_component_member.PropMapManager.find(o))&&!isCorrectInitFormParent(n,t)&&validateIllegalInitFromParent(e,a,t,o,n,r)):isInitFromLocal(e)&&_typescript.default.isPropertyAssignment(e)&&t!==_pre_define.COMPONENT_OBJECT_LINK_DECORATOR?isCorrectInitFormParent(_pre_define.COMPONENT_NON_DECORATOR,t)||validateIllegalInitFromParent(e,a,t,e.initializer.getText(),_pre_define.COMPONENT_NON_DECORATOR,r):t===_pre_define.COMPONENT_OBJECT_LINK_DECORATOR&&e.initializer&&(_typescript.default.isPropertyAccessExpression(e.initializer)||_typescript.default.isElementAccessExpression(e.initializer)||_typescript.default.isIdentifier(e.initializer))||(o=getParentPropertyName(e,t,r)||a,isCorrectInitFormParent(n=_pre_define.COMPONENT_NON_DECORATOR,t))||(i&&judgeStructAssignedDollar(e)?r.push({type:_utils.LogType.WARN,message:`Unrecognized property '${o}', make sure it can be assigned to `+`${t} property '${a}' by yourself.`,pos:(e.initializer||e).getStart()}):validateIllegalInitFromParent(e,a,t,o,n,r,_utils.LogType.WARN)))}function judgeStructAssignedDollar(e){return _main.partialUpdateConfig.partialUpdateMode&&e.initializer&&_typescript.default.isPropertyAccessExpression(e.initializer)&&e.initializer.expression&&_typescript.default.isIdentifier(e.initializer.expression)&&e.initializer.expression.escapedText.toString()===_pre_define.$$}function isInitFromParent(e){if(_typescript.default.isPropertyAssignment(e)&&e.initializer){if(_typescript.default.isPropertyAccessExpression(e.initializer)&&e.initializer.expression&&e.initializer.expression.kind===_typescript.default.SyntaxKind.ThisKeyword&&_typescript.default.isIdentifier(e.initializer.name))return!0;if(_typescript.default.isIdentifier(e.initializer)&&matchStartWithDollar(e.initializer.getText()))return!0}return!1}function isInitFromLocal(e){return!(!_typescript.default.isPropertyAssignment(e)||!_typescript.default.isIdentifier(e.initializer)||matchStartWithDollar(e.initializer.getText()))}function getParentPropertyName(t,r,i){var a=t.initializer;if(a){let e=a.getText();var n=_main.globalProgram.checker?.getSymbolAtLocation(a);return r===_pre_define.COMPONENT_LINK_DECORATOR?(r=a.name||a,e=!n&&hasDollar(a)?r.getText().replace(/^\$/,""):r.getText()):(!n&&hasDollar(a)&&validateNonLinkWithDollar(t,i),t.initializer&&t.initializer.name&&(e=t.initializer.name.getText())),e}}function isCorrectInitFormParent(e,t){switch(t){case _pre_define.COMPONENT_STATE_DECORATOR:case _pre_define.COMPONENT_PROP_DECORATOR:case _pre_define.COMPONENT_PROVIDE_DECORATOR:return!0;case _pre_define.COMPONENT_NON_DECORATOR:if([_pre_define.COMPONENT_NON_DECORATOR,_pre_define.COMPONENT_STATE_DECORATOR,_pre_define.COMPONENT_LINK_DECORATOR,_pre_define.COMPONENT_PROP_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR,_pre_define.COMPONENT_STORAGE_LINK_DECORATOR].includes(e))return!0;break;case _pre_define.COMPONENT_LINK_DECORATOR:case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:return![_pre_define.COMPONENT_NON_DECORATOR].includes(e)}return!1}function getPropertyDecoratorKind(e,t){for(const r of decoractorMap.entries())if(getCollectionSet(t,r[1]).has(e))return r[0]}function createFindChildById(e,t,r=!1){return _typescript.default.factory.createVariableStatement(void 0,_typescript.default.factory.createVariableDeclarationList([_typescript.default.factory.createVariableDeclaration(_typescript.default.factory.createIdentifier(""+_pre_define.CUSTOM_COMPONENT_EARLIER_CREATE_CHILD+e),void 0,_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(t)),_typescript.default.factory.createConditionalExpression(_typescript.default.factory.createParenthesizedExpression(_typescript.default.factory.createBinaryExpression(createConditionParent(r),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.AmpersandAmpersandToken),_typescript.default.factory.createPropertyAccessExpression(createConditionParent(r),_typescript.default.factory.createIdentifier(_pre_define.CUSTOM_COMPONENT_FUNCTION_FIND_CHILD_BY_ID)))),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),_typescript.default.factory.createAsExpression(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(createConditionParent(r),_typescript.default.factory.createIdentifier(""+_pre_define.CUSTOM_COMPONENT_FUNCTION_FIND_CHILD_BY_ID)),void 0,[r?_typescript.default.factory.createCallExpression(_typescript.default.factory.createIdentifier(_pre_define.GENERATE_ID),void 0,[]):_typescript.default.factory.createStringLiteral(e)]),_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(t))),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ColonToken),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_IF_UNDEFINED)))],_typescript.default.NodeFlags.Let))}function createConditionParent(e){return e?_typescript.default.factory.createParenthesizedExpression((0,_process_component_build.parentConditionalExpression)()):_typescript.default.factory.createThis()}function createCustomComponentIfStatement(e,t,r,i){e=""+_pre_define.CUSTOM_COMPONENT_EARLIER_CREATE_CHILD+e;return _typescript.default.factory.createIfStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsToken),_typescript.default.factory.createIdentifier(""+_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED)),_typescript.default.factory.createBlock([t],!0),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(""+_pre_define.COMPONENT_CONSTRUCTOR_UPDATE_PARAMS)),void 0,[r])),_validate_ui_syntax.isStaticViewCollection.get(i)?createStaticIf(e):void 0,_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(""+_pre_define.BASE_COMPONENT_NAME),_typescript.default.factory.createIdentifier(""+_pre_define.COMPONENT_CREATE_FUNCTION)),void 0,[_typescript.default.factory.createIdentifier(e)]))],!0))}function createStaticIf(e){return _typescript.default.factory.createIfStatement(_typescript.default.factory.createPrefixUnaryExpression(_typescript.default.SyntaxKind.ExclamationToken,_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.CUSTOM_COMPONENT_NEEDS_UPDATE_FUNCTION)),void 0,[])),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.CUSTOM_COMPONENT_MARK_STATIC_FUNCTION)),void 0,[]))],!0),void 0)}function hasDollar(e){return!(!_typescript.default.isPropertyAccessExpression(e)||!matchStartWithDollar(e.name.getText()))||!(!_typescript.default.isIdentifier(e)||!matchStartWithDollar(e.getText()))}function matchStartWithDollar(e){return/^\$/.test(e)}function validateForbiddenToInitViaParam(e,t,r){var i=new Set([...getCollectionSet(t,_validate_ui_syntax.storageLinkCollection),...getCollectionSet(t,_validate_ui_syntax.storagePropCollection),...getCollectionSet(t,_validate_ui_syntax.consumeCollection)]),a=new Set;(0,_validate_ui_syntax.getLocalStorageCollection)(t,a),(isThisProperty(e,i)||isThisProperty(e,a))&&r.push({type:_utils.LogType.ERROR,message:`Property '${e.name.getText()}' in the custom component '${t}'`+" cannot be initialized here (forbidden to specify).",pos:e.name.getStart()})}function validateMandatoryToInitViaParam(t,r,i,a,e){var n,o=this;let s;"esmodule"===_main.projectConfig.compileMode&&"rollup"===process.env.compileTool&&t.expression?(n=[...getCollectionSet(t.expression.getText(),_utils.storedFileInfo.overallObjectLinkCollection)],e.isComponentV2||n.unshift(...getCollectionSet(t.expression.getText(),_utils.storedFileInfo.overallLinkCollection)),s=new Set(n),r=t.expression.getText()):(n=[...getCollectionSet(r,_validate_ui_syntax.objectLinkCollection)],e.isComponentV2||n.unshift(...getCollectionSet(r,_validate_ui_syntax.linkCollection)),s=new Set(n)),s.forEach(function(e){_newArrowCheck(this,o),e&&!i.has(e)&&a.push({type:_utils.LogType.ERROR,message:`Property '${e}' in the custom component '${r}'`+" is missing (mandatory to specify).",pos:t.getStart()})}.bind(this))}function validateInitDecorator(t,e,r,i){var a=this,n=new Set([...getCollectionSet(e,_validate_ui_syntax.builderParamObjectCollection),...getCollectionSet(e,_validate_ui_syntax.propCollection),...getCollectionSet(e,_validate_ui_syntax.regularCollection),...getCollectionSet(e,_validate_ui_syntax.stateCollection),...getCollectionSet(e,_validate_ui_syntax.provideCollection)]);const o=new Set([..._validate_ui_syntax.builderParamInitialization.get(e)||[],..._validate_ui_syntax.propInitialization.get(e)||[],..._validate_ui_syntax.regularInitialization.get(e)||[],..._validate_ui_syntax.stateInitialization.get(e)||[],..._validate_ui_syntax.provideInitialization.get(e)||[]]),s=(n.forEach(function(e){_newArrowCheck(this,a),e&&!r.has(e)&&o&&o.has(e)&&i.push({type:_utils.LogType.ERROR,message:`Property '${e}' must be initialized through the component constructor.`,pos:t.getStart()})}.bind(this)),_validate_ui_syntax.privateCollection.get(e)||new Set([]));r.forEach(function(e){_newArrowCheck(this,a),s.has(e)&&i.push({type:_utils.LogType.WARN,message:`Property '${e}' is private and can not be initialized through the component constructor.`,pos:t.getStart()})}.bind(this))}function validateIllegalInitFromParent(e,t,r,i,a,n,o=void 0){let s=_utils.LogType.ERROR;o?s=o:[_pre_define.COMPONENT_STATE_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR].includes(a)&&r===_pre_define.COMPONENT_OBJECT_LINK_DECORATOR&&(s=_utils.LogType.WARN),_process_component_member.PropMapManager.reserveLog(i,a,{type:s,message:`The ${a} property '${i}' cannot be assigned to `+`the ${r} property '${t}'.`,pos:(e.initializer||e).getStart()})}function validateNonLinkWithDollar(e,t){t.push({type:_utils.LogType.ERROR,message:`Property '${e.name.getText()}' cannot initialize`+" using '$' to create a reference to a variable.",pos:e.initializer.getStart()})}