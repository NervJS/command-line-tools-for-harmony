"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.lazyImportReExportCheck=lazyImportReExportCheck,exports.processJsCodeLazyImport=processJsCodeLazyImport,exports.reExportNoCheckMode=exports.reExportCheckLog=void 0,exports.resetReExportCheckLog=resetReExportCheckLog,exports.transformLazyImport=transformLazyImport;var ts=_interopRequireWildcard(require("typescript")),_utils=require("./utils"),_create_ast_node_utils=_interopRequireDefault(require("./create_ast_node_utils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,o,s={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((o=i?Object.getOwnPropertyDescriptor(e,r):null)&&(o.get||o.set)?Object.defineProperty(s,r,o):s[r]=e[r]);return s.default=e,t&&t.set(e,s),s}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const reExportCheckLog=new _create_ast_node_utils.default.FileLog,reExportNoCheckMode=(exports.reExportCheckLog=reExportCheckLog,"noCheck"),reExportStrictMode=(exports.reExportNoCheckMode=reExportNoCheckMode,"strict");function processJsCodeLazyImport(e,t,r,o){let s=ts.createSourceFile(e,t,ts.ScriptTarget.ES2021,!0,ts.ScriptKind.JS);return lazyImportReExportCheck(s=r?transformLazyImport(s):s,o),r?ts.createPrinter({newLine:ts.NewLineKind.LineFeed}).printFile(s):t}function transformLazyImport(e,s){var i=this,t=function(t){var r=this;_newArrowCheck(this,i);const o=function(e){return _newArrowCheck(this,r),ts.isImportDeclaration(e)?updateImportDecl(e,s):e}.bind(this);return function(e){return _newArrowCheck(this,r),ts.visitEachChild(e,o,t)}.bind(this)}.bind(this);return ts.transform(e,[t]).transformed[0]}function updateImportDecl(t,r){var o=t.importClause;if(!o||!o.namedBindings||o.name||!ts.isNamedImports(o.namedBindings)||o.isLazy||o.isTypeOnly)return t;{let e;var s=o.namedBindings,r=((e=r?(r=eliminateTypeSymbol(s,r),ts.factory.createImportClause(!1,o.name,ts.factory.createNamedImports(r))):ts.factory.createImportClause(!1,o.name,s)).isLazy=!0,ts.canHaveModifiers(t)?ts.getModifiers(t):void 0);return ts.factory.updateImportDeclaration(t,r,e,t.moduleSpecifier,t.assertClause)}}function eliminateTypeSymbol(e,t){var r=this;const o=[];return e.elements.forEach(function(e){_newArrowCheck(this,r);!e.isTypeOnly&&t.isReferencedAliasDeclaration(e)&&o.push(ts.factory.createImportSpecifier(!1,e.propertyName?ts.factory.createIdentifier(e.propertyName.text):void 0,ts.factory.createIdentifier(e.name.text)))}.bind(this)),o}function resetReExportCheckLog(){reExportCheckLog.cleanUp()}function lazyImportReExportCheck(e,t){var r=this;if(t!==reExportNoCheckMode){reExportCheckLog.sourceFile=e;const i=new Set,n=new Map,a=new Map;e.statements.forEach(function(e){_newArrowCheck(this,r),collectLazyImportSymbols(e,i,n,a),collectLazyReExportSymbols(e,i,n,a)}.bind(this));for(var[o,s]of a.entries())for(const c of s)collectReExportErrors(c,o,t)}}function collectLazyImportSymbols(e,t,r,o){var s,i=this;ts.isImportDeclaration(e)&&e.importClause&&e.importClause.isLazy&&((s=e.importClause.name)&&(t.add(s.text),o.set(s.text,r.get(s.text)??[])),s=e.importClause.namedBindings)&&ts.isNamedImports(s)&&0!==s.elements.length&&s.elements.forEach(function(e){_newArrowCheck(this,i);e=e.name.text;t.add(e),o.set(e,r.get(e)??[])}.bind(this))}function collectLazyReExportSymbols(r,o,s,i){var e,t,n=this;ts.isExportAssignment(r)&&ts.isIdentifier(r.expression)&&(e=r.expression.text,(t=o.has(e)?i:s).get(e)||t.set(e,[]),t.get(e).push(r)),ts.isExportDeclaration(r)&&!r.moduleSpecifier&&ts.isNamedExports(r.exportClause)&&0!==r.exportClause.elements.length&&r.exportClause.elements.forEach(function(e){_newArrowCheck(this,n);var t=e.name.text,e=e.propertyName?e.propertyName.text:t,t=o.has(e)?i:s;t.get(e)||t.set(e,[]),t.get(e).push(r)}.bind(this))}function collectReExportErrors(e,t,r){let o;try{o=e.getStart()}catch{o=0}let s=_utils.LogType.WARN;r===reExportStrictMode&&(s=_utils.LogType.ERROR);e="ARKTS ERROR: Symbol of lazy-import is re-export.\n"+`Error Message: '${t}' of lazy-import is re-export.
`+"Solutions: > Please make sure the namedBindings of lazy-import are not be re-exported.\n> Please check whether the autoLazyImport switch is opened.";reExportCheckLog.errors.push({type:s,message:e,pos:o})}