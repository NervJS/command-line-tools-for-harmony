"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.appStorageDecorators=exports.UpdateResult=exports.PropMapManager=void 0,exports.createCustomComponentNewExpression=createCustomComponentNewExpression,exports.createViewCreate=createViewCreate,exports.decoratorParamSet=void 0,exports.findDecoratorIndex=findDecoratorIndex,exports.immutableDecorators=exports.forbiddenSpecifyDefaultValueDecorators=void 0,exports.isBasicType=isBasicType,exports.isLocalStorageParameter=isLocalStorageParameter,exports.isSimpleType=isSimpleType,exports.isSingleKey=isSingleKey,exports.judgeBuilderParamAssignedByBuilder=judgeBuilderParamAssignedByBuilder,exports.observedPropertyDecorators=exports.mandatoryToInitViaParamDecorators=exports.mandatorySpecifyDefaultValueDecorators=void 0,exports.processMemberVariableDecorators=processMemberVariableDecorators,exports.propAndLinkDecorators=void 0,exports.resetProcessComponentMember=resetProcessComponentMember,exports.stateObjectCollection=exports.simpleTypes=exports.setUpdateParamsDecorators=exports.setStateVarsDecorators=void 0;var _typescript=_interopRequireDefault(require("typescript")),_pre_define=require("./pre_define"),_component_map=require("./component_map"),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_constructor=require("./process_component_constructor"),_utils=require("./utils"),_process_component_class=require("./process_component_class"),_process_ui_syntax=require("./process_ui_syntax"),_main=require("../main"),_process_component_build=require("./process_component_build");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}const path=require("path"),observedPropertyDecorators=new Set([_pre_define.COMPONENT_STATE_DECORATOR,_pre_define.COMPONENT_PROVIDE_DECORATOR]),propAndLinkDecorators=(exports.observedPropertyDecorators=observedPropertyDecorators,new Set([_pre_define.COMPONENT_PROP_DECORATOR,_pre_define.COMPONENT_LINK_DECORATOR])),appStorageDecorators=(exports.propAndLinkDecorators=propAndLinkDecorators,new Set([_pre_define.COMPONENT_STORAGE_PROP_DECORATOR,_pre_define.COMPONENT_STORAGE_LINK_DECORATOR,_pre_define.COMPONENT_LOCAL_STORAGE_LINK_DECORATOR,_pre_define.COMPONENT_LOCAL_STORAGE_PROP_DECORATOR])),mandatorySpecifyDefaultValueDecorators=(exports.appStorageDecorators=appStorageDecorators,new Set([...observedPropertyDecorators,...appStorageDecorators])),forbiddenSpecifyDefaultValueDecorators=(exports.mandatorySpecifyDefaultValueDecorators=mandatorySpecifyDefaultValueDecorators,new Set([_pre_define.COMPONENT_LINK_DECORATOR,_pre_define.COMPONENT_CONSUME_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR])),mandatoryToInitViaParamDecorators=(exports.forbiddenSpecifyDefaultValueDecorators=forbiddenSpecifyDefaultValueDecorators,new Set([...propAndLinkDecorators,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR])),setUpdateParamsDecorators=(exports.mandatoryToInitViaParamDecorators=mandatoryToInitViaParamDecorators,new Set([...observedPropertyDecorators,_pre_define.COMPONENT_PROP_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR,_pre_define.COMPONENT_BUILDERPARAM_DECORATOR])),setStateVarsDecorators=(exports.setUpdateParamsDecorators=setUpdateParamsDecorators,new Set([_pre_define.COMPONENT_OBJECT_LINK_DECORATOR])),immutableDecorators=(exports.setStateVarsDecorators=setStateVarsDecorators,new Set([_pre_define.COMPONENT_OBJECT_LINK_DECORATOR,_pre_define.COMPONENT_BUILDERPARAM_DECORATOR])),simpleTypes=(exports.immutableDecorators=immutableDecorators,new Set([_typescript.default.SyntaxKind.StringKeyword,_typescript.default.SyntaxKind.NumberKeyword,_typescript.default.SyntaxKind.BooleanKeyword,_typescript.default.SyntaxKind.EnumDeclaration])),decoratorParamSet=(exports.simpleTypes=simpleTypes,new Set),stateObjectCollection=(exports.decoratorParamSet=decoratorParamSet,new Set);exports.stateObjectCollection=stateObjectCollection;class UpdateResult{constructor(){_defineProperty(this,"itemUpdate",!1),_defineProperty(this,"ctorUpdate",!1),_defineProperty(this,"properity",void 0),_defineProperty(this,"ctor",void 0),_defineProperty(this,"variableGet",void 0),_defineProperty(this,"variableSet",void 0),_defineProperty(this,"updateParams",void 0),_defineProperty(this,"deleteParams",!1),_defineProperty(this,"controllerSet",void 0),_defineProperty(this,"purgeVariableDepStatement",void 0),_defineProperty(this,"decoratorName",void 0),_defineProperty(this,"stateVarsParams",void 0)}setProperity(e){this.itemUpdate=!0,this.properity=e}setCtor(e){this.ctorUpdate=!0,this.ctor=e}setControllerSet(e){this.controllerSet=e}getControllerSet(){return this.controllerSet}setVariableGet(e){this.variableGet=e}setVariableSet(e){this.variableSet=e}setUpdateParams(e){this.updateParams=e}setStateVarsParams(e){this.stateVarsParams=e}setDeleteParams(e){this.deleteParams=e}setPurgeVariableDepStatement(e){this.purgeVariableDepStatement=e}setDecoratorName(e){this.decoratorName=e}isItemUpdate(){return this.itemUpdate}isCtorUpdate(){return this.ctorUpdate}getProperity(){return this.properity}getCtor(){return this.ctor}getUpdateParams(){return this.updateParams}getStateVarsParams(){return this.stateVarsParams}getPurgeVariableDepStatement(){return this.purgeVariableDepStatement}getVariableGet(){return this.variableGet}getVariableSet(){return this.variableSet}getDecoratorName(){return this.decoratorName}isDeleteParams(){return this.deleteParams}}exports.UpdateResult=UpdateResult;class PropMapManager{static register(e,t){PropMapManager.curPropMap.set(e,t),t!==_pre_define.COMPONENT_NON_DECORATOR&&PropMapManager.releaseLogs(e,_pre_define.COMPONENT_NON_DECORATOR)}static find(e){return PropMapManager.curPropMap.get(e)}static reserveLog(e,t,r){e=e+"-"+t,t=PropMapManager.logInfoMap.get(e)??[];PropMapManager.logInfoMap.set(e,[...t,r])}static releaseLogs(e,t){e=e+"-"+t;PropMapManager.logInfoMap.has(e)&&PropMapManager.logInfoMap.delete(e)}static reset(){PropMapManager.curPropMap.clear(),PropMapManager.logInfoMap.clear()}}function processMemberVariableDecorators(e,t,r,a,i,o,s,p,n,c){var _=new UpdateResult,d=t.name,f=_typescript.default.getAllDecorators(t);if((0,_process_component_class.isRegularProperty)(f)){if(!d.escapedText)return _;PropMapManager.register(d.escapedText.toString(),_pre_define.COMPONENT_NON_DECORATOR),_.setProperity(void 0),_.setUpdateParams(createUpdateParams(d,_pre_define.COMPONENT_NON_DECORATOR)),_.setCtor((0,_process_component_constructor.updateConstructor)(r,[],[createVariableInitStatement(t,_pre_define.COMPONENT_NON_DECORATOR,o,s,p,n,c)],[])),_.setControllerSet(createControllerSet(t,e,d,i)),_main.partialUpdateConfig.partialUpdateMode&&_.setDeleteParams(!0)}else{if(!t.type)return validatePropertyNonType(d,o),_;validateCustomDecorator(f,o)?_.setUpdateParams(createUpdateParams(d,_pre_define.COMPONENT_CUSTOM_DECORATOR)):processPropertyNodeDecorator(e,t,_,r,d,a,o,s,p,n,c)}return f&&f.length&&validatePropDecorator(f)&&_.setStateVarsParams(createStateVarsBody(d)),_}function createStateVarsBody(e){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier("__"+e.escapedText.toString())),_typescript.default.factory.createIdentifier(_pre_define.RESERT)),void 0,[_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS),e)]))}function createControllerSet(e,t,r,a){if(_validate_ui_syntax.componentCollection.customDialogs.has(t.getText())&&e.type&&e.type.getText()===_pre_define.SET_CONTROLLER_CTR_TYPE)return a.hasController=!0,_typescript.default.factory.createMethodDeclaration(void 0,void 0,_typescript.default.factory.createIdentifier(_pre_define.SET_CONTROLLER_METHOD),void 0,void 0,[_typescript.default.factory.createParameterDeclaration(void 0,void 0,_typescript.default.factory.createIdentifier(_pre_define.SET_CONTROLLER_CTR),void 0,_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(_pre_define.SET_CONTROLLER_CTR_TYPE),void 0),void 0)],void 0,_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),r),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createIdentifier(_pre_define.SET_CONTROLLER_CTR)))],!0))}function processPropertyNodeDecorator(t,r,a,i,o,s,p,n,c,_,d){var f=_typescript.default.getAllDecorators(r),l=[];for(let e=0;e<f.length;e++){var y=f[e].getText().replace(/\(.*\)$/,"").trim(),u=[_pre_define.COMPONENT_WATCH_DECORATOR,_pre_define.COMPONENT_REQUIRE_DECORATOR].includes(y);if(u||PropMapManager.register(o.escapedText.toString(),y),_component_map.BUILDIN_STYLE_NAMES.has(y.replace("@",""))&&validateDuplicateDecorator(f[e],p),!u&&isForbiddenUseStateType(r.type))return void validateForbiddenUseStateType(o,y,r.type.typeName.getText(),p);if(t.getText()===_validate_ui_syntax.componentCollection.entryComponent&&mandatoryToInitViaParamDecorators.has(y)&&validateHasIllegalDecoratorInEntry(t,o,y,p),r.initializer&&forbiddenSpecifyDefaultValueDecorators.has(y))return void validatePropertyDefaultValue(o,y,p);if(!r.initializer&&mandatorySpecifyDefaultValueDecorators.has(y))return void validatePropertyNonDefaultValue(o,y,p);!r.questionToken||!mandatoryToInitViaParamDecorators.has(y)||y===_pre_define.COMPONENT_PROP_DECORATOR&&r.initializer||validateHasIllegalQuestionToken(o,y,p),isSimpleType(r.type,n)||y===_pre_define.COMPONENT_BUILDERPARAM_DECORATOR||stateObjectCollection.add(o.escapedText.toString()),y===_pre_define.COMPONENT_WATCH_DECORATOR&&validateWatchDecorator(o,f,p)?processWatch(r,f[e],s,p):_pre_define.INNER_COMPONENT_MEMBER_DECORATORS.has(y)&&(l.push(y),y!==_pre_define.COMPONENT_REQUIRE_DECORATOR)&&processStateDecorators(r,y,a,i,p,n,c,_,d)}validatePropertyDecorator(l,o,p)}function validatePropertyDecorator(e,t,r){1<e.length&&!validateRequireDecorator(e)&&validateMultiDecorators(t,r)}_defineProperty(exports.PropMapManager=PropMapManager,"curPropMap",new Map),_defineProperty(PropMapManager,"logInfoMap",new Map);const DECORATOR_LENGTH=2,SUPPORT_REQUIRE_DECORATOR=[_pre_define.COMPONENT_PROP_DECORATOR,_pre_define.COMPONENT_BUILDERPARAM_DECORATOR,_pre_define.COMPONENT_STATE_DECORATOR,_pre_define.COMPONENT_PROVIDE_DECORATOR,_pre_define.COMPONENT_WATCH_DECORATOR];function validateRequireDecorator(e){var t=this,r=e.some(function(e){return _newArrowCheck(this,t),SUPPORT_REQUIRE_DECORATOR.includes(e)}.bind(this));return e.length===DECORATOR_LENGTH&&e.includes(_pre_define.COMPONENT_REQUIRE_DECORATOR)&&r}function processStateDecorators(e,t,r,a,i,o,s,p,n){var c=e.name,_=(r.setProperity(void 0),[]),i=createVariableInitStatement(e,t,i,o,s,p,n);i&&_.push(i),addAddProvidedVar(e,c,t,_),r.setCtor((0,_process_component_constructor.updateConstructor)(a,[],[..._],[],!1)),t!==_pre_define.COMPONENT_BUILDERPARAM_DECORATOR&&(r.setVariableGet(createGetAccessor(c,_pre_define.CREATE_GET_METHOD)),r.setDeleteParams(!0)),immutableDecorators.has(t)||r.setVariableSet(createSetAccessor(c,_pre_define.CREATE_SET_METHOD,e.type)),setUpdateParamsDecorators.has(t)&&r.setUpdateParams(createUpdateParams(c,t,e)),_main.projectConfig.optLazyForEach&&setStateVarsDecorators.add(_pre_define.COMPONENT_STATE_DECORATOR),setStateVarsDecorators.has(t)&&r.setStateVarsParams(createStateVarsParams(c,t)),_main.partialUpdateConfig.partialUpdateMode&&_pre_define.BASICDECORATORS.has(t)&&(o="__"+c.escapedText.toString(),r.setDecoratorName(t),r.setPurgeVariableDepStatement(createPurgeVariableDepStatement(o)))}function createPurgeVariableDepStatement(e){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(e)),_typescript.default.factory.createIdentifier(_pre_define.PURGEDEPENDENCYONELMTID)),void 0,[_typescript.default.factory.createIdentifier(_pre_define.RMELMTID)]))}function processWatch(e,t,r,a){var i,o,s;e.name&&(i=e.name.getText(),t.expression)&&_typescript.default.isCallExpression(t.expression)&&t.expression.arguments&&1===t.expression.arguments.length&&(s=getClassMethod(e),o=t.expression.arguments[0],_typescript.default.isStringLiteral(o)?s&&s.has(o.text)?r.set(i,o):a.push({type:_utils.LogType.ERROR,message:`Cannot find name ${o.getText()} in struct '${e.parent.name.getText()}'.`,pos:o.getStart()}):_typescript.default.isIdentifier(t.expression.arguments[0])?(e=createPropertyAccessExpressionWithThis(s=t.expression.arguments[0].getText()),r.set(i,e),decoratorParamSet.add(s),validateWatchParam(_utils.LogType.WARN,o.getStart(),a)):_typescript.default.isPropertyAccessExpression(t.expression.arguments[0])?(r.set(i,t.expression.arguments[0]),validateWatchParam(_utils.LogType.WARN,o.getStart(),a)):validateWatchParam(_utils.LogType.ERROR,o.getStart(),a))}function getClassMethod(e){var t=e.getSourceFile(),t=t?t.fileName:void 0;return t&&_validate_ui_syntax.classMethodCollection.get(t)?_validate_ui_syntax.classMethodCollection.get(t).get(e.parent.name.getText()):new Set}function createVariableInitStatement(e,t,r,a,i,o,s){var p=e.name;let n,c;switch(e.type&&(n=e.type),t){case _pre_define.COMPONENT_NON_DECORATOR:c=updateNormalProperty(e,p,r,i);break;case _pre_define.COMPONENT_STATE_DECORATOR:case _pre_define.COMPONENT_PROVIDE_DECORATOR:c=(_main.partialUpdateConfig.partialUpdateMode?updateObservedPropertyPU:updateObservedProperty)(e,p,n,a);break;case _pre_define.COMPONENT_LINK_DECORATOR:wrongDecoratorInPreview(e,_pre_define.COMPONENT_LINK_DECORATOR,o,r),c=(_main.partialUpdateConfig.partialUpdateMode?updateSynchedPropertyTwoWayPU:updateSynchedPropertyTwoWay)(p,n,a);break;case _pre_define.COMPONENT_PROP_DECORATOR:wrongDecoratorInPreview(e,_pre_define.COMPONENT_PROP_DECORATOR,o,r),c=(_main.partialUpdateConfig.partialUpdateMode?updateSynchedPropertyOneWayPU:updateSynchedPropertyOneWay)(p,n,t,r,a);break;case _pre_define.COMPONENT_STORAGE_PROP_DECORATOR:case _pre_define.COMPONENT_STORAGE_LINK_DECORATOR:c=updateStoragePropAndLinkProperty(e,p,t);break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:c=(_main.partialUpdateConfig.partialUpdateMode?updateSynchedPropertyNesedObjectPU:updateSynchedPropertyNesedObject)(p,n,t,r);break;case _pre_define.COMPONENT_CONSUME_DECORATOR:wrongDecoratorInPreview(e,_pre_define.COMPONENT_CONSUME_DECORATOR,o,r),c=updateConsumeProperty(e,p);break;case _pre_define.COMPONENT_BUILDERPARAM_DECORATOR:c=updateBuilderParamProperty(e,p,r)}var _=s.members;return _.push(_typescript.default.factory.createPropertySignature(void 0,p,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),n)),s=_typescript.default.factory.updateInterfaceDeclaration(s,_typescript.default.getModifiers(s),s.name,s.typeParameters,s.heritageClauses,_),c}function wrongDecoratorInPreview(e,t,r,a){r&&_main.projectConfig.isPreview&&a.push({type:_utils.LogType.WARN,message:`The variable with ${t} in component with @Preview may `+"cause error in component preview mode",pos:e.getStart()})}function createUpdateParams(e,t,r=void 0){let a;switch(t){case _pre_define.COMPONENT_NON_DECORATOR:case _pre_define.COMPONENT_STATE_DECORATOR:case _pre_define.COMPONENT_PROVIDE_DECORATOR:case _pre_define.COMPONENT_CUSTOM_DECORATOR:a=createUpdateParamsWithIf(e);break;case _pre_define.COMPONENT_PROP_DECORATOR:_main.partialUpdateConfig.partialUpdateMode?r&&r.initializer&&(a=createUpdateParamsWithIf(e,!0,r.initializer)):a=createUpdateParamsWithoutIf(e);break;case _pre_define.COMPONENT_BUILDERPARAM_DECORATOR:a=createUpdateParamsWithIf(e);break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:a=createUpdateParamsWithSet(e)}return a}function createStateVarsParams(e,t){let r;switch(t){case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:r=createUpdateParamsWithSet(e);break;case _pre_define.COMPONENT_STATE_DECORATOR:r=createUpdateParamsForState(e)}return r}function createUpdateParamsWithIf(e,t=!1,r=void 0){return _typescript.default.factory.createIfStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.CREATE_CONSTRUCTOR_PARAMS),_typescript.default.factory.createIdentifier(e.escapedText.toString())),t?_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsEqualsToken):_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ExclamationEqualsEqualsToken),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED)),t?_typescript.default.factory.createBlock([createUpdateParamsWithSet(e,!0,r)]):_typescript.default.factory.createBlock([createUpdateParamsWithoutIf(e)],!0),void 0)}function createUpdateParamsForState(e){return _typescript.default.factory.createIfStatement(createPropertyAccessExpressionWithParams(e.getText()),_typescript.default.factory.createBlock([createUpdateParamsWithSet(e)]))}function createUpdateParamsWithoutIf(e){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis(e.getText()),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),createPropertyAccessExpressionWithParams(e.getText())))}function createUpdateParamsWithSet(e,t=!1,r=void 0){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(createPropertyAccessExpressionWithThis("__"+e.getText()),_typescript.default.factory.createIdentifier(_pre_define.CREATE_SET_METHOD)),void 0,[t?r:createPropertyAccessExpressionWithParams(e.getText())]))}function updateNormalProperty(e,t,r,a){e=_typescript.default.visitNode(e.initializer,function e(t){(0,_process_component_class.isProperty)(t)&&(t=(0,_process_component_class.createReference)(t,r));return _typescript.default.visitEachChild(t,e,a)});return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis(t.getText()),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),e||_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED)))}function updateObservedProperty(e,t,r,a){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis("__"+t.getText()),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createNewExpression(_typescript.default.factory.createIdentifier(isSimpleType(r,a)?_pre_define.OBSERVED_PROPERTY_SIMPLE:_pre_define.OBSERVED_PROPERTY_OBJECT),void 0,[e.initializer,_typescript.default.factory.createThis(),_typescript.default.factory.createStringLiteral(t.escapedText.toString())])))}function updateSynchedPropertyTwoWay(e,t,r){e=e.escapedText.toString();return createInitExpressionStatementForDecorator(e,isSimpleType(t,r)?_pre_define.SYNCHED_PROPERTY_SIMPLE_TWO_WAY:_pre_define.SYNCHED_PROPERTY_OBJECT_TWO_WAY,createPropertyAccessExpressionWithParams(e))}function updateSynchedPropertyOneWay(e,t,r,a,i){var o=e.escapedText.toString();if(isSimpleType(t,i))return createInitExpressionStatementForDecorator(o,_pre_define.SYNCHED_PROPERTY_SIMPLE_ONE_WAY,createPropertyAccessExpressionWithParams(o));validateNonSimpleType(e,r,a)}function findDecoratorIndex(e,t){var r=this;return e.findIndex(function(e){return _newArrowCheck(this,r),t.includes(e.getText().replace(/\(.*\)$/,"").trim())}.bind(this))}function updateStoragePropAndLinkProperty(r,a,i){var o=_typescript.default.getAllDecorators(r);if(isSingleKey(r)){let e,t;o=[o[findDecoratorIndex(o,[i])].expression.arguments[0],r.initializer,_typescript.default.factory.createThis(),_typescript.default.factory.createStringLiteral(a.getText())];return _main.partialUpdateConfig.partialUpdateMode?(e=i===_pre_define.COMPONENT_STORAGE_PROP_DECORATOR?_pre_define.CREATE_STORAGE_PROP:_pre_define.CREATE_STORAGE_LINK,t=_pre_define.THIS,o.splice(2,1)):(e=i===_pre_define.COMPONENT_STORAGE_PROP_DECORATOR?_pre_define.APP_STORAGE_SET_AND_PROP:_pre_define.APP_STORAGE_SET_AND_LINK,t=_pre_define.APP_STORAGE),_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis("__"+a.getText()),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(t),_typescript.default.factory.createIdentifier(e)),void 0,o)))}}function getDecoratorKey(e,t=!1){let r,a=!1,i=!1;e=_typescript.default.getAllDecorators(e);let o=e[findDecoratorIndex(e,[_pre_define.COMPONENT_PROVIDE_DECORATOR,_pre_define.COMPONENT_CONSUME_DECORATOR])].expression.arguments[0];return _typescript.default.isIdentifier(o)?(r=o.getText(),decoratorParamSet.add(r)):_typescript.default.isStringLiteral(o)?(r=o.text,a=!0):t&&_typescript.default.isObjectLiteralExpression(o)&&1===o.properties.length&&_typescript.default.isPropertyAssignment(o.properties[0])&&o.properties[0].initializer?(r=o.properties[0].initializer.text,o=o.properties[0].initializer,i=!0):r=o.getText(),[r,a,o,i]}function updateSynchedPropertyNesedObject(e,t,r,a){if(isObservedClassType(t))return createInitExpressionStatementForDecorator(e.getText(),_pre_define.SYNCHED_PROPERTY_NESED_OBJECT,createPropertyAccessExpressionWithParams(e.getText()));validateNonObservedClassType(e,r,a)}function updateConsumeProperty(e,t){t=t.getText();let r;var a=[];return r=isSingleKey(e,!0)?(a.push(...getDecoratorKey(e)),a[0]):t,_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis("__"+t),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createCallExpression(createPropertyAccessExpressionWithThis(_pre_define.INITIALIZE_CONSUME_FUNCTION),void 0,[0===a.length?_typescript.default.factory.createStringLiteral(r):4===a.length&&a[2],_typescript.default.factory.createStringLiteral(t)])))}function updateBuilderParamProperty(e,t,r){t=t.getText();return judgeBuilderParamAssignedByBuilder(e)&&r.push({type:_utils.LogType.ERROR,message:"BuilderParam property can only initialized by Builder function or LocalBuilder method in struct.",pos:e.getStart()}),_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis(t),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),e.initializer||_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED)))}function judgeBuilderParamAssignedByBuilder(e){return e.initializer&&!(e.initializer&&(_typescript.default.isIdentifier(e.initializer)&&_component_map.CUSTOM_BUILDER_METHOD.has(e.initializer.escapedText.toString())||_typescript.default.isPropertyAccessExpression(e.initializer)&&e.initializer.name&&_typescript.default.isIdentifier(e.initializer.name)&&(_component_map.CUSTOM_BUILDER_METHOD.has(e.initializer.name.escapedText.toString())||_component_map.INNER_CUSTOM_LOCALBUILDER_METHOD.has(e.initializer.name.escapedText.toString()))||(0,_process_component_build.isWrappedBuilder)(e.initializer)))}function createViewCreate(e){return _main.partialUpdateConfig.partialUpdateMode?(0,_process_component_build.createFunction)(_typescript.default.factory.createIdentifier(_pre_define.BASE_COMPONENT_NAME_PU),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_FUNCTION),_typescript.default.factory.createNodeArray([e])):(0,_process_component_build.createFunction)(_typescript.default.factory.createIdentifier(_pre_define.BASE_COMPONENT_NAME),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CREATE_FUNCTION),_typescript.default.factory.createNodeArray([e]))}function createCustomComponentNewExpression(e,t,r=!1,a=!1,i=!1){return addCustomComponentId(_typescript.default.factory.createNewExpression(e.expression,e.typeArguments,e.arguments.length?e.arguments:[]),e,t,r,a,i)}function addCustomComponentId(r,a,i,o=!1,s=!1,p=!1){var n=this,e=_process_ui_syntax.transformLog.sourceFile.getLineAndCharacterOfPosition((0,_process_component_build.getRealNodePos)(r));const c=e.line+1,_=e.character+1;for(const t of _validate_ui_syntax.componentCollection.customComponents)_utils.componentInfo.componentNames.add(t);return _utils.componentInfo.componentNames.forEach(function(e){_newArrowCheck(this,n);let t;r.arguments&&r.arguments.length&&(t=Array.from(r.arguments),_main.partialUpdateConfig.partialUpdateMode)&&1===r.arguments.length&&manageLocalStorageComponents(a,t),i===e?(t||(t=[_typescript.default.factory.createObjectLiteralExpression([],!0)],_main.partialUpdateConfig.partialUpdateMode&&t.push(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_IF_UNDEFINED))),_main.partialUpdateConfig.partialUpdateMode?(t.unshift(s||_utils.storedFileInfo.processLocalBuilder?(0,_process_component_build.parentConditionalExpression)():_typescript.default.factory.createThis()),t.push(p?_typescript.default.factory.createPrefixUnaryExpression(_typescript.default.SyntaxKind.MinusToken,_typescript.default.factory.createNumericLiteral("1")):_typescript.default.factory.createIdentifier(_pre_define.ELMTID),createArrowFunctionNode(),componentParamRowAndColumn(c,_))):(++_utils.componentInfo.id,t.unshift(o?_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createStringLiteral(path.basename(_process_ui_syntax.transformLog.sourceFile.fileName,_pre_define.EXTNAME_ETS)+"_"),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.PlusToken),_typescript.default.factory.createIdentifier(_pre_define._GENERATE_ID)):_typescript.default.factory.createStringLiteral(_utils.componentInfo.id.toString()),o?(0,_process_component_build.parentConditionalExpression)():_typescript.default.factory.createThis())),r=_typescript.default.factory.updateNewExpression(r,r.expression,r.typeArguments,t)):t&&(r=_typescript.default.factory.updateNewExpression(r,r.expression,r.typeArguments,t))}.bind(this)),r}function manageLocalStorageComponents(e,t){isLocalStorageParameter(e)?t.unshift(_typescript.default.factory.createObjectLiteralExpression([],!1)):t.push(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_IF_UNDEFINED))}function isLocalStorageParameter(e){return _main.globalProgram.checker&&_main.globalProgram.checker.getResolvedSignature&&_main.globalProgram.checker.getResolvedSignature(e)&&_main.globalProgram.checker.getResolvedSignature(e).parameters&&1===_main.globalProgram.checker.getResolvedSignature(e).parameters.length&&"##storage"===_main.globalProgram.checker.getResolvedSignature(e).parameters[0].escapedName}function componentParamRowAndColumn(e,t){return _typescript.default.factory.createObjectLiteralExpression([_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier("page"),_typescript.default.factory.createStringLiteral(path.relative(process.cwd(),_process_ui_syntax.resourceFileName).replace(/\\/g,"/"))),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier("line"),_typescript.default.factory.createNumericLiteral(e)),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier("col"),_typescript.default.factory.createNumericLiteral(t))],!1)}function createArrowFunctionNode(){return _typescript.default.factory.createArrowFunction(void 0,void 0,[],void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock([],!1))}function createInitExpressionStatementForDecorator(e,t,r){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis("__"+e),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createNewExpression(_typescript.default.factory.createIdentifier(t),void 0,[r,_typescript.default.factory.createThis(),_typescript.default.factory.createStringLiteral(e)])))}function createPropertyAccessExpressionWithParams(e){return _typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.CREATE_CONSTRUCTOR_PARAMS),_typescript.default.factory.createIdentifier(e))}function createPropertyAccessExpressionWithThis(e){return _typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(e))}function addAddProvidedVar(t,r,a,i){if(a===_pre_define.COMPONENT_PROVIDE_DECORATOR){let e;a=[];isSingleKey(t,!0)&&(a.push(...getDecoratorKey(t,!0)),e=a[0],i.push(createAddProvidedVar(e,r,a[1],a[2],a[3]))),e!==r.getText()&&i.push(createAddProvidedVar(r.getText(),r,!0,void 0,a[3]))}}function createAddProvidedVar(e,t,r,a,i){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(createPropertyAccessExpressionWithThis(_pre_define.ADD_PROVIDED_VAR),void 0,[r?_typescript.default.factory.createStringLiteral(e):a,createPropertyAccessExpressionWithThis("__"+t.getText()),i?_typescript.default.factory.createIdentifier(_pre_define.TRUE):_typescript.default.factory.createIdentifier(_pre_define.FALSE)]))}function createGetAccessor(e,t){return _typescript.default.factory.createGetAccessorDeclaration(void 0,e,[],void 0,_typescript.default.factory.createBlock([_typescript.default.factory.createReturnStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(createPropertyAccessExpressionWithThis("__"+e.getText()),_typescript.default.factory.createIdentifier(t)),void 0,[]))],!0))}function createSetAccessor(e,t,r){return _typescript.default.factory.createSetAccessorDeclaration(void 0,e,[_typescript.default.factory.createParameterDeclaration(void 0,void 0,_typescript.default.factory.createIdentifier(_pre_define.CREATE_NEWVALUE_IDENTIFIER),void 0,r,void 0)],_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(createPropertyAccessExpressionWithThis("__"+e.getText()),_typescript.default.factory.createIdentifier(t)),void 0,[_typescript.default.factory.createIdentifier(_pre_define.CREATE_NEWVALUE_IDENTIFIER)]))],!0))}function isForbiddenUseStateType(e){return!!(_typescript.default.isTypeReferenceNode(e)&&_typescript.default.isIdentifier(e.typeName)&&_component_map.forbiddenUseStateType.has(e.typeName.getText()))}function isSimpleType(e,t,r){e=e||_typescript.default.factory.createKeywordTypeNode(_typescript.default.SyntaxKind.AnyKeyword);let a;return _main.globalProgram.program?a=_main.globalProgram.program.getTypeChecker():_main.globalProgram.watchProgram?a=_main.globalProgram.watchProgram.getCurrentProgram().getProgram().getTypeChecker():t&&(a=t.getTypeChecker()),getDeclarationType(e,a,r)}function getDeclarationType(e,r,t){if(simpleTypes.has(e.kind))return!0;if(_typescript.default.isTypeReferenceNode(e)&&e.typeName&&_typescript.default.isIdentifier(e.typeName)&&_validate_ui_syntax.enumCollection.has(e.typeName.escapedText.toString()))return!0;if(r){r=r.getTypeFromTypeNode(e);if(1056&r.flags)return!0;if(r.types&&r.types.length){var a=r.types;let t=!1;for(let e=0;e<a.length;e++)isBasicType(a[e].flags)||(t=!0);if(!t)return!0}}return!1}function isBasicType(e){return!!(4092&e)}function isObservedClassType(e){if(judgmentTypedeclaration(e)&&_validate_ui_syntax.observedClassCollection.has(e.typeName.escapedText.toString()))return!0;if(_typescript.default.isUnionTypeNode(e)&&e.types){var t=e.types;for(let e=0;e<t.length;e++)if(judgmentTypedeclaration(t[e])&&!_validate_ui_syntax.observedClassCollection.has(t[e].typeName.escapedText.toString()))return!1;return!0}return!1}function judgmentTypedeclaration(e){return _typescript.default.isTypeReferenceNode(e)&&e.typeName&&_typescript.default.isIdentifier(e.typeName)}function isSingleKey(e,t=!1){var r=this,e=_typescript.default.getAllDecorators(e);const a=new Set(["Provide","Consume"]);return e.some(function(e){return _newArrowCheck(this,r),_typescript.default.isCallExpression(e.expression)&&e.expression.arguments&&1===e.expression.arguments.length&&_typescript.default.isIdentifier(e.expression.expression)&&(!t||a.has(e.expression.expression.escapedText.toString()))}.bind(this))}function validateMultiDecorators(e,t){t.push({type:_utils.LogType.ERROR,message:`The property '${e.escapedText.toString()}' cannot have mutilate state management decorators.`,pos:e.getStart()})}function validatePropertyNonDefaultValue(e,t,r){r.push({type:_utils.LogType.ERROR,message:`The ${t} property '${e.getText()}' must be specified a default value.`,pos:e.getStart()})}function validatePropertyDefaultValue(e,t,r){r.push({type:_utils.LogType.ERROR,message:`The ${t} property '${e.getText()}' cannot be specified a default value.`+"Solutions:>Please initialize the rules according to the decorator.",pos:e.getStart()})}function validatePropertyNonType(e,t){t.push({type:_utils.LogType.ERROR,message:`The property '${e.getText()}' must specify a type.`,pos:e.getStart()})}function validateNonSimpleType(e,t,r){r.push({type:_main.projectConfig.optLazyForEach?_utils.LogType.WARN:_utils.LogType.ERROR,message:`The type of the ${t} property '${e.getText()}' `+"can only be string, number or boolean.",pos:e.getStart()})}function validateNonObservedClassType(e,t,r){r.push({type:_main.projectConfig.optLazyForEach?_utils.LogType.WARN:_utils.LogType.ERROR,message:`The type of the ${t} property '${e.getText()}' can only be `+`objects of classes decorated with ${_pre_define.COMPONENT_OBSERVED_DECORATOR} class decorator in ets (not ts).`,pos:e.getStart()})}function validateHasIllegalQuestionToken(e,t,r){r.push({type:_utils.LogType.WARN,message:`The ${t} property '${e.getText()}' cannot be an optional parameter.`,pos:e.getStart()})}function validateHasIllegalDecoratorInEntry(e,t,r,a){a.push({type:_utils.LogType.WARN,message:`The @Entry component '${e.getText()}' cannot have the `+`${r} property '${t.getText()}'.`,pos:t.getStart()})}function validateForbiddenUseStateType(e,t,r,a){a.push({type:_utils.LogType.ERROR,message:`The ${t} property '${e.getText()}' cannot be a '${r}' object.`,pos:e.getStart()})}function validateDuplicateDecorator(e,t){t.push({type:_utils.LogType.ERROR,message:`The decorator '${e.getText()}' cannot have the same name as the built-in `+`style attribute '${e.getText().replace("@","")}'.`,pos:e.getStart()})}function validateWatchDecorator(e,t,r){var a=this;let i=!1;return t.length===DECORATOR_LENGTH&&(i=t.some(function(e){return _newArrowCheck(this,a),e.getText()===_pre_define.COMPONENT_REQUIRE_DECORATOR}.bind(this))),1!==t.length&&!i||(r.push({type:_utils.LogType.ERROR,message:`Regular variable '${e.escapedText.toString()}' can not be decorated with @Watch.`,pos:e.getStart()}),!1)}function validateWatchParam(e,t,r){r.push({type:e,message:"The parameter should be a string.",pos:t})}function updateObservedPropertyPU(e,t,r,a){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(createPropertyAccessExpressionWithThis("__"+t.getText()),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),_typescript.default.factory.createNewExpression(_typescript.default.factory.createIdentifier(isSimpleType(r,a)?_pre_define.OBSERVED_PROPERTY_SIMPLE_PU:_pre_define.OBSERVED_PROPERTY_OBJECT_PU),void 0,[e.initializer,_typescript.default.factory.createThis(),_typescript.default.factory.createStringLiteral(t.escapedText.toString())])))}function updateSynchedPropertyTwoWayPU(e,t,r){e=e.escapedText.toString();return createInitExpressionStatementForDecorator(e,isSimpleType(t,r)?_pre_define.SYNCHED_PROPERTY_SIMPLE_TWO_WAY_PU:_pre_define.SYNCHED_PROPERTY_OBJECT_TWO_WAY_PU,createPropertyAccessExpressionWithParams(e))}function updateSynchedPropertyOneWayPU(e,t,r,a,i){e=e.escapedText.toString();return isSimpleType(t,i,a)?createInitExpressionStatementForDecorator(e,_pre_define.SYNCHED_PROPERTY_SIMPLE_ONE_WAY_PU,createPropertyAccessExpressionWithParams(e)):createInitExpressionStatementForDecorator(e,_pre_define.SYNCHED_PROPERTY_OBJECT_ONE_WAY_PU,createPropertyAccessExpressionWithParams(e))}function updateSynchedPropertyNesedObjectPU(e,t,r,a){return(!_main.partialUpdateConfig.partialUpdateMode||"esmodule"!==_main.projectConfig.compileMode||!checkObjectLinkType(t))&&("esmodule"===_main.projectConfig.compileMode&&_main.partialUpdateConfig.partialUpdateMode||!isObservedClassType(t))?void validateNonObservedClassType(e,r,a):createInitExpressionStatementForDecorator(e.getText(),_pre_define.SYNCHED_PROPERTY_NESED_OBJECT_PU,createPropertyAccessExpressionWithParams(e.getText()))}function validateCustomDecorator(t,e){let r=!1,a=!1,i;for(let e=0;e<t.length;e++){var o=t[e],s=o.getText().replace(/\(.*\)$/,"").trim();_pre_define.INNER_COMPONENT_MEMBER_DECORATORS.has(s)?(r=!0,i=i||o):a=!0}if(a&&r)e.push({type:_utils.LogType.ERROR,message:`The inner decorator ${i.getText()} cannot be used together with custom decorator.`,pos:i.getStart()});else if(!r)return!0;return!1}function validatePropDecorator(t){for(let e=0;e<t.length;e++){var r=t[e].getText().replace(/\(.*\)$/,"").trim();if(_pre_define.COMPONENT_PROP_DECORATOR===r)return!0}return!1}function checkObjectLinkType(e){if(_main.globalProgram.checker){var r=_main.globalProgram.checker.getTypeFromTypeNode(e);if(e.parent&&_typescript.default.isPropertyDeclaration(e.parent)&&isObserved(r))return!0;if(r.types&&r.types.length){let t=0;for(let e=0;e<r.types.length;e++){if(r.types[e].intrinsicName)return!1;isObserved(r.types[e])&&(t+=1)}return t===r.types.length}}return!1}function isObserved(e){var a=this;return!!(e&&e.getSymbol()&&e.getSymbol().declarations)&&e.getSymbol().declarations.some(function(e){var t=this,r=(_newArrowCheck(this,a),_typescript.default.getAllDecorators(e));return!(!_typescript.default.isClassDeclaration(e)||!r)&&r.some(function(e){return _newArrowCheck(this,t),_typescript.default.isIdentifier(e.expression)&&e.expression.escapedText.toString()===_pre_define.OBSERVED}.bind(this))}.bind(this))}function resetProcessComponentMember(){decoratorParamSet.clear()}