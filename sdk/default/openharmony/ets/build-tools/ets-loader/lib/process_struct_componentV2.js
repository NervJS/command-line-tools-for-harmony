"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.StructInfo=exports.ParamDecoratorInfo=void 0;var _typescript=_interopRequireDefault(require("typescript")),_utils=require("./utils"),_pre_define=require("./pre_define"),_constant_define=_interopRequireDefault(require("./constant_define")),_create_ast_node_utils=_interopRequireDefault(require("./create_ast_node_utils")),_process_component_class=require("./process_component_class"),_process_component_member=require("./process_component_member"),_validate_ui_syntax=require("./validate_ui_syntax");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}class ParamDecoratorInfo{constructor(){_defineProperty(this,"initializer",void 0),_defineProperty(this,"hasRequire",!1)}}exports.ParamDecoratorInfo=ParamDecoratorInfo;class StructInfo{constructor(){_defineProperty(this,"isComponentV1",!1),_defineProperty(this,"isComponentV2",!1),_defineProperty(this,"isCustomDialog",!1),_defineProperty(this,"isReusable",!1),_defineProperty(this,"structName",""),_defineProperty(this,"updatePropsDecoratorsV1",[]),_defineProperty(this,"linkDecoratorsV1",[]),_defineProperty(this,"paramDecoratorMap",new Map),_defineProperty(this,"eventDecoratorSet",new Set),_defineProperty(this,"localDecoratorSet",new Set),_defineProperty(this,"providerDecoratorSet",new Set),_defineProperty(this,"consumerDecoratorSet",new Set),_defineProperty(this,"builderParamDecoratorSet",new Set),_defineProperty(this,"regularSet",new Set),_defineProperty(this,"propertiesMap",new Map),_defineProperty(this,"staticPropertySet",new Set)}}exports.StructInfo=StructInfo;const structMapInEts=new Map;function getOrCreateStructInfo(e){let t=structMapInEts.get(e);return t||((t=new StructInfo).structName=e,structMapInEts.set(e,t)),t}function getAliasStructInfo(e){let t;return t=e.expression&&structMapInEts.has(e.expression.getText())?structMapInEts.get(e.expression.getText()):t}function processStructComponentV2(e,t,r){return _typescript.default.factory.createClassDeclaration(_typescript.default.getModifiers(e),e.name,e.typeParameters,(0,_process_component_class.updateHeritageClauses)(e,t,!0),processStructMembersV2(e,r,t))}function processStructMembersV2(r,a,o){var n=this,e=r.name.getText();const c=[],i={count:0},s=getOrCreateStructInfo(e),p=[];var t=[],u=_typescript.default.getAllDecorators(r);const d={componentFreezeParam:void 0};return(0,_process_component_class.decoratorAssignParams)(u,a,d),traverseStructInfo(s,p,t),r.members.forEach(function(e){var t;_newArrowCheck(this,n),_typescript.default.isConstructorDeclaration(e)?processStructConstructorV2(r.members,c,p,d):_typescript.default.isPropertyDeclaration(e)?c.push(processComponentProperty(e,s,o)):_typescript.default.isMethodDeclaration(e)&&e.name?(t=(0,_process_component_class.processComponentMethod)(e,a,o,i))&&c.push(t):c.push(e)}.bind(this)),(0,_process_component_class.validateBuildMethodCount)(i,r.name,o),updateStateVarsMethodNode(t,c),c.push((0,_process_component_class.addRerenderFunc)([])),_validate_ui_syntax.componentCollection.entryComponent===e&&c.push((0,_process_component_class.getEntryNameFunction)(_validate_ui_syntax.componentCollection.entryComponent)),c}function traverseStructInfo(e,t,r){var a=[...e.builderParamDecoratorSet,...e.eventDecoratorSet];for(const o of e.propertiesMap)e.staticPropertySet.has(o[0])||setPropertyStatement(e,t,o[0],o[1],a);for(const n of e.paramDecoratorMap)e.staticPropertySet.has(n[0])||r.push(updateParamNode(n[0]))}function setPropertyStatement(e,t,r,a,o){o.includes(r)?e.eventDecoratorSet.has(r)?t.push(createPropertyAssignNode(r,a||getDefaultValueForEvent(),!0)):t.push(createPropertyAssignNode(r,a,!0)):e.paramDecoratorMap.has(r)?(o=e.paramDecoratorMap.get(r),t.push(createInitParam(r,o.initializer))):t.push(createPropertyAssignNode(r,a,!1))}function getDefaultValueForEvent(){return _typescript.default.factory.createArrowFunction(void 0,void 0,[],void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock([],!1))}function createPropertyAssignNode(e,t,r){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(e)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsToken),setInitValue(e,t,r)))}function processComponentProperty(e,t,r){var a=e.name.getText(),o=_typescript.default.getAllDecorators(e);let n;return t.regularSet.has(a)||e.type||checkV2ComponentMemberType(e.name,a,r),t.staticPropertySet.has(a)&&(n=e.initializer),t.paramDecoratorMap.has(a)?processParamProperty(e,o,n):t.builderParamDecoratorSet.has(a)?processBuilderParamProperty(e,r,o,n):_typescript.default.factory.updatePropertyDeclaration(e,_typescript.default.concatenateDecoratorsAndModifiers(o,_typescript.default.getModifiers(e)),e.name,e.questionToken,e.type,n)}function checkV2ComponentMemberType(e,t,r){r.push({type:_utils.LogType.ERROR,message:`The property '${t}' must specify a type.`,pos:e.getStart()})}function processParamProperty(e,t,r){t=(0,_utils.removeDecorator)(t,_constant_define.default.REQUIRE);return _typescript.default.factory.updatePropertyDeclaration(e,_typescript.default.concatenateDecoratorsAndModifiers(t,_typescript.default.getModifiers(e)),e.name,e.questionToken,e.type,r)}function processBuilderParamProperty(e,t,r,a){(0,_process_component_member.judgeBuilderParamAssignedByBuilder)(e)&&t.push({type:_utils.LogType.ERROR,message:"BuilderParam property can only initialized by Builder function.",pos:e.getStart()});t=(0,_utils.removeDecorator)(r,_constant_define.default.BUILDER_PARAM);return _typescript.default.factory.updatePropertyDeclaration(e,_typescript.default.concatenateDecoratorsAndModifiers(t,_typescript.default.getModifiers(e)),e.name,e.questionToken,e.type,a)}function setInitValue(e,t,r){let a=t||_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED);return a=r?createInitNode(e,a):a}function createInitNode(e,t){return _typescript.default.factory.createConditionalExpression(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createStringLiteral(e),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.InKeyword),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS),_typescript.default.factory.createIdentifier(e)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ColonToken),t)}function parseComponentProperty(e,a,o,n){var c=this;e.members.forEach(function(e){var t,r;_newArrowCheck(this,c),_typescript.default.isPropertyDeclaration(e)&&(t=_typescript.default.getAllDecorators(e),r=_typescript.default.getModifiers(e),a.propertiesMap.set(e.name.getText(),e.initializer),parsePropertyDecorator(e,t,a,o,n),parsePropertyModifiers(e.name.getText(),a,r))}.bind(this))}function parsePropertyModifiers(e,t,r){var a=this;r&&r.length&&r.some(function(e){return _newArrowCheck(this,a),e.kind===_typescript.default.SyntaxKind.StaticKeyword}.bind(this))&&t.staticPropertySet.add(e)}class PropertyDecorator{constructor(){_defineProperty(this,"hasParam",!1),_defineProperty(this,"hasRequire",!1),_defineProperty(this,"hasOnce",!1),_defineProperty(this,"hasEvent",!1)}}const decoratorsFunc={Param:parseParamDecorator,Event:parseEventDecorator,Require:parseRequireDecorator,Once:parseOnceDecorator,Local:parseLocalDecorator,BuilderParam:parseBuilderParamDecorator,Provider:parseProviderDecorator,Consumer:parseConsumerDecorator};function parsePropertyDecorator(t,r,a,e,o){var n=new PropertyDecorator;let c=!0;for(let e=0;e<r.length;e++){var i=r[e].getText().replace(/\([^\(\)]*\)/,"").trim(),s=i.replace("@","").trim();decoratorsFunc[s]&&decoratorsFunc[s](n,t,a),!_constant_define.default.COMPONENT_MEMBER_DECORATOR_V2.includes(i)&&i!==_constant_define.default.DECORATOR_BUILDER_PARAM||(c=!1)}c&&a.regularSet.add(t.name.getText()),checkPropertyDecorator(n,t,e,o)}function checkPropertyDecorator(e,t,r,a){r&&a&&checkParamDecorator(e,t,r,a)}function parseParamDecorator(e,t,r){e.hasParam=!0;let a=r.paramDecoratorMap.get(t.name.getText());(a=a||new ParamDecoratorInfo).initializer=t.initializer,r.paramDecoratorMap.set(t.name.getText(),a)}function parseEventDecorator(e,t,r){e.hasEvent=!0,r.eventDecoratorSet.add(t.name.getText())}function parseRequireDecorator(e,t,r){e.hasRequire=!0;let a=r.paramDecoratorMap.get(t.name.getText());(a=a||new ParamDecoratorInfo).hasRequire=!0,r.paramDecoratorMap.set(t.name.getText(),a)}function parseOnceDecorator(e){e.hasOnce=!0}function parseLocalDecorator(e,t,r){r.localDecoratorSet.add(t.name.getText())}function parseProviderDecorator(e,t,r){r.providerDecoratorSet.add(t.name.getText())}function parseConsumerDecorator(e,t,r){r.consumerDecoratorSet.add(t.name.getText())}function parseBuilderParamDecorator(e,t,r){let a=_validate_ui_syntax.builderParamObjectCollection.get(r.structName);(a=a||new Set).add(t.name.getText()),_validate_ui_syntax.builderParamObjectCollection.set(r.structName,a),r.builderParamDecoratorSet.add(t.name.getText())}function checkParamDecorator(e,t,r,a){!e.hasParam||t.initializer||e.hasRequire||(0,_utils.addLog)(_utils.LogType.ERROR,"When a variable decorated with @Param is not assigned a default value, it must also be decorated with @Require.",t.getStart(),r,a),e.hasOnce&&!e.hasParam&&(0,_utils.addLog)(_utils.LogType.ERROR,"When a variable decorated with @Once, it must also be decorated with @Param.",t.getStart(),r,a),e.hasRequire&&!e.hasParam&&(0,_utils.addLog)(_utils.LogType.ERROR,"In a struct decorated with @ComponentV2, @Require can only be used with @Param.",t.getStart(),r,a)}function processStructConstructorV2(e,t,r,a){var o=this,a=a.componentFreezeParam||void 0,n=e.findIndex(function(e){return _newArrowCheck(this,o),_typescript.default.isConstructorDeclaration(e)}.bind(this));-1!==n&&(e=e[n],t.splice(n,0,_typescript.default.factory.updateConstructorDeclaration(e,_typescript.default.getModifiers(e),createConstructorParams(),updateConstructorBody(e.body,r,a))))}function createConstructorParams(){var t=this;return[_pre_define.COMPONENT_CONSTRUCTOR_PARENT,_pre_define.COMPONENT_CONSTRUCTOR_PARAMS,_pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE_PU,_pre_define.ELMTID,_pre_define.COMPONENT_PARAMS_LAMBDA_FUNCTION,_pre_define.CUSTOM_COMPONENT_EXTRAINFO].map(function(e){return _newArrowCheck(this,t),_create_ast_node_utils.default.createParameterDeclaration(e)}.bind(this))}function updateConstructorBody(e,t,r){var a=[createSuperV2()];return e.statements&&a.push(...e.statements),a.push(...t,_create_ast_node_utils.default.createFinalizeConstruction(r)),_typescript.default.factory.createBlock(a,!0)}function createSuperV2(){var t=this,e=[_pre_define.COMPONENT_CONSTRUCTOR_PARENT,_pre_define.ELMTID,_pre_define.CUSTOM_COMPONENT_EXTRAINFO];return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createSuper(),void 0,e.map(function(e){return _newArrowCheck(this,t),_typescript.default.factory.createIdentifier(e)}.bind(this))))}function createInitParam(e,t){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(_constant_define.default.INIT_PARAM)),void 0,[_typescript.default.factory.createStringLiteral(e),_typescript.default.factory.createConditionalExpression(_typescript.default.factory.createParenthesizedExpression(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.AmpersandAmpersandToken),createParamBinaryNode(e))),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS),_typescript.default.factory.createIdentifier(e)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ColonToken),t||_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED))]))}function updateParamNode(e){return _typescript.default.factory.createIfStatement(createParamBinaryNode(e),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(_constant_define.default.UPDATE_PARAM)),void 0,[_typescript.default.factory.createStringLiteral(e),_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS),_typescript.default.factory.createIdentifier(e))]))],!0))}function createParamBinaryNode(e){return _typescript.default.factory.createBinaryExpression(_typescript.default.factory.createStringLiteral(e),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.InKeyword),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS))}function updateStateVarsMethodNode(e,t){e.length&&t.push(_typescript.default.factory.createMethodDeclaration([_typescript.default.factory.createToken(_typescript.default.SyntaxKind.PublicKeyword)],void 0,_typescript.default.factory.createIdentifier(_constant_define.default.UPDATE_STATE_VARS),void 0,void 0,[_create_ast_node_utils.default.createParameterDeclaration(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS)],void 0,_typescript.default.factory.createBlock([emptyJudgeForParamsNode(),...e],!0)))}function emptyJudgeForParamsNode(){return _typescript.default.factory.createIfStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsEqualsToken),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED)),_typescript.default.factory.createBlock([_typescript.default.factory.createReturnStatement(void 0)],!0),void 0)}function resetStructMapInEts(){structMapInEts.clear()}var _default={getOrCreateStructInfo:getOrCreateStructInfo,processStructComponentV2:processStructComponentV2,parseComponentProperty:parseComponentProperty,resetStructMapInEts:resetStructMapInEts,getAliasStructInfo:getAliasStructInfo};exports.default=_default;