"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TEMPORARYS=exports.SRC_MAIN=exports.ProcessFileInfo=exports.LogType=exports.IGNORE_ERROR_CODE=exports.EntryOptionValue=exports.CompilationTimeStatistics=exports.BUILD=void 0,exports.addLog=addLog,exports.circularFile=circularFile,exports.componentInfo=void 0,exports.createGetShared=createGetShared,exports.createGetSharedForVariable=createGetSharedForVariable,exports.differenceResourcesRawfile=differenceResourcesRawfile,exports.emitLogInfo=emitLogInfo,exports.genLoaderOutPathOfHar=genLoaderOutPathOfHar,exports.genTemporaryPath=genTemporaryPath,exports.generateSourceFilesInHar=generateSourceFilesInHar,exports.getAllComponentsOrModules=getAllComponentsOrModules,exports.getBelongModuleInfo=getBelongModuleInfo,exports.getExtensionIfUnfullySpecifiedFilepath=getExtensionIfUnfullySpecifiedFilepath,exports.getHotReloadFiles=getHotReloadFiles,exports.getMessage=getMessage,exports.getPossibleBuilderTypeParameter=getPossibleBuilderTypeParameter,exports.getProjectRootPath=getProjectRootPath,exports.getResolveModules=getResolveModules,exports.getRollupCache=getRollupCache,exports.getStoredFileInfo=getStoredFileInfo,exports.getTransformLog=getTransformLog,exports.harFilesRecord=void 0,exports.hasDecorator=hasDecorator,exports.hotReloadIncrementalTime=void 0,exports.isFileInProject=isFileInProject,exports.isHarmonyOs=isHarmonyOs,exports.isLinux=isLinux,exports.isMac=isMac,exports.isPackageModulesFile=isPackageModulesFile,exports.isString=isString,exports.isWindows=isWindows,exports.judgeUseSharedStorageForExpresion=judgeUseSharedStorageForExpresion,exports.maxFilePathLength=maxFilePathLength,exports.mkDir=mkDir,exports.mkdirsSync=mkdirsSync,exports.nodeLargeOrEqualTargetVersion=nodeLargeOrEqualTargetVersion,exports.parseErrorMessage=parseErrorMessage,exports.readFile=readFile,exports.removeDecorator=removeDecorator,exports.removeDir=removeDir,exports.repeatLog=void 0,exports.resetUtils=resetUtils,exports.resolveModuleNamesTime=void 0,exports.resourcesRawfile=resourcesRawfile,exports.setChecker=setChecker,exports.setRollupCache=setRollupCache,exports.shouldWriteChangedList=shouldWriteChangedList,exports.startTimeStatisticsLocation=startTimeStatisticsLocation,exports.stopTimeStatisticsLocation=stopTimeStatisticsLocation,exports.storedFileInfo=void 0,exports.toHashData=toHashData,exports.toUnixPath=toUnixPath,exports.tryToLowerCasePath=tryToLowerCasePath,exports.unlinkSync=unlinkSync,exports.validateFilePathLength=validateFilePathLength,exports.validateFilePathLengths=validateFilePathLengths,exports.writeCollectionFile=writeCollectionFile,exports.writeFileSync=writeFileSync,exports.writeUseOSFiles=writeUseOSFiles;var _path=_interopRequireDefault(require("path")),_typescript=_interopRequireDefault(require("typescript")),_fs=_interopRequireDefault(require("fs")),_os=_interopRequireDefault(require("os")),_uglifyJs=_interopRequireDefault(require("uglify-js")),_main=require("../main"),_crypto=require("crypto"),_pre_define=require("./pre_define");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}let LogType=function(e){return e.ERROR="ERROR",e.WARN="WARN",e.NOTE="NOTE",e}({});exports.LogType=LogType;const TEMPORARYS="temporarys",BUILD=(exports.TEMPORARYS=TEMPORARYS,"build"),SRC_MAIN=(exports.BUILD=BUILD,"src/main"),red=(exports.SRC_MAIN=SRC_MAIN,"[31m"),reset="[39m",WINDOWS="Windows_NT",LINUX="Linux",MAC="Darwin",HARMONYOS="HarmonyOS",repeatLog=new Map;function emitLogInfo(t,e,r=!1,o=null){var i=this;e&&e.length&&e.forEach(function(e){switch(_newArrowCheck(this,i),e.type){case LogType.ERROR:r?t.error("[31m"+getMessage(e.fileName||o,e,!0)):t.emitError(getMessage(e.fileName||t.resourcePath,e));break;case LogType.WARN:r?t.warn("[33m"+getMessage(e.fileName||o,e,!0)):t.emitWarning(getMessage(e.fileName||t.resourcePath,e));break;case LogType.NOTE:r?t.info("[34m"+getMessage(e.fileName||o,e,!0)):t.emitWarning(getMessage(t.resourcePath,e))}}.bind(this))}function addLog(e,t,r,o,i){r=i.getLineAndCharacterOfPosition(r);o.push({type:e,message:t,line:r.line+1,column:r.character+1,fileName:i.fileName})}function getMessage(e,t,r=!1){let o;return o=t.line&&t.column?`BUILD${t.type} File: ${e}:${t.line}:${t.column}
 `+t.message:`BUILD${t.type} File: ${e}
 `+t.message,o=r?o.replace(/^BUILD/,"ArkTS:"):o}function getTransformLog(e){var r=this;const o=e.sourceFile;return e.errors.map(function(e){var t;return _newArrowCheck(this,r),e.pos||0===e.pos?e.column&&e.line||(t=o.getLineAndCharacterOfPosition(e.pos),e.line=t.line+1,e.column=t.character+1):(e.line=e.line||void 0,e.column=e.column||void 0),e.fileName||(e.fileName=o.fileName),e}.bind(this))}exports.repeatLog=repeatLog;class ComponentInfo{constructor(){_defineProperty(this,"_id",0),_defineProperty(this,"_componentNames",new Set(["ForEach"]))}set id(e){this._id=e}get id(){return this._id}set componentNames(e){this._componentNames=e}get componentNames(){return this._componentNames}}let componentInfo=new ComponentInfo;function hasDecorator(e,t,r=null,o=null){var i=_typescript.default.getAllDecorators(e);if(i&&i.length){var s={Extend:!1,AnimatableExtend:!1};for(let e=0;e<i.length;e++){var n=i[e].getText().replace(/\(.*\)$/,"").replace(/\s*/g,"").trim();if(o&&_pre_define.EXTEND_DECORATORS.includes(t))n===_pre_define.COMPONENT_EXTEND_DECORATOR&&(s.Extend=!0),n===_pre_define.COMPONENT_ANIMATABLE_EXTEND_DECORATOR&&(s.AnimatableExtend=!0);else if(n===t)return r&&r.push(...i.slice(e+1),...i.slice(0,e)),!0}return o&&s.Extend&&s.AnimatableExtend&&o.push({type:LogType.ERROR,message:"The function can not be decorated by '@Extend' and '@AnimatableExtend' at the same time.",pos:e.getStart()}),t===_pre_define.COMPONENT_EXTEND_DECORATOR&&s.Extend||t===_pre_define.COMPONENT_ANIMATABLE_EXTEND_DECORATOR&&s.AnimatableExtend}return!1}exports.componentInfo=componentInfo;const STATEMENT_EXPECT=1128,SEMICOLON_EXPECT=1005,STATESTYLES_EXPECT=1003,IGNORE_ERROR_CODE=[STATEMENT_EXPECT,SEMICOLON_EXPECT,STATESTYLES_EXPECT];function readFile(t,r){var o=this;try{_fs.default.readdirSync(t).forEach(function(e){_newArrowCheck(this,o);e=_path.default.join(t,e);_fs.default.statSync(e).isDirectory()?readFile(e,r):r.push(e)}.bind(this))}catch(e){console.error(red,"ArkTS ERROR: "+e,reset)}}function circularFile(o,i){o&&i&&_fs.default.readdir(o,function(e,t){var r=this;t&&t.forEach(function(e){_newArrowCheck(this,r);var t=_path.default.resolve(o,e),e=_path.default.resolve(i,e);(_fs.default.statSync(t).isFile()?copyFile:circularFile)(t,e)}.bind(this))})}function copyFile(e,t){try{var r=_path.default.join(t,"..");if(_fs.default.existsSync(r)&&_fs.default.statSync(r).isDirectory()||mkDir(r),!_fs.default.existsSync(t)){var o=_fs.default.createReadStream(e);const i=_fs.default.createWriteStream(t);o.pipe(i),o.on("close",function(){i.end()})}}catch(e){throw e.message}}function mkDir(e){var t=_path.default.join(e,"..");_fs.default.existsSync(t)&&!_fs.default.statSync(t).isFile()||mkDir(t),_fs.default.mkdirSync(e)}function toUnixPath(e){var t;return/^win/.test(require("os").platform())?(t=e.split(_path.default.sep),_path.default.posix.join(...t)):e}function tryToLowerCasePath(e){return toUnixPath(e).toLowerCase()}function toHashData(e){var e=_fs.default.readFileSync(e).toString(),t=(0,_crypto.createHash)("sha256");return t.update(e),t.digest("hex")}function writeFileSync(e,t){var r;_fs.default.existsSync(e)||(r=_path.default.join(e,".."),_fs.default.existsSync(r)&&!_fs.default.statSync(r).isFile())||mkDir(r),_fs.default.writeFileSync(e,t)}function genLoaderOutPathOfHar(e,t,r,o,i){e=toUnixPath(e),r=toUnixPath(r);t=toUnixPath(t),o=toUnixPath(o).replace(toUnixPath(i),""),i=e.replace(t,"").replace(o,"");return _path.default.join(r,i)}function genTemporaryPath(t,e,r,o,i,s=!1){if(t=toUnixPath(t).replace(/\.[cm]js$/,_pre_define.EXTNAME_JS),e=toUnixPath(e),"rollup"===process.env.compileTool){let e="";e=i?i.isLocalDependency?(n=s&&o.compileHar?"":i.moduleName,t.replace(toUnixPath(i.belongModulePath),n)):t.replace(toUnixPath(i.belongProjectPath),""):t.replace(toUnixPath(o.projectRootPath),"");var n=_path.default.join(r,e);return n}if(isPackageModulesFile(t,o)){i=o.packageDir,n=toUnixPath(_path.default.join(o.projectRootPath,i));let e="";return e=-1===t.indexOf(n)?(o=toUnixPath(o.projectRootPath),o=(o=t.replace(o,"")).substring(o.indexOf(i)+i.length+1),_path.default.join(r,s?"":_pre_define.TEMPORARY,i,_pre_define.MAIN,o)):t.replace(n,_path.default.join(r,s?"":_pre_define.TEMPORARY,i,_pre_define.AUXILIARY))}return-1!==t.indexOf(e)?(o=t.replace(e,""),_path.default.join(r,s?"":_pre_define.TEMPORARY,o)):""}function isPackageModulesFile(e,t){e=toUnixPath(e);var r=toUnixPath(t.projectRootPath),r=e.replace(r,""),o=t.packageDir;if(-1!==r.indexOf(o)){r=toUnixPath(_path.default.resolve(t.projectRootPath,o));if(-1!==e.indexOf(r))return!0;if(t.modulePathMap)for(const s in t.modulePathMap){var i=t.modulePathMap[s],i=toUnixPath(_path.default.resolve(i,o));if(-1!==e.indexOf(i))return!0}}return!1}exports.IGNORE_ERROR_CODE=IGNORE_ERROR_CODE;const harFilesRecord=new Map;function generateSourceFilesInHar(e,t,r,o,i){var i=getBelongModuleInfo(e,i,o.projectRootPath);let s=genTemporaryPath(e,o.compileShared?o.projectRootPath:o.moduleRootPath,o.compileShared||o.byteCodeHar?_path.default.resolve(o.aceModuleBuild,"../etsFortgz"):o.cachePath,o,i,o.compileShared);s.match(new RegExp(o.packageDir))||(s=s.replace(/\.ets$/,r).replace(/\.ts$/,r),"uglify"===o.obfuscateHarType&&".js"===r&&(t=_uglifyJs.default.minify(t).code),o.compileMode===_pre_define.ESMODULE&&/\.d\.e?ts$/.test(s)?(i={sourcePath:e=toUnixPath(e),originalDeclarationCachePath:s,originalDeclarationContent:t},harFilesRecord.set(e,i)):(mkdirsSync(_path.default.dirname(s)),_fs.default.writeFileSync(s,t)))}function mkdirsSync(e){return!!_fs.default.existsSync(e)||!!mkdirsSync(_path.default.dirname(e))&&(_fs.default.mkdirSync(e),!0)}function nodeLargeOrEqualTargetVersion(e){return e<=parseInt(process.versions.node.split(".")[0])}function removeDir(e){_fs.default.existsSync(e)&&(nodeLargeOrEqualTargetVersion(16)?_fs.default.rmSync(e,{recursive:!0}):_fs.default.rmdirSync(e,{recursive:!0}))}function parseErrorMessage(e){var t=this,e=e.split("\n");let r="";return e.forEach(function(e){_newArrowCheck(this,t),/^at/.test(e.trim())||(r=r+e+"\n")}.bind(this)),r}function isWindows(){return _os.default.type()===WINDOWS}function isLinux(){return _os.default.type()===LINUX}function isMac(){return _os.default.type()===MAC}function isHarmonyOs(){return _os.default.type()===HARMONYOS}function maxFilePathLength(){return isWindows()?32766:isLinux()||isHarmonyOs()?4095:isMac()?1016:-1}function validateFilePathLength(e,t){return maxFilePathLength()<0?(t.error(red,"Unknown OS platform",reset),process.exitCode=_pre_define.FAIL,!1):0<e.length&&e.length<=maxFilePathLength()||(e.length>maxFilePathLength()?t.error(red,`The length of ${e} exceeds the limitation of current platform, which is `+maxFilePathLength()+". Please try moving the project folder to avoid deeply nested file path and try again",reset):t.error(red,"Validate file path failed",reset),process.exitCode=_pre_define.FAIL,!1)}function validateFilePathLengths(e,t){var r=this;return e.forEach(function(e){return _newArrowCheck(this,r),!!validateFilePathLength(e,t)}.bind(this)),!0}function unlinkSync(e){_fs.default.existsSync(e)&&_fs.default.unlinkSync(e)}function getExtensionIfUnfullySpecifiedFilepath(e){if(_fs.default.existsSync(e)&&_fs.default.statSync(e).isFile())return"";let t=_pre_define.EXTNAME_ETS;return _fs.default.existsSync(e+".ts")&&_fs.default.statSync(e+".ts").isFile()?t=".ts":_fs.default.existsSync(e+".d.ts")&&_fs.default.statSync(e+".d.ts").isFile()?t=".d.ts":_fs.default.existsSync(e+".d.ets")&&_fs.default.statSync(e+".d.ets").isFile()?t=".d.ets":_fs.default.existsSync(e+".js")&&_fs.default.statSync(e+".js").isFile()?t=".js":_fs.default.existsSync(e+".json")&&_fs.default.statSync(e+".json").isFile()&&(t=".json"),t}function shouldWriteChangedList(e,t){return!(!(_main.projectConfig.compileMode===_pre_define.ESMODULE&&"true"===process.env.watchMode&&!_main.projectConfig.isPreview&&_main.projectConfig.changedFileList&&t.length+e.length)||"rollup"!==process.env.compileTool&&1===e.length&&e[0]===_main.projectConfig.projectPath&&!t.length)}exports.harFilesRecord=harFilesRecord;const hotReloadIncrementalTime={hotReloadIncrementalStartTime:"",hotReloadIncrementalEndTime:""};exports.hotReloadIncrementalTime=hotReloadIncrementalTime;let allModifiedFiles=new Set;function getHotReloadFiles(e,t,r){var o=this;return hotReloadIncrementalTime.hotReloadIncrementalStartTime=(new Date).getTime().toString(),t=t.map(function(e){return _newArrowCheck(this,o),_path.default.relative(_main.projectConfig.projectPath,e)}.bind(this)),{modifiedFiles:[...allModifiedFiles=new Set([...allModifiedFiles,...e.filter(function(e){return _newArrowCheck(this,o),_fs.default.statSync(e).isFile()&&(r.has(e)||![".ets",".ts",".js"].includes(_path.default.extname(e)))}.bind(this)).map(function(e){return _newArrowCheck(this,o),_path.default.relative(_main.projectConfig.projectPath,e)}.bind(this))].filter(function(e){return _newArrowCheck(this,o),!t.includes(e)}.bind(this)))],removedFiles:[...t]}}function getResolveModules(e,t){return t?[_path.default.resolve(e,"../../../../../"),_path.default.resolve(e,"../../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../../../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../../")]:[_path.default.resolve(e,"../../../../"),_path.default.resolve(e,"../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../")]}function writeUseOSFiles(e){let t="";var r;_fs.default.existsSync(_main.projectConfig.aceSoPath)?t=_fs.default.readFileSync(_main.projectConfig.aceSoPath,"utf-8")+"\n":(r=_path.default.resolve(_main.projectConfig.aceSoPath,".."),_fs.default.existsSync(r)&&!_fs.default.statSync(r).isFile()||mkDir(r)),_fs.default.writeFileSync(_main.projectConfig.aceSoPath,t+Array.from(e).join("\n"))}function writeCollectionFile(e,t,r,o,i=null,s=void 0){for(var n of t.keys()){var a;0===t.get(n).size?r.delete(n):i&&!i.has(n)||(a=_main.projectConfig.projectRootPath?_path.default.relative(_main.projectConfig.projectRootPath,n):n,r.set(a,Array.from(t.get(n))))}var l=JSON.stringify(Object.fromEntries(r),null,2);writeFileSync(_path.default.resolve(e,o),l),s&&writeFileSync(_path.default.resolve(s,o),l)}function getAllComponentsOrModules(e,t){var t=_path.default.resolve(_main.projectConfig.cachePath,t),r=new Map;if(_fs.default.existsSync(t)){var o,i=require(t);for(o in i)e.has(o)&&r.set(o,i[o])}return r}function getPossibleBuilderTypeParameter(e){var t=this;const r=[];return _main.partialUpdateConfig.builderCheck||(isDollarParameter(e)?e[0].type.members.forEach(function(e){_newArrowCheck(this,t),e.name&&_typescript.default.isIdentifier(e.name)&&r.push(e.name.escapedText.toString())}.bind(this)):e.forEach(function(e){_newArrowCheck(this,t),e.name&&_typescript.default.isIdentifier(e.name)&&r.push(e.name.escapedText.toString())}.bind(this))),r}function isDollarParameter(e){return 1===e.length&&e[0].name&&_typescript.default.isIdentifier(e[0].name)&&e[0].name.escapedText.toString()===_pre_define.$$&&e[0].type&&_typescript.default.isTypeLiteralNode(e[0].type)&&e[0].type.members&&0<e[0].type.members.length}class ProcessFileInfo{constructor(){_defineProperty(this,"buildStart",!0),_defineProperty(this,"wholeFileInfo",{}),_defineProperty(this,"transformedFiles",new Set),_defineProperty(this,"cachedFiles",[]),_defineProperty(this,"shouldHaveEntry",[]),_defineProperty(this,"resourceToFile",{}),_defineProperty(this,"lastResourceList",new Set),_defineProperty(this,"resourceList",new Set),_defineProperty(this,"shouldInvalidFiles",new Set),_defineProperty(this,"resourceTableChanged",!1),_defineProperty(this,"currentArkTsFile",void 0),_defineProperty(this,"reUseProgram",!1),_defineProperty(this,"resourcesArr",new Set),_defineProperty(this,"lastResourcesSet",new Set),_defineProperty(this,"transformCacheFiles",{}),_defineProperty(this,"processBuilder",!1),_defineProperty(this,"processGlobalBuilder",!1),_defineProperty(this,"processLocalBuilder",!1),_defineProperty(this,"builderLikeCollection",new Set),_defineProperty(this,"newTsProgram",void 0),_defineProperty(this,"changeFiles",[]),_defineProperty(this,"isFirstBuild",!0),_defineProperty(this,"processForEach",0),_defineProperty(this,"processLazyForEach",0),_defineProperty(this,"processRepeat",!1),_defineProperty(this,"isAsPageImport",!1),_defineProperty(this,"overallObjectLinkCollection",new Map),_defineProperty(this,"overallLinkCollection",new Map),_defineProperty(this,"overallBuilderParamCollection",new Map),_defineProperty(this,"lazyForEachInfo",{forEachParameters:null,isDependItem:!1}),_defineProperty(this,"routerInfo",new Map),_defineProperty(this,"hasLocalBuilderInFile",!1)}addGlobalCacheInfo(e,t,r){if(this.buildStart){for(const o in t)this.resourceToFile[o]=new Set(t[o]);this.lastResourceList=new Set(e)}this.resourceTableChanged&&this.compareResourceDiff(),r&&(this.transformCacheFiles=r)}addFileCacheInfo(e,t){t&&"moduleJson"===process.env.compileMode&&(Array.isArray(t.fileToResourceList)?t.fileToResourceList=new Set(t.fileToResourceList):t.fileToResourceList=new Set),e.match(/(?<!\.d)\.(ets)$/)?this.wholeFileInfo[e]=new SpecialArkTSFileInfo(t):e.match(/(?<!\.d)\.(ts)$/)&&"moduleJson"===process.env.compileMode&&(this.wholeFileInfo[e]=new TSFileInfo(t))}collectTransformedFiles(e){e.match("moduleJson"===process.env.compileMode?/(?<!\.d)\.(ets|ts)$/:/(?<!\.d)\.(ets)$/)&&this.transformedFiles.add(e)}collectCachedFiles(e){e.match("moduleJson"===process.env.compileMode?/(?<!\.d)\.(ets|ts)$/:/(?<!\.d)\.(ets)$/)&&this.cachedFiles.push(e)}judgeShouldHaveEntryFiles(t){var r=this;this.shouldHaveEntry=Object.values(_main.projectConfig.entryObj).filter(function(e){return _newArrowCheck(this,r),!t.has(e.toLowerCase())&&e.match(/(?<!\.d)\.(ets)$/)}.bind(this))}saveCacheFileInfo(e){if("moduleJson"===process.env.compileMode){var t=e.get("fileCacheInfo")||{},r=e.get("resourceToFileCacheInfo")||{};for(const s in r)r[s]=new Set(r[s]);var o=Object.assign(r,this.resourceToFile);for(const n of this.transformedFiles){t[n]=this.wholeFileInfo[n].fileInfo;for(const a of this.wholeFileInfo[n].newFileToResourceList)t[n].fileToResourceList.has(a)||this.resourceToFileBecomeSet(o,a,n);for(const l of t[n].fileToResourceList)this.wholeFileInfo[n].newFileToResourceList.has(l)||o[l].delete(n);t[n].fileToResourceList=[...this.wholeFileInfo[n].newFileToResourceList]}for(const c of this.cachedFiles)t[c].fileToResourceList=[...t[c].fileToResourceList];for(const f in this.resourceToFile=o)o[f]=[...o[f]];e.set("fileCacheInfo",t),e.set("resourceListCacheInfo",[...this.resourceList]),e.set("resourceToFileCacheInfo",o)}else{var i=e.get("fileCacheInfo")||{};for(const d of this.transformedFiles)i[d]=this.wholeFileInfo[d].fileInfo;e.set("fileCacheInfo",i)}}resourceToFileBecomeSet(e,t,r){e[t]||(e[t]=new Set),e[t]instanceof Set?e[t].add(r):Array.isArray(e[t])&&(e[t]=new Set(e[t]),e[t].add(r))}updateResourceList(e){this.resourceList.add(e)}compareResourceDiff(){var t=this;for(const e of this.lastResourceList)!this.resourceList.has(e)&&this.resourceToFile[e]&&this.resourceToFile[e].forEach(function(e){_newArrowCheck(this,t),this.shouldInvalidFiles.add(e)}.bind(this));for(const r of this.resourceList)this.resourceToFile[r]||(this.resourceToFile[r]=new Set),this.lastResourceList.has(r)||this.resourceToFile[r].forEach(function(e){_newArrowCheck(this,t),this.shouldInvalidFiles.add(e)}.bind(this))}collectResourceInFile(e,t){this.wholeFileInfo[t]&&this.wholeFileInfo[t].newFileToResourceList.add(e)}clearCollectedInfo(e){this.buildStart=!1,this.resourceTableChanged=!1,this.isAsPageImport=!1,this.saveCacheFileInfo(e),this.transformedFiles=new Set,this.cachedFiles=[],this.lastResourceList=new Set([...this.resourceList]),this.shouldInvalidFiles.clear(),this.resourcesArr.clear()}setCurrentArkTsFile(){this.currentArkTsFile=new SpecialArkTSFileInfo}getCurrentArkTsFile(){return this.currentArkTsFile}}let storedFileInfo=new(exports.ProcessFileInfo=ProcessFileInfo);exports.storedFileInfo=storedFileInfo;class TSFileInfo{constructor(e,t){_defineProperty(this,"fileInfo",{fileToResourceList:new Set}),_defineProperty(this,"newFileToResourceList",new Set),t||(this.fileInfo=e||this.fileInfo)}}class SpecialArkTSFileInfo extends TSFileInfo{constructor(e){super(e,!0),_defineProperty(this,"fileInfo",{hasEntry:!1,fileToResourceList:new Set}),_defineProperty(this,"recycleComponents",new Set([])),_defineProperty(this,"compFromDETS",new Set),_defineProperty(this,"animatableExtendAttribute",new Map),_defineProperty(this,"pkgName",void 0),this.fileInfo=e||this.fileInfo}get hasEntry(){return this.fileInfo.hasEntry}set hasEntry(e){this.fileInfo.hasEntry=e}}function setChecker(){_main.globalProgram.program?(_main.globalProgram.checker=_main.globalProgram.program.getTypeChecker(),_main.globalProgram.strictChecker=_main.globalProgram.program.getLinterTypeChecker()):_main.globalProgram.watchProgram&&(_main.globalProgram.checker=_main.globalProgram.watchProgram.getCurrentProgram().getProgram().getTypeChecker())}function resourcesRawfile(t,r,o=""){var i=this;_fs.default.existsSync(process.env.rawFileResource)&&_fs.default.statSync(t).isDirectory()&&_fs.default.readdirSync(t).forEach(function(e){_newArrowCheck(this,i),_fs.default.statSync(_path.default.join(t,e)).isDirectory()?resourcesRawfile(_path.default.join(t,e),r,o?o+"/"+e:e):o?r.add(o+"/"+e):r.add(e)}.bind(this))}function differenceResourcesRawfile(e,t){if(0===e.size||e.size!==t.size)return 0!==e.size||e.size!==t.size;for(const r of e.values())if(!t.has(r))return!0;return!1}function isString(e){return"string"==typeof e}function getRollupCacheStoreKey(e){return[e.compileSdkVersion,e.compatibleSdkVersion,e.runtimeOS,e.etsLoaderPath].join("#")}function getRollupCacheKey(e){var t=e.widgetCompile?"widget":"non-widget";let r="non-ohosTest";return e.testFrameworkPar&&(r=JSON.stringify(e.testFrameworkPar)),[e.entryModuleName,e.targetName,t,r,e.needCoverageInsert,e.isOhosTest].join("#")}function clearRollupCacheStore(e,t){if(e)for(var r of e.keys())r!==t&&e.unmount(r)}function startTimeStatisticsLocation(e){e&&e.start()}function stopTimeStatisticsLocation(e){e&&e.stop()}let resolveModuleNamesTime;exports.resolveModuleNamesTime=resolveModuleNamesTime;class CompilationTimeStatistics{constructor(e,t,r){_defineProperty(this,"hookEventFactory",void 0),_defineProperty(this,"createProgramTime",void 0),_defineProperty(this,"runArkTSLinterTime",void 0),_defineProperty(this,"diagnosticTime",void 0),_defineProperty(this,"scriptSnapshotTime",void 0),_defineProperty(this,"processImportTime",void 0),_defineProperty(this,"processComponentClassTime",void 0),_defineProperty(this,"validateEtsTime",void 0),_defineProperty(this,"tsProgramEmitTime",void 0),_defineProperty(this,"shouldEmitJsTime",void 0),_defineProperty(this,"transformNodesTime",void 0),_defineProperty(this,"emitTime",void 0),_defineProperty(this,"printNodeTime",void 0),_defineProperty(this,"noSourceFileRebuildProgramTime",void 0),_defineProperty(this,"etsTransformBuildStartTime",void 0),_defineProperty(this,"etsTransformLoadTime",void 0),_defineProperty(this,"processKitImportTime",void 0),_defineProperty(this,"processUISyntaxTime",void 0),e&&e.getHookEventFactory&&("etsChecker"===t&&"buildStart"===r&&e.getHookEventFactory(t,r)?(this.hookEventFactory=e.getHookEventFactory(t,r),this.createProgramTime=this.hookEventFactory.createEvent("createProgram"),this.runArkTSLinterTime=this.hookEventFactory.createEvent("arkTSLinter"),this.diagnosticTime=this.hookEventFactory.createEvent("diagnostic"),this.scriptSnapshotTime=this.createProgramTime.createSubEvent("scriptSnapshot"),exports.resolveModuleNamesTime=resolveModuleNamesTime=this.hookEventFactory.createEvent("resolveModuleNames")):"etsTransform"===t&&"transform"===r&&e.getHookEventFactory(t,r)?(this.hookEventFactory=e.getHookEventFactory(t,r),this.validateEtsTime=this.hookEventFactory.createEvent("validateEts"),this.tsProgramEmitTime=this.hookEventFactory.createEvent("tsProgramEmit"),this.shouldEmitJsTime=this.hookEventFactory.createEvent("shouldEmitJs"),this.transformNodesTime=this.tsProgramEmitTime.createSubEvent("transformNodes"),this.emitTime=this.tsProgramEmitTime.createSubEvent("emit"),this.printNodeTime=this.hookEventFactory.createEvent("printNode"),this.noSourceFileRebuildProgramTime=this.hookEventFactory.createEvent("noSourceFileRebuildProgram"),this.processKitImportTime=this.tsProgramEmitTime.createSubEvent("processKitImport"),this.processUISyntaxTime=this.tsProgramEmitTime.createSubEvent("processUISyntax"),this.processImportTime=this.processUISyntaxTime.createSubEvent("processImport"),this.processComponentClassTime=this.processUISyntaxTime.createSubEvent("processComponentClass")):"etsTransform"===t&&"buildStart"===r&&e.getHookEventFactory(t,r)?(this.hookEventFactory=e.getHookEventFactory(t,r),this.etsTransformBuildStartTime=this.hookEventFactory.createEvent("etsTransformBuildStart")):"etsTransform"===t&&"load"===r&&e.getHookEventFactory(t,r)&&(this.hookEventFactory=e.getHookEventFactory(t,r),this.etsTransformLoadTime=this.hookEventFactory.createEvent("etsTransformLoad")))}}function resetUtils(){exports.componentInfo=componentInfo=new ComponentInfo,harFilesRecord.clear(),exports.storedFileInfo=storedFileInfo=new ProcessFileInfo}function getStoredFileInfo(){return storedFileInfo}exports.CompilationTimeStatistics=CompilationTimeStatistics;class EntryOptionValue{constructor(){_defineProperty(this,"routeName",void 0),_defineProperty(this,"storage",void 0),_defineProperty(this,"useSharedStorage",void 0)}}function sharedNode(){return _typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE_TYPE_PU),_typescript.default.factory.createIdentifier(_pre_define.GET_SHARED)),void 0,[])}function createGetShared(e){return _typescript.default.factory.createConditionalExpression(e.useSharedStorage,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),sharedNode(),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ColonToken),e.storage||_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED))}function createGetSharedForVariable(e,t=!0){return _typescript.default.factory.createConditionalExpression(_typescript.default.factory.createPropertyAccessExpression(e,_typescript.default.factory.createIdentifier(_pre_define.USE_SHARED_STORAGE)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),sharedNode(),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ColonToken),t?_typescript.default.factory.createPropertyAccessExpression(e,_typescript.default.factory.createIdentifier(_pre_define.STORAGE)):_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED))}function judgeUseSharedStorageForExpresion(e){return _typescript.default.factory.createBinaryExpression(e,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.AmpersandAmpersandToken),_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createPropertyAccessExpression(e,_typescript.default.factory.createIdentifier(_pre_define.USE_SHARED_STORAGE)),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.ExclamationEqualsToken),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED)))}function getRollupCache(e,t,r){var o;if(e)return e.cache?e.cache.get(r):e.cacheStoreManager?(o=getRollupCacheStoreKey(t),t=getRollupCacheKey(t)+"#"+r,clearRollupCacheStore(e.cacheStoreManager,o),e.cacheStoreManager.mount(o).getCache(t)):void 0}function setRollupCache(e,t,r,o){var i;e&&(e.cache?e.cache.set(r,o):e.cacheStoreManager&&(i=getRollupCacheStoreKey(t),t=getRollupCacheKey(t)+"#"+r,e.cacheStoreManager.mount(i).setCache(t,o)))}function removeDecorator(e,t){var r=this;return e.filter(function(e){return _newArrowCheck(this,r),!_typescript.default.isDecorator(e)||!_typescript.default.isIdentifier(e.expression)||e.expression.escapedText.toString()!==t}.bind(this))}function isFileInProject(e,t){t=toUnixPath(_path.default.relative(toUnixPath(t),toUnixPath(e)));return _fs.default.existsSync(e)&&_fs.default.statSync(e).isFile()&&!t.startsWith("../")}function getProjectRootPath(e,t,r){if(r)for(const o of r)if(isFileInProject(e,o))return o;return t.projectRootPath}function getBelongModuleInfo(e,t,r){for(const o of Object.keys(t))if(toUnixPath(e).startsWith(toUnixPath(t[o])+"/"))return{isLocalDependency:!0,moduleName:o,belongModulePath:t[o]};return{isLocalDependency:!1,moduleName:"",belongModulePath:r}}exports.EntryOptionValue=EntryOptionValue;