"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkAotConfig=checkAotConfig,exports.generateAot=generateAot;var fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),os=_interopRequireWildcard(require("os")),_pre_define=require("./pre_define"),_utils=require("./utils"),_ark_utils=require("./ark_utils");function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,i,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((i=o?Object.getOwnPropertyDescriptor(e,r):null)&&(i.get||i.set)?Object.defineProperty(n,r,i):n[r]=e[r]);return n.default=e,t&&t.set(e,n),n}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const hostToolKeyWords="[HostTool] ",logLevelIndex=4;function checkAotPartialConfig(e,t,r){return!(t.anBuildMode!==_pre_define.AOT_PARTIAL&&!t.apPath)}function checkAotFullConfig(e,t,r){return t.anBuildMode===_pre_define.AOT_FULL}function checkAotTypeConfig(e,t,r){return t.anBuildMode===_pre_define.AOT_TYPE}function checkAotConfig(e,t,r){return checkAotTypeConfig(e,t,r)||checkAotFullConfig(e,t,r)||checkAotPartialConfig(e,t,r)}function generateAot(e,t,r,i,n){var o,a=this,e=path.join((0,_ark_utils.getBuildBinDir)(e),(0,_utils.isWindows)()?"ark_aot_compiler.exe":"ark_aot_compiler"),l=path.join(r.anBuildOutPut,r.moduleName),e=((0,_utils.validateFilePathLengths)([e,t,l],i)||n("ArkTS:ERROR GenerateAot failed. Invalid file path."),fs.existsSync(t)||n(`ArkTS:ERROR GenerateAot failed. AppAbc not found in "${t}"`),`"${e}" `+`--aot-file="${l}" --compiler-target-triple=aarch64-unknown-linux-gnu `);let u="";r.anBuildMode===_pre_define.AOT_FULL?u=e+` "${t}"`:r.anBuildMode===_pre_define.AOT_PARTIAL?(o=r.apPath,(0,_utils.validateFilePathLength)(o,i)||n("ArkTS:ERROR GenerateAot failed. Invalid profile file path."),fs.existsSync(o)||n(`ArkTS:ERROR GenerateAot failed. Partial mode lost profile in "${o}"`),u=e+` --enable-pgo-profiler=true --compiler-pgo-profiler-path="${o}" "${t}"`):n("ArkTS:ERROR GenerateAot failed. unknown anBuildMode: "+r.anBuildMode);try{i.debug("generateAot cmd: "+u),(0,_utils.mkdirsSync)(r.anBuildOutPut),fs.closeSync(fs.openSync(l+".an","w")),fs.closeSync(fs.openSync(l+".ai","w"))}catch(e){e.stdout.toString().split(os.EOL).forEach(function(e){var t,r;_newArrowCheck(this,a),e.includes(hostToolKeyWords)&&(r=t="",[t,r]=e.split(hostToolKeyWords),!t&&!r||"F"!==(e=t.trim().split(/\s+/)[logLevelIndex])&&"E"!==e||i.warn("ArkTS:WARN "+r))}.bind(this)),i.warn("ArkTS:WARN "+e),i.warn("ArkTS:WARN Failed to generate aot file, the module may run with an interpreter")}}