"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SRC_MAIN=void 0,exports.writeFileSyncByNode=writeFileSyncByNode;var _path=_interopRequireDefault(require("path")),_typescript=_interopRequireDefault(require("typescript")),_fs=_interopRequireDefault(require("fs")),_generate_sourcemap=require("./fast_build/ark_compiler/generate_sourcemap"),_pre_define=require("./pre_define"),_utils=require("./utils"),_ark_utils=require("./ark_utils"),_validate_ui_syntax=require("./validate_ui_syntax"),_utils2=require("./fast_build/ark_compiler/utils"),_ob_config_resolver=require("./fast_build/ark_compiler/common/ob_config_resolver");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const SRC_MAIN="src/main";async function writeFileSyncByNode(t,r,i,a,o,n){var o=(0,_ark_utils.createAndStartEvent)(o,"write file sync by node"),s=(0,_ark_utils.createAndStartEvent)(o,"generate content and source map information"),u=genContentAndSourceMapInfo(t,a,r,i),l=_generate_sourcemap.SourceMapGenerator.getInstance();(0,_ark_utils.stopEvent)(s);let c=(0,_utils.genTemporaryPath)(a||t.fileName,r.projectPath,process.env.cachePath,r,i);if(0!==c.length){c.endsWith(_pre_define.EXTNAME_ETS)&&(c=c.replace(/\.ets$/,_pre_define.EXTNAME_TS));s=(0,_ob_config_resolver.getRelativeSourcePath)(a||t.fileName,r.projectRootPath,i?.belongProjectPath);let e;e="rollup"===process.env.compileTool?(i=l.isNewSourceMaps()?a:s,l.fillSourceMapPackageInfo(a,u.sourceMapJson),l.updateSourceMap(i,u.sourceMapJson),l.getSourceMaps()):(_ark_utils.newSourceMaps[s]=u.sourceMapJson,_ark_utils.newSourceMaps),(0,_utils2.isDebug)(r)?((0,_utils.mkdirsSync)(_path.default.dirname(c)),_fs.default.writeFileSync(c,u.content),(0,_ark_utils.stopEvent)(o)):(i=(0,_ark_utils.createAndStartEvent)(o,"write obfuscated source code"),await(0,_ark_utils.writeObfuscatedSourceCode)({content:u.content,buildFilePath:c,relativeSourceFilePath:s,originSourceFilePath:t.fileName,rollupModuleId:a||void 0},n,r,e),(0,_ark_utils.stopEvent)(i))}}function genContentAndSourceMapInfo(e,t,r,i){var a=_typescript.default.createPrinter({newLine:_typescript.default.NewLineKind.LineFeed}),o=_typescript.default.createCompilerHost({sourceMap:!0}),t=t||e.fileName,o=_typescript.default.createSourceMapGenerator(o,_typescript.default.getBaseFileName(t),"","",{sourceMap:!0,inlineSourceMap:!1,inlineSources:!1,sourceRoot:"",mapRoot:"",extendedDiagnostics:!1}),n=_typescript.default.createTextWriter(_typescript.default.getNewLineCharacter({newLine:_typescript.default.NewLineKind.LineFeed,removeComments:!1})),a=(a.writeFile(e,n,o),o.toJSON());a.sources=[(0,_utils.toUnixPath)(t).startsWith((0,_utils.toUnixPath)(r.projectRootPath))?(0,_utils.toUnixPath)(t).replace((0,_utils.toUnixPath)(r.projectRootPath)+"/",""):(0,_utils.toUnixPath)(t).replace((0,_utils.toUnixPath)(i.belongProjectPath)+"/","")];let s=n.getText();return{content:s="rollup"!==process.env.compileTool?(0,_ark_utils.transformModuleSpecifier)(t,(0,_validate_ui_syntax.processSystemApi)(s,!0),r):s,sourceMapJson:a}}exports.SRC_MAIN=SRC_MAIN;