"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var n={};if(null!=r)for(var o in r)"default"!==o&&Object.prototype.hasOwnProperty.call(r,o)&&e(n,r,o);return t(n,r),n},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getProxyAgent=void 0;const o=require("http-proxy-agent"),s=require("https-proxy-agent"),i=require("../../config"),c=n(require("../../log")),u=n(require("fs")),p=r(require("https")),f=n(require("url")),l=require("../../tools/tunnel/Tunnel"),a=require("../../common/message"),g=new Map;function h(e){const t=function(){const e=i.config.getString(i.types.NO_PROXY).split(","),t=process.env[i.types.NO_PROXY]?process.env[i.types.NO_PROXY]:process.env[i.types.NO_PROXY.toUpperCase()];t&&e.push(...t.split(","));return e}();for(const r of t){if(d(r.trim(),e.hostname))return!0}return!1}function d(e,t){if(!e)return!1;if("."===e[0])return t.endsWith(e);const r=e.split("*"),n=r.length;if(1===n)return e===t;if(2===n){const[e,n]=r;return t.startsWith(e)&&t.endsWith(n)&&t.length>=e.length+n.length}return!1}let y=!1;function _(e){const t=i.config.getString(e);return t||(process.env[e]?process.env[e]:process.env[e.toLocaleUpperCase()])}exports.getProxyAgent=function(e){if(function(){if(y)return;const e=i.config.get(i.types.STRICT_SSL);!1!==e&&"false"!==e||(process.removeAllListeners("warning"),process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),y=!0}(),g.has(e))return g.get(e);const t=function(e){try{return new URL(e)}catch(t){return void c.default.error("",`An unknown error occurred while getting the proxy: ${e}, detail: ${t.message}`)}}(e);if(!t)return;const r=i.config.get(i.types.STRICT_SSL),n=function(e){const t=i.config.getString(i.types.CA_FILES),r=[];if(!0===e&&t){t.split(",").forEach((e=>{if(e){const t=u.default.readFileSync(e);r.push(t)}}))}return r}(r);return h(t)?function(e,t){return!0===e&&t.length>0?new p.Agent({rejectUnauthorized:!0,ca:t}):void 0}(r,n):function(e,t,r,n){let c;if("https:"===t.protocol.trim()){const t=_(i.types.HTTPS_PROXY);t?c=!0===e&&n.length>0?function(e){if(!e.proxy)throw new Error(a.Messages.Http.ProxyNotProvided);if("string"==typeof e.proxy){const t=f.default.parse(e.proxy);e.proxy=Object.assign(Object.assign({},t),{port:Number(t.port)})}const t=e.proxy;e.endServerProtocol||(e.endServerProtocol="https:");let r;r="http:"===t.protocol?(0,l.httpsOverHttp)(e):(0,l.httpsOverHttps)(e);return r}({proxy:t,endServerProtocol:"https:",rejectUnauthorized:!0,ca:n}):new s.HttpsProxyAgent(t):!0===e&&n.length>0&&(c=new p.Agent({rejectUnauthorized:!0,ca:n}))}else if("http:"===t.protocol.trim()){const e=_(i.types.HTTP_PROXY);e&&(c=new o.HttpProxyAgent(e))}return g.set(r,c),c}(r,t,e,n)};