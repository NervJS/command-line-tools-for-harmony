"use strict";var e=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function u(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}a((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAvailableAuthByUrl=exports.getUserAgent=exports.getFetchTimeout=exports.fetchPackageReal=exports.fetchPackage=exports.fetchPackageCacheMap=exports.getAuditRegistry=exports.getPublishRegistry=exports.getRegistryList=exports.formatRegistry=exports.RegistryType=void 0;const r=t(require("node-fetch")),n=t(require("../../log")),o=require("../../config"),i=require("./proxy"),s=require("../../config/DefaultConfig"),u=require("../../common/Constants"),a=require("../../util/StringUtils"),c=require("./OhpmRequestInit"),g=require("../../common/message"),f=require("../dependency/util/getRedirectUrlFromResponse"),l=require("../../util/readDefaultRegistryFromConfig");function p(e){return e.endsWith("/")?e:`${e}/`}!function(e){e.ohpm="ohpm",e.npm="npm",e.local="local"}(exports.RegistryType||(exports.RegistryType={})),exports.formatRegistry=p,exports.getRegistryList=function(e){var t,r;let n="";if(-1!==e.indexOf("/")&&e.startsWith("@")){const r=e.split("/")[0];n=null===(t=o.config.getString(`${r}:registry`))||void 0===t?void 0:t.trim()}if(n||(n=null===(r=o.config.getString(o.types.REGISTRY))||void 0===r?void 0:r.trim()),n||(n=(0,l.readDefaultRegistryFromConfig)()),!n)return[];const i=[],s=n.split(",");for(const e of s){const t=e.trim();t&&i.push(p(t))}return i},exports.getPublishRegistry=function(){const e=o.config.getString("publish_registry");return e?p(e):""},exports.getAuditRegistry=function(){let e=o.config.getString("registry");if(!e)return"";const t=e.split(",");return 0===t.length?"":(e=t[0],e?p(e):"")},exports.fetchPackageCacheMap=new Map,exports.fetchPackage=function(t,r,o){return e(this,void 0,void 0,(function*(){try{let e=exports.fetchPackageCacheMap.get(t);return e?(n.default.debug("fetchPackage",`reuse promise, key: ${r}@${o}, url: ${t}.`),e):(n.default.debug("fetchPackage",`new promise, key: ${r}@${o}, url: ${t}.`),e=d(t,r,o),exports.fetchPackageCacheMap.set(t,e),yield e)}catch(e){exports.fetchPackageCacheMap.delete(t),function(e,t,r){const o=r.message;if(o&&o.toLowerCase().includes(u.Constants.TAGTIMEOUT)){n.default.warn(r.errno,`response timeout while fetch package ${e} from ${t}, errMsg: ${o}`);const i=new Error(o);throw i.errno=u.Constants.ERRORTIMEOUT,i}throw r.errno=u.Constants.ERR_TYPE_MAP[r.type]?u.Constants.ERR_TYPE_MAP[r.type]:r.errno,n.default.warn(r.errno,`fetch package ${e} from ${t} failed, errMsg: ${o}`),r}(r,t,e)}}))};let h=1;function d(t,o,s){return e(this,void 0,void 0,(function*(){n.default.debug("",`fetchPackageReal ${o}@${s} from url: ${t}.`);const u=R(t),a=(new c.OhpmRequestInit).withAgent((0,i.getProxyAgent)(t)).withTimeout(y()).withRedirect("manual");u&&a.withHeaders({Authorization:u});let l=yield(0,r.default)(t,a);const p=(0,f.getRedirectUrlFromResponse)(l);if(p&&(l=yield function(t,o,s,u){return e(this,void 0,void 0,(function*(){n.default.debug("",`start fetch package ${s}@${u} from redirectUrl: ${o}.`);const e=R(o),t=(new c.OhpmRequestInit).withAgent((0,i.getProxyAgent)(o)).withTimeout(y());return e&&t.withHeaders({Authorization:e}),(0,r.default)(o,t)}))}(0,p,o,s)),l.ok)return n.default.info("fetch package done "+h++,`${o} from ${t}`),l.buffer();n.default.error("",(0,g.format)(g.Messages.Fetcher.Registry.FetchPkgFailed,{url:t,status:String(l.status),statusText:l.statusText}))}))}function y(){const e=o.config.get(o.types.FETCH_TIMEOUT);return e||s.defaultConfig.fetch_timeout}function m(e,t){if(!t)return"";const r=o.config.get(t);if(Array.isArray(r))for(const n of r){const r=n.substring(0,n.indexOf(t));if(e.startsWith(r))return o.config.get(n)?o.config.get(n):""}return""}function R(e){const t=m(e=e.startsWith("http:")?e.substring("http:".length):e.substring("https:".length),s.AccessTokenType.READ);return a.StringUtils.isBlank(t)?m(e,s.AccessTokenType.READ_WRITE):t}exports.fetchPackageReal=d,exports.getFetchTimeout=y,exports.getUserAgent=function(){return`${u.Constants.PM}/${u.Constants.PmVersion} node/${process.versions.node}`},exports.getAvailableAuthByUrl=R;