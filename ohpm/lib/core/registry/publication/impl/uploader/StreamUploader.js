"use strict";var t=this&&this.__awaiter||function(t,e,r,a){return new(r||(r=Promise))((function(o,i){function n(t){try{u(a.next(t))}catch(t){i(t)}}function s(t){try{u(a.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(n,s)}u((a=a.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.StreamUploader=void 0;const r=require("../../utils/genPublicationFormData"),a=e(require("node-fetch")),o=e(require("path")),i=require("../../../registry"),n=require("../../../proxy"),s=require("../../../../publish/util/clearUnUsedFieldInMetadata");exports.StreamUploader=class{uploadPackage(e,r,a){return t(this,void 0,void 0,(function*(){const t=yield e.getAuthorization(a);return this.publishPkgViaStream(a,t,r)}))}publishPkgViaStream(e,u,c){return t(this,void 0,void 0,(function*(){const d=yield(0,r.genPublicationFormData)(c),l=c.name;(0,s.clearUnUsedFieldInMetadata)(c);const h=l.replace("/","%2f");return(0,a.default)(e.concat("stream").concat(o.default.sep).concat(h),{headers:Object.assign({command:"publish",version:"v1","user-agent":(0,i.getUserAgent)(),authorization:u},d.getHeaders()),body:d,method:"POST",agent:(0,n.getProxyAgent)(e),timeout:(0,i.getFetchTimeout)()}).then((e=>t(this,void 0,void 0,(function*(){if(r.publicationStream&&r.publicationStream.close(),e.ok)return e.json();if(404===e.status)throw Object.assign(new Error(`HttpCode ${e.status}, ${e.statusText}`),{code:e.status});let t={};try{t=yield e.json()}catch(t){throw Object.assign(new Error(`HttpCode ${e.status}, ${e.statusText}`),{code:e.status})}throw Object.assign(new Error(`HttpCode ${e.status}, ${t.error}`),{code:e.status})})))).catch((t=>{throw r.publicationStream&&r.publicationStream.close(),t}))}))}};