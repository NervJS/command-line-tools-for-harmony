"use strict";var t=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(a,s){function r(t){try{c(i.next(t))}catch(t){s(t)}}function o(t){try{c(i.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,o)}c((i=i.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AttachmentUploader=void 0;const n=e(require("node-fetch")),i=require("../../../registry"),a=require("../../../proxy"),s=require("../../../handleResponseError"),r=require("../../../../../common/Constants"),o=require("../../../../../util/FsUtil"),c=require("../../../../publish/util/clearUnUsedFieldInMetadata"),l=e(require("path"));exports.AttachmentUploader=class{uploadPackage(e,r,o){return t(this,void 0,void 0,(function*(){const t=r.name;r=yield this.buildAttachments(r),(0,c.clearUnUsedFieldInMetadata)(r);const l=t.replace("/","%2f"),u=yield(0,n.default)(o.concat(l),{headers:{command:"publish",version:"v1","user-agent":(0,i.getUserAgent)(),Authorization:yield e.getAuthorization(o),"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(r),method:"PUT",agent:(0,a.getProxyAgent)(o)});return u.ok||(yield(0,s.handleResponseError)(u,"Publish")),u.json()}))}buildAttachments(e){return t(this,void 0,void 0,(function*(){const t=Object.keys(e.versions)[0],n=Object.values(e.versions)[0],i=e.isTgz?l.default.join(n.cache,n.hspPkg.interfaceHar):e.pkg;e._attachments={};const a=`${e.name}-${t}${r.Constants.HAR_SUFFIX}`;if(e._attachments[a]={content_type:"application/octet-stream",data:(yield o.FsUtil.readFile(i)).toString("base64"),length:(yield o.FsUtil.stat(i)).size},e.isTgz){const i=`${e.name}-${t}${r.Constants.HSP_SUFFIX}`,a=l.default.join(n.cache,n.hspPkg.hsp);e._attachments[i]={content_type:"application/octet-stream",data:(yield o.FsUtil.readFile(a)).toString("base64"),length:(yield o.FsUtil.stat(a)).size}}return e}))}};