"use strict";var e=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.cleanAllCaches=exports.getPkgCachePath=exports.getPkgFilePathInCacheDir=exports.CacheConstants=void 0;const i=require("../registry/registry"),r=require("../../config"),n=t(require("path")),o=t(require("../../log")),s=require("../../util"),a=require("../../tools/ssri/Ssri"),l=require("../../util/FsUtil"),c=t(require("perf_hooks"));var u;function f(e,t,i){return s.HashUtil.getDigest(t,i)===e}function d(e,t,i){const r=t.substring(0,2),o=t.substring(2,4),s=t.substring(4),a=n.default.join(e,i,r,o);return n.default.join(a,s)}!function(e){e.ContentDir="content-v1",e.HarBallDir="harball"}(u=exports.CacheConstants||(exports.CacheConstants={})),exports.getPkgFilePathInCacheDir=d,exports.getPkgCachePath=function(t,h,g,p,y){return e(this,void 0,void 0,(function*(){let e,C;if(g){const t=a.ssri.parse(g);e=t.getAlgorithm(),C=t.hexDigest()}else e="sha1",C=y;const v=d(n.default.join(r.config.getString(r.types.CACHE),u.ContentDir),C,e),x=n.default.dirname(v);if(yield l.FsUtil.exists(v)){if(f(C,yield l.FsUtil.readFile(v),e))return o.default.debug("",`found package ${t}@${h} from cache file ${v}`),v}s.FsBlockingUtil.createDirIfNotExists(x);const F=n.default.join(x,`${t.replace(/\//g,"+")}@${h}.${process.pid}.${c.default.performance.now()}`),k=yield(0,i.fetchPackage)(p,t,h);if(!f(C,k,e)){const e=`The integrity check of package: ${t}@${h} failed.`;throw o.default.error("",e),new Error(e)}s.FsBlockingUtil.writeFileSync(F,k);try{yield l.FsUtil.renameIfNotExist(F,v)}catch(e){throw o.default.warn("fetch package error.",`rename cache path "${F}" to"${v}" failed, error: ${e}.`),e}return v}))},exports.cleanAllCaches=function(){return e(this,void 0,void 0,(function*(){yield function(){return e(this,void 0,void 0,(function*(){const e=n.default.resolve(r.config.getString(r.types.CACHE),u.ContentDir);(yield l.FsUtil.exists(e))&&(yield l.FsUtil.remove(e))}))}(),yield function(){return e(this,void 0,void 0,(function*(){const e=n.default.resolve(r.config.getString(r.types.CACHE),u.HarBallDir);(yield l.FsUtil.exists(e))&&(yield l.FsUtil.remove(e))}))}()}))};