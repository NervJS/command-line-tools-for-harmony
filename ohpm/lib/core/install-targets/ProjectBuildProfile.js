"use strict";var t=this&&this.__awaiter||function(t,o,e,s){return new(e||(e=Promise))((function(i,r){function l(t){try{n(s.next(t))}catch(t){r(t)}}function u(t){try{n(s.throw(t))}catch(t){r(t)}}function n(t){var o;t.done?i(t.value):(o=t.value,o instanceof e?o:new e((function(t){t(o)}))).then(l,u)}n((s=s.apply(t,o||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.projectBuildProfile=void 0;const e=o(require("path")),s=require("../../common/Constants"),i=o(require("../../log")),r=require("../../util"),l=require("../../util/FsUtil");exports.projectBuildProfile=new class{constructor(){this.projectRoot="",this.moduleRoots=[],this.useOhmurl=!1,this.productPaths=["app","products"],this.ohmurlPaths=["buildOption","strictMode","useNormalizedOHMUrl"],this.moduleMap=new Map,this.moduleRootSet=new Set}init(t){this.projectRoot=t,this.profileJson=r.FsBlockingUtil.readJSON5Sync(e.default.join(t,s.Constants.BuildProfile)),this.loadModuleRoots(),this.loadOHMUrlConfig()}getUseOhmurl(){return this.useOhmurl}getModuleRoots(){return this.moduleRoots}getModulePath(t){return this.moduleMap.get(t)}getModuleName(o){return t(this,void 0,void 0,(function*(){for(const t of this.moduleMap.keys()){let e=this.moduleMap.get(t);if(e&&(e=l.FsUtil.slash(e),o===e))return t}return""}))}reflushModuleRoots(t){t&&t.length&&(this.clearModuleRoots(),this.loadModuleRoots(t))}clearModuleRoots(){this.moduleRoots=[],this.moduleMap.clear(),this.moduleRootSet.clear()}isModuleRoot(t){return this.moduleRootSet.has(t)}loadModuleRoots(t){const o=[];t&&t.length?o.push(...t):this.profileJson&&o.push(...this.profileJson.modules),o.forEach((t=>{const o=t.srcPath;if(!o)return;const s=e.default.isAbsolute(o)?o:e.default.resolve(this.projectRoot,o);this.moduleRoots.push(s),this.moduleMap.set(t.name,s),this.moduleRootSet.add(s)}))}loadOHMUrlConfig(){if(!this.profileJson)return void i.default.warn("loadOHMUrlConfig",`the ${s.Constants.BuildProfile} content is empty!`);const t=this.getProducts();t&&Array.isArray(t)&&t.length?this.findOHMUrlConfigInProducts(t):i.default.warn("",`loadOHMUrlConfig fail, can not find "products" in project-level ${s.Constants.BuildProfile}`)}getProducts(){let t;for(const o of this.productPaths)if(t=t?t[o]:this.profileJson[o],!t)return;return t}findOHMUrlConfigInProducts(t){for(const o of t){let t;for(const e of this.ohmurlPaths)if(t=t?t[e]:o[e],!t)break;if(t){this.useOhmurl=!0;break}}}};