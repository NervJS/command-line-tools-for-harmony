"use strict";var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}l((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TargetManager=void 0;const i=t(require("path")),n=require("../../util"),r=require("../../common/message"),a=require("../../util/isDirPathSilentlySync"),o=t(require("../../log")),s=require("./DependencyMapFile"),l=require("./types"),d=require("../../util/FsUtil"),c=require("./ProjectBuildProfile"),u=require("../../config");class h{constructor(){this.targetPath=""}static getInstance(){return this.instance||(this.instance=new h),this.instance}validateTargetPath(e){if(e&&e.trim()){if(o.default.debug("",`start validateTargetPath, targetPath: ${e}`),i.default.isAbsolute(e)||(e=i.default.resolve(process.cwd(),e)),!n.FsBlockingUtil.existsSync(e))throw new Error(`${(0,r.format)(r.Messages.Target.TargetPathUnExistError,{filePath:e})}`);if(!(0,a.isDirPathSilentlySync)(e))throw new Error(`${(0,r.format)(r.Messages.Target.NotDirPathError,{filePath:e})}`)}}init(t){return e(this,void 0,void 0,(function*(){if(!t||!t.trim())return this.targetPath="",void(this.dependencyMapFile&&(this.dependencyMapFile.clearOhPkgJsonMap(),this.dependencyMapFile=void 0));this.targetPath=t.trim(),this.dependencyMapFile=new s.DependencyMapFile(this.targetPath),yield this.dependencyMapFile.loadDepMapFile()}))}mergeWithDependencyMapJson(t){var i;return e(this,void 0,void 0,(function*(){const e=null===(i=this.dependencyMapFile)||void 0===i?void 0:i.getDependencyMap();if(!this.dependencyMapFile||!e)return t;if(!t)return this.convertModuleNameToPkgName(e);let n=Object.assign({},t);const r=Object.assign({},e),a=Object.keys(t);let o=Object.keys(r);return o.forEach((e=>{var t;for(let i=0;i<a.length;i++){const o=a[i].trim(),s=this.getNamePartFromOverrideKey(o),l=null===(t=this.dependencyMapFile)||void 0===t?void 0:t.getPkgNameByModuleName(e);if(s===l){delete r[`${e}`],delete n[`${o}`],n[`${l}`]=this.dependencyMapFile.getOhPkgJsonPath(e);break}}})),o=Object.keys(r),o&&(n=Object.assign(Object.assign({},n),this.convertModuleNameToPkgName(r))),n}))}getDependencyMap(){var t;return e(this,void 0,void 0,(function*(){const e=null===(t=this.dependencyMapFile)||void 0===t?void 0:t.getDependencyMap();return e?this.convertModuleNameToPkgName(e):{}}))}isTargetMod(){return!!this.targetPath}hasTarget(){var e;return!!(null===(e=this.dependencyMapFile)||void 0===e?void 0:e.hasTargetName())}getTargetName(){var e;return this.dependencyMapFile?null===(e=this.dependencyMapFile)||void 0===e?void 0:e.getTargetName():""}needChangeLockFileName(){var e;return!!(null===(e=this.dependencyMapFile)||void 0===e?void 0:e.needChangeLockFileName())}getModuleRoots(){var e;const t=null===(e=this.dependencyMapFile)||void 0===e?void 0:e.getModuleNames();if(!t)return[];const n=[];return t.forEach((e=>{const t=c.projectBuildProfile.getModulePath(e);if(!t)throw new Error((0,r.format)(r.Messages.Target.ModulePathUnExistError,{moduleName:e,filePath:i.default.join(this.targetPath,l.DEPENDENCY_MAP_JSON)}));n.push(t)})),n}getProjectOhPkgJson(){var e;return null===(e=this.dependencyMapFile)||void 0===e?void 0:e.getProjectOhPkgJson()}getModuleOhPkgJson(t){return e(this,void 0,void 0,(function*(){if(t===u.config.getProjectRoot())return this.getProjectOhPkgJson();t=d.FsUtil.slash(t);const e=yield c.projectBuildProfile.getModuleName(t);return e||o.default.warn("getModuleName",`get moduleName from moduleDir: ${t}`),this.getModuleOhPkgJsonByModuleName(e)}))}getModuleOhPkgJsonByModuleName(t){var i;return e(this,void 0,void 0,(function*(){let e={};return t&&(e=null===(i=this.dependencyMapFile)||void 0===i?void 0:i.getOhPkgJsonByModuleName(t)),Object.assign({},e)}))}setModuleOhPkgJson(e,t){var i;null===(i=this.dependencyMapFile)||void 0===i||i.setOhPkgJsonByModuleName(e,t)}getResolveConflictPath(e){const t=d.FsUtil.slash(e),r=t.lastIndexOf("/"),a=t.slice(r+1),o=i.default.join(this.targetPath,"resolve-conflict",a);return n.FsBlockingUtil.createDirIfNotExists(o),o}getNamePartFromOverrideKey(e){let t=e;const i=e.lastIndexOf("@");return i<=0||e.length<=i+1?i>0&&(t=e.slice(0,e.length-1)):t=e.slice(0,i),t}isJsonObjEmpty(e){return!e||0===Object.keys(e).length}convertModuleNameToPkgName(e){if(!e||!Object.keys(e).length)return{};const t={};return Object.keys(e).forEach((i=>{var n;const r=null===(n=this.dependencyMapFile)||void 0===n?void 0:n.getPkgNameByModuleName(i);r&&(t[`${r}`]=e[`${i}`])})),t}}exports.TargetManager=h;