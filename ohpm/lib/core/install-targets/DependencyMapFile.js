"use strict";var e=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(a,o){function n(e){try{h(i.next(e))}catch(e){o(e)}}function r(e){try{h(i.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,r)}h((i=i.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DependencyMapFile=void 0;const s=require("../../util"),i=require("../../common/message"),a=require("../../util/isFilePathSilentlySync"),o=t(require("../../log")),n=require("./types"),r=require("../../util/FsUtil"),h=t(require("path")),l=require("./ProjectBuildProfile"),d=require("../../config");class u{constructor(e){this.basePath="",this.targetName="",this.rootDependency="",this.dependencyMap={},this.pkgNameMap=new Map,this.ohPkgJsonMap=new Map,this.modules=[],this.targetPath=e,this.filePath=this.resolveFilePath(h.default.join(e,n.DEPENDENCY_MAP_JSON)),o.default.debug("",`Found ${n.DEPENDENCY_MAP_JSON} in ${this.filePath}`)}loadDepMapFile(){return e(this,void 0,void 0,(function*(){const e=yield r.FsUtil.readJSON5(this.filePath);e?(this.basePath=e.basePath?e.basePath.trim():this.targetPath,this.targetName=e.targetName?e.targetName.trim():"",this.rootDependency=e.rootDependency?h.default.join(this.targetPath,e.rootDependency):"",yield this.loadDependencyMap(e),this.loadModules(e),o.default.debug("",`Load file content of ${n.DEPENDENCY_MAP_JSON} - ${this.filePath} succeed, , basePath: ${this.basePath}, rootDependency: ${this.rootDependency}, targetName: ${this.targetName}, dependencyMap: ${JSON.stringify(this.dependencyMap)}, modules: ${JSON.stringify(this.modules)}`)):o.default.warn("",`the content of ${this.filePath} is empty.`)}))}getPkgNameByModuleName(e){return this.pkgNameMap.get(e)}clearOhPkgJsonMap(){this.ohPkgJsonMap.clear()}getProjectOhPkgJson(){return Object.assign({},this.ohPkgJsonMap.get(u.KEY_PROJECT_OH_PKG))}getOhPkgJsonByModuleName(e){return this.ohPkgJsonMap.get(e)}setOhPkgJsonByModuleName(e,t){e===d.config.getProjectRoot()?this.ohPkgJsonMap.set(u.KEY_PROJECT_OH_PKG,Object.assign({},t)):this.ohPkgJsonMap.set(t.name,Object.assign({},t))}hasTargetName(){return!!this.targetName}getTargetName(){return this.targetName}getRootDependencyPath(){return this.rootDependency}needChangeLockFileName(){return!(!this.targetName||this.targetName===n.DEFAULT_TARGET_NAME)}getDependencyMap(){return this.dependencyMap}getModules(){return this.modules}getModuleNames(){return Object.keys(this.dependencyMap)}getOhPkgJsonPath(e){const t=this.dependencyMap[`${e}`];if(!t)throw new Error((0,i.format)(i.Messages.Target.OhPkgPathEmptyError,{moduleName:e,filePath:this.filePath}));return t}getModuleOhPkgJson(t){return e(this,void 0,void 0,(function*(){return r.FsUtil.readJSON5(this.getOhPkgJsonPath(t))}))}loadDependencyMap(t){return e(this,void 0,void 0,(function*(){this.dependencyMap={};const e=t.dependencyMap;if(e){Object.keys(e).forEach((t=>{let s=e[`${t}`];s&&!h.default.isAbsolute(s)&&(s=h.default.join(this.targetPath,s)),this.dependencyMap[`${t.trim()}`]=s?s.trim():""})),yield this.loadOhPkgJsons()}}))}loadOhPkgJsons(){return e(this,void 0,void 0,(function*(){this.pkgNameMap.clear();const e=this.getModuleNames();for(const t of e){const e=yield this.getModuleOhPkgJson(t.trim());this.pkgNameMap.set(t,e.name),this.ohPkgJsonMap.set(t.trim(),e)}const t=this.getRootDependencyPath();t&&s.FsBlockingUtil.existsSync(t)&&this.ohPkgJsonMap.set(u.KEY_PROJECT_OH_PKG,yield r.FsUtil.readJSON5(t))}))}loadModules(e){this.modules=[];const t=e.modules;t&&t.length&&(t.forEach((e=>{e.srcPath&&(e.srcPath=h.default.resolve(this.basePath,e.srcPath))})),this.modules=t),l.projectBuildProfile.reflushModuleRoots(this.getModules())}resolveFilePath(e){if(!s.FsBlockingUtil.existsSync(e))throw new Error((0,i.format)(i.Messages.Target.FileUnExistError,{filePath:e}));if(!(0,a.isFilePathSilentlySync)(e))throw new Error((0,i.format)(i.Messages.Target.NotFilePathError,{filePath:e}));return e}}exports.DependencyMapFile=u,u.KEY_PROJECT_OH_PKG="project_root";