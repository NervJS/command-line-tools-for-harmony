"use strict";var e=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(n,r){function l(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(l,s)}a((o=o.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.genConvertCachePath=exports.convertExecute=void 0;const i=require("./definitions"),o=require("../../util/FsUtil"),n=t(require("path")),r=require("../../common/Constants"),l=require("../../config"),s=require("uuid"),a=require("../../util"),d=require("../../common/GlobalState"),u=t(require("../../log")),c=require("./vaildateConvert"),f=t(require("os")),h=require("../install/common/OptionValid"),v=require("../install"),y=require("../publish/PublishCore"),p=require("../../tools/posh"),g=require("../install/common/checkInvalidCmdWhileParameterization"),m=t(require("semver"));function C(t,i,l){return e(this,void 0,void 0,(function*(){const s=n.default.join(t,r.Constants.NodeModules);let a=0;try{if(i.startsWith("@")){const r=yield function(t,i,r,l){return e(this,void 0,void 0,(function*(){const e=n.default.join(i,t);let s=0;const a=yield o.FsUtil.readdir(e);if(!a.length)throw new Error(`${t} has no subdirectories`);for(const e of a){const a=`${t}+${e}`;try{const l=n.default.join(i,t,e);(yield o.FsUtil.stat(n.default.join(i,t))).isDirectory()&&(++s,yield b(a,l,r))}catch(e){u.default.error("",e.message),l.push(a)}}return s}))}(i,s,t,l);a+=r}else++a,yield b(i,n.default.join(s,i),t)}catch(e){u.default.error("",e.message),l.push(i)}return a}))}function b(t,l,s){return e(this,void 0,void 0,(function*(){u.default.info("",`> start convert package: ${t}`),yield function(t){return e(this,void 0,void 0,(function*(){const e=n.default.join(t,r.Constants.NodeModules);(yield o.FsUtil.exists(e))&&(yield o.FsUtil.rm(e,{recursive:!0,force:!0}))}))}(l),yield(0,c.validateAndRestorePackageJson)(l,t,i.convertMode.LOCAL),yield(0,c.packLibrariesLocal)(l,t,s)}))}function k(t){return e(this,void 0,void 0,(function*(){const e=t.slice(t.lastIndexOf("@")+1);return!!m.default.valid(e)}))}function M(t,o,l){return e(this,void 0,void 0,(function*(){const s=n.default.join(t,r.Constants.MyModules,r.Constants.PmDir);try{yield function(t,o,l){return e(this,void 0,void 0,(function*(){u.default.info("",`> start convert package: ${t}`);const e=function(e){let t,i;if(e.startsWith("@")){const o=e.split("+");t=o[0],i=o[1]}else t="",i=e;const o=i.split("@");return{group:t,fullName:i,name:o[0],version:o[1]}}(t),s=n.default.join(o,t,r.Constants.MyModules);let a;a=e.group?n.default.join(s,e.group,e.name):n.default.join(s,e.name),yield(0,c.validateAndRestorePackageJson)(a,t,i.convertMode.REMOTE),yield(0,c.packLibrariesRemote)(a,t,l)}))}(o,s,t)}catch(e){u.default.error("",e.message),l.push(o)}}))}exports.convertExecute=function(t,s,c){return e(this,void 0,void 0,(function*(){const m=(new Date).getTime();let b=!1;switch(yield function(t){return e(this,void 0,void 0,(function*(){return t?i.convertMode.REMOTE:i.convertMode.LOCAL}))}(s.registry)){case i.convertMode.REMOTE:b=yield function(t,s,c){return e(this,void 0,void 0,(function*(){const f=n.default.join(c,r.Constants.MyPackageJson),y=JSON.stringify(i.defaultConvertData,null," ");a.FsBlockingUtil.writeFileSync(f,y);const p={save:!1,link:!0,registry:s.registry,prefix:c,experimentalConcurrentlySafe:!0};d.GlobalState.command=d.CommandType.INSTALL,d.GlobalState.installMode.push(d.ExperimentalOption.CONCURRENTLY_SAFE_INSTALL),d.GlobalState.installMode.push(d.ExperimentalOption.NO_CHECK_REGISTRY),(0,h.validInstallOptions)(d.GlobalState.command,p),yield(0,g.checkInvalidCmdWhileParameterization)([t]),yield(0,v.install)(l.config.getRootDir(),[t],p);const m=yield function(t){return e(this,void 0,void 0,(function*(){const e=n.default.join(t,r.Constants.MyModules,r.Constants.PmDir),l=n.default.join(t,i.PACK_DIR);yield o.FsUtil.createDirIfNotExists(l);const s=yield o.FsUtil.readdir(e),a=[];let d=0;for(const i of s){(yield o.FsUtil.stat(n.default.join(e,i))).isDirectory()&&i!==r.Constants.MyModules&&(yield k(i))&&(++d,yield M(t,i,a))}return a.length?(u.default.error("",`Number of failed conversions: ${a.length}`),!1):(u.default.info("",`A total of ${d} packets are converted successfully.`),!0)}))}(c);return m}))}(t,s,c);break;case i.convertMode.LOCAL:b=yield function(t,i){return e(this,void 0,void 0,(function*(){const l=yield function(t){return e(this,void 0,void 0,(function*(){const e=n.default.resolve(process.cwd(),t);if(!(yield o.FsUtil.exists(e))||n.default.basename(e)!==r.Constants.NodeModules)throw new Error(`Local mode conversion is used, configure a correct "${r.Constants.NodeModules}" directory.`);return e}))}(t);yield o.FsUtil.copy(n.default.dirname(l),i);const s=yield function(t){return e(this,void 0,void 0,(function*(){const e=n.default.join(t,r.Constants.NodeModules),i=yield o.FsUtil.readdir(e),l=[];let s=0;for(const r of i){if((yield o.FsUtil.stat(n.default.join(e,r))).isDirectory()&&".bin"!==r&&".package-lock.json"!==r){s+=(yield C(t,r,l))}}return l.length&&0!==s?(u.default.error("",`A total of ${l.length} package(s) failed to convert.`),u.default.info("",`A total of ${s-l.length} package(s) are converted successfully.`),!1):(u.default.info("",`A total of ${s} package(s) are converted successfully.`),!0)}))}(i);return s}))}(t,c)}yield function(t,l,s){return e(this,void 0,void 0,(function*(){if(!t)return;if(!s)return void u.default.warn("","Not all packages are converted. The packages not be automatically published.");u.default.info("","Start batch publish.");const e=n.default.join(l,i.PACK_DIR),d=yield o.FsUtil.readdir(e),c=[];for(let t=0;t<d.length;t++)try{yield(new y.PublishCore).publish(n.default.join(e,d[t]),{})}catch(e){a.FsBlockingUtil.rmDirSync(`${f.default.homedir}/${r.Constants.PmDir}/cache/harball/`),e&&u.default.error("",`Publish failed, ${e}`),c.push(d[t])}c.length?(u.default.warn("",`A total of ${d.length} packages need to be published, among which ${c.length} packages fail to upload.`),u.default.warn("",p.posh.bold.bgBlack.yellowBright("Failure List:")),c.forEach((e=>{u.default.warn("",`> Failed to publish "${e}"`)}))):u.default.info("",`All ${d.length} packages uploaded successfully`)}))}(s.publish,c,b),yield function(t){return e(this,void 0,void 0,(function*(){const e=n.default.join(t,i.PACK_DIR),r=n.default.join(process.cwd(),`convert_${Date.now()}`);(yield o.FsUtil.exists(e))&&(yield o.FsUtil.createDirIfNotExists(r),yield o.FsUtil.copy(e,r),u.default.info("",`Converted packages are saved to the "${r}" directory.`))}))}(c),a.PrintUtil.printCostTime(m,"convert")}))},exports.genConvertCachePath=function(){const e=`${l.config.getString(l.types.CACHE)}/${(0,s.v4)().replace(/-/g,"")}/${d.CommandType.CONVERT}/`;return a.FsBlockingUtil.createDirIfNotExists(e),e};