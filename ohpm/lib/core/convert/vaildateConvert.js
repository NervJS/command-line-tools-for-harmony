"use strict";var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.packLibrariesLocal=exports.packLibrariesRemote=exports.validateAndRestorePackageJson=void 0;const i=t(require("path")),n=require("../../util/FsUtil"),o=require("./definitions"),r=t(require("../../log")),s=require("../../common/Constants"),a=require("child_process"),l=require("../validator/rule/types"),c=require("../../common/message"),u=require("../../util"),d=require("./vaildateAndRestore/RepoDefaultValidatorFactory"),f=require("../../tools/posh"),p=require("./common/repoDefaultVaildConfFunctions"),y=require("../../util/OsUtil"),h=y.OsUtil.isWindows?process.env.ComSpec||"cmd":process.env.SHELL||"sh",g=f.posh.bold.redBright("change"),m=f.posh.bold.redBright("delete");function v(e,t){return"main"!==e&&"types"!==e||!t.includes("\\")?t:t.replace(/\\/g,"/")}function F(e,t,n,o){switch(k(e)){case"description":!function(e,t,i){const n=k(e),o=(0,p.getRuleContentFromValidConf)(e,l.ValidationRuleType.LengthLimit).maxLength,r=i[n];i[n]&&i[n].length>o&&(i[n]=i[n].slice(0,o),R(t,e,r,i[n]))}(e,t,n);break;case"author":!function(e,t,i){const n=k(e);if(!i[n])return;R(t,e,$(i,e),""),x(i,e,"")}(e,t,n);break;case"keywords":!function(e,t,i){const n=k(e),o=(0,p.getRuleContentFromValidConf)(e,l.ValidationRuleType.LengthLimit),r=(0,p.getRuleContentFromValidConf)(e,l.ValidationRuleType.ListItemLengthLimit),s=o.maxLength,a=r.minLength,c=r.maxLength;if(!i[n])return;if(!Array.isArray(i[n]))return void delete i[n];const u=JSON.parse(JSON.stringify(i[n])),d=new Map;for(let e=0;e<i[n].length;e++){let t=i[n][e];d.has(t)||(t=t.slice(0,c),t.length<a||d.set(t,e))}i[n]=Array.from(d.keys()),i[n]=i[n].slice(0,s),R(t,e,u,i[n])}(e,t,n);break;case"homepage":!function(e,t,i){const n=k(e),o=256;if(!i[n])return void delete i[n];if(i[n].length>o){const r=i[n].slice(0,o);R(t,e,i[n],r),i[n]=r}}(e,t,n);break;case"repository":!function(e,t,i){const n=k(e),o=(0,p.getRuleContentFromValidConf)(e,l.ValidationRuleType.RegExp),r=new RegExp(o),s=i[n];if(!s)return;if("string"==typeof s)return R(t,e,$(i,e),""),void x(i,e,"");if("object"==typeof s&&s.url&&r.test(s.url))return R(t,e,$(i,e),s.url),void x(i,e,s.url);U(t,e,i[n]),delete i[n]}(e,t,n);break;case"license":!function(e,t,i){const n=k(e),o="ISC",r=(0,p.getRuleContentFromValidConf)(e,l.ValidationRuleType.LengthLimit).maxLength;i[n]&&(i[n]=i[n].slice(0,r));i[n]||(R(t,e,i[n],o),i[n]=o)}(e,t,n);break;case"types":!function(e,t,i){const n=k(e);i[n]||(U(t,e,i[n]),delete i[n])}(e,t,n);break;case"main":!function(e,t,n,o){const r="main",s="types";let a=n[r];a||(a=n[s]);a||(a=function(e,t){let i="";const n=u.FsBlockingUtil.readdirSync(e);for(const e of n)if(t.includes(e.toLowerCase())){i=e;break}return i}(o,["index.js","index.ets","index.ts"]),a&&R(t,e,n[r],a));if(!a)return;const l=function(e,t){const n=i.default.dirname(i.default.join(e,t));if(!u.FsBlockingUtil.existsSync(n))return t;const o=u.FsBlockingUtil.readdirSync(n),r=i.default.basename(i.default.join(e,t));for(let e=0;e<o.length;e++)if(o[e].startsWith(r))return t.replace(r,o[e]);return t}(o,a);l!==a&&(R(t,e,a,l),a=l);if(n[r]=a,!u.FsBlockingUtil.existsSync(i.default.join(o,n[r])))return U(t,e,n[r]),void delete n[r];n[s]&&n[s]===n[r]&&delete n[r]}(e,t,n,o);break;case"artifactType":!function(e,t,i){const n="artifactType",o=(0,p.getDefaultValueFromValidConf)(n);i[n]||(R(t,e,i[n],o),i[n]=o)}(e,t,n)}}function k(e){let t=e;return e.includes(".")&&(t=e.slice(0,e.indexOf("."))),t}function w(e){let t=e;return e.includes(".")&&(t=e.slice(0,e.indexOf("."))),o.OhPackageJsonRequireAttrs.includes(t)}function x(e,t,i){const n=t.split("."),o=(e,t,i,n=0)=>{const r=t[n];n===t.length-1?e[r]=i:(e[r]||(e[r]={}),o(e[r],t,i,n+1))};o(e,n,i)}function $(e,t){const i=function(e,t){const i=t.split(".");for(let t=0;t<i.length-1;t++){const o=e[i[t]];if("object"!=typeof(n=o)||Array.isArray(n)||null===n)throw new Error((0,c.format)(c.Messages.Validator.AttributeTypeError,{attrName:`${i[t]}`}));e=o}var n;return e}(e,t);return i[t.slice(t.lastIndexOf(".")+1)]||void 0}function C(e,t=process.cwd(),i=o.shellStdio.inherit){const n=y.OsUtil.isWindows?["/d","/s","/c",e]:["-c",e];return(0,a.spawnSync)(h,n,{windowsVerbatimArguments:!0,stdio:i,cwd:t,env:process.env})}function R(e,t,i,n){const o=f.posh.yellow(` the value of "${t}" from ${JSON.stringify(i)} to ${JSON.stringify(n)}.`),s=f.posh.yellow(`package "${e}":`);r.default.log("warn",s+g+o)}function U(e,t,i){const n=f.posh.yellow(` the value of "${t}", the value ${JSON.stringify(i)} is invalid.`),o=f.posh.yellow(`package "${e}":`);r.default.log("warn",o+m+n)}exports.validateAndRestorePackageJson=function(t,a,c){return e(this,void 0,void 0,(function*(){let e;if(e=c===o.convertMode.REMOTE?i.default.join(t,s.Constants.MyPackageJson):i.default.join(t,s.Constants.PackageJson),!(yield n.FsUtil.exists(e)))throw new Error(`${a} ${e} file is not found`);const f=yield n.FsUtil.readJSON5(e),y=new Map;!function(e){const t="author",i=e[t];if(!i)return void(e[t]={name:"",url:"",email:""});if("string"!=typeof i)return;const n=i.match(/^([^(<]+)/),o=i.match(/\(([^)]+)\)/),r=i.match(/<([^>]+)>/),s={name:"",url:"",email:""};n&&n[0].trim()&&(s.name=n[0].trim());r&&(s.email=r[1]);o&&(s.url=o[1]);e[t]=s}(f),function(e){const t="keywords",i=(0,p.getRuleContentFromValidConf)(t,l.ValidationRuleType.ListItemLengthLimit),n=new RegExp(i.reg);if(!e[t]||!Array.isArray(e[t]))return void delete e[t];const o=new Set;for(let i=0;i<e[t].length;i++){const r=e[t][i];o.has(r)||n.test(r)&&o.add(r)}e[t]=Array.from(o)}(f);const h=d.ValidatorFactory.createRepoDefaultValidator(((e,t)=>{var i,n,o,r;i=e,n=t,(o=y).has(i)?null===(r=o.get(i))||void 0===r||r.push(n):o.set(i,[n])}));yield h.validate(f),function(e,t,n){const o="types";if(!t[o])return;if(!u.FsBlockingUtil.existsSync(i.default.join(e,t[o]))){const e={attrName:o,ruleType:l.ValidationRuleType.CustomFunction,errorMsg:`attribute "${o}" declare file does not exist: "${t[o]}"`};n.set(o,[e])}}(t,f,y),function(e,t,n){const o="main",r="types";if(!t[o]&&!t[r]){const e={attrName:o,ruleType:l.ValidationRuleType.NotNull,errorMsg:`attribute "${o}" in "oh-package.json5" can not be empty`};return void n.set(o,[e])}if(t[r]&&!t[o])return;if(!u.FsBlockingUtil.existsSync(i.default.join(e,t[o]))){const e={attrName:o,ruleType:l.ValidationRuleType.CustomFunction,errorMsg:`attribute "${o}" declare file does not exist: "${t[o]}"`};n.set(o,[e])}}(t,f,y);let g=!1,m="";for(const e of y.keys()){g||(g=w(e),m=e);const i=y.get(e);null==i||i.forEach((t=>{r.default.warn(`package "${a}":`,`${t.errorMsg}, value: ${JSON.stringify($(f,e))}`)})),F(e,a,f,t)}if(f.main||f.types||(g=!0),g)throw new Error(`> Failed to convert the "${a}" package, required "${m}" field validation failed.`);const k={};for(const e of o.needConvertAttrs)f[e]&&(k[e]=f[e]);c===o.convertMode.LOCAL&&(yield n.FsUtil.rm(e,{recursive:!0,force:!0}));const x=i.default.join(t,s.Constants.MyPackageJson);yield n.FsUtil.writeFile(x,JSON.stringify(k,v,2))}))},exports.packLibrariesRemote=function(t,r,a){return e(this,void 0,void 0,(function*(){const e=i.default.join(a,o.PACK_DIR);yield n.FsUtil.createDirIfNotExists(e);const l=i.default.join(i.default.dirname(t),"package");yield n.FsUtil.rename(t,l);const c=i.default.join(i.default.dirname(t),`${r}.har`),u=C(`tar -czf ${r}.har package`,i.default.dirname(t),o.shellStdio.pipe);if(!u||0!==u.status)throw new Error(`Failed to compress the HAR package ${r}.`);const d=i.default.join(l,s.Constants.MyPackageJson),f=(yield n.FsUtil.readJSON5(d)).name.replace("/","+")+s.Constants.HSP_SUFFIX,p=i.default.join(a,s.Constants.MyModules,s.Constants.HSP_SUFFIX,r,f);if(yield n.FsUtil.exists(p)){const t=i.default.join(e,f),s=i.default.join(e,`${r}.har`);yield n.FsUtil.copy(p,t),yield n.FsUtil.copy(c,s);const a=C(`tar -czf ${r}.tgz ${f} ${r}.har`,e,o.shellStdio.pipe);if(!a||0!==a.status)throw new Error(`Failed to compress the tgz package ${r}.`);yield n.FsUtil.rm(t,{recursive:!0,force:!0}),yield n.FsUtil.rm(s,{recursive:!0,force:!0})}else yield n.FsUtil.copy(c,i.default.join(e,`${r}.har`))}))},exports.packLibrariesLocal=function(t,r,s){return e(this,void 0,void 0,(function*(){const e=i.default.join(s,o.PACK_DIR);yield n.FsUtil.createDirIfNotExists(e);const a=i.default.join(i.default.dirname(t),"package");(yield n.FsUtil.exists(a))&&(yield n.FsUtil.rm(a,{recursive:!0,force:!0})),yield n.FsUtil.rename(t,a);const l=i.default.join(i.default.dirname(t),`${r}.har`),c=C(`tar -czf ${r}.har package`,i.default.dirname(t),o.shellStdio.pipe);if(!c||0!==c.status)throw new Error(`Failed to compress the Har package ${r}.`);yield n.FsUtil.copy(l,i.default.join(e,`${r}.har`))}))};