"use strict";var e=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(o,n){function s(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OverrideProjectJsonFile=void 0;const i=require("./types"),r=t(require("path")),o=require("../../util/FsUtil"),n=t(require("../../log")),s=require("../../common/message"),a=require("../../util"),c=require("../../common/Constants"),h=require("../../util/isFilePathSilentlySync"),l=require("../../util/isDirPathSilentlySync");exports.OverrideProjectJsonFile=class{constructor(e,t){this.key=this.resolveKey(e),this.configPath=this.resolvePath(t)}overrideConfig(t){return e(this,void 0,void 0,(function*(){if(!t)return t;this.projectJsonContent||(yield this.loadConfigFile());const e=Object.keys(i.SUPPORT_OVERRIDE_PROJECT_JSON_KEY);for(const r of e){const e=i.SUPPORT_OVERRIDE_PROJECT_JSON_KEY[r],o=this.projectJsonContent[e];o&&(t[e]=o)}return n.default.debug("",`Override config with ${this.key}:${this.configPath} succeed, final data: ${JSON.stringify(t)}.`),t}))}resolveKey(e){if(!e||!e.trim())throw new Error((0,s.format)(s.Messages.OverrideDepMap.KeyEmptyError,{key:e,configNode:c.Constants.PmRc}));if(e.trim().length===i.PREFIX_OVERRIDE_PROJECT_JSON.length)throw new Error((0,s.format)(s.Messages.OverrideDepMap.FilePathEmptyError,{configNode:c.Constants.PmRc,configName:e}));if(this.projectPath=r.default.resolve(e.slice(i.PREFIX_OVERRIDE_PROJECT_JSON.length).trim()),!a.FsBlockingUtil.existsSync(this.projectPath))throw new Error((0,s.format)(s.Messages.OverrideDepMap.FileUnExistError,{filePath:this.projectPath,configNode:c.Constants.PmRc,configName:e}));if(!(0,l.isDirPathSilentlySync)(this.projectPath))throw new Error((0,s.format)(s.Messages.OverrideDepMap.InvalidDirPathError,{filePath:this.projectPath,configNode:c.Constants.PmRc,configName:e}));return`${i.PREFIX_OVERRIDE_PROJECT_JSON}${this.projectPath}`}resolvePath(e){const t=r.default.isAbsolute(e)?e:r.default.resolve(this.projectPath,e);if(!a.FsBlockingUtil.existsSync(t))throw new Error((0,s.format)(s.Messages.OverrideDepMap.FileUnExistError,{filePath:e,configNode:c.Constants.PmRc,configName:this.key}));if(!(0,h.isFilePathSilentlySync)(t))throw new Error((0,s.format)(s.Messages.OverrideDepMap.InvalidFilePathError,{filePath:e,configNode:c.Constants.PmRc,configName:this.key}));return e}loadConfigFile(){return e(this,void 0,void 0,(function*(){const e=r.default.isAbsolute(this.configPath)?this.configPath:r.default.resolve(this.projectPath,this.configPath);this.projectJsonContent=yield o.FsUtil.readJSON5(e),n.default.debug("",`Load project json file content of ${this.key} - ${this.configPath} succeed, content: ${JSON.stringify(this.projectJsonContent)}.`)}))}};