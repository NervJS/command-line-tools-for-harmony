"use strict";var e=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(o,n){function s(e){try{l(r.next(e))}catch(e){n(e)}}function a(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OverrideDepMapFile=void 0;const i=require("./types"),r=t(require("../../log")),o=t(require("path")),n=require("../../util"),s=require("../../common/message"),a=t(require("semver")),l=require("../../util/FsUtil"),c=require("../../util/isFilePathSilentlySync"),d=require("../dependency/util"),u=require("../../common/Constants"),f=require("../../config"),h=require("../dependency/util/isInnerPkgDependency"),E=require("../install-targets/TargetManager");exports.OverrideDepMapFile=class{constructor(e,t,o){this.projectRoot=o,this.key=this.resolveKey(e),this.filePath=this.resolveFilePath(t),r.default.debug("",`Found ${i.NAME_OVERRIDE_DEPENDENCY_MAP} config -> ${this.key} - ${this.filePath}`)}getKey(){return this.key}overrideConfig(t){return e(this,void 0,void 0,(function*(){if(!t)return t;this.depFileContent||(yield this.loadDepMapFile());return Object.keys(i.SUPPORT_OVERRIDE_DEP_MAP_KEY).forEach((e=>{const r=i.SUPPORT_OVERRIDE_DEP_MAP_KEY[e],o=this.depFileContent[r];t[r]=o||{}})),r.default.debug("",`Override config with ${this.key}:${this.filePath} succeed, final data: ${JSON.stringify(t)}.`),t}))}getOverrideConfig(){return e(this,void 0,void 0,(function*(){if(E.TargetManager.getInstance().isTargetMod()){const e=this.getKey(),t=yield E.TargetManager.getInstance().getModuleOhPkgJsonByModuleName(e);if(t&&Object.keys(t).length>0)return t}return this.depFileContent||(yield this.loadDepMapFile()),this.depFileContent}))}resolveKey(e){if(!e||!e.trim())throw new Error((0,s.format)(s.Messages.OverrideDepMap.KeyEmptyError,{configNode:i.NAME_OVERRIDE_DEPENDENCY_MAP}));const t=e.lastIndexOf("@");if(t<=0||e.length<=t+1)return t>0&&(e=e.slice(0,e.length-1)),e;const r=e.slice(t+1);return(0,d.isLocalDependency)(r)?this.generateKeyByLocalSpec(e,t,r):(this.validSpec(r),e)}validSpec(e){if(!a.default.valid(e,{loose:!0})&&!(0,d.isStandardTagDependency)(e)&&e!==u.Constants.LATEST)throw new Error((0,s.format)(s.Messages.OverrideDepMap.InvalidSpecError,{spec:e,configNode:i.NAME_OVERRIDE_DEPENDENCY_MAP}))}generateKeyByLocalSpec(e,t,i){return i.startsWith("file:")&&(i=i.substring(5)),i=o.default.isAbsolute(i)?o.default.resolve(i):o.default.resolve(this.projectRoot,i),`${e.slice(0,t)}@${i}`}resolveFilePath(e){if(!e||!e.trim())throw new Error((0,s.format)(s.Messages.OverrideDepMap.FilePathEmptyError,{configNode:i.NAME_OVERRIDE_DEPENDENCY_MAP,configName:this.key}));const t=o.default.isAbsolute(e)?e:o.default.resolve(this.projectRoot,e);if(!n.FsBlockingUtil.existsSync(t))throw new Error((0,s.format)(s.Messages.OverrideDepMap.FileUnExistError,{filePath:e,configNode:i.NAME_OVERRIDE_DEPENDENCY_MAP,configName:this.key}));if(!(0,c.isFilePathSilentlySync)(t))throw new Error((0,s.format)(s.Messages.OverrideDepMap.InvalidFilePathError,{filePath:e,configNode:i.NAME_OVERRIDE_DEPENDENCY_MAP,configName:this.key}));return t}loadDepMapFile(){return e(this,void 0,void 0,(function*(){const e=yield l.FsUtil.readJSON5(this.filePath),t=f.config.get(f.types.ODM_R2_PROJECT_ROOT);this.depFileContent=t?yield this.resolveRelativeSpec(e):e,r.default.debug("",`Load file content of ${this.key} - ${this.filePath} succeed, odmR2ProjectRoot: ${t}, content: ${JSON.stringify(this.depFileContent)}.`)}))}resolveRelativeSpec(t){return e(this,void 0,void 0,(function*(){if(!t)return{};const e=Object.keys(i.SUPPORT_OVERRIDE_DEP_MAP_KEY);for(const r of e){const e=i.SUPPORT_OVERRIDE_DEP_MAP_KEY[r];t[e]=yield this.relativeToProject(t[e])}return t}))}relativeToProject(t){return e(this,void 0,void 0,(function*(){if(!t)return{};const e=Object.keys(t);if(!e||!e.length)return{};const i={};return e.forEach((e=>{const r=t[e];if(!r)throw new Error((0,s.format)(s.Messages.OverrideDepMap.InvalidVersionError,{filePath:this.filePath,key:e}));(0,d.isLocalDependency)(r)||(0,h.isInnerPkgDependency)(r)?i[e]=o.default.resolve(this.projectRoot,r.replace(/file:/i,"")):i[e]=r})),i}))}};