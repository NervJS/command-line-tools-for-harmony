"use strict";var e=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function c(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,c)}a((i=i.apply(e,n||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.savePackageJsonOfResolveConflict=void 0;const t=require("../../locker"),i=require("../../../util/FsUtil"),o=n(require("path")),r=require("../../../common/Constants"),s=n(require("../../../log")),c=require("../../install-targets/TargetManager"),a=require("../../dependency/util"),l=require("../../overrides");function d(e,n,t){if(!n)return n;const i=e.moduleRootDir;return Object.keys(n).forEach((o=>{var r;const s=(0,l.resolveSpecWithOverrides)(i,o,e.root.requirements);let c=t.getLockSpec(i,o,s);const d=null==c?void 0:c.lastIndexOf("@");d>0&&(c=c.slice(d+1)),(0,a.isLocalDependency)(n[`${o}`])&&(c=(null===(r=n[`${o}`])||void 0===r?void 0:r.includes(t.relativeSpec(i,c)))?n[`${o}`]:`file:${t.relativeSpec(i,c)}`),n[`${o}`]=c})),n}exports.savePackageJsonOfResolveConflict=function(n,a,l){return e(this,void 0,void 0,(function*(){if(!l.save)return;let e=yield c.TargetManager.getInstance().getModuleOhPkgJson(a.moduleRootDir);if(!e||!Object.keys(e).length){const n=o.default.join(a.moduleRootDir,r.Constants.MyPackageJson);e=yield i.FsUtil.readJSON5(n)}e=e||{},e.dependencies={},e.devDependencies={},e.dynamicDependencies={};const u=a.root,f=t.PackageLockerManager.getInstance();e.dependencies=d(a,u.dependencies,f),e.devDependencies=d(a,u.devDependencies,f),e.dynamicDependencies=d(a,u.dynamicDependencies,f),yield i.FsUtil.writeFile(o.default.join(n,r.Constants.MyPackageJson),JSON.stringify(e,null,2)),s.default.debug("",`savePackageJsonOfResolveConflict succeed, targetConflictPath: ${n}.`)}))};