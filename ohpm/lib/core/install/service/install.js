"use strict";var e=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((o=o.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.install=void 0;const t=require("../../../util"),n=require("./handleCliInput"),o=require("./installModules"),r=require("../../locker"),a=require("../../dependency/util/deleteEmptyOhModulesDir"),i=require("./updateCommandLineInputDependencies"),s=require("./createRootNodesForInstallation"),l=require("./getModuleRootDirs"),c=require("../../install-targets/TargetManager"),u=require("../common/savePackageJsonOfResolveConflict"),d=require("../../../config"),g=require("../../dependency/tree-store/DependencyTreeStore"),p=require("../common/updatePkgJson");exports.install=function(f,y,m,v){return e(this,void 0,void 0,(function*(){const e=(new Date).getTime(),M=(0,l.getModuleRootDirs)(f,m),D=r.PackageLockerManager.getInstance();try{D.syncLoadLockers(M);const e=yield(0,s.createRootNodesForInstallation)(M,y,m),t=yield(0,o.installModules)(e);m.saveDynamic||m.saveDev?m.saveProd=!1:m.saveProd=m.save;const l=d.config.get(d.types.AUTO_GENERATE_CUSTOM_DEPENDENCY_FILE);for(const e of t){if(e.moduleRootDir!==f||c.TargetManager.getInstance().isTargetMod()||((0,i.updateCommandLineInputDependencies)(e,n.cliInputNames),yield(0,p.updatePkgJson)(e.moduleRootDir,e.root,m,n.cliInputNames)),c.TargetManager.getInstance().isTargetMod()){const t=c.TargetManager.getInstance().getResolveConflictPath(e.moduleRootDir);yield(0,u.savePackageJsonOfResolveConflict)(t,e,m)}l&&g.DependencyTreeStore.getInstance().addModuleTree(e)}yield r.PackageLockerManager.getInstance().flushAllLockers()}finally{M.forEach((e=>(0,a.deleteEmptyOhModulesDir)(e))),v&&(yield v())}t.PrintUtil.printCostTime(e,"install")}))};