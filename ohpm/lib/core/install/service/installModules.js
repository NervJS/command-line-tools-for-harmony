"use strict";var e=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function l(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.installModules=void 0;const n=t(require("../../../log")),r=require("../../dependency/tree-builder/AsyncTreeBuilder"),o=require("../../dependency/visitor"),i=require("../../dependency/walker"),s=require("../../locker"),l=require("../../resolve-version/rebuildSingleDepTree"),c=require("../../../config"),a=require("../../dependency/util/deleteUselessHarStoreDir"),u=require("../../../common/GlobalState"),d=require("../../dependency/util"),f=require("../../../tools/ohpa/OhpaType"),g=require("../../../common/Constants"),y=require("../../../tools/posh"),p=require("../../alarm"),v=t(require("path")),m=require("../../install-targets/TargetManager"),h=require("../../install-targets/ProjectBuildProfile"),C=require("../../audit"),S=require("../../overrides"),M=require("../../override-dependency-map/OverrideProjectJsonManager"),k=require("../common/definitions"),P=require("../../../util/needResolveConflict"),T=require("../../version-conflict/VersionConflictManager"),q=require("../../version-conflict/impl/VersionStrictModeStrategy"),R=require("../../alarm/strictConflictVersionAlarm"),D=require("../../resolve-version/resolveVersionConflict2LockFile "),L=require("../../dependency/dep-lock/DependencyLockResolver"),O=require("../../../util/FsUtil"),I=require("../../dependency/dep-lock/types"),w=require("../../dependency/util/deleteUselessTmpDir"),_=require("../../resolve-version/resolveInnerPkgVersionConflict");function E(e){const t=new Set;return e.forEach((e=>{e.flatTree().filter((e=>!e.isRoot)).forEach((e=>{t.add(e.nodeKey)}))})),t.size}exports.installModules=function(t){return e(this,void 0,void 0,(function*(){const b=(0,P.needResolveConflict)(),F=c.config.get(c.types.RESOLVE_CONFLICT_STRICT),N=F?(0,R.strictConflictVersionAlarm)(b):(0,p.conflictVersionAlarm)(b);F&&T.VersionConflictManager.getInstance().setVerConflictStrategy(new q.VersionStrictModeStrategy);let j=h.projectBuildProfile.getUseOhmurl();j||(j=c.config.get(c.types.ENFORCE_DEPENDENCY_KEY));const A=(0,p.dependencyNameInconsistencyAlarm)(j),V=yield function(t,o,i,c,a){return e(this,void 0,void 0,(function*(){const u=[];let d=[];const f=Date.now();n.default.debug("TreeBuilding","building dependency trees.");for(const[e,n]of t){const t=new r.AsyncTreeBuilder({resolveConflict:c});u.push(t.build(e,n).then((()=>{d.push(t.getResult())})))}return yield Promise.all(u),c&&(0,_.resolveInnerPkgVersionConflict)(),d.forEach((e=>{o.recordConflictMessage(e),i.recordInconsistencyMessage(e)})),c&&(a&&o.alarmConflictMessage(a),d=yield function(t){return e(this,void 0,void 0,(function*(){const e=s.PackageLockerManager.getInstance();e.clearLockerCache();for(const n of t)(0,D.resolveVersionConflict2LockFile)(n,e);const n=[],r=[];for(const e of t)r.push((0,l.rebuildSingleDepTree)(e).then((e=>{n.push(e)})));return yield Promise.all(r),n}))}(d)),n.default.debug("TreeBuilding",`all dependency trees are built successfully, cost: ${Date.now()-f}ms.`),d}))}(t,N,A,b,F);return A.alarmInconsistencyMessage(),yield function(t){return e(this,void 0,void 0,(function*(){const e=Date.now();n.default.debug("TreeInstall","installing dependency trees.");const r=o.DepNodeInstaller.getInstance(),s=[];for(const e of t)s.push(r.run(new i.AsyncFlattenTreeWalker(e)));yield Promise.all(s),n.default.debug("TreeInstall",`all dependency trees are installed successfully, cost: ${Date.now()-e}ms.`),u.GlobalState.installMode.includes(u.ExperimentalOption.INSTALL_ALL)&&(yield(0,a.deleteUselessHarStoreDir)(c.config.getProjectRoot()))}))}(V),yield function(t){return e(this,void 0,void 0,(function*(){const r=Date.now();n.default.debug("TreeSymlink","Symlinking dependency trees");const l=o.DepNodeSymlinker.getInstance(),a=[];for(const e of t)a.push(l.run(new i.AsyncFlattenTreeWalker(e)));yield Promise.all(a),yield function(){return e(this,void 0,void 0,(function*(){const e=s.PackageLockerManager.getInstance();yield(0,d.deleteUselessLinks)(v.default.join(c.config.getProjectRoot(),g.Constants.MyModules,g.Constants.PmDir,g.Constants.MyModules),(t=>!!e.getMaxSatisfyingVersionData(t)))}))}(),yield(0,w.deleteUselessTmpDir)(c.config.getProjectRoot()),n.default.debug("TreeSymlink",`all dependency trees are symlinked successfully, cost ${Date.now()-r}ms`)}))}(V),N.alarmConflictMessage(!1),function(e){const t=e.filter((e=>e.moduleRootDir===c.config.getProjectRoot()))[0];if(!t)return;const r=t.root,o=[];for(const e of Object.keys(r.rawRequirements)){const n=r.rawRequirements[e];(0,d.parseDependency)(`${e}@${n.spec}`,t.moduleRootDir).type===f.OhpaType.SourceCode&&o.push(`${e}@${n.spec}`)}o.length>0&&n.default.log("warn",y.posh.bold.bgBlack.yellowBright(`Source code dependencies in project-level "${g.Constants.MyPackageJson}" are as follows, which could lead to circular dependencies reference.`)+y.posh.yellow(`\n\t - "${o.join('",\n\t - "')}"\n`))}(V),yield function(t){return e(this,void 0,void 0,(function*(){const e=yield L.DependencyLockResolver.getInstance().resolve(t);if(0===Object.keys(e.packages).length)return;const n=v.default.resolve(c.config.getProjectRoot(),g.Constants.MyModules,g.Constants.PmDir);yield O.FsUtil.createDirIfNotExists(n);const r=v.default.resolve(n,I.DependencyLockFileName),o=JSON.stringify(e,null,2);yield O.FsUtil.createFile(r),yield O.FsUtil.writeFile(r,o,{encoding:"utf8",flag:"w"})}))}(V),function(e,t,n){const r={packageNum:E(n),useTargetPath:m.TargetManager.getInstance().isTargetMod(),useInstallAll:!!u.GlobalState.installMode.find((e=>e===u.ExperimentalOption.INSTALL_ALL)),useResolveConflict:e,useResolveConflictStrict:c.config.get(c.types.RESOLVE_CONFLICT_STRICT),useParameterFile:!!c.config.getParameterFilePath(),useOverrides:S.overridesMap.size>0,useOverrideDepMap:M.OverrideProjectJsonManager.getInstance().getMapSize()>0,useStrictSsl:c.config.get(c.types.STRICT_SSL),useOdmR2ProjectRoot:c.config.get(c.types.ODM_R2_PROJECT_ROOT),useCrossProcessLock:c.config.get(c.types.ENABLE_CROSS_PROCESS_LOCK),useEnforceDepKey:t,useLockfileStableOrder:c.config.get(c.types.LOCKFILE_STABLE_ORDER)},o=C.auditParamsManager.get().useNoLink;r.useNoLink=void 0===o?!k.defaultInstallOptions.link:o,C.auditParamsManager.add(r)}(b,j,V),V}))};