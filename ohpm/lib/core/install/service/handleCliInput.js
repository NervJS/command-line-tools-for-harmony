"use strict";var e=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(r,o){function i(e){try{u(a.next(e))}catch(e){o(e)}}function s(e){try{u(a.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((a=a.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handleCliInput=exports.cliInputNames=void 0;const n=t(require("../../../log")),a=require("../../dependency/util"),r=require("../../../common/GlobalState"),o=require("../../../common/Constants"),i=require("../../../tools/ohpa/OhpaType"),s=require("../common/updateDependencies"),u=require("../../parameter"),c=t(require("path")),d=require("../../../common/message");function l(t,n,a,r,i){return e(this,void 0,void 0,(function*(){if(i.save){if(!(yield u.ParameterizationManager.getInstance().canModify(c.default.join(t,o.Constants.MyPackageJson),`${a}`)))throw new Error((0,d.format)(d.Messages.Parameterization.ForbiddenInstallError,{key:`${a}`}));exports.cliInputNames.push(a),(0,s.updateDependencies)(n,a,r.getRawSpec(),i)}else n.requirements[a]={spec:r.getFetchSpec(),depType:"noSave"}}))}function p(t,a,r,i){return e(this,void 0,void 0,(function*(){if(a.requirements[r]){if(!(yield u.ParameterizationManager.getInstance().canModify(c.default.join(t,o.Constants.MyPackageJson),`${r}`)))throw new Error((0,d.format)(d.Messages.Parameterization.ForbiddenUnInstallError,{key:`${r}`}));!function(e,t){delete e.requirements[t.getName()]}(a,i)}else n.default.warn("",`The package you want to uninstall: "${r}" does not exist in ${o.Constants.MyPackageJson}`)}))}function m(e,t,a){t.requirements[a]||n.default.warn("",`The package you want to update: "${a}" does not exist in ${c.default.resolve(e,o.Constants.MyPackageJson)}`)}function f(t){return e(this,void 0,void 0,(function*(){if(t.getName()&&t.getName().length)return t.getName();switch(t.getWhere(),t.getRaw(),t.getWhere(),t.type){case i.OhpaType.SourceCode:return(0,a.readDepNameFromSourceCode)(t.getFetchSpec());case i.OhpaType.File:return(0,a.readDepNameFromTarball)(t.getFetchSpec());default:return""}}))}exports.cliInputNames=[],exports.handleCliInput=function(t,o,i,s){return e(this,void 0,void 0,(function*(){for(const e of o){if(!e){n.default.warn("handleCliInput","empty package name.");continue}const o=(0,a.parseDependency)(e,t),u=yield f(o);if(!u)throw new Error((0,d.format)(d.Messages.Install.InvalidCliInputPkg,{pkg:o.getRaw()}));switch(r.GlobalState.command){case r.CommandType.INSTALL:yield l(t,i,u,o,s);break;case r.CommandType.UNINSTALL:yield p(t,i,u,o);break;case r.CommandType.UPDATE:m(t,i,u);break;default:n.default.warn("handleCliInput","invalid command.")}}}))};