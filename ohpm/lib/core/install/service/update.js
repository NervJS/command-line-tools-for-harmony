"use strict";var e=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{l(o.next(e))}catch(e){r(e)}}function a(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((o=o.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.updateSymlink=void 0;const t=require("../common/definitions"),n=require("../../../util"),o=require("../../../common/message"),i=require("../../dependency/util"),r=require("./installModules"),s=require("../../locker"),a=require("../../dependency/util/deleteEmptyOhModulesDir"),l=require("../common/updatePkgJson"),c=require("./createRootNodesForInstallation"),u=require("./getModuleRootDirs"),d=require("../../../common/Constants");exports.updateSymlink=function(f,g,p){return e(this,void 0,void 0,(function*(){const m=(new Date).getTime();if(!g)throw new Error(o.Messages.Common.PkgNotFound);const y=Object.assign(Object.assign({},t.defaultInstallOptions),p),h=y.tagFilter?y.tagFilter:void 0,k=(0,u.getModuleRootDirs)(g,y),q=yield(0,c.createRootNodesForInstallation)(k,f,y),v=s.PackageLockerManager.getInstance();v.syncLoadLockers(k);const M=y.allModules?k:[g];f&&0!==f.length||h?M.forEach((e=>{!function(e,t,n,o){const r=s.PackageLockerManager.getInstance();(t&&0!==t.length?Object.keys(n).filter((e=>t.find((t=>t===e)))):Object.keys(n)).forEach((t=>{const s=n[t].spec,a=`${t}@${s}`;o?(0,i.isStandardTagDependency)(s)&&o.test(s.slice(d.Constants.TAG_PREFIX.length))&&r.deleteSpecifier(e,a):r.deleteSpecifier(e,a)}))}(e,f,q.get(e).requirements,h)})):v.clearSpecifiers(g,y);try{yield(0,r.installModules)(q),yield Promise.all(M.map((t=>e(this,void 0,void 0,(function*(){yield(0,l.updatePkgJson)(t,q.get(t),y)}))))),yield v.flushAllLockers()}finally{k.forEach((e=>(0,a.deleteEmptyOhModulesDir)(e)))}n.PrintUtil.printCostTime(m,"update")}))};