"use strict";var e=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))((function(o,n){function c(e){try{a(i.next(e))}catch(e){n(e)}}function s(e){try{a(i.throw(e))}catch(e){n(e)}}function a(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(c,s)}a((i=i.apply(e,r||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DevEcoTraceWriter=void 0;const t=require("../utils/TraceToEventUtils"),i=require("../utils/DevEcoKeyProducerUtils"),o=require("../utils/DateUtils"),n=r(require("path")),c=require("../../../util/FsUtil"),s=require("../TracePathConfig"),a=require("../../../tools/encrypt/factory/EncryptFactory"),u=require("../../../tools/encrypt/EncryptType"),f=require("../utils/BufferUtils"),l=require("../../../common/message");class T{static getInstance(){return this.INSTANCE||(this.INSTANCE=new T),this.INSTANCE}getTraceFilePath(){const e=s.TracePathConfig.getTraceLogDir(),r=`${s.TracePathConfig.TRACE_FILE_NAME_PREFIX}${s.TracePathConfig.SERVICE_FLAG}_${o.DateUtils.getCurDateToHour()}`;return n.default.join(e,r)}write(r){return e(this,void 0,void 0,(function*(){const e=yield i.DevEcoKeyProducerUtils.getKey(),o=yield(0,t.convertTraceToEvent)(r,!1);if(!o)throw f.BufferUtils.freeBuffer(e),new Error(l.Messages.TraceWriter.TraceConvertError);const n=a.EncryptFactory.encrypt(e,JSON.stringify(o.toJSON()),u.EncryptType.AES);if(!n)throw f.BufferUtils.freeBuffer(e),new Error(l.Messages.TraceWriter.TraceEncryptError);f.BufferUtils.freeBuffer(e),yield this.writeToFile(n.concat("\n"))}))}writeToFile(r){return e(this,void 0,void 0,(function*(){if(!r)throw new Error(l.Messages.TraceWriter.TraceWriteError);const e=this.getTraceFilePath();yield c.FsUtil.appendFile(e,r)}))}}exports.DevEcoTraceWriter=T;