"use strict";var e=this&&this.__awaiter||function(e,c,a,d){return new(a||(a=Promise))((function(f,t){function r(e){try{i(d.next(e))}catch(e){t(e)}}function b(e){try{i(d.throw(e))}catch(e){t(e)}}function i(e){var c;e.done?f(e.value):(c=e.value,c instanceof a?c:new a((function(e){e(c)}))).then(r,b)}i((d=d.apply(e,c||[])).next())}))},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DevEcoKeyProducerUtils=void 0;const a=require("../../../util/FsUtil"),d=require("./HexUtils"),f=require("./PbkdfUtils"),t=require("./isInnerIDE"),r=require("../../../tools/encrypt/factory/EncryptFactory"),b=require("../../../tools/encrypt/EncryptType"),i=require("./BufferUtils"),o=require("../../../common/message"),n=c(require("path")),s=require("../TracePathConfig");class l{static getKey(){return e(this,void 0,void 0,(function*(){const e=yield this.getRootKey(),c=yield this.getLocalKey(),a=r.EncryptFactory.decrypt(e,c,b.EncryptType.AES),f=d.HexUtils.hexString2ByteArray(a.toString("utf-8"));return i.BufferUtils.freeBuffer(e),Buffer.from(f)}))}static getRootKey(){return e(this,void 0,void 0,(function*(){const e=n.default.join(s.TracePathConfig.getTraceLogDir(),l.LOCAL_ROOT_KEY_FILE_NAME);if(!(yield a.FsUtil.exists(e)))throw new Error((0,o.format)(o.Messages.TraceWriter.FileUnExistError,{fileDesc:"root key"}));const c=(yield a.FsUtil.readJSON(e)).salt;let r;r=(yield(0,t.isInnerIDE)())?l.getCombinedKey(l.TRACE_ONE,l.TWO,l.THREE,l.FOURTH):l.getCombinedKey(l.TRACE_ONE,l.TRACE_TWO,l.TRACE_THREE,l.TRACE_FOURTH);const b=d.HexUtils.hexString2ByteArray(c),u=f.PbkdfUtils.encrypt(r,Buffer.from(b));return i.BufferUtils.freeBuffer(r),u}))}static getCombinedKey(e,c,a,f){const t=d.HexUtils.hexString2ByteArray(e),r=d.HexUtils.hexString2ByteArray(c),b=d.HexUtils.hexString2ByteArray(a),i=d.HexUtils.hexString2ByteArray(f),o=Math.min(t.length,r.length,b.length,i.length),n=[];for(let e=0;e<o;e++){const c=t[e]^r[e]^b[e]^i[e];n[e]=d.HexUtils.byteToChar(c)}return Buffer.from(n.join(""))}static getLocalKey(){return e(this,void 0,void 0,(function*(){const e=n.default.join(s.TracePathConfig.getTraceLogDir(),l.LOCAL_KEY_FILE_NAME);if(!(yield a.FsUtil.exists(e)))throw new Error((0,o.format)(o.Messages.TraceWriter.FileUnExistError,{fileDesc:"local key"}));return(yield a.FsUtil.readJSON(e)).localKey}))}}exports.DevEcoKeyProducerUtils=l,l.LOCAL_ROOT_KEY_FILE_NAME="a.json",l.LOCAL_KEY_FILE_NAME="b.json",l.TRACE_ONE="365eb0993e8ce7d0abc3cee5433d99b405ee72ba386e3f89087ca9800462bd836263ec66b4df68d110f093f2b583e7bf5ce4a68a2474ba6cdd8fce34a21ea23a7d82450a556b128ec8e1726c6f7b9a6c038831e148e4826a82847808cb6837a81266cc3dcfa6aaa0e63b5d1b215656687a3a2309449ee8ff7840094ac3d8f26c",l.TWO="04199decbb1f3dfb241bcba8d234073ec311a1a563d6e2d719720b2b8b70326946c097357c9065a1c0dbab804b59b55bdce7cf3c6ea70550f4fe4ea986c05525a5fa5b018246433dcd2ad4e0c775701d14c7bd10d0660ade18782320e3551a0e4f6ff1aa22df65b831d3cd752d543731ef336fee9252fe971f50086eb58b4c1a",l.TRACE_TWO="8722d88e31d50af16f3dd1c41bcf59222faf20201481e5ba89ceed4c6e39976d87db618509a5baf23d2722afae71639c1263cddfb3e331fc90ca9e7b04697ed994c582dcac522237441cbf3515aeb3cdb5c8bd179a8cbbdaa8653020cf53e0b5372aa219154d08c967e7adc1dc8e0547f2620f4678d64c4388c60b92c25aa050CTAV=94e534a76d3286acf4b96eb08d372885a4454651a4d375b6868495aed56a9afcdcdde90ccb519b2390744e3b50dd3e1e62520bc083943d1e4ca0d07c10ad249e",l.THREE="886b5aa308962eb23d218e258c5ee95fe4e8b9fc8229c016c4ce063ba5be123c039c84bd535b0fde94ef1d0159488b77c7cde1aebf2a466465baa5c7998ec1a8049a12ca77c8f9fff0cc0a9305810a7228160147acc0679c3612bb20f4ae43fb00adff304c698bf4ff0928fe581c4a340c4999e697098ab66eaf6cfc73bdff88",l.TRACE_THREE="744e446b7da3d9fe6c8beeb5135daca5fd5b8ff81a06409b613eb195e2efe75225fc2970e508c9434062d36b40008967b1cc7f39f1034e77b9cad0ff5c43d90d0a493444daf416f9deba8fadad166bddb03c4445cbb43c1b211e5d9ccf9c35d699c44d331a862be5a17a5211675e368aa9a80aa071d384f48a9d65d7100f6863",l.FOURTH="0bf2cbd9e75ae9527fbe909e358eab40d6e7faca88b9f6ca9775d15c7c63cfef4dd684c66035e970ed6805b72c849ccfed8fa2a76ecded1358c08859ba516e78e5e7524075419268229e0e5e2d55937da65c5ad924402d28108fa05edf83a73854eb2c2f868fdd26edd88482943f74d02e2ccec557a83c29ae9e3b772cb29ecb",l.TRACE_FOURTH="65471ef6114e7cc8ff0fae51b489d2cd10aa92d61743873d10bb64c321456ce96a40bc9fbb1b3242ac5bc61b7b97be852f0a26ed07bd2aa7fcead13659beae8dc57ee634eb33c8f5d03b7b2b4989c14a82f5e65c1a38a78d218fdf93a1bf98a64e6950430f1a8f73e4717ec0c634d9d2789bb08d24dd137cef5d970266dc9d9e";