"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,s)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(n){if(n&&n.__esModule)return n;var i={};if(null!=n)for(var s in n)"default"!==s&&Object.prototype.hasOwnProperty.call(n,s)&&e(i,n,s);return t(i,n),i},i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(s,r){function o(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPkgContent=exports.logHsp=exports.logHar=exports.buildHarMetaData=exports.patchManifest=exports.getManifest=exports.genCachePath=exports.isTgzFile=void 0;const s=n(require("path")),r=require("../../util"),o=require("../../tools/ssri/Ssri"),a=n(require("tar")),u=require("../../tools/columnify/Columnify"),c=require("../../common/Constants"),l=require("uuid"),p=require("../cache"),f=require("../../config"),g=require("../../util/FsUtil"),d=require("stream");function h(){const e=`${f.config.getString(f.types.CACHE)}/${p.CacheConstants.HarBallDir}/${(0,l.v4)().replace(/-/g,"")}/`;return r.FsBlockingUtil.createDirIfNotExists(e),e}exports.isTgzFile=function(e){return!!e&&e.toLowerCase().endsWith(c.Constants.TGZ_SUFFIX)},exports.genCachePath=h,exports.getManifest=function(e,t,n){return i(this,void 0,void 0,(function*(){let i;const o=n&&"{}"!==n?n:h();let u;void 0===e?i=s.join(t,c.Constants.MyPackageJson):r.FsBlockingUtil.statSync(e).isDirectory()?i=s.join(e,c.Constants.MyPackageJson):(yield a.extract({file:e,cwd:o,strip:1}),i=s.join(o,c.Constants.MyPackageJson));try{u=r.FsBlockingUtil.readJSON5Sync(i),u.harCache=o}catch(e){if(e&&e.message){const t=g.FsUtil.slash(o);e.message=e.message.replace(t,"package/")}throw e}return u}))},exports.patchManifest=function(e){return i(this,void 0,void 0,(function*(){return e._nodeVersion=process.versions.node,e[`_${c.Constants.PM}Version`]=c.Constants.PmVersion,e}))},exports.buildHarMetaData=function(e,t,n){return i(this,void 0,void 0,(function*(){const i=Object.assign({},t),s={_id:i.name,name:i.name,packageType:i.packageType,description:i.description,"dist-tags":{},versions:{}};s.versions[i.version]=i;const r=i.tag||"latest";s["dist-tags"][r]=i.version;const o=`${i.name}-${i.version}${c.Constants.HAR_SUFFIX}`,a=`${i.name}/-/${o}`;return i._id=`${i.name}@${i.version}`,i.dist=Object.assign({},i.dist),i.dist.integrity=n,i.dist.tarball=new URL(a,e).href.replace(/^http:\/\//,"https://"),s}))},exports.logHar=function(e,t){return i(this,void 0,void 0,(function*(){const n=new RegExp(`^${c.Constants.MyModules}/`);(0,r.output)(`registry:${t.registry}`),(0,r.output)(""),(0,r.output)(`package:${e.name}@${e.version}\n`),(0,r.output)("=== Harball Contents ==="),e.files.length&&(0,r.output)(u.columnify.format(e.files.map((e=>{const t=y(e.size,!1);return/^node_modules\//.test(e.path)||n.test(e.path)?"":{key:`${t}`,value:e.path}})))),(0,r.output)("=== Harball Details ==="),(0,r.output)(u.columnify.format([{key:"name:",value:e.name},{key:"version:",value:e.version},e.filename&&{key:"filename:",value:e.filename},{key:"package size:",value:y(e.size)},{key:"unpacked size:",value:y(e.unpackedSize)},{key:"shasum:",value:e.shasum},{key:"integrity:",value:e.integrity.toString()},{key:"total files:",value:e.entryCount}])),(0,r.output)("")}))},exports.logHsp=function(e){return i(this,void 0,void 0,(function*(){(0,r.output)("=== Hspball Details ==="),(0,r.output)(u.columnify.format([{key:"shasum:",value:e.shasum},{key:"integrity_hsp:",value:e.integrity.toString()}])),(0,r.output)("")}))},exports.getPkgContent=function(e,t){return i(this,void 0,void 0,(function*(){const n=[];let i=0,s=0;const r=(yield g.FsUtil.stat(e)).size,u=g.FsUtil.createReadStream(e),l=new d.PassThrough,p=new d.PassThrough;u.pipe(l),u.pipe(p);const f=a.t({onentry(e){"Directory"!==e.type&&(i++,s+=void 0===e.size?0:e.size,n.push({path:e.path.replace(/^package\//,""),size:void 0===e.size?0:e.size,mode:e.mode}))}});l.pipe(f);const h=yield o.ssri.fromStream(p,{algorithms:["sha1","sha512"]}),y=e=>{const t=e.charAt(0);return t===t.toUpperCase()},m=n.filter((e=>y(e.path))),v=n.filter((e=>!y(e.path)));return function(e){const t=e.integrity.get("sha1")[0].getDigest();return e.manifest?{id:e.manifest._id||`${e.manifest.name}@${e.manifest.version}`,name:e.manifest.name,version:e.manifest.version,size:e.size,unpackedSize:e.totalEntrySize,shasum:t,integrity:o.ssri.parse(e.integrity.getIntegrity()),filename:`${e.manifest.name}-${e.manifest.version}${c.Constants.HAR_SUFFIX}`,files:e.uppers.concat(e.others),entryCount:e.totalEntries,packageType:e.manifest.packageType}:{size:e.size,unpackedSize:e.totalEntrySize,shasum:t,integrity:o.ssri.parse(e.integrity.getIntegrity()),files:e.uppers.concat(e.others),entryCount:e.totalEntries}}({totalEntries:i,totalEntrySize:s,integrity:h,manifest:t,size:r,uppers:m,others:v})}))};const y=(e,t=!0)=>{let n="";return t&&(n=" "),e<1024?`${e}${n}B`:e<1048576?`${(e/1024).toFixed(1)}${n}kB`:e<1073741824?`${(e/1048576).toFixed(1)}${n}MB`:`${(e/1073741824).toFixed(1)}${n}GB`};