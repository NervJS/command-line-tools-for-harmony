"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var a=Object.getOwnPropertyDescriptor(t,i);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,a)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(i){if(i&&i.__esModule)return i;var r={};if(null!=i)for(var a in i)"default"!==a&&Object.prototype.hasOwnProperty.call(i,a)&&e(r,i,a);return t(r,i),r},r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PublishCore=void 0;const s=require("./common"),n=require("./util/validPkgPath"),o=require("../scripts/ScriptRunner"),l=require("../dependency/util"),u=a(require("path")),c=i(require("tar")),d=require("../../util"),h=require("../missing-dep-detect/DepStatementsMissingDetector"),g=require("../../config"),p=a(require("../../log")),f=require("../../common/message"),v=require("../../common/Constants"),y=require("./util/validatePkgSize"),P=require("./util/validateHmPackage"),m=require("../validator"),b=require("./util/validateTag"),k=require("./util/getAndValidPublishRegistry"),M=require("./util/validAndFixAuthor"),C=require("../../util/FsUtil"),S=require("../registry/publication/impl/OhpmPublication"),E=require("../registry/publication/utils/getAuthorization"),D=require("./util/validateCompability"),z=require("./util/interceptDebugPackage"),_=require("../registry/publication/impl/authorization/SshAuthorization"),H=require("../audit"),T=require("../registry/types");exports.PublishCore=class{constructor(){this.validator=m.PackageValidatorImpl.getInstance()}prepublish(e){return r(this,void 0,void 0,(function*(){let t,i=!1;try{(0,n.validPkgPath)(e),i=(0,s.isTgzFile)(e),t=yield this.getManifest(e,i),t=yield(0,M.validAndFixAuthor)(t),yield this.validPublishPkg(i,e,t),(0,z.interceptDebugPackage)(!1,t),d.PrintUtil.printSucceedMsg(`prepublish ${t.name} ${t.version} succeed.`)}finally{yield this.clearCache(i,t)}}))}publish(e,t){return r(this,void 0,void 0,(function*(){let i,r=!1;try{(0,n.validPkgPath)(e),(0,b.validateTag)(t.tag),r=(0,s.isTgzFile)(e),i=yield this.getManifest(e,r),i=yield(0,M.validAndFixAuthor)(i);const a=(0,k.getAndValidPublishRegistry)(i,t);yield this.validPublishPkg(r,e,i),o.ScriptRunner.runHook(o.ScriptConstants.prePublish,void 0,i),yield this.publishPkg(r,e,i,a),o.ScriptRunner.runHook(o.ScriptConstants.postPublish,void 0,i)}finally{yield this.clearCache(r,i)}}))}validPublishPkg(e,t,i){return r(this,void 0,void 0,(function*(){if(yield(0,D.validateCompability)(t,i),yield this.validator.validate(i),yield this.missingDepStatementCheck(i),e){this.validPackageType(i.packageType);const e=u.default.resolve(i.cache,i.hspPkg.interfaceHar),t=yield this.validHarContent(e,i),r=u.default.resolve(i.cache,i.hspPkg.hsp),a=yield this.validHspContent(r);i.size=t.pkgSize+a.pkgSize,i.fileNum=t.pkgFileNum+a.pkgFileNum}else{const e=yield this.validHarContent(t,i);i.size=e.pkgSize,i.fileNum=e.pkgFileNum}}))}validHarContent(e,t){return r(this,void 0,void 0,(function*(){const i=yield(0,s.getPkgContent)(e,t);return(0,y.validatePkgSize)(i),(0,P.validateHmPackage)(t,t.harCache),{pkgSize:i.size,pkgFileNum:i.entryCount}}))}validHspContent(e){return r(this,void 0,void 0,(function*(){const t=yield(0,s.getPkgContent)(e,null);if(t.size<=0)throw new Error((0,f.format)(f.Messages.Publish.HspFileIsEmpty,{path:e}));return(0,y.validatePkgSize)(t),{pkgSize:t.size,pkgFileNum:t.entryCount}}))}getManifest(e,t){return r(this,void 0,void 0,(function*(){const i=process.cwd();return t?this.getTgzManifest(e,i):this.getHarManifest(e,i)}))}getMetaData(e,t,i,a){return r(this,void 0,void 0,(function*(){const r=a?yield this.buildTgzMeta(e,t,i):yield this.buildHarMeta(e,t,i);return r.pkg=e,r.isTgz=a,r}))}getTgzManifest(e,t){return r(this,void 0,void 0,(function*(){const i=yield(0,l.hspDetect)(e);if(!i)throw new Error((0,f.format)(f.Messages.Publish.InvalidTgzFile,{path:e}));const r={};r.hspPkg=i;const a=(0,s.genCachePath)();r.cache=a,r.harCache=u.default.resolve(a,i.interfaceHar.split(".")[0]),r.hspCache=u.default.resolve(a,i.hsp.split(".")[0]),c.extract({file:e,cwd:a,strip:0,sync:!0},[i.interfaceHar,i.hsp]),d.FsBlockingUtil.createDirIfNotExists(r.harCache),d.FsBlockingUtil.createDirIfNotExists(r.hspCache);const n=yield this.getHarManifest(u.default.resolve(a,i.interfaceHar),t,r.harCache);return Object.assign(Object.assign({},r),n)}))}getHarManifest(e,t,i){return r(this,void 0,void 0,(function*(){let r=yield(0,s.getManifest)(e,t,i);return r=yield(0,s.patchManifest)(r),r}))}missingDepStatementCheck(e){return r(this,void 0,void 0,(function*(){const t=e.harCache,i=new h.DepStatementsMissingDetector,r=[];try{r.push(...yield i.detectMissingDeps(t))}catch(e){if(g.config.get(g.types.ENSURE_DEPENDENCY_INCLUDE))throw e}if(r.length>0){if(g.config.get(g.types.ENSURE_DEPENDENCY_INCLUDE))throw i.missingMessages.forEach((e=>p.default.error("",e))),new Error(f.Messages.Publish.DepStatementsMissing);i.missingMessages.forEach((e=>p.default.warn("",e)))}}))}publishPkg(e,t,i,a){return r(this,void 0,void 0,(function*(){const r=yield this.getMetaData(t,i,a,e),s=yield(0,E.getAuthorization)(a.registry);(0,z.interceptDebugPackage)(s instanceof _.SshAuthorization,i),this.genPublishAuditData(i,s);const n=yield new S.OhpmPublication(s).publishPackage(i.size,r,a.registry);d.PrintUtil.printSucceedMsg(`+${i.name} ${i.version} `),n.additionalMsg&&(0,d.output)(n.additionalMsg)}))}buildTgzMeta(e,t,i){return r(this,void 0,void 0,(function*(){this.validPackageType(t.packageType);const e=[],r=[],a=u.default.resolve(t.cache,t.hspPkg.interfaceHar);r.push(this.buildHarMeta(a,t,i).then((t=>{e.push(t)})));const s=u.default.resolve(t.cache,t.hspPkg.hsp);return r.push(this.buildHspMeta(s).then((t=>{e.push(t)}))),yield Promise.all(r),this.mergeResolves(t.name,t.version,e)}))}mergeResolves(e,t,i){return r(this,void 0,void 0,(function*(){let r=-1,a=-1;if(i.forEach(((e,t)=>{e.name?r=t:a=t})),-1===r||-1===a)throw new Error((0,f.format)(f.Messages.Publish.BuildTgzMetadataFailed,{name:e,version:t}));const s=i[r];return s.versions[t].dist.integrity_hsp=i[a].integrity_hsp,s.hspType=i[a].hspType,s}))}validPackageType(e){if(!e)throw new Error(f.Messages.Validator.PackageTypeEmptyError);if(e!==v.Constants.HSPPackageType)throw new Error(f.Messages.Validator.PackageTypeInvalidError)}buildHarMeta(e,t,i){return r(this,void 0,void 0,(function*(){const r=yield(0,s.getPkgContent)(e,t);return yield(0,s.logHar)(r,i),(0,s.buildHarMetaData)(i.registry,t,r.integrity.toString())}))}buildHspMeta(e){return r(this,void 0,void 0,(function*(){const t=yield(0,s.getPkgContent)(e,null);return yield(0,s.logHsp)(t),{integrity_hsp:t.integrity.toString(),hspType:v.HspType.BUNDLE_APP}}))}clearCache(e,t){return r(this,void 0,void 0,(function*(){p.default.debug("","start clear cache."),t&&(e?yield C.FsUtil.remove(t.cache):yield C.FsUtil.remove(t.harCache),p.default.debug("","clear cache succeed."))}))}genPublishAuditData(e,t){const i={packageSize:e.size,fileNum:e.fileNum,authMode:t instanceof _.SshAuthorization?T.AuthType.sshKey:T.AuthType.accessToken,useStrictSsl:g.config.get(g.types.STRICT_SSL),useEnsureDepInclude:g.config.get(g.types.ENSURE_DEPENDENCY_INCLUDE)};H.auditParamsManager.add(i)}};