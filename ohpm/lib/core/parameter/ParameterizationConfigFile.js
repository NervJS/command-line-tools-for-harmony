"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,i)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var a={};if(null!=r)for(var i in r)"default"!==i&&Object.prototype.hasOwnProperty.call(r,i)&&e(a,r,i);return t(a,r),a},a=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(i,o){function n(e){try{l(a.next(e))}catch(e){o(e)}}function s(e){try{l(a.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}l((a=a.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ParameterizationConfigFile=void 0;const o=require("../../config"),n=i(require("path")),s=require("../../common/Constants"),l=require("../../util/FsUtil"),d=i(require("../../log")),f=require("./types"),c=require("./index"),h=require("../../util"),u=i(require("fs-extra")),P=require("../../common/message"),m=i(require("semver")),g=require("../dependency/util"),E=require("../override-dependency-map/readProjectOhPackageJson5"),p=r(require("tar")),y=require("../../common/GlobalState"),F=require("../publish/common");class v{constructor(){this.loaded=!1,this.parameterJson={},this.parameterFilePath=""}isLoaded(){return this.loaded}isParameterFileConfiged(){return a(this,void 0,void 0,(function*(){const e=o.config.getProjectRoot(),t=n.default.join(e,s.Constants.MyPackageJson);yield this.validProjectRoot(e,t);const r=yield(0,E.readProjectOhPackageJson5)();if(this.validPkgJson(r),!r.parameterFile)return!1;let a="";try{if(a=(0,c.getObjectValueByKey)(v.KEY_PARAMETER_FILE_PATH,r),!a)return!1}catch(e){return d.default.error("",`Found exception while get "${v.KEY_PARAMETER_FILE_PATH}" path from ${s.Constants.MyPackageJson}, ${e}`),!1}if(a=n.default.resolve(o.config.getProjectRoot(),a),!h.FsBlockingUtil.existsSync(a))throw new Error((0,P.format)(P.Messages.Parameterization.ConfiguredProjectLevelParameterFileNotExist,{parameterPath:a}));if(!this.isFilePath(a))throw new Error((0,P.format)(P.Messages.Parameterization.InvalidFilePathError,{filename:`${s.Constants.MyPackageJson}`}));if(!this.isFileNotEmpty(a))throw new Error((0,P.format)(P.Messages.Parameterization.FileContentEmptyError,{filepath:`${a}`}));return!0}))}validPkgJson(e){if(!e)throw new Error(P.Messages.Parameterization.FileEmptyError)}validProjectRoot(e,t){return a(this,void 0,void 0,(function*(){if(!e||!(yield l.FsUtil.exists(t)))throw new Error(P.Messages.Parameterization.NotFoundProjectRootError)}))}loadParameterFile(){return a(this,void 0,void 0,(function*(){if(this.isLoaded())return;d.default.debug("","start load parameterFile.");const e=Date.now();if(o.config.getParameterFilePath()?(d.default.debug("","The path of the parameterFile is obtained from the CLI."),this.parameterFilePath=n.default.isAbsolute(o.config.getParameterFilePath())?o.config.getParameterFilePath():n.default.resolve(o.config.getProjectRoot(),o.config.getParameterFilePath())):this.parameterFilePath=yield this.getParameterFilePathFromProjectRoot(),!h.FsBlockingUtil.existsSync(this.parameterFilePath))throw new Error((0,P.format)(P.Messages.Parameterization.ParameterFileNotExist,{parameterFilePath:this.parameterFilePath}));if(!this.isFilePath(this.parameterFilePath))throw new Error((0,P.format)(P.Messages.Parameterization.InvalidFilePathError,{filename:`${s.Constants.MyPackageJson}`}));if(!this.isFileNotEmpty(this.parameterFilePath))throw new Error((0,P.format)(P.Messages.Parameterization.FileContentEmptyError,{filepath:`${this.parameterFilePath}`}));this.parameterJson=yield l.FsUtil.readJSON5(this.parameterFilePath),this.parameterJson?yield this.validParameters(this.parameterJson):d.default.warn("",`the content of ${v.KEY_PARAMETER_FILE_PATH} is empty in ${this.parameterFilePath}`),this.loaded=!0,d.default.debug("",`load parameterFile completed in ${(0,h.calculateCostTime)(e)}.`)}))}validParameters(e){return a(this,void 0,void 0,(function*(){if(!e)return;const t=Object.keys(e);for(const r of t){this.validKey(r);const t=(0,c.getObjectValueByKey)(r,e);if("string"==typeof t)yield this.validVersion(r,t);else{if("object"!=typeof t)throw new Error((0,P.format)(P.Messages.Parameterization.VersionTypeError));yield this.validParameters(t)}}}))}findVersion(e){return a(this,void 0,void 0,(function*(){if(d.default.debug("",`start find parameter version of ${e}.`),!this.preFind(e))return d.default.warn("",`parameterKey '${e}' is empty or invalid!`),e;const t=e.slice(v.KEY_PARAMETER_INDEX_START).split(v.KEY_PARAMETER_SPILITER);let r=this.matchValueWithLongestPrefixStrategy(t,this.parameterJson);return(0,g.isLocalDependency)(r)&&(r=this.resolveLocalDependencyPath(r)),this.postFind(t,r)}))}matchValueWithLongestPrefixStrategy(e,t){let r="";for(let a=e.length;a>0;a--){const i=e.slice(0,a).join(".");if(r=this.getValueFromJson(i,r,t),"string"==typeof r)return r;if(r&&("object"==typeof r&&a!==e.length&&(r=this.matchValueWithLongestPrefixStrategy(e.slice(a,e.length),r),r)))return r}return""}getValueFromJson(e,t,r){return t=t?(0,c.getObjectValueByKey)(e,t):(0,c.getObjectValueByKey)(e,r)}preFind(e){return d.default.debug("",`start pre-find, parameterKey: ${e}.`),!!e&&v.REGEX_PARAMETER.test(e)}postFind(e,t){if(d.default.debug("",`start post-find, parameter path size: ${e.length}.`),!t)throw new Error((0,P.format)(P.Messages.Parameterization.ParameterUnExistError,{parameterPath:e.join("."),filePath:this.parameterFilePath}));if("string"!=typeof t)throw new Error((0,P.format)(P.Messages.Parameterization.InvalidParameterConfigError,{parameterPath:e.join("."),filePath:this.parameterFilePath}));return d.default.debug("",`find parameter version succeed: '@param:${e.join(".")}' -> '${t}'.`),t}validConsistencyOfDepNameAndActualPkgName(e,t){return a(this,void 0,void 0,(function*(){let r;if(r=this.isFilePath(t)?(0,F.isTgzFile)(t)?yield this.readOhPkgJsonOfTgz(e,t):yield this.readOhPkgJsonOfHar(e,t):yield l.FsUtil.readJSON5(n.default.join(t,s.Constants.MyPackageJson)),!r||!Object.keys(r))throw new Error((0,P.format)(P.Messages.Parameterization.ReadOhPkgJsonError,{parameterKey:e,parameterValue:t}));if(e!==r.name)throw new Error((0,P.format)(P.Messages.Parameterization.InconsistentDepNames,{depName:e,depPath:t,actualPkgName:r.name}))}))}readOhPkgJsonOfHar(e,t){return a(this,void 0,void 0,(function*(){const r=n.default.join(o.config.getProjectRoot(),s.Constants.MyModules,`${e}-${Date.now()}`);yield l.FsUtil.createDirIfNotExists(r);try{p.extract({file:t,cwd:r,strip:0,sync:!0},[`package/${s.Constants.MyPackageJson}`]);const e=n.default.join(r,`package/${s.Constants.MyPackageJson}`);if(e)return yield l.FsUtil.readJSON5(e)}finally{yield l.FsUtil.remove(r)}return{}}))}readOhPkgJsonOfTgz(e,t){return a(this,void 0,void 0,(function*(){const r=n.default.join(o.config.getProjectRoot(),s.Constants.MyModules,`${e}-${Date.now()}`);yield l.FsUtil.createDirIfNotExists(r);try{let e="";p.extract({file:t,cwd:r,strip:0,sync:!0,filter:(t,r)=>!!t.endsWith(s.Constants.HAR_SUFFIX)&&(e=t,!0)}),p.extract({file:n.default.join(r,e),cwd:r,strip:0,sync:!0},[`package/${s.Constants.MyPackageJson}`]);const a=n.default.join(r,`package/${s.Constants.MyPackageJson}`);if(a)return yield l.FsUtil.readJSON5(a)}finally{yield l.FsUtil.remove(r)}return{}}))}getParameterFilePathFromProjectRoot(){return a(this,void 0,void 0,(function*(){const e=o.config.getProjectRoot(),t=n.default.join(e,s.Constants.MyPackageJson);yield this.validProjectRoot(e,t);const r=yield(0,E.readProjectOhPackageJson5)();if(this.validPkgJson(r),!r.parameterFile)throw new Error((0,P.format)(P.Messages.Parameterization.ParameterFileNotConfigError,{configName:v.KEY_PARAMETER_FILE_PATH,ohPkgName:s.Constants.MyPackageJson}));const a=(0,c.getObjectValueByKey)(v.KEY_PARAMETER_FILE_PATH,r);if(!a)throw new Error((0,P.format)(P.Messages.Parameterization.FilePathEmptyError,{configName:v.KEY_PARAMETER_FILE_PATH,ohPkgPath:t}));return n.default.resolve(e,a)}))}isFilePath(e){try{const t=u.default.statSync(e);return t&&t.isFile()}catch(t){return d.default.error("isFilePath",`Read file: ${e} stat failed, ${t}`),!1}}isFileNotEmpty(e){try{const t=u.default.readFileSync(e,"utf8");return!(!t||!t.trim())}catch(t){return d.default.error("isFileNotEmpty",`Read file: ${e} content failed, ${t}`),!1}}validKey(e){if(!e)throw new Error((0,P.format)(P.Messages.Parameterization.KeyEmptyError));if(!v.REGEX_PARAMETER_KEY.test(e))throw new Error((0,P.format)(P.Messages.Parameterization.InvalidKeyError,{key:`${e}`}))}validVersion(e,t){return a(this,void 0,void 0,(function*(){if(!t||!t.trim())throw new Error((0,P.format)(P.Messages.Parameterization.VersionEmptyError));if("*"!==(t=t.trim())&&"latest"!==t)if((0,g.isLocalDependency)(t)){if(!y.GlobalState.isLink)throw new Error((0,P.format)(P.Messages.Parameterization.UnSupportLinkModeError));yield this.validLocalDependencyPath(e,t)}else{if(!m.default.validRange(t,{loose:!0,includePrerelease:!0})&&!(0,g.isStandardTagDependency)(t))throw new Error((0,P.format)(P.Messages.Parameterization.InvalidVersionError,{version:`${t}`,parameterFile:this.parameterFilePath}))}}))}validLocalDependencyPath(e,t){return a(this,void 0,void 0,(function*(){if(t=this.resolveLocalDependencyPath(t),!h.FsBlockingUtil.existsSync(t))throw new Error((0,P.format)(P.Messages.Parameterization.ConfiguredParameterFileNotExistError,{parameterPath:this.parameterFilePath,parameterKey:e,filePath:t}))}))}resolveLocalDependencyPath(e){const t=n.default.dirname(this.parameterFilePath);return e=e.replace(/file:/i,"").trim(),n.default.isAbsolute(e)||(e=n.default.resolve(t,e)),e}}exports.ParameterizationConfigFile=v,v.KEY_PARAMETER_FILE_PATH="parameterFile",v.KEY_PARAMETER_INDEX_START=f.PREFIX_PARAMETER.length,v.KEY_PARAMETER_SPILITER=".",v.REGEX_PARAMETER=/^@param:.+([.].+)*/,v.REGEX_PARAMETER_KEY=/(?=^(@(?![0-9\-_])[a-z0-9\-_]+(?<![-_])\/)?(?![0-9\-_.])[a-z0-9\-_.]+(?<![-_.])$).{1,128}$/i;