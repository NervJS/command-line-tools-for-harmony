"use strict";var e=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,s){function a(e){try{c(r.next(e))}catch(e){s(e)}}function o(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AsyncDepNodeDataBuilder=void 0;const i=require("../util"),r=t(require("../../../log")),n=require("./DepBuilderFactory"),s=require("../../locker");exports.AsyncDepNodeDataBuilder=class{constructor(e){this.REGEX_LATEST_MATCHER=/(latest)/i,this.fetcher=e}build(t){return e(this,void 0,void 0,(function*(){let e=(0,i.parseDependency)(t.pkg,t.where);const n=e.getFetchSpec();let a=e.getSaveSpec();const o=t.name||e.getName();let c;try{const p={name:o,fetchSpec:n,rootDir:t.rootDir,where:t.where,parentSaveRoot:t.parentSaveRoot};if(r.default.debug("DepNodeDataBuilder",`start fetching depNode metadata, fetchRequest: ${JSON.stringify(p,null,2)}.`),c=yield this.fetcher.fetch(p),c.isFromLockFile){const e=Object.keys(c.versions);e&&e.length&&!c.versions[e[0]].resolved&&(s.PackageLockerManager.getInstance().deleteSpecifier(t.rootDir,`${o}@${n}`),c=yield this.fetcher.fetch(p))}const{name:d,pinnedVersion:u}=yield(0,i.getPinnedVersion)(o,n,c);a=this.resolveSaveSpec(u,t,n,a);const h=(0,i.getLockPkgFromMetaData)(c.versions[u],c.registryType);return e=(0,i.parseDependency)(`${d}@${u}`,t.where),this.buildDepNodeData(t,{fetchSpec:n,saveSpec:a},c,e,h)}catch(i){return this.unMetDepNodeData(o,n,e.type,t,i)}}))}buildDepNodeData(e,t,i,r,s){return n.DepBuilderFactory.getInstance().getBuilderImpl(r.type).build({name:r.getName(),version:s.version?s.version:"0.0.0",actualName:i.name,fetchSpec:t.fetchSpec,saveSpec:t.saveSpec,pinnedSpec:r.getRawSpec(),registryType:i.registryType,ohpaType:r.type,isNativeSoType:r.isNativeSoType(),isRoot:!!e.isRoot,isLink:e.isLink,isShared:e.isShared,integrity:s.integrity,shasum:s.shasum,resolved:s.resolved,integrityHsp:s.integrity_hsp,resolvedHsp:s.resolved_hsp,dynamicDependencies:s.dynamicDependencies,devDependencies:s.devDependencies,dependencies:s.dependencies,packageType:s.packageType,hspType:s.hspType})}unMetDepNodeData(e,t,i,r,n){return{unmet:!0,version:"",error:n,actualName:"",fetchSpec:t,isLink:r.isLink,isRoot:!!r.isRoot,isShared:r.isShared,name:e,ohpaType:i,pinnedSpec:"",pkgStoreDir:"",saveRootDir:"",saveSpec:""}}resolveSaveSpec(e,t,i,r){return this.REGEX_LATEST_MATCHER.test(i)&&(this.REGEX_LATEST_MATCHER.test(t.pkg)||(r=e)),r}};