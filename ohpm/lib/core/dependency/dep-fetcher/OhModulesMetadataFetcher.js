"use strict";var e=this&&this.__awaiter||function(e,t,a,n){return new(a||(a=Promise))((function(i,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function o(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,o)}c((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhModulesMetadataFetcher=void 0;const a=require("../util"),n=require("../../../tools/ohpa/OhpaType"),i=t(require("path")),r=require("../../../common/Constants"),s=require("../../../util/FsUtil"),o=require("../../locker");exports.OhModulesMetadataFetcher=class{constructor(){this.pkgJsonMapCache=new Map}fetch(t){return e(this,void 0,void 0,(function*(){const e=yield this.findDepSaveDir(t);return e?this.fetchMetadataFromDepSaveDir(t.rootDir,e,t.name,t.fetchSpec):{name:t.name,versions:{},isFromLockFile:!1}}))}findDepSaveDir(t){return e(this,void 0,void 0,(function*(){switch((0,a.parseDependency)(`${t.name}@${t.fetchSpec}`,t.where).type){case n.OhpaType.Version:case n.OhpaType.Range:case n.OhpaType.Tag:return this.findRegistryDepSaveDir(t.parentSaveRoot,t.name);case n.OhpaType.File:case n.OhpaType.SourceCode:return this.findLocalDepSaveDir(t.parentSaveRoot,t.name);default:return}}))}findRegistryDepSaveDir(t,a){return e(this,void 0,void 0,(function*(){const e=i.default.join(t,r.Constants.MyModules,a),n=i.default.join(e,r.Constants.MyPackageJson);if(yield s.FsUtil.exists(n))return e}))}fetchMetadataFromDepSaveDir(t,n,r,s){return e(this,void 0,void 0,(function*(){const e=o.PackageLockerManager.getInstance().getLockPkg(t,r,s);let c;if(e){const n=o.PackageLockerManager.getInstance(),c=n.getLockSpec(t,r,s);let p=n.parseSpecKey(c).version;return(0,a.isLocalDependency)(p)&&(p=i.default.resolve(t,p)),{name:r,packageType:e.packageType,registryType:e.registryType,versions:{[p]:e},isFromLockFile:!0}}{const e=yield this.readPkgJsonFromDepSaveDir(n);return c=(0,a.isLocalDependency)(s)?s:e.version,{name:r,packageType:e.packageType,registryType:e.registryType,versions:{[c]:e},isFromLockFile:!1}}}))}readPkgJsonFromDepSaveDir(t){return e(this,void 0,void 0,(function*(){let e;return this.pkgJsonMapCache.has(t)?e=this.pkgJsonMapCache.get(t):(e=yield s.FsUtil.readJSON5(i.default.join(t,r.Constants.MyPackageJson)),this.pkgJsonMapCache.set(t,e)),e}))}findLocalDepSaveDir(t,a){return e(this,void 0,void 0,(function*(){let e=i.default.resolve(t,r.Constants.MyModules,a);return(yield s.FsUtil.exists(e))||(t=i.default.resolve(t,".."),i.default.basename(t)!==r.Constants.MyModules&&(t=i.default.resolve(t,"..")),e=i.default.resolve(t,a)),(yield s.FsUtil.exists(i.default.join(e,r.Constants.MyPackageJson)))?e:void 0}))}};