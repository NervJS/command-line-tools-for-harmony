"use strict";var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{a(n.next(e))}catch(e){o(e)}}function l(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DepNodeSymlinker=void 0;const i=t(require("path")),n=require("../../../common/Constants"),s=require("../../../config"),o=require("../../../util/FsUtil"),r=require("../util"),l=require("../../install/common/ensureFileExist"),a=require("../../../tools/ohpa/OhpaType");class d{constructor(){this.symlinkVisitedCache=new Set,this.symlinkCache=new Set,this.phantomCompatibleLinkCache=new Set}static getInstance(){return this.Instance||(this.Instance=new d),this.Instance}run(t){return e(this,void 0,void 0,(function*(){yield this.preWalk(t.context),yield t.walk(this),yield this.postWalk(t.context)}))}postWalk(t){return e(this,void 0,void 0,(function*(){yield this.symlinkCompatibleModules(t)}))}preWalk(t){return e(this,void 0,void 0,(function*(){yield this.deleteUselessDirectDepLinks(t)}))}deleteUselessDirectDepLinks(t){return e(this,void 0,void 0,(function*(){const e=t.tree.root,s=i.default.join(t.tree.moduleRootDir,n.Constants.MyModules);yield(0,r.deleteUselessLinks)(s,(t=>-1!==Object.keys(e.requirements).findIndex((e=>e===t))))}))}visit(t,s){return e(this,void 0,void 0,(function*(){const e=t.node,l=i.default.join(e.isRoot?s.tree.moduleRootDir:e.resolveSaveRootDir(s.tree.moduleRootDir),n.Constants.MyModules);if(!this.symlinkVisitedCache.has(l)&&(this.symlinkVisitedCache.add(l),yield(0,r.deleteUselessLinks)(l,(t=>e.ohpaType===a.OhpaType.SourceCode||t===e.name||-1!==Object.keys(e.rawRequirements).findIndex((e=>e===t)))),Object.keys(e.requirements).length>0&&(0,r.isNeedChildren)(e))){yield o.FsUtil.createDirIfNotExists(l);for(const t of Object.keys(e.requirements)){const r=e.requirements[t];let a=s.tree.pickNode(t,r.spec,e);a.packageType===n.Constants.HSPPackageType&&(a=s.tree.pickMaxVersion(t));const d=i.default.join(l,t);if(this.isNodeSymlinking(a,d,s))return;this.symlinkCache.add(d),s.symLinkCache.add(d);const c=a.resolvePkgStoreDir(s.tree.moduleRootDir);yield o.FsUtil.symLinkDir(c,d)}}}))}isNodeSymlinking(e,t,i){return e.isShared&&this.symlinkCache.has(t)||i.symLinkCache.has(t)}symlinkCompatibleModules(t){return e(this,void 0,void 0,(function*(){const a=t.tree.root,d=i.default.join(a.isShared?s.config.getProjectRoot():t.tree.moduleRootDir,n.Constants.MyModules,n.Constants.PmDir,n.Constants.MyModules),c=[];for(const s of t.tree.finalDepList){if(s.isRoot||(0,r.isLocalDependency)(s.pinnedSpec))continue;const a=i.default.join(d,s.name);if(this.phantomCompatibleLinkCache.has(a))continue;this.phantomCompatibleLinkCache.add(a);const u=i.default.join(s.resolveSaveRootDir(t.tree.moduleRootDir),n.Constants.MyModules,s.name),h=()=>e(this,void 0,void 0,(function*(){yield(0,l.ensureFileExist)(u),yield o.FsUtil.symLinkDir(u,a)}));c.push(h())}yield Promise.all(c)}))}}exports.DepNodeSymlinker=d;