"use strict";var e=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,s){function a(e){try{h(o.next(e))}catch(e){s(e)}}function n(e){try{h(o.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,n)}h((o=o.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DepNodeInstaller=void 0;const r=t(require("path")),o=require("../../../common/Constants"),i=require("../../../config"),s=require("../../../util/FsUtil"),a=require("../../../util"),n=require("../util"),h=require("../dep-install"),l=require("../util/deleteUselessDir");class c{constructor(){this._harStoreDirCache=new Set,this._hspStoreDirCache=new Set}static getInstance(){return this.Instance||(this.Instance=new c),this.Instance}run(t){return e(this,void 0,void 0,(function*(){yield this.preWalk(t.context),yield t.walk(this),yield this.postWalk(t.context)}))}get harStoreDirCache(){return new Set(this._harStoreDirCache)}get hspStoreDirCache(){return new Set(this._hspStoreDirCache)}postWalk(t){return e(this,void 0,void 0,(function*(){const e=r.default.join(t.tree.moduleRootDir,o.Constants.MyModules,o.Constants.HSPDir);yield(0,l.deleteUselessDir)(e,(e=>!t.hspStoreDirCache.has(e)))}))}preWalk(t){return e(this,void 0,void 0,(function*(){const e=t.tree.root,n=r.default.join(t.tree.moduleRootDir,o.Constants.MyModules,o.Constants.PmDir);e.isShared&&i.config.getProjectRoot()!==t.tree.moduleRootDir&&(yield s.FsUtil.exists(n))&&a.FsBlockingUtil.rmDirSync(n)}))}visit(t,r){return e(this,void 0,void 0,(function*(){let e=t.node;if(!this.isVisited(e,r)&&(e.packageType===o.Constants.HSPPackageType&&(e=r.tree.pickMaxVersion(e.name)),this.markNodeAsVisited(e,r),!(yield(0,n.checkAndRemoveOldLocalPkg)(r.tree.moduleRootDir,e))))try{yield(0,h.installDependency)(r.tree.moduleRootDir,e)}catch(t){throw this.clearVisited(e,r),t}}))}clearVisited(e,t){const r=t.tree.moduleRootDir;this._hspStoreDirCache.delete(e.resolveHspStoreDir(r)),this._harStoreDirCache.delete(e.resolveSaveRootDir(r)),t.hspStoreDirCache.delete(e.resolveHspStoreDir(r)),t.harStoreDirCache.delete(e.resolveSaveRootDir(r))}markNodeAsVisited(e,t){t.harStoreDirCache.add(e.resolveSaveRootDir(t.tree.moduleRootDir)),this._harStoreDirCache.add(e.resolveSaveRootDir(t.tree.moduleRootDir)),e.hspType===o.HspType.BUNDLE_APP&&"dev"!==e.depType&&(this._hspStoreDirCache.add(e.resolveHspStoreDir(t.tree.moduleRootDir)),t.hspStoreDirCache.add(e.resolveHspStoreDir(t.tree.moduleRootDir)))}isVisited(e,t){let r=!1;const i=t.tree.moduleRootDir;return r=e.hspType===o.HspType.BUNDLE_APP?e.isRoot||e.isShared&&this._harStoreDirCache.has(e.resolveSaveRootDir(i))&&this._hspStoreDirCache.has(e.resolveHspStoreDir(i))||t.harStoreDirCache.has(e.resolveSaveRootDir(i))&&t.hspStoreDirCache.has(e.resolveHspStoreDir(i)):e.isRoot||e.isShared&&this._harStoreDirCache.has(e.resolveSaveRootDir(i))||t.harStoreDirCache.has(e.resolveSaveRootDir(i)),r}}exports.DepNodeInstaller=c;