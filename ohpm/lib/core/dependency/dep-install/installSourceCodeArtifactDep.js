"use strict";var t=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function u(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,u)}l((n=n.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.installSourceCodeArtifactDep=void 0;const i=require("../../../common/GlobalState"),n=e(require("path")),o=require("../../../common/Constants"),s=require("../../../util/FsUtil"),r=e(require("perf_hooks")),u=require("../../../util");function l(e){return t(this,void 0,void 0,(function*(){const t=n.default.join(e,o.Constants.MyPackageJson);(yield s.FsUtil.exists(t))&&u.FsBlockingUtil.rmDirSync(e)}))}exports.installSourceCodeArtifactDep=function(e,u){return t(this,void 0,void 0,(function*(){u.isLink||(i.GlobalState.installMode.includes(i.ExperimentalOption.CONCURRENTLY_SAFE_INSTALL)?yield function(e,i){return t(this,void 0,void 0,(function*(){const t=i.resolvePkgStoreDir(e);yield l(t);const u=`${t}.${process.pid}.${r.default.performance.now()}`,c=n.default.join(i.pinnedSpec,o.Constants.NodeModules),d=n.default.join(i.pinnedSpec,o.Constants.MyModules),a=n.default.join(i.pinnedSpec,"build"),f={errorOnExist:!0,recursive:!0,filter:t=>!t.startsWith(c)&&!t.startsWith(d)&&!t.startsWith(a)};yield s.FsUtil.copy(i.pinnedSpec,u,f),yield s.FsUtil.renameIfNotExist(u,t)}))}(e,u):yield function(e,i){return t(this,void 0,void 0,(function*(){const t=i.resolvePkgStoreDir(e);yield l(t);const r=n.default.join(i.pinnedSpec,o.Constants.NodeModules),u=n.default.join(i.pinnedSpec,o.Constants.MyModules),c=n.default.join(i.pinnedSpec,"build"),d={errorOnExist:!0,recursive:!0,filter:t=>!t.startsWith(r)&&!t.startsWith(u)&&!t.startsWith(c)};yield s.FsUtil.copy(i.pinnedSpec,t,d)}))}(e,u))}))};