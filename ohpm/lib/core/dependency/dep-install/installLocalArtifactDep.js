"use strict";var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.installLocalArtifact=void 0;const i=require("../../../common/Constants"),n=t(require("perf_hooks")),r=require("../../../util/FsUtil"),o=t(require("tar")),s=require("../util"),a=t(require("path")),l=require("./handleInstallException"),c=require("../../../common/message");exports.installLocalArtifact=function(t,d){return e(this,void 0,void 0,(function*(){try{if(d.packageType===i.Constants.HSPPackageType&&d.hspType===i.HspType.BUNDLE_APP)return void(yield function(t,l){return e(this,void 0,void 0,(function*(){const e=l.resolveHspStoreDir(t),d=l.resolvePkgStoreDir(t),p=n.default.performance.now(),u=`${e}.${process.pid}.${p}`,f=`${d}.${process.pid}.${p}`;yield r.FsUtil.createDirIfNotExists(u),yield r.FsUtil.createDirIfNotExists(f);const y=yield(0,s.hspDetect)(l.pinnedSpec);if(!y)throw new Error((0,c.format)(c.Messages.Install.InstallLocalHspFailed,{path:l.pinnedSpec}));yield o.default.extract({file:l.pinnedSpec,cwd:f,strip:0});const h=a.default.join(f,y.interfaceHar);yield r.FsUtil.extractAndIgnoreTargetFolder(h,f,i.Constants.SignFolderName);const F=a.default.join(f,y.hsp);"dev"!==l.depType&&(yield r.FsUtil.copyFile(F,a.default.join(u,l.hspName)),yield r.FsUtil.copyFile(a.default.join(f,i.Constants.MyPackageJson),a.default.join(u,i.Constants.MyPackageJson)),yield r.FsUtil.renameIfNotExist(u,e)),yield r.FsUtil.rm(F),yield r.FsUtil.rm(h),yield r.FsUtil.renameIfNotExist(f,d)}))}(t,d));const l=d.resolvePkgStoreDir(t),p=`${l}.${process.pid}.${n.default.performance.now()}`;yield r.FsUtil.createDirIfNotExists(p),yield r.FsUtil.extractAndIgnoreTargetFolder(d.pinnedSpec,p,i.Constants.SignFolderName),yield(0,s.ensureOhPackageJson5)(p),yield r.FsUtil.renameIfNotExist(p,l)}catch(e){(0,l.handleInstallException)(e,t,d)}}))};