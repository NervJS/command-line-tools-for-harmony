"use strict";var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.installRegistryArtifactDep=void 0;const i=require("../../../common/GlobalState"),n=require("../../../common/Constants"),o=t(require("../../../log")),r=require("../../../util/FsUtil"),s=t(require("tar")),a=t(require("path")),l=t(require("perf_hooks")),d=require("./handleInstallException"),c=require("../util"),p=require("../../cache"),u=require("../../../common/message"),y=require("../../publish/util/validDone");let f=0;function g(t,i,o){return e(this,void 0,void 0,(function*(){const e=i.resolvePkgStoreDir(t),s=yield r.FsUtil.readFile(o);yield v(s),yield r.FsUtil.createDirIfNotExists(e),yield r.FsUtil.extractAndIgnoreTargetFolder(o,e,n.Constants.SignFolderName),yield(0,c.ensureOhPackageJson5)(e)}))}function h(t,i,o){return e(this,void 0,void 0,(function*(){const e=i.resolvePkgStoreDir(t),s=`${e}.${process.pid}.${l.default.performance.now()}`,a=yield r.FsUtil.readFile(o);yield v(a),yield r.FsUtil.createDirIfNotExists(s),yield r.FsUtil.extractAndIgnoreTargetFolder(o,s,n.Constants.SignFolderName),yield(0,c.ensureOhPackageJson5)(s),yield r.FsUtil.renameIfNotExist(s,e)}))}function v(t){return e(this,void 0,void 0,(function*(){if(t.length>n.Constants.MaxPackSizeB)throw new Error((0,u.format)(u.Messages.DepInstall.TarBallSizeExceed));s.default.list({onentry(e){if("Directory"===e.type)return;const t=function(e){if(/(\/\.\.\/)|(\.\.\/)|(\/\.\.)|(\.\.$)/gi.test(e))return(0,y.done)(`${e},cannot contain special characters .. or ../`);return(0,y.done)("")}(e.path);if(!t.validForPackages)throw new Error(t.error)}}).end(t)}))}exports.installRegistryArtifactDep=function(t,s){return e(this,void 0,void 0,(function*(){o.default.debug("fetching package",`${s.name}@${s.pinnedSpec}`);const c=yield(0,p.getPkgCachePath)(s.name,s.pinnedSpec,s.integrity,s.resolved,s.shasum);let y;s.packageType===n.Constants.HSPPackageType&&s.hspType===n.HspType.BUNDLE_APP&&(y=yield(0,p.getPkgCachePath)(s.name,s.pinnedSpec,s.integrityHsp,s.resolvedHsp,s.shasum)),i.GlobalState.installMode.includes(i.ExperimentalOption.CONCURRENTLY_SAFE_INSTALL)?yield function(t,i,s,c){return e(this,void 0,void 0,(function*(){try{if(i.packageType===n.Constants.HSPPackageType)return void(yield function(t,i,o,s){return e(this,void 0,void 0,(function*(){if(i.hspType===n.HspType.BUNDLE_APP&&!s&&"dev"!==i.depType)throw new Error((0,u.format)(u.Messages.Install.NotFoundHspFileByRegistryTgz,{packageName:i.name}));if(yield h(t,i,o),i.hspType===n.HspType.BUNDLE_APP&&"dev"!==i.depType){const e=i.resolveHspStoreDir(t),o=i.resolvePkgStoreDir(t),d=l.default.performance.now(),c=`${e}.${process.pid}.${d}`;yield r.FsUtil.createDirIfNotExists(c);const p=a.default.join(c,i.hspName);yield r.FsUtil.copyFile(s,p),yield r.FsUtil.copyFile(a.default.join(o,n.Constants.MyPackageJson),a.default.join(c,n.Constants.MyPackageJson)),yield r.FsUtil.renameIfNotExist(c,e)}}))}(t,i,s,c));yield h(t,i,s),o.default.debug("place package done "+f++,`${i.name}@${i.pinnedSpec} to ${i.resolvePkgStoreDir(t)}`)}catch(e){(0,d.handleInstallException)(e,t,i)}}))}(t,s,c,y):yield function(t,i,s,l){return e(this,void 0,void 0,(function*(){try{if(i.packageType===n.Constants.HSPPackageType)return void(yield function(t,i,o,s){return e(this,void 0,void 0,(function*(){if(i.hspType===n.HspType.BUNDLE_APP&&!s&&"dev"!==i.depType)throw new Error((0,u.format)(u.Messages.Install.NotFoundHspFileByRegistryTgz,{packageName:i.name}));if(yield g(t,i,o),i.hspType===n.HspType.BUNDLE_APP&&"dev"!==i.depType){const e=i.resolveHspStoreDir(t),o=i.resolvePkgStoreDir(t);yield r.FsUtil.createDirIfNotExists(e);const l=a.default.join(e,i.hspName);yield r.FsUtil.copyFile(s,l),yield r.FsUtil.copyFile(a.default.join(o,n.Constants.MyPackageJson),a.default.join(e,n.Constants.MyPackageJson))}}))}(t,i,s,l));yield g(t,i,s),o.default.debug("place package done "+f++,`${i.name}@${i.pinnedSpec} to ${i.resolvePkgStoreDir(t)}`)}catch(e){(0,d.handleInstallException)(e,t,i)}}))}(t,s,c,y)}))};