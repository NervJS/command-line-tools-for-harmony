"use strict";var e=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(c,o){function n(e){try{a(i.next(e))}catch(e){o(e)}}function r(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?c(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,r)}a((i=i.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageLocker=void 0;const s=t(require("path")),i=require("../../common/Constants"),c=require("../../util/FsUtil"),o=require("../../tools/json5"),n=require("./index"),r=require("../registry/registry"),a=require("../install-targets/TargetManager"),l=require("../../config");exports.PackageLocker=class{constructor(e){this.visitedLockSpecKeySet=new Set,this.visitedLockPkgKeySet=new Set,this.lockFilePath=s.default.join(process.cwd(),i.Constants.LockJson),this.lockJson=o.JSON5.parse(o.JSON5.stringify(n.LockFile.defaultLockJson)),this.lockFilePath=s.default.join(e,this.getLockFileName()),this.dedupeCache=new Map,this.moduleRoot=e}getLockFileName(){return a.TargetManager.getInstance().needChangeLockFileName()?`oh-package-${a.TargetManager.getInstance().getTargetName()}-lock.json5`:i.Constants.LockJson}getDepNodeDataFromCache(e){const t=this.dedupeCache.get(e);return t&&this.markVisited(t),t}addDepNodeData(e,t){this.dedupeCache.set(e,t)}getLockSpec(e,t){const s=`${e}@${t}`;this.visitedLockSpecKeySet.add(s);const i=this.lockJson.specifiers;if(i)return i[s]}updateLockSpec(e,t,s){const i=`${e}@${t}`,c=this.lockJson.specifiers;this.visitedLockSpecKeySet.add(i),c[i]=`${e}@${s}`}getLockPkg(e,t){const s=this.getLockSpec(e,t),i=this.lockJson.packages;if(s&&i)return i[s]}updateLockPkg(e,t,s){this.lockJson.packages[`${e}@${t}`]=s}clearSpecifiers(){this.lockJson.specifiers={},this.lockJson.meta.stableOrder=!0}deleteSpecifier(e){delete this.lockJson.specifiers[e]}deletePackage(e){delete this.lockJson.packages[e]}clearVisitedSet(){this.visitedLockPkgKeySet.clear(),this.visitedLockSpecKeySet.clear()}markVisited(e){let t=e.fetchSpec;e.registryType===r.RegistryType.local&&(t=c.FsUtil.slash(s.default.relative(this.moduleRoot,e.fetchSpec))),this.visitedLockSpecKeySet.add(`${e.name}@${t}`)}flush(){return e(this,void 0,void 0,(function*(){if(Object.keys(this.lockJson.specifiers).forEach((e=>{if(!this.visitedLockSpecKeySet.has(e))return void delete this.lockJson.specifiers[e];const t=this.lockJson.specifiers[e];this.visitedLockPkgKeySet.add(t)})),Object.keys(this.lockJson.packages).forEach((e=>{if(!this.visitedLockPkgKeySet.has(e))return void delete this.lockJson.packages[e];const t=this.lockJson.packages[e];t.dependencies&&0!==Object.keys(t.dependencies).length||(t.dependencies=void 0),t.dynamicDependencies&&0!==Object.keys(t.dynamicDependencies).length||(t.dynamicDependencies=void 0)})),(yield c.FsUtil.exists(this.lockFilePath))||Object.keys(this.lockJson.packages).length>0){const e=l.config.get(l.types.LOCKFILE_STABLE_ORDER);(e||this.lockJson.meta.stableOrder)&&(this.lockJson=this.sortLockJson(this.lockJson,e)),yield c.FsUtil.writeFile(this.lockFilePath,JSON.stringify(this.lockJson,null,2))}}))}sortLockJson(e,t=!1){e.specifiers=this.sortByKey(e.specifiers);const s=this.sortByKey(e.packages);return t&&this.sortPackagesChildren(s),e.packages=s,e}sortPackagesChildren(e){Object.keys(e).forEach((t=>{const s=e[t];Object.keys(s).forEach((e=>{const t=s[e];"object"==typeof t&&(s[e]=this.sortByKey(t))})),e[`${t}`]=s}))}sortByKey(e){if(!e||!Object.keys(e).length)return e;const t={};return Object.keys(e).sort().forEach((s=>{t[s]=e[s]})),t}};