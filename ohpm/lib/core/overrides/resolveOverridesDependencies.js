"use strict";var e=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,a)}c((o=o.apply(e,r||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isExactVersion=exports.normalizedAndValidProjectLevelOverrides=exports.resolveOverridesDependencies=exports.overridesMap=void 0;const t=require("../../config"),o=r(require("../../log")),n=r(require("path")),i=require("../../common/Constants"),s=require("../../util/FsUtil"),a=require("../../common/message"),c=require("../../tools/ohpa/Ohpa"),d=require("../locker"),l=require("../parameter"),u=require("../override-dependency-map/readProjectOhPackageJson5"),p=r(require("semver")),v=require("../install/service/loadProjectLevelOverrides");function f(e,r,t){const s=n.default.join(t,i.Constants.MyPackageJson),d=c.ohpa.validSpec(r,t);if(!d)throw o.default.error("EOVERRIDE",(0,a.format)(a.Messages.Overrides.InvalidSpec,{replaceSpec:r,depName:e,packageJsonPath:s})),new Error(a.Messages.Overrides.ValidSpecFailed);return d}function g(e){try{return null!==p.default.parse(e,{loose:!0})}catch(e){return!1}}exports.overridesMap=new Map,exports.resolveOverridesDependencies=function(r,s){return e(this,void 0,void 0,(function*(){"overrides"in r&&s!==t.config.getProjectRoot()&&o.default.warn("",`Only project-level "overrides" is supported. "overrides" configured at "${n.default.join(s,i.Constants.MyPackageJson)}" will be ignored.`);const e=v.projectLevelOverrides,a=d.PackageLockerManager.getInstance();Object.keys(e).forEach((r=>{const t=f(r,e[r],s);g(t)?a.updateLockSpec(s,r,t,t):a.deleteSpecifier(s,`${r}@${t}`),e[r]=t,exports.overridesMap.set(r,t)}))}))},exports.normalizedAndValidProjectLevelOverrides=function(){return e(this,void 0,void 0,(function*(){let e={};if(t.config.getProjectRoot()){const r=n.default.join(t.config.getProjectRoot(),i.Constants.MyPackageJson);if(yield s.FsUtil.exists(r)){let r=yield(0,u.readProjectOhPackageJson5)();r=yield l.ParameterizationManager.getInstance().assignParameterOnPkgJson(r),e=r.overrides||{},Object.keys(e).forEach((r=>{e[r]=f(r,e[r],t.config.getProjectRoot())}))}}return e}))},exports.isExactVersion=g;