"use strict";var t=this&&this.__createBinding||(Object.create?function(t,e,r,s){void 0===s&&(s=r);var o=Object.getOwnPropertyDescriptor(e,r);o&&!("get"in o?!e.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,o)}:function(t,e,r,s){void 0===s&&(s=r),t[s]=e[r]}),e=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),r=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var s={};if(null!=r)for(var o in r)"default"!==o&&Object.prototype.hasOwnProperty.call(r,o)&&t(s,r,o);return e(s,r),s},s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScriptRunner=exports.hookMap=exports.ScriptConstants=void 0;const o=require("child_process"),n=s(require("../../log")),i=s(require("path")),a=require("../../common/Constants"),p=require("../../util"),c=r(require("process")),l=require("../../common/GlobalState"),u=require("../../config"),d=require("../../common/message"),f="win32"===c.platform,m=f?c.env.ComSpec||"cmd":c.env.SHELL||"sh";exports.ScriptConstants={preInstall:"preInstall",postInstall:"postInstall",preUninstall:"preUninstall",postUninstall:"postUninstall",preVersion:"preVersion",postVersion:"postVersion",prePublish:"prePublish",postPublish:"postPublish"},exports.hookMap={[exports.ScriptConstants.preInstall]:l.CommandType.INSTALL,[exports.ScriptConstants.postInstall]:l.CommandType.INSTALL,[exports.ScriptConstants.preUninstall]:l.CommandType.UNINSTALL,[exports.ScriptConstants.postUninstall]:l.CommandType.UNINSTALL,[exports.ScriptConstants.preVersion]:l.CommandType.VERSION,[exports.ScriptConstants.postVersion]:l.CommandType.VERSION,[exports.ScriptConstants.prePublish]:l.CommandType.PUBLISH,[exports.ScriptConstants.postPublish]:l.CommandType.PUBLISH};exports.ScriptRunner=class{static runHook(t,e,r){l.GlobalState.command&&exports.hookMap[t]&&l.GlobalState.command===exports.hookMap[t]&&(e||(e=u.config.getRootDir()),this.runScript("hooks",t,e,r))}static runAlias(t,e,r=c.cwd()){return this.run(t,e,r,!1)}static errOut(t,e,r){n.default.error(`Failed to execute the script: '${t}'.`,e||""),n.default.error("path",r)}static runScript(t,e,r,s){let o=s;if(o||(o=this.getPkgJson(r)),!o||!o[t]||!o[t][e])return;if(!this.run(e,o[t][e],r,!0))throw new Error((0,d.format)(d.Messages.Script.HookFail,{hookName:e}))}static getPkgJson(t){const e=i.default.join(t,a.Constants.MyPackageJson);if(p.FsBlockingUtil.existsSync(e))try{return p.FsBlockingUtil.readJSON5Sync(e)}catch(t){n.default.error("JSON5.parse",`Failed to parse ${e}`)}}static run(t,e,r=c.cwd(),s){var i;if(!e)return n.default.error("",`Missing script: ${t}`),!1;(0,p.output)(`\n> script alias: ${t}, cwd: ${r}`),(0,p.output)(`> ${e}\n`);const a=f?["/d","/s","/c",e]:["-c",e];if(!this.validScript(e))throw new Error(d.Messages.Script.CommandError);const l=(0,o.spawnSync)(m,a,{windowsVerbatimArguments:!0,stdio:"inherit",cwd:r,env:c.env});if(l&&0===l.status)return!0;if(s){const e=null===(i=l.error)||void 0===i?void 0:i.message;this.errOut(t,e||"",r)}return!1}static validScript(t){const e=t.split("||");for(const t of e){const e=t.split("&&");for(const t of e){const e=t.trim();if(!e.startsWith(a.Constants.PM))continue;const r=e.split(" ");if(r.length<2||"run"!==r[1])return!1}}return!0}};