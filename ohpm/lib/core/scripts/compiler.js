"use strict";var t=this&&this.__awaiter||function(t,r,e,i){return new(e||(e=Promise))((function(n,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function c(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){var r;t.done?n(t.value):(r=t.value,r instanceof e?r:new e((function(t){t(r)}))).then(o,c)}u((i=i.apply(t,r||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isLogicalSymbol=exports.compiler=exports.SPIRIT_OR=exports.SPIRIT_AND=void 0;const e=require("../../util"),i=require("../../common/message"),n=r(require("path")),s=require("../../common/Constants"),o=require("./Queue"),c=require("./ScriptNode"),u=require("./DirectedGraph"),a=require("./ParamParser"),l=require("../../util/StringUtils");exports.SPIRIT_AND="&&",exports.SPIRIT_OR="||";const p=/\s+/,f=["(","[","{"],d=new u.DirectedGraph,h=new a.ParamParser;let S;function g(r,u,a,p){return t(this,void 0,void 0,(function*(){return function(t){if(!t)throw i.Messages.Script.PkgUnExistError}(a),function(t){const r=t.charCodeAt(0);if(r<97||r>122)throw w(t,i.Messages.Script.InvalidKey);const e=t.length;if(e<1||e>128)throw w(t,i.Messages.Script.InvalidKeyLen);if(!t.match("^[A-Za-z0-9:_-]+$"))throw w(t,i.Messages.Script.InvalidKeyRegex)}(r),function(t){if(-1!==t.findIndex((t=>"--prefix"===t)))throw i.Messages.Script.PrefixInvalidError}(u),function(t,r,e){(function(t,r,e){if(r&&r.length<=0)return;if(!e){if(r[0]!==" -- ".trim())throw i.Messages.Script.InvalidParamConfigError;r.splice(0,1)}let n=!0;for(let t=0;t<r.length;t++)if(h.isKey(r[t]))n=!0;else{if(0===t)throw i.Messages.Script.InvalidHeaderParamError;if(!n)throw i.Messages.Script.InvalidParamError;n=!1}})(0,r,e),function(t){const r=t.join(" ").length;if(r<0||r>2048)throw i.Messages.Script.InvalidParamLen}(r)}(0,u,p),function(t){S||(S=function(t){try{return e.FsBlockingUtil.readJSON5Sync(n.default.join(t,s.Constants.MyPackageJson))}catch(t){throw i.Messages.Script.ParsePkgError}}(t))}(a),function(t){if(!S||!S.scripts||void 0===S.scripts[t])throw w(t,i.Messages.Script.ScriptUnExistError)}(r),d.add(r),function(r,e,i){return t(this,void 0,void 0,(function*(){const t=new o.Queue(null);for(;!e.isEmpty();){const n=e.pop();if(n)if(m(n))t.push(new c.ScriptNode(n));else{const s=e.isEmpty(),o=yield I(n,r,s?i:[]);t.push(o)}}return d.rollBack(),t}))}(a,function(t){const r=function(t){const r=S.scripts[t];if(!r||l.StringUtils.isBlank(r))throw w(t,i.Messages.Script.ScriptEmptyError);return r}(t),e=m(r);if(r.includes("ohpm run")&&r.includes(" -- ")&&e)throw w(t,i.Messages.Script.ScriptContentError);return e?function(t){const r=new o.Queue(null),e=t.split(exports.SPIRIT_OR);for(let t=0;t<e.length;t++){const i=e[t].split(exports.SPIRIT_AND);for(let t=0;t<i.length;t++){const e=i[t];e&&(r.push(e.trim()),t!==i.length-1&&r.push(exports.SPIRIT_AND))}t!==e.length-1&&r.push(exports.SPIRIT_OR)}return r}(r):new o.Queue(r.trim())}(r),u)}))}function m(t){return t.includes(exports.SPIRIT_AND)||t.includes(exports.SPIRIT_OR)}function I(r,e,n){return t(this,void 0,void 0,(function*(){let o=r.trim().split(p);o=h.parse(o,n);let u=null;const a=o[0].toLowerCase().trim();return a===s.Constants.PM?function(r,e){return t(this,void 0,void 0,(function*(){if(r.length<=1)throw i.Messages.Script.ScriptInvalidError;if("run"!==r[1])throw i.Messages.Script.CommandError;if(r.length<=2)throw i.Messages.Script.ScriptInvalidError;const t=r[2];if(!d.preAdd(t))throw i.Messages.Script.DirectedCycleError;r.splice(0,3);const n=yield g(t,r,e,!1),s=new c.ScriptNode(t);return s.setIsOhpm(!0),s.setChildren(n),d.rollBack(),s}))}(o,e):(function(t){f.forEach((r=>{if(t.includes(r))throw i.Messages.Script.InvalidCommandError.concat(` position: ${t}`)}))}(a),o=function(t){const r=t.findIndex((t=>t.trim()===" -- ".trim()));return r>=0&&t.splice(r,1),t}(o),u=new c.ScriptNode(o[0]),u.setScripts(o.join(" ")),u)}))}function w(t,r){return r.concat(" script alias: ").concat(t)}exports.compiler=g,exports.isLogicalSymbol=m;