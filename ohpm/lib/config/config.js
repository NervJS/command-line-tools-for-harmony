"use strict";var t=this&&this.__createBinding||(Object.create?function(t,e,o,i){void 0===i&&(i=o);var s=Object.getOwnPropertyDescriptor(e,o);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[o]}}),Object.defineProperty(t,i,s)}:function(t,e,o,i){void 0===i&&(i=o),t[i]=e[o]}),e=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),o=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var i={};if(null!=o)for(var s in o)"default"!==s&&Object.prototype.hasOwnProperty.call(o,s)&&t(i,o,s);return e(i,o),i},i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Config=void 0;const s=require("./TypeValidate"),r=require("../util"),a=o(require("os")),l=i(require("path")),c=i(require("../log")),n=require("./DefaultConfig"),h=require("../common/Constants"),d=i(require("ini")),f=require("../core/override-dependency-map/types"),u=require("../common/message"),g=require("../core/install-targets/ProjectBuildProfile"),p=l.default.join(a.homedir(),h.Constants.PmDir,h.Constants.PmRc);exports.Config=class{constructor(){this.localPrefix=null,this.parameterFilePath=null,this.localPackage=null,this.projectRoot=null,this.loaded=!1,this.defaults=n.defaultConfig;const t=[...P];this.data=new Map,this.sources=new Map;for(const e of t)this.data.set(e,new Map),this.sources.set(e,e);this.options=null,this.reset()}reset(){this.loaded=!1,this.localPackage=null,this.projectRoot=null,this.localPrefix=null}getLocalPackage(){return this.localPackage}getLocalPrefix(){return this.localPrefix}getRootDir(){return this.localPrefix?this.localPrefix:""}getProjectRoot(){return this.projectRoot?this.projectRoot:this.getRootDir()}getModuleRoots(){return g.projectBuildProfile.getModuleRoots()}getParameterFilePath(){return this.parameterFilePath}setParameterFilePath(t){this.parameterFilePath=t}get(t){this.checkConfigIsLoaded();for(const e of P){const o=this.data.get(e);if(o&&o.has(t))return o.get(t)}}getString(t){return this.get(t)||""}set(t,e){this.checkConfigIsLoaded();const o=this.data.get(n.configType.USER);o&&this.validate(o,t,e,p,!0)}find(t){this.checkConfigIsLoaded();for(const e of P){const o=this.data.get(e);if(o&&o.has(t))return e}return""}delete(t){this.checkConfigIsLoaded();const e=this.data.get(n.configType.USER);return!!e&&(!!e.has(t)&&(e.delete(t),!0))}validCli(t,e){this.checkConfigIsLoaded();const o=this.data.get(n.configType.CLI);return(0,s.validate)(o,t,e)}save(){if(!this.loaded)throw new Error(u.Messages.Config.NotLoadedWhenSaving);const t=d.default.stringify(this.toObject(this.data.get(n.configType.USER))).trim()+a.EOL;t.trim()?r.FsBlockingUtil.writeFileSync(p,t):r.FsBlockingUtil.existsSync(p)&&r.FsBlockingUtil.unlinkSync(p)}toObject(t){const e={};return t&&t.forEach(((t,o)=>{o!==n.AccessTokenType.READ&&o!==n.AccessTokenType.READ_WRITE&&(e[o]=t)})),e}load(t){if(this.loaded)throw new Error(u.Messages.Config.RepeatLoadConfiguration);this.loadDefaults(),this.loadCLI(t),this.loadProjectConfig(),this.loadUserConfig(),this.loaded=!0}loadDefaults(){this.loadObject(this.defaults,n.configType.DEFAULT,n.configType.DEFAULT,!1)}loadObject(t,e,o,i){this.sources.set(e,o);const s=this.data.get(e);if(s)for(const e of Object.keys(t))this.validate(s,e,t[e],o,i)}loadCLI(t){t&&(this.options=t,this.loadObject(t,n.configType.CLI,"command line options",!0))}invalidHandler(t,e,o,i,s){i&&s&&(i.startsWith("Invalid key")?c.default.warn("",`${i}`):c.default.warn("invalid config",`${t}=${JSON.stringify(e)} set in ${o}${i}`))}loadProjectConfig(){this.localPrefix||this.loadLocalPrefix(),this.localPrefix&&(this.localPackage=l.default.resolve(this.localPrefix,h.Constants.MyPackageJson)),this.projectRoot||this.loadProjectRoot();const t=this.localPrefix?this.localPrefix:process.cwd();if(this.projectRoot&&t!==this.projectRoot){const e=l.default.join(t,h.Constants.PmRc);this.sources.set(n.configType.CWD,e),this.loadFile(e,n.configType.CWD)}const e=l.default.join(this.projectRoot?this.projectRoot:t,h.Constants.PmRc);this.sources.set(n.configType.PROJECT,e),this.loadFile(e,n.configType.PROJECT)}loadUserConfig(){this.sources.set(n.configType.USER,p),this.loadFile(p,n.configType.USER)}loadLocalPrefix(){const t=this.data.get(n.configType.CLI);if(t&&this.options&&this.options.prefix)return void this.setLocalPrefix(t.get(n.types.LOCAL_PREFIX));let e=process.cwd();for(;e!==l.default.resolve(e,"..");e=l.default.resolve(e,".."))if(this.checkPkgDir(e))return void(this.localPrefix=e);this.checkPkgDir(e)&&(this.localPrefix=e)}checkPkgDir(t){return r.FsBlockingUtil.existsSync(l.default.join(t,h.Constants.MyPackageJson))}setLocalPrefix(t){t&&this.checkPkgDir(t)&&(this.localPrefix=t,this.projectRoot="")}loadFile(t,e){try{if(!r.FsBlockingUtil.existsSync(t))return;let o=r.FsBlockingUtil.readFileSync(t,"utf-8");if(o){const t=new RegExp(`${f.PREFIX_OVERRIDE_PROJECT_JSON}\\s+`,"ig");o=o.replace(t,f.PREFIX_OVERRIDE_PROJECT_JSON)}const i=d.default.parse(o);this.loadObject(i,e,t,!1)}catch(e){c.default.warn("loadFile",`load .ohpmrc file "${t}" failed. err: ${e}`)}}validate(t,e,o,i,r){const a=(0,s.validate)(t,e,o);"string"==typeof a?this.invalidHandler(e,o,i,a,r):t.set(e,o)}checkConfigIsLoaded(){if(!this.loaded)throw new Error(u.Messages.Config.NotLoadedWhenSetting)}loadProjectRoot(){let t=this.localPrefix?this.localPrefix:process.cwd();for(this.checkProjectRootDir(t)&&(this.projectRoot=t);!this.projectRoot&&t!==l.default.resolve(t,"..");)t=l.default.resolve(t,".."),this.checkProjectRootDir(t)&&(this.projectRoot=t);this.projectRoot&&g.projectBuildProfile.init(this.projectRoot)}checkProjectRootDir(t){const e=l.default.join(t,h.Constants.BuildProfile);if(!r.FsBlockingUtil.existsSync(e))return!1;let o;try{o=r.FsBlockingUtil.readJSON5Sync(e)}catch(t){return c.default.error("",`Check project root directory error, ${e} is not the standard JSON5 format file.`),!1}return!!o&&"modules"in o}};const P=new Set(["cli","cwd","project","user","default"]);