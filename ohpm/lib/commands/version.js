"use strict";var e=this&&this.__awaiter||function(e,r,o,i){return new(o||(o=Promise))((function(n,t){function s(e){try{c(i.next(e))}catch(e){t(e)}}function a(e){try{c(i.throw(e))}catch(e){t(e)}}function c(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(s,a)}c((i=i.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.versionCmd=void 0;const r=require("../util"),o=require("../common/message"),i=require("semver"),n=require("../config"),t=require("../core/scripts/ScriptRunner"),s=require("../common/GlobalState"),a=require("../tools/posh"),c=require("../core/install/common/OptionValid"),l=require("../core/parameter"),g=require("../core/parameter/util/validParameterFileConfig"),u=require("../util/isStandardProject");exports.versionCmd=function(f,d){return e(this,void 0,void 0,(function*(){s.GlobalState.command=s.CommandType.VERSION,(0,c.validVersionOptions)("version",d),yield(0,g.validParameterFileConfig)(),yield function(s){return e(this,void 0,void 0,(function*(){if(!n.config.getLocalPackage()||!r.FsBlockingUtil.existsSync(n.config.getLocalPackage()))throw Error(o.Messages.Common.PkgNotFound);if((0,u.isStandardProject)()&&n.config.getLocalPrefix()===n.config.getProjectRoot())throw Error(o.Messages.Version.ForbiddenOpt);let e=r.FsBlockingUtil.readJSON5Sync(n.config.getLocalPackage());if(e=yield l.ParameterizationManager.getInstance().assignParameterOnPkgJson(e),!e.name)throw new Error(o.Messages.Check.PkgNameNotExist);if(!s&&!e.version)throw new Error(o.Messages.Version.NotExist);if(s){if(!(yield l.ParameterizationManager.getInstance().canModify(n.config.getLocalPackage(),"version")))throw new Error((0,o.format)(o.Messages.Parameterization.ForbiddenModifyError,{key:"version"}));t.ScriptRunner.runHook(t.ScriptConstants.preVersion),e.version=function(e,r){const n=(0,i.clean)(r)||"";let t=null;if(e&&(0,i.valid)(e,{loose:!0}))t=(0,i.clean)(e,{loose:!0});else{if(!n){const e=r?(0,o.format)(o.Messages.Version.InvalidOriginVersion,{version:r}):o.Messages.Version.NotExist;throw new Error(e)}"major"!==e&&"minor"!==e&&"patch"!==e||(t=(0,i.inc)(n,e,{loose:!0}))}if(!t)throw Error((0,o.format)(o.Messages.Version.InvalidVersionArg,{version:e}));if(t===n)throw Error(o.Messages.Version.NoChange);return t}(s,e.version||""),r.FsBlockingUtil.writeFileSync(n.config.getLocalPackage(),JSON.stringify(e,null,2)),r.PrintUtil.print(`${e.name}: ${a.posh.green(`'${e.version}'`)}`),t.ScriptRunner.runHook(t.ScriptConstants.postVersion)}else r.PrintUtil.print(`${e.name}: ${a.posh.green(`'${e.version}'`)}`)}))}(f)}))};