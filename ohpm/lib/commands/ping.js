"use strict";var t=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{a(r.next(t))}catch(t){o(t)}}function u(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.pingCmd=void 0;const n=e(require("../log")),r=require("../core/registry"),i=e(require("node-fetch")),o=require("../common/Constants"),s=require("../core/install/common/OptionValid"),u=require("../core/registry/OhpmRequestInit"),a=require("../common/message"),c=require("../common/ohpm.config"),d=require("../util");function f(e,s){return t(this,void 0,void 0,(function*(){s=`${e.trim().replace(/\/?$/g,"")}/${s.trim().replace(/^\//,"")}`;const t=yield(0,r.getAuth)(e),a=(new u.OhpmRequestInit).withAgent((0,r.getProxyAgent)(e)).withTimeout((0,r.getFetchTimeout)()).withRedirect("error");t&&a.withHeaders({Authorization:t});try{const t=yield(0,i.default)(s,a);if(n.default.debug(`STATUS_${t.status}`,`- GET ${s}`),t.ok){const e=yield t.text();return e||!0}return!(404!==t.status||!c.PmConfig.registryWhiteList.includes(e))||(n.default.error("",`HttpCode ${t.status}, API ping in ${e} - ${t.statusText}`),!1)}catch(t){return t.errno=o.Constants.ERR_TYPE_MAP[t.type]?o.Constants.ERR_TYPE_MAP[t.type]:t.errno,o.Constants.ERRNO_EXIT_LIST.includes(t.errno)?(n.default.error(t.errno,t.message),!1):(n.default.error("",t.message),!1)}}))}exports.pingCmd=function(e){return t(this,void 0,void 0,(function*(){const i=Date.now();(0,s.validRequestOptions)("ping",e);const o=yield function(e){return t(this,void 0,void 0,(function*(){const t=[],i=(0,r.getRegistryList)("");if(0===i.length)throw new Error(a.Messages.Ping.RegistryIsEmpty);for(const r of i){n.default.info("PING",r);const i=Date.now(),o=yield f(r,e);if(o){!0!==o&&n.default.info("PONG",o);const t=Date.now()-i;n.default.info("PONG",`${t}ms`)}else t.push(r)}return t}))}("/-/ping"),u=Date.now()-i;if(d.PrintUtil.printSucceedMsg(`PONG Total ${u}ms`),o.length>0)throw new Error((0,a.format)(a.Messages.Ping.PingRegistriesFailed,{registries:o.join(", ")}))}))};