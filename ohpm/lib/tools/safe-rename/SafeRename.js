"use strict";var e=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(i,s){function n(e){try{d(o.next(e))}catch(e){s(e)}}function a(e){try{d(o.throw(e))}catch(e){s(e)}}function d(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(n,a)}d((o=o.apply(e,r||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SafeRename=void 0;const t=require("../../common/message"),o=r(require("fs-extra")),i=r(require("fs")),s=r(require("path")),n=require("../ohfs"),a=r(require("../../log")),d=require("../../util");class c{rename(r,t,o=0){return e(this,void 0,void 0,(function*(){try{yield i.default.promises.rename(r,t)}catch(e){if(++o>3)throw e;yield this.doRenameError(r,t,o,e)}}))}doRenameError(r,o,i=0,s){return e(this,void 0,void 0,(function*(){switch(s.code){case"ENOTEMPTY":case"EEXIST":case"ENOTDIR":throw s;case"EPERM":case"EACCESS":yield this.accessError(r,o,s).then((e=>{if("boolean"!=typeof e||!e)throw e}));break;case"ENOENT":yield this.notExistError(r,o,i);break;case"EXDEV":yield this.crossBoardError(r,o);break;default:throw new Error((0,t.format)(t.Messages.Rename.UnknownError,{code:s.code,detail:s.message}))}}))}existError(r,t,o=0){return e(this,void 0,void 0,(function*(){yield n.remove.async(t),yield this.rename(r,t,o)}))}notExistError(r,o,n=0){return e(this,void 0,void 0,(function*(){try{yield i.default.promises.stat(r)}catch(e){if("ENOENT"===e.code)throw new Error((0,t.format)(t.Messages.Rename.SourceUnExistError,{src:r,detail:e.message}))}yield i.default.promises.mkdir(s.default.dirname(o),{recursive:!0}),yield this.rename(r,o,n)}))}accessError(r,t,o){return e(this,void 0,void 0,(function*(){const e=Date.now();let s=0,n=o;for(;Date.now()-e<c.TIMEOUT_ERROR&&("EPERM"===n.code||"EACCESS"===n.code);){yield new Promise((e=>setTimeout(e,s)));const e=yield this.statWithErrorReturn(r),o=yield this.statWithErrorReturn(t);if(o.stat&&e.stat)return d.FsBlockingUtil.rmDirNoThrowError(r),a.default.info("",`rename ${r} to ${t} while target path already exist.`),!0;if(e.error&&!o.error)return a.default.info("",`rename ${r} to ${t} while source path doesn't exist, detail: ${e.error}`),!0;try{return yield i.default.promises.rename(r,t),!0}catch(e){n=e}s<250&&(s+=20),a.default.debug("",`rename ${r} to ${t} failed, retry with backoff: ${s}ms.`)}return n}))}statWithErrorReturn(r){return e(this,void 0,void 0,(function*(){try{return{stat:yield i.default.promises.stat(r),error:void 0}}catch(e){return{stat:void 0,error:e}}}))}crossBoardError(r,t){return e(this,void 0,void 0,(function*(){yield n.remove.async(t),o.default.copySync(r,t),yield n.remove.async(r)}))}}exports.SafeRename=c,c.TIMEOUT_ERROR=6e4;