"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ohpa=void 0;const e=require("./OhpaResult"),s=require("./OhpaType"),t=require("../../common/message"),i=require("../../util/FsUtil"),r=require("../../common/Constants"),a=require("../../core/dist-tags/isStandardTag"),n=require("../../core/dependency/util"),{OsUtil:l}=require("../../util/OsUtil"),{validatePkg:o}=require("./ValidatePkg"),c=require("semver"),p=l.isWindows?require("path").win32:require("path"),{homedir:d}=require("os");class h{parse(e,s){if(h.isURL.test(e)||h.isGit.test(e))throw new Error((0,t.format)(t.Messages.Ohpa.PkgInvalidError));let i="",r="";const a="@"===e[0]?e.slice(1).indexOf("@")+1:e.indexOf("@"),n=a>0?e.slice(0,a):e;if("@"!==n[0]&&a<0&&this.isLocalDependency(n))r=e;else{const s=o.validate(n);if(s)throw new Error(s);i=n,a>0&&(r=e.slice(a+1))}return this.resolve(i,r,s,e)}validSpec(e,s){if(e&&(0,n.isTagDependency)(e)){const s=e.slice(r.Constants.TAG_PREFIX.length);return(0,a.isStandardTag)(s)?e:""}if(e&&(this.isLocalDependency(e)||this.isInnerPkgDependency(e))){const t=((h.REGEX_LOCAL.test(e)?"":h.LOCAL_PREFIX)+e).replace(h.REGEX_LOCAL,"");return`file:${p.resolve(s,t)}`}return c.validRange(e)}resolve(s,t,i,r){const a=(new e.OhpaResult).setRaw(r).setRawSpec(t);return s&&(a.setName(s),a.setEscapedName(s.replace("/","%2f")),a.setScope("@"===s[0]?s.slice(0,s.indexOf("/")):"")),t&&!(0,n.isTagDependency)(t)&&(this.isLocalDependency(t)||this.isInnerPkgDependency(t))?this.fromFile(a,i):this.fromRegistry(a)}fromFile(e,t){t=t||process.cwd(),e.setWhere(t);const i=this.isLocalFile(e.getRawSpec())?s.OhpaType.File:s.OhpaType.SourceCode;e.setType(i);const r=e.getRawSpec().replace(h.REGEX_LOCAL,"").trim(),a=p.isAbsolute(r)?p.relative(t,r):r,n=this.removeHeaderSepOnWin(r,a),l=this.resolveSaveSpec(t,n);return e.setSaveSpec(l),e.setFetchSpec(p.resolve(t,n.resolvedPath)),e}fromRegistry(e){e.setRegistry(!0);const i=""===e.getRawSpec()?h.LATEST:e.getRawSpec().trim();e.setFetchSpec(i),e.setSaveSpec(i);const l=c.valid(i,!0),o=c.validRange(i,!0);if(l)e.setType(s.OhpaType.Version);else if(o)e.setType(s.OhpaType.Range);else{let l=i;if((0,n.isTagDependency)(i)&&(l=i.slice(r.Constants.TAG_PREFIX.length),!(0,a.isStandardTag)(l)))throw new Error((0,t.format)(t.Messages.DistTags.TagPkgInvalidError,{tag:l,pkg:e.getRaw()}));if(encodeURIComponent(l)!==l)throw new Error((0,t.format)(t.Messages.Ohpa.SpecUriError,{spec:i,raw:e.getRaw()}));e.setType(s.OhpaType.Tag)}return e}removeHeaderSepOnWin(e,s){return l.isWindows&&(e=e.replace(/^\/+([a-z]:\/)/i,"$1"),s=s.replace(/^\/+([a-z]:\/)/i,"$1")),{specPath:e,resolvedPath:s}}resolveSaveSpec(e,s){let t;if(h.REGEX_PATH_LINUX.test(s.specPath)){const e=s.specPath.indexOf("~");t=`file:${s.specPath.slice(e)}`,s.resolvedPath=p.resolve(d(),s.specPath.slice(e+2))}else t=`file:${i.FsUtil.slash(p.relative(e,s.resolvedPath))}`;return t}isLocalDependency(e){return h.REGEX_LOCAL.test(e)||h.hasSep.test(e)||h.isFile.test(e)||h.isDir.test(e)}isInnerPkgDependency(e){return h.LATEST!==e&&!c.validRange(e,{loose:!0,includePrerelease:!0})&&h.REGEX_START_EN.test(e)}isLocalFile(e){return h.isFile.test(e)}}h.REGEX_LOCAL=/^file:(\s+)?/i,h.hasSep=l.isWindows?/[\\/]/:/\//,h.isDir=l.isWindows?/^(?:[.]|~\/|[/\\]|[a-z]:)/i:/^(?:[.]|~\/|\/|[a-z]:)/i,h.isFile=/[.](?:tgz|tar.gz|tar|har)$/i,h.isURL=/^git[+][a-z]+:/i,h.isGit=/^[^@]+@[^:.]+\.[^:]+:.+$/i,h.REGEX_PATH_LINUX=/^\/?~(\/|$)/,h.REGEX_START_EN=/^[a-z]/i,h.LOCAL_PREFIX="file:",h.LATEST="latest",exports.ohpa=new h;