"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nodeResolve=exports.DEFAULTS=void 0;const fs_1=__importDefault(require("fs")),path_1=__importStar(require("path")),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),deepmerge_1=__importDefault(require("deepmerge")),is_builtin_module_1=__importDefault(require("is-builtin-module")),arkts_pack_js_1=require("../../arkts-pack.js"),constants_js_1=require("../../util/constants.js"),fs_js_1=require("../../util/fs.js"),importCheckPlugin_js_1=__importDefault(require("../importCheckPlugin.js")),cache_js_1=require("./cache.js"),deprecated_options_js_1=__importDefault(require("./deprecated-options.js")),resolveImportSpecifiers_js_1=require("./resolveImportSpecifiers.js"),resolveOhModules_js_1=require("./resolveOhModules.js"),util_js_1=require("./util.js"),ES6ImportExportRegExp=/(?:^\s*|[}{\(\);,\n]\s*)(import[\s+|{]['"]|(import|module)[\s+|*|{][^"'\(\)\n;]+[\s|}]+from\s*['"]|export[\s+|{](\*|\{|default|function|var|const|let|[_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*))/,ES6AliasRegExp=/(?:^\s*|[}{\(\);,\n]\s*)(export\s*\*\s*from\s*(?:'([^']+)'|"([^"]+)"))/,logger=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("caseSensitiveCheck");function isModule(e){return ES6ImportExportRegExp.test(e)||ES6AliasRegExp.test(e)}const deepFreeze=e=>{Object.freeze(e);for(const t of Object.values(e))"object"!=typeof t||Object.isFrozen(t)||deepFreeze(t);return e},baseConditions=["default","module"],baseConditionsEsm=[...baseConditions,"import"],baseConditionsCjs=[...baseConditions,"require"],defaults={dedupe:[],extensions:[".mjs",".js",".json",".node"],resolveOnly:[],moduleDirectories:["oh_modules"],ignoreSideEffectsForRoot:!1},ignoreVirtualFilePrefix="\0hvigor_ignore_";exports.DEFAULTS=deepFreeze((0,deepmerge_1.default)({},defaults));const allowPatterns=e=>{const t=e.map((e=>{if(e instanceof RegExp)return e;const t=e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&");return new RegExp(`^${t}$`)}));return e=>!t.length||t.some((t=>t.test(e)))};async function updateLocation(e,t,o,s,r){if(e&&!s){await(0,fs_js_1.fileExists)(t)&&(t=await(0,fs_js_1.realpathFS)(t))}return r.set(t,o),t}function initData(e){const t=(0,util_js_1.getMainFields)(e),o=!0===e.preferBuiltins||!1===e.preferBuiltins;return{conditionsEsm:[...baseConditionsEsm,...e.exportConditions||[]],conditionsCjs:[...baseConditionsCjs,...e.exportConditions||[]],packageInfoCache:new Map,idToPackageInfo:new Map,mainFields:t,useBrowserOverrides:-1!==t.indexOf("browser"),isPreferBuiltinsSet:o,preferBuiltins:!o||e.preferBuiltins,rootDir:(0,path_1.resolve)(e.rootDir||process.cwd()),dedupe:e.dedupe}}function reject(e,t){return!!(0,util_js_1.normalizeInput)(t.input).includes(e)&&null}function getImportSpecifierList(e,t,o){const s=[e];if(void 0!==t||e[0].match(/^\.?\.?\//)||s.push(`./${e}`),t&&e.endsWith(".js"))for(const r of[".ts",".tsx"])t.endsWith(r)&&o.includes(r)&&s.push(e.replace(/.js$/,r));return s}function addSourceRootsIntoImportSpecifiers(e,t,o,s,r,i,n,a){if(e||!r||!n)return;const l=t.getModuleInfo(r)?.meta,c=l?.pkgName,d=l?.pkgPath,u=n[c]?.sourceRoots;c&&d&&o===c&&u?.length&&u.forEach((e=>{const t=path_1.default.resolve(d,e,s.join("/"));let o=path_1.default.relative(i,t).replace(/\\/g,"/");"."!==o.charAt(0)&&(o=`./${o}`),a.push(o)}))}function addResolvedMeta(e,t,o,s,r){if(e&&s&&s>r){const i=o.slice(r+1,s).map((e=>path_1.default.resolve(t,e)));e.meta={backupSourceRoots:i,resolvedBySourceRoot:!0}}return e}async function getRes(e,t,o,s,r,i,n,a,l,c,d,u,f){if(e){if(t&&c)return!d&&o&&s!==r&&i.warn(`preferring built-in module '${r}' over local alternative at '${o.location}', pass 'preferBuiltins: false' to disable this behavior or 'preferBuiltins: true' to disable this warning`),!1;if(u&&0!==n.indexOf((0,path_1.normalize)(u.trim(path_1.sep))))return null}if(f.modulesOnly&&await(0,fs_js_1.fileExists)(n)){return isModule(await(0,fs_js_1.readFile)(n,"utf-8"))?{id:`${n}${a}`,moduleSideEffects:l(n)}:null}return{id:`${n}${a}`,moduleSideEffects:l(n)}}function updateBrowserMapCache(e,t,o){if(e){if(Object.prototype.hasOwnProperty.call(e,t)){if(!e[t])return o.set(t,e),[{id:constants_js_1.ES6_BROWSER_EMPTY},null];t=e[t]}o.set(t,e)}return[null,t]}function getResolveLikeNode(e,t,o,s,r,i,n,a,l,c,d,u,f,p,_,h,g,m,v,j,S,E,k){return async(w,C,R,x)=>{const[b,y]=C.split("?"),P=""+(y?`?${y}`:"");C=b;const F=!R||e(C)?t:(0,path_1.dirname)(R),M=o.get(R);if(s&&M){const e=(0,path_1.resolve)(F,C);if(!1===M[C]||!1===M[e])return{id:constants_js_1.ES6_BROWSER_EMPTY};C=("."!==C[0]&&M[C]||M[e]||M[`${e}.js`]||M[`${e}.json`])??C}const O=C.split(/[/\\]/);let D=O.shift(),I=!1;if("@"===D[0]&&O.length>0?D+=`/${O.shift()}`:"."===D[0]&&(D=(0,path_1.resolve)(F,C),I=!0),!I&&!r(D))return reject(C,i);const $=getImportSpecifierList(C,R,n),B=$.length-1;addSourceRootsIntoImportSpecifiers(I,w,D,O,R,F,j.pkgNameToPkgInfo,$);const q=x&&x["node-resolve"]&&x["node-resolve"].isRequire,A=q?a:l;let L;s&&!A.includes("browser")&&A.push("browser"),L=k&&E&&S?await doNativeResolve(q?E:S,$,F,R):await(0,resolveImportSpecifiers_js_1.resolveImportSpecifiers)({importer:R,importSpecifierList:$,exportConditions:A,warn:(...e)=>w.warn(...e),packageInfoCache:c,extensions:n,mainFields:d,preserveSymlinks:u,useBrowserOverrides:s,baseDir:F,moduleDirectories:f,modulePaths:p,rootDir:t,ignoreSideEffectsForRoot:_,caseSensitiveCheck:j.caseSensitiveCheck,sdkModulesPath:j.sdkModulesPath});const N=(0,is_builtin_module_1.default)(C),T=N&&h?{packageInfo:void 0,hasModuleSideEffects:()=>null,hasPackageEntry:!0,packageBrowserField:!1}:L;if(!T)return null;const{packageInfo:W,hasModuleSideEffects:z,hasPackageEntry:H,packageBrowserField:V}=T;let{location:U}=T;const Y=updateBrowserMapCache(V,U,o);if(Y[0])return Y[0];U=Y[1],U=await updateLocation(H,U,W,u,g);return addResolvedMeta(await getRes(H,N,L,T,C,w,U,P,z,h,m,v,j),F,$,T.resolvedSpecifierIndex,B)}}async function doNativeResolve(e,t,o,s){for(let r=0;r<t.length;r++){const i=await e.async(o,t[r]);if(i.error||!i.path)continue;if(i.caseSensitiveDetected&&s){const e=`File: ${s}\n         Cannot resolved import statement ${t[r]+(i.indexLoaded?"/index":"")}. Please check the case.`;cache_js_1.caseErrorSet.add(e)}const n="\\\\?\\";return{location:i.path.startsWith(n)?i.path.substring(n.length):i.path,resolvedSpecifierIndex:r,hasModuleSideEffects:()=>null}}}function checkModuleDirectories(e){if(e.some((e=>e.includes("/"))))throw new Error("`moduleDirectories` option must only contain directory names. If you want to load modules from somewhere not supported by the default module resolution algorithm, see `modulePaths`.")}function updateDedupe(e,t){return"function"!=typeof e&&(e=e=>t.dedupe.includes(e)||t.dedupe.includes((0,util_js_1.getPackageName)(e))),e}function getResolveOnly(e){return"function"==typeof e.resolveOnly?e.resolveOnly:allowPatterns(e.resolveOnly)}function isExternal(e,t,o,s,r={}){for(const[e,i]of t)if(e.test(o))return"true"===r.widgetCompile&&logger.error(`The service widget file contains one or more references to HSPs: '${i}'.Solutions: Remove these references for the service widget to function correctly.${s?`\nFile: ${s}`:""}`),!0;for(const[t,i]of e)if(t.test(o)){if("true"===r.widgetCompile&&r.byteCodeHar2HspDep?.get(i)?.length){const e=r.byteCodeHar2HspDep?.get(i)?.map((e=>`'${e}'`));logger.error(`The service widget file contains one or more references to HSPs: ${e.join(", ")}.Solutions: Remove these references for the service widget to function correctly.${s?`\nFile: ${s}`:""}`)}return!0}return!1}function readSystemApi(e){const t=new Map;return e.forEach((e=>{fs_1.default.readdirSync(e).forEach((o=>{const s=path_1.default.join(e,o);fs_1.default.statSync(s).isFile()&&t.set(o.replace(".d.ts","").replace(".d.ets",""),s)}))})),t}function getVirtualFileId(e){return ignoreVirtualFilePrefix+e.replace(/\\/g,"_").replace(/\//g,"_")}function loadNativeResolver(e,t,o,s,r,i){if(!e)return[void 0,void 0];try{const{ResolverFactory:e}=require("oxc-resolver"),n=new e({conditionNames:t.conditionsEsm,mainFields:t.mainFields,extensions:o,symlinks:!s,modules:[...r,"oh_modules"],caseSensitive:i}),a=n.cloneWithOptions({conditionNames:t.conditionsCjs});return[n,a]}catch(e){console.warn("load native resolver failed: ",e)}return[void 0,void 0]}function nodeResolve(e={}){const{warnings:t}=(0,deprecated_options_js_1.default)(e),o={...defaults,...e},{extensions:s,jail:r,moduleDirectories:i,modulePaths:n,ignoreSideEffectsForRoot:a,sdkModulesPath:l,useNativeResolver:c}=o,d=initData(o);let u,f,p;checkModuleDirectories(i);const _=updateDedupe(d.dedupe,o),h=getResolveOnly(o),g=new Map,m=new Map;let v=!1;const j=new Map;let S,E;return{name:"oh-resolve",buildStart(e){u=e,t.forEach((e=>this.warn(e))),({preserveSymlinks:f}=e);const r=this.share?.projectConfig?.projectTopDir||process.cwd();this.share.symlinkMap=(0,resolveOhModules_js_1.resolveAllOhModules)(r),updateRealpathCache(o.useRealpathCache),p=readSystemApi(new Set(l)),getExternal(m,j,this.share.projectConfig),v=!this.share.projectConfig.isFaMode,[S,E]=loadNativeResolver(c,d,s,f,n,o.caseSensitiveCheck)},generateBundle:clearCache,beforeBuildEnd(){cache_js_1.caseErrorSet.forEach((e=>{logger.error(e)}))},resolveId:{order:"post",async handler(e,t,l){if(e===constants_js_1.ES6_BROWSER_EMPTY)return e;if(/\0/.test(e))return null;const{custom:k={}}=l;let w;return/\0/.test(t)&&(t=void 0),/^lib\S+\.so/.test(e)?{id:getVirtualFileId(e),external:v}:!o.caseSensitiveCheck&&isExternal(m,j,e,t,this.share?.projectConfig)?{id:e,external:!0}:("."!==e[0]&&p.has(e)&&(w={id:p.get(e)}),w||(w=await getResolveLikeNode(_,d.rootDir,g,d.useBrowserOverrides,h,u,s,d.conditionsCjs,d.conditionsEsm,d.packageInfoCache,d.mainFields,f,i,n,a,d.preferBuiltins,d.idToPackageInfo,d.isPreferBuiltinsSet,r,o,S,E,c)(this,e,t,k)),o.caseSensitiveCheck&&isExternal(m,j,e,t,this.share?.projectConfig)?{id:e,external:!0}:w&&(importCheckPlugin_js_1.default.resolveId.call(this,e,w.id,t,o),w.id.endsWith(".d.ts")||w.id.endsWith(".d.ets"))?{id:getVirtualFileId(w.id),external:v}:w)}},load:load,moduleParsed(e){importCheckPlugin_js_1.default.moduleParsed.call(this,e)},getPackageInfoForId:e=>d.idToPackageInfo.get(e),cleanUp:()=>{m.clear(),p?.clear(),clearCache(),S?.clearCache()}}}function getExternal(e,t,o){const s=new Set;if(o.compileMode===constants_js_1.ESMODULE){const e=(0,arkts_pack_js_1.loadAceBuildJson)(o.aceBuildJson);Object.keys(e?.hspNameOhmMap??{}).forEach((e=>{t.set(new RegExp(`^(${e})($|/\\S*)`,"i"),e)}))}if(o.compileBlockPkg)for(const e of o.compileBlockPkg)s.add(e);for(const t of s)e.set(new RegExp(`^(${t})($|/\\S*)`,"i"),t)}function updateRealpathCache(e){e?(0,fs_js_1.enableRealpathCache)():(0,fs_js_1.disableRealpathCache)()}function clearCache(){(0,fs_js_1.clearRealpathCache)(),(0,fs_js_1.clearFileCache)(),(0,cache_js_1.clearStepAddressingCache)(),cache_js_1.readCachedFile.clear(),cache_js_1.isFileCached.clear(),cache_js_1.isDirCached.clear()}function load(e){return e===constants_js_1.ES6_BROWSER_EMPTY?"export default {};":e.startsWith(ignoreVirtualFilePrefix)?"":(importCheckPlugin_js_1.default.load.call(this,e),null)}exports.nodeResolve=nodeResolve,exports.default=nodeResolve;