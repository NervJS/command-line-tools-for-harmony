"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.invalidCachePlugin=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_common_1=require("@ohos/hvigor-common"),fs_extra_1=__importDefault(require("fs-extra")),json5_1=__importDefault(require("json5")),arkts_pack_js_1=require("../arkts-pack.js"),constants_js_1=require("../util/constants.js"),hash_js_1=require("../util/hash.js"),module_meta_info_plugin_js_1=require("./module-meta-info-plugin.js");let allPlugins;const OLD_HAR_NAME_OHM_MAP="oldHarNameOhmMap",CUR_HAR_NAME_OHM_MAP="curHarNameOhmMap",PKG_JSON_FILE_HASH="pkgJsonFileHash",NEW_OHM_URL_HASH="newOhmUrlHash",ROUTER_MAP_HASH="routerMapHash",CASE_SENSITIVE_CHECK="caseSensitiveCheck",MODULE_DEPS="moduleDeps",PROJECT_ARK_OPTION="projectArkOption",TS_IMPORT_SENDABLE="tsImportSendable",AUTO_LAZY_IMPORT="autoLazyImport",PROJECT_OH_PACKAGE="projectDevDept",ALLOW_EMPTY_BUNDLE_NAME="allowEmptyBundleName",OHOS_UI_TRANSFORM_OPTIMIZATION="ohos.uiTransform.Optimization",BUNDLE_NAME="bundleName",RE_EXPORT_CHECK_MODE="reExportCheckMode",depCache=new Map;let inCIEnv=!1;function invalidCachePlugin(){return{name:"invalidCachePlugin",buildStart:buildStart,shouldTransformCachedModule:shouldTransformCachedModule,buildEnd:buildEnd,beforeBuild:beforeBuild,beforeBuildEnd:beforeBuildEnd,cleanUp(){depCache.clear()}}}function setProjectConfigCache(e){const t=e.share?.projectConfig,a=t?.projectArkOption?.tscConfig?.targetESVersion,o=t?.projectArkOption?.autoLazyImport,s=t?.reExportCheckMode;void 0!==o&&e.cache.set(AUTO_LAZY_IMPORT,o),a&&e.cache.set(PROJECT_ARK_OPTION,a),t?.pkgJsonFileHash&&e.cache.set(PKG_JSON_FILE_HASH,t?.pkgJsonFileHash),t?.routerMap&&e.cache.set(ROUTER_MAP_HASH,t?.routerMap),e.cache.set(OLD_HAR_NAME_OHM_MAP,e.cache.get(CUR_HAR_NAME_OHM_MAP)),e.cache.delete(CUR_HAR_NAME_OHM_MAP),e.cache.set(NEW_OHM_URL_HASH,!!t?.useNormalizedOHMUrl),e.cache.set(CASE_SENSITIVE_CHECK,t?.caseSensitiveCheck),e.cache.set(TS_IMPORT_SENDABLE,t?.tsImportSendable),e.cache.set(RE_EXPORT_CHECK_MODE,s)}function buildEnd(){setProjectConfigCache(this);const e=new Map;for(const t of this.getModuleIds()){const a=this.getModuleInfo(t);e.set(t,a?a.importedIds.concat(a.dynamicallyImportedIds):[])}this.cache.set(MODULE_DEPS,e);const t=this.share?.projectConfig?.mockParams?.mockConfigPath;if(t&&fs_extra_1.default.existsSync(t)){const e=hash_js_1.Hash.hash(fs_extra_1.default.readFileSync(t));this.cache.set(t,e)}}function beforeBuildEnd(){const e=this.share?.projectConfig?.allowEmptyBundleName;void 0!==e&&this.cache.set(ALLOW_EMPTY_BUNDLE_NAME,e),this.cache.set(PROJECT_OH_PACKAGE,this.share?.projectDevDept),this.cache.set(OHOS_UI_TRANSFORM_OPTIMIZATION,this.share?.projectConfig?.uiTransformOptimization),this.cache.set(BUNDLE_NAME,this.share?.projectConfig?.bundleName)}function buildStart({plugins:e}){const t=this.share?.projectConfig?.mockParams?.mockConfigPath;if(t&&fs_extra_1.default.existsSync(t)){const e=this.cache?.get(t),a=hash_js_1.Hash.hash(fs_extra_1.default.readFileSync(t));this.share.projectConfig.mockParams.isMockConfigChanged=a!==e}else this.share?.projectConfig?.mockParams&&(this.share.projectConfig.mockParams.isMockConfigChanged=!1);inCIEnv=(0,hvigor_common_1.isCI)();const a=(0,arkts_pack_js_1.loadAceBuildJson)(this.share?.projectConfig?.aceBuildJson).hspNameOhmMap;this.cache.set(CUR_HAR_NAME_OHM_MAP,a),allPlugins=[],allPlugins.push(...e),allPlugins=allPlugins.filter((e=>"object"==typeof e&&(e.shouldInvalidCache??!1)))}function beforeBuild(){if(this.share?.projectConfig?.projectTopDir){const e=path_1.default.resolve(this.share.projectConfig.projectTopDir,"oh-package.json5"),t=fs_extra_1.default.readFileSync(e,"utf-8");this.share.projectDevDept=json5_1.default.parse(t)?.devDependencies||{}}}function preCheckShouldTransform(e){const t=e.share?.projectConfig?.projectArkOption?.tscConfig?.targetESVersion!==e.cache.get(PROJECT_ARK_OPTION),a=e.share?.projectConfig?.projectArkOption?.autoLazyImport!==e.cache.get(AUTO_LAZY_IMPORT),o=e.share?.projectConfig?.allowEmptyBundleName!==e.cache.get(ALLOW_EMPTY_BUNDLE_NAME),s=e.share?.projectConfig?.reExportCheckMode!==e.cache.get(RE_EXPORT_CHECK_MODE),n=e.share?.projectConfig?.tsImportSendable!==!!e.cache.get(TS_IMPORT_SENDABLE);return t||a||o||s||n}function isHarNameOhmChanged(e){const t=e.cache.get(OLD_HAR_NAME_OHM_MAP),a=e.cache.get(CUR_HAR_NAME_OHM_MAP);if(t&&a)for(const e of Object.keys(a))if(t[e]&&a[e]!==t[e])return!0;return!1}function isPkgJsonFileChanged(e){return e.share?.projectConfig?.pkgJsonFileHash!==e.cache.get(PKG_JSON_FILE_HASH)}async function isPluginsHasInvalidCache(e,t){const a=await Promise.all(allPlugins.map((a=>a.shouldInvalidCache.apply(e,[t]))));let o=!1;return a.forEach((e=>{e&&"boolean"==typeof e&&(o||(o=e))})),o}async function shouldTransformCachedModule(e){if(localTestHasChangedMockConfig(this))return!0;if(!(0,wdk_1.isEqual)(this.cache?.get(PROJECT_OH_PACKAGE)??{},this.share?.projectDevDept??{}))return!0;if(isPkgJsonFileChanged(this)&&(inCIEnv||!this.share?.projectConfig?.resolveConflictMode))return!0;if(preCheckShouldTransform(this))return!0;if(isHarNameOhmChanged(this))return!0;if(isModulePkgNameChanged(e))return!0;if(bundleNameHasChanged(this))return!0;return await isPluginsHasInvalidCache(this,e)||hasHookEventChangedDeps(this,e)}function localTestHasChangedMockConfig(e){return!(!e?.share?.projectConfig?.isLocalTest||!e.share.projectConfig.mockParams?.isMockConfigChanged)}function bundleNameHasChanged(e){return e.share?.projectConfig?.uiTransformOptimization!==e.cache.get(OHOS_UI_TRANSFORM_OPTIMIZATION)||!1===e.share?.projectConfig?.uiTransformOptimization&&e.cache.get(BUNDLE_NAME)!==e.share?.projectConfig?.bundleName}function hasHookEventChangedDeps(e,t){const a=e.share.getHookEventFactory("invalidCachePlugin","shouldTransformCachedModule"),o=a.createEvent("hasChangedDeps")?.start(),s=hasChangedDeps(e.cache.get(MODULE_DEPS)?.get(t.id),e.share.depInfo.changedDeps);return o?.stop(),s}function hasChangedDeps(e,t){if(!e)return!1;for(const a of e){if(!depCache.has(a)){const e=depChanged(a,t);depCache.set(a,e)}if(depCache.get(a))return!0}return!1}function depChanged(e,t){let a=!1;for(const{name:o,lastRootPath:s}of t)if(s&&e.startsWith(s)||e===o||e.startsWith(o)){a=!0;break}return a}function isModulePkgNameChanged(e){if(!(e?.meta?.pkgPath&&e?.meta?.pkgName))return!1;const t=(0,module_meta_info_plugin_js_1.getPackageJsonInfo)(path_1.default.resolve(e.meta.pkgPath,constants_js_1.OH_PACKAGE_JSON5));return e.meta.pkgName!==t?.pkgName}exports.invalidCachePlugin=invalidCachePlugin;