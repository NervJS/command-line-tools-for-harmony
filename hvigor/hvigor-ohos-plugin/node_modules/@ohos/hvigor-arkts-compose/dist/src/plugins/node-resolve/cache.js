"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.clearStepAddressingCache=exports.readCachedFile=exports.isFileCached=exports.isDirCached=exports.caseErrorSet=void 0;const fs_1=__importDefault(require("fs")),fs_js_1=require("../../util/fs.js"),path_1=__importDefault(require("path"));exports.caseErrorSet=new Set;const onError=e=>{if("ENOENT"===e.code)return!1;throw e},makeCache=e=>{const t=new Map,r=async(r,a,i)=>{t.has(r)||t.set(r,e(r).catch((e=>{throw t.delete(r),e})));try{const e=await t.get(r);return addCaseSensitiveErrorLog(r,e,i),await a(null,e)}catch(e){return a(e)}};return r.clear=()=>t.clear(),r};exports.isDirCached=makeCache((async e=>{try{const t=await(0,fs_js_1.stat)(e);return t.isDirectory()}catch(e){return onError(e)}})),exports.isFileCached=makeCache((async e=>{try{const t=await(0,fs_js_1.stat)(e);return t.isFile()}catch(e){return onError(e)}})),exports.readCachedFile=makeCache(fs_js_1.readFile);const legalDirectorySet=new Set,notLegalDirectorySet=new Set;let dirFileMap={};function clearStepAddressingCache(){legalDirectorySet.clear(),notLegalDirectorySet.clear(),dirFileMap={},exports.caseErrorSet.clear()}function getRootDir(e){return e.startsWith("/")?"/":e.split(":\\")[0]+":\\"}function checkFileWithCase(e,t,r){try{t=getRootDir(t)}catch(e){}if(legalDirectorySet.has(e)||[...r,t].includes(e))return!0;if(notLegalDirectorySet.has(e))return!1;const a=path_1.default.dirname(e),i=path_1.default.basename(e);let s;if(dirFileMap[a]?s=dirFileMap[a]:(s=fs_1.default.readdirSync(a),dirFileMap[a]=s),!s.includes(i))return notLegalDirectorySet.add(e),!1;const o=checkFileWithCase(a,t,r);return o&&legalDirectorySet.add(e),o}function addCaseSensitiveErrorLog(e,t,r){if(r?.caseSensitiveCheck&&t){const t=checkFileWithCase(e.toString(),r.rootDir,r.sdkModulesPath),a=r.originImportPath??e;if(a.endsWith("oh-package.json5")&&r.joinPackageJson)return;if(!t){const e=`ERROR File: ${r.importer} \n        Cannot resolved import statement ${r?.joinIndex?`${a}/index`:a}. Please check the case.`;exports.caseErrorSet.add(e)}}}exports.clearStepAddressingCache=clearStepAddressingCache;