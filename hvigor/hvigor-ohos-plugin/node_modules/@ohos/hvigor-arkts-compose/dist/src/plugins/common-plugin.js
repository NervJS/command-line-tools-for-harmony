"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.commonPlugin=void 0;const hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),compile_event_factory_js_1=require("../analyzer/compile-event-factory.js"),compose_error_js_1=require("../data/compose-error.js"),constants_js_1=require("../util/constants.js"),utils_js_1=require("../util/utils.js"),DEP_INFO_CACHE_FILE="dep_info.json",LOGGER=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("commonPlugin");function commonPlugin(e,o){let t=!0,r=!1;return{name:"commonPlugin",options(){this.share.projectConfig=e,this.share.getLogger=hvigor_arkts_base_1.ArktsBaseLogger.getPluginLogger,this.share.throwArkTsCompilerError=compose_error_js_1.throwArkTsCompilerError,this.share.getHookEventFactory=e.perf===constants_js_1.AnalyzeMode.VERBOSE?compile_event_factory_js_1.CompileEventFactory.getHookEventFactory:getBogusHookEventFactory,this.share.getSourceFiles=loadSdkGetModuleSourceFilesFunc(e.etsLoaderPath),r=!!e.needCoverageInsert,(0,utils_js_1.isLinux)()||e.runtimeOS===constants_js_1.OPEN_HARMONY||e.isFaMode||(e.apiVersion>=constants_js_1.API_VERSION_11&&(this.share.cacheStoreManager=o,this.share.cache=e.compileEnv?o?.mount(e.compileEnv):void 0),this.share.commonCache=o?.mount(constants_js_1.TSC_COMMON_CACHE_KEY,!0))},beforeBuild(){(!t||e.isPreview&&!fs_extra_1.default.existsSync(e.buildDir))&&(t=!1,(0,compose_error_js_1.throwArkTsCompilerError)("Please restart previewer."));const{resolveConflictMode:o,depName2RootPath:r,depName2DepInfo:s}=readDepInfoCache(e.cachePath);this.share.depInfo=getDepInfo(e.resolveConflictMode,o,e.depName2RootPath,r,e.depName2DepInfo,s),writeDepInfoCache(e.resolveConflictMode,e.depName2RootPath,e.depName2DepInfo,e.cachePath)},beforeBuildEnd:{order:"post",async handler(){throwErrorIfHasErrorInfo(e.watchMode)}},transform(t,s){s.endsWith("?commonjs-entry")?this.share.projectConfig.needCoverageInsert=!1:this.share.projectConfig.needCoverageInsert=r,(0,hvigor_arkts_base_1.deleteModuleCache)(s,e.cachePath,o,e.compileEnv)}}}function readDepInfoCache(e){const o={resolveConflictMode:void 0,depName2RootPath:void 0,depName2DepInfo:void 0};if(!e)return o;const t=path_1.default.resolve(e,DEP_INFO_CACHE_FILE);if(!fs_extra_1.default.existsSync(t))return o;const r=fs_extra_1.default.readJsonSync(t);let s,a;return r?.depName2RootPath&&(s=new Map,Object.keys(r.depName2RootPath).forEach((e=>s?.set(e,r.depName2RootPath[e])))),r?.depName2DepInfo&&(a=new Map,Object.keys(r.depName2DepInfo).forEach((e=>a?.set(e,r.depName2DepInfo[e])))),{resolveConflictMode:r?.resolveConflictMode,depName2RootPath:s,depName2DepInfo:a}}function writeDepInfoCache(e,o,t,r){if(!r)return;const s=path_1.default.resolve(r,DEP_INFO_CACHE_FILE),a={resolveConflictMode:e,depName2RootPath:o?.size?{}:void 0,depName2DepInfo:t?.size?{}:void 0};o.forEach(((e,o)=>a.depName2RootPath[o]=e)),t.forEach(((e,o)=>a.depName2DepInfo[o]=e)),fs_extra_1.default.ensureFileSync(s),fs_extra_1.default.writeJSONSync(s,a)}function getDepInfo(e,o,t,r,s,a){if(void 0===o)return{enableIncre:!1,changedDeps:[]};if(e&&o){const e=[];return t.forEach(((o,t)=>{r?.get(t)&&r?.get(t)!==o&&e.push({name:t,lastRootPath:r?.get(t)})})),s.forEach(((o,t)=>{const r=a?.get(t);r&&o.pkgName===r.pkgName&&o.pkgVersion!==r.pkgVersion&&e.push({name:t,lastRootPath:r.pkgRootPath})})),r?.forEach(((o,r)=>{t.has(r)||e.push({name:r,lastRootPath:o})})),{enableIncre:!0,changedDeps:e}}return{enableIncre:!1,changedDeps:[]}}function getBogusHookEventFactory(){const e=()=>{},o=()=>({start:e,stop:e,startAsyncEvent:e,stopAsyncEvent:e,createSubEvent:o});return{createEvent:o}}function throwErrorIfHasErrorInfo(e){hvigor_arkts_base_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()&&"true"!==e&&(0,compose_error_js_1.throwArkTsCompilerError)("ArkTS Compiler Error")}function loadSdkGetModuleSourceFilesFunc(e){const o=path_1.default.join(e,"lib","fast_build","ark_compiler","module","module_source_file.js");if(fs_extra_1.default.existsSync(o))try{return require(o).ModuleSourceFile.getSourceFiles}catch(e){return void LOGGER.debug(`load getSourceFiles failed ${e}.`)}else LOGGER.debug(`${o} not exists.`)}exports.commonPlugin=commonPlugin;