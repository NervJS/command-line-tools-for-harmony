"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a);var c=Object.getOwnPropertyDescriptor(t,a);c&&!("get"in c?!t.__esModule:c.writable||c.configurable)||(c={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,c)}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.deleteModuleCache=exports.build=exports.writeWatchCache=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path=__importStar(require("path")),hvigor_common_1=require("@ohos/hvigor-common"),fse=__importStar(require("fs-extra")),rollup_1=require("rollup"),arkts_base_log_js_1=require("./log/arkts-base-log.js"),build_event_js_1=require("./util/build-event.js"),constants_js_1=require("./util/constants.js"),pack_js_1=require("./util/msgpack/pack.js"),struct_js_1=require("./util/msgpack/struct.js"),utils_js_1=require("./util/utils.js");(0,struct_js_1.updateReadStruct)();const logger=arkts_base_log_js_1.ArktsBaseLogger.getLogger("build"),extensionSet=new Set([".ets",".ts","js",".mjs",".cjs"]);let triggerTsWatch,watchParentPort,watchCache,watchEnableFileSystemCache,watchCacheDirectory,lastWatchRes,tsWatchEnd=!1,rollupWatchEnd=!1,isWatchFirst=!0;const lastReUsedFiles=new Set,FILE_NAME_TRANSFORM=/[\0:\\\/\*\?\"\<\>\|]/g,FILE_NAME_MAX_LENGTH=241;function readWatchLogs(e){let t=[];const a=path.resolve(e??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);if(fs_1.default.existsSync(a))try{t=JSON.parse(fs_1.default.readFileSync(a).toString())}catch(e){logger.debug(`read watch logs failed ${e.message}`)}return t}function writeWatchLogs(){const e=path.resolve(watchCacheDirectory??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);try{fse.ensureFileSync(e),fs_1.default.writeFileSync(e,JSON.stringify(arkts_base_log_js_1.ArktsBaseLogger.getLastLogEvents()))}catch(e){logger.debug(`write watch logs failed ${e.message}`)}}function removeWatchLogs(){const e=path.resolve(watchCacheDirectory??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);fs_1.default.rmSync(e,{force:!0})}async function writeWatchCache(e){lastWatchRes?(watchCacheDirectory&&fs_1.default.existsSync(watchCacheDirectory)&&await writeCache({enableFileSystemCache:watchEnableFileSystemCache,cache:watchCache,cacheDirectory:watchCacheDirectory,pkgName2SourceRoots:e,useTempFile:!1}),writeWatchLogs()):(removeCache(watchCacheDirectory),removeWatchLogs()),watchCache=void 0,watchEnableFileSystemCache=void 0,watchCacheDirectory=void 0}exports.writeWatchCache=writeWatchCache;const isValidImportee=(e,t=!0)=>{if(!e||/\0/.test(e)||path.isAbsolute(e)||e.startsWith("."))return!1;if(!t)return!0;const a=e.startsWith("@");return e.split(/[/\\]/).length>(a?2:1)};function collectImportees(e,t){const a=new Set,s=new Set;return t.modules.forEach((t=>{Object.keys(t.resolvedIds).forEach((c=>{t.meta?.belongModulePath===e&&isValidImportee(c)&&a.add(c),isValidImportee(c,!1)&&s.add(c)}))})),[Array.from(a),Array.from(s)]}async function processImportees(e,t,a,s,c){const{isByteCodeHar:r,bundledDependencies:o}=t;if(!(r&&a&&s&&c))return;const n=e.startEvent("process importees"),[i,l]=collectImportees(a,c);r&&await fse.writeJson(path.join(s,constants_js_1.NON_ENTRY_IMPORTEE_CACHE_FILE_NAME),i),o&&await fse.writeJson(path.join(s,constants_js_1.COMPILED_IMPORTEE_CACHE_FILE_NAME),l),e.endEvent(n.getId())}function collectFilesByModulePath(e,t){if(!e.modules?.length)return[];const a=/(\.e?ts)$/;return e.modules.filter((e=>e.meta?.belongModulePath===t&&a.test(e.id))).map((e=>e.id))}function difference(e,t){const a=new Set(t);return e.filter((e=>!a.has(e)))}function getModuleLastCachedSourceFiles(e){if(!e.declaredFilesPath||!e.cache||!e.modulePath)return[];const t=e.startEvent("get module last cached source files"),a=collectFilesByModulePath(e.cache,e.modulePath);return e.endEvent(t.getId()),a}function getDeclaredFilePath(e,t,a){const s=path.resolve(e,path.relative(a,t));return/(\.d\.e?ts)$/.test(s)?s:s.replace(/(\.e?ts)$/,".d$1")}async function removeEmptyDir(e,t){const a=path.relative(t,e);if(!a)return;const s=a.split(path.sep);for(;s.length;){const e=path.resolve(t,...s);if(!fse.existsSync(e))return;if((await fse.readdir(e)).length)return;await fse.remove(e),s.pop()}}async function removeRedundantDeclaredFiles(e,t,a,s,c){if(!(a&&s&&c&&t.length))return;const r=e.startEvent("remove redundant declared files"),o=difference(t,collectFilesByModulePath(c,s));if(!o.length)return void e.endEvent(r.getId());const n=new Set;for(const e of o){const t=getDeclaredFilePath(a,e,s);fse.existsSync(t)&&(await fse.remove(t),n.add(path.dirname(t)))}for(const e of n)fse.existsSync(e)&&await removeEmptyDir(e,a);e.endEvent(r.getId())}async function build(e,t,a,s,c,r,o){cleanEtsForTgz(e),readCacheWithEvent(e,o);const n=getModuleLastCachedSourceFiles(e);removeUncacheableModules(e);const i=e.compileEnv,l=!!e.disableGenerateBundle,h=void 0===e.writeBundle||e.writeBundle,d=e.watchMode??"false",u=e.unsupportedChangedFiles??[],{enableFileSystemCache:g,cacheDirectory:p,isPreview:_,pkgName2SourceRoots:f,isByteCodeHar:m,modulePath:E,declaredFilesPath:v,bundledDependencies:C}=e;deleteOptions(e);const w=e.startEvent(constants_js_1.ROLLUP_EVENT_NAME);if("true"===d){const o=await startWatch(e,_??!1,t,a,s,c,g,p,u,r);return e.endEvent(w.getId()),o}const y=await(0,rollup_1.rollup)(e);if(e.endEvent(w.getId()),!l)for(const t of e.output)h?await y.write(t):await y.generate(t);await processImportees(e,{isByteCodeHar:m,bundledDependencies:C},E,p,y.cache),await removeRedundantDeclaredFiles(e,n,v,E,y.cache);const k=e.startEvent("write build package cache");await writeCache({enableFileSystemCache:g,cache:y.cache,cacheDirectory:p,pkgName2SourceRoots:f,cacheKey:i,cacheStoreManager:o,parentEvent:k,changedModules:y.changedModules}),e.endEvent(k.getId());const S=e.startEvent("wait for plug-in registration asynchronous task to complete");return await y.triggerBundleEnd(),e.endEvent(S.getId()),arkts_base_log_js_1.ArktsBaseLogger.reset(),{timing:y.getTimings&&y.getTimings(),callback:async e=>{const t=getCacheDir(p),a=getCacheModulesDir(t);await handleCacheFiles(e,a),e&&(await y.close(),i&&o?.mount(i).setCache(t,getFinalCache(y.cache,f),!0))}}}async function handleCacheFiles(e,t){if(!fse.existsSync(t))return;const a=fse.readdirSync(t),s=[];for(const c of a)c.startsWith("new-")&&(e?s.push(fse.rename(path.resolve(t,c),path.resolve(t,c.replace("new-","")))):s.push(fse.rm(path.resolve(t,c))));await Promise.all(s)}function deleteOptions(e){["disableGenerateBundle","writeBundle","enableFileSystemCache","cacheDirectory","watchMode","unsupportedChangedFiles","isPreview","compileEnv","extensions","pkgName2SourceRoots","resolveConflictMode","depName2RootPath","modulePath","isByteCodeHar","declaredFilesPath","bundledDependencies","arkCompileCachePath","buildMode"].forEach((t=>{Reflect.deleteProperty(e,t)}))}function clearWatchData(){triggerTsWatch=!1,tsWatchEnd=!1,rollupWatchEnd=!1,arkts_base_log_js_1.ArktsBaseLogger.clearLogEvents(),lastReUsedFiles.clear()}function sendWatchResult(){isWatchFirst=!1,arkts_base_log_js_1.ArktsBaseLogger.sendLastLogEvents(lastReUsedFiles),lastWatchRes=!arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo(),watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_RESULT,content:lastWatchRes}),clearWatchData()}function processTsWatchEnd(){tsWatchEnd=!0,rollupWatchEnd&&sendWatchResult()}function processRollupWatchEnd(){rollupWatchEnd=!0,!tsWatchEnd&&triggerTsWatch||sendWatchResult()}function updateLastReUsedFiles(e){e.forEach((e=>lastReUsedFiles.add("Windows_NT"===os_1.default.type()?path.posix.join(...e.split(path.sep)):e)))}async function startWatch(e,t,a,s,c,r,o,n,i,l){arkts_base_log_js_1.ArktsBaseLogger.addLastLogEvents(readWatchLogs(n)),arkts_base_log_js_1.ArktsBaseLogger.setLogCallback(a,processTsWatchEnd),watchParentPort=s;const h=new Set;return new Promise(((a,s)=>{const d=(0,rollup_1.watch)(e);r(d),d.on("event",(e=>{switch(e.code){case"BUNDLE_START":watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_START}),validateUnsupportedChangedFiles(e.lastChangedFiles,i),updateTriggerTsWatchWithLastChangedFiles(e.lastChangedFiles);break;case"BUNDLE_END":if(isWatchFirst&&arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()){const e=arkts_base_log_js_1.ArktsBaseLogger.getLogEvents().filter((e=>"error"===e.level)).map((e=>e.msg)).join("");s(e)}c(),updateCache(o,e.result.cache,n),hotReload(t,e.result.watchFiles,h),e.result.getTimings?a({timing:e.result.getTimings()}):a({}),updateLastReUsedFiles(e.lastReUsedFiles),processRollupWatchEnd();break;case"ERROR":s("Compilation failed"),arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:e.error.message,type:constants_js_1.PLUGIN_LOG_TYPE}),l&&l(e.error),processRollupWatchEnd()}}))}))}function hotReload(e,t,a){e||(isWatchFirst?(t.forEach((e=>a.add(e))),sendHotReloadWatchFileList(t)):validateWatchScope(t,a))}function validateUnsupportedChangedFiles(e,t){for(const a of t)if(e.has(a))throw arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:`${a} has been changed, which is not supported in watch mode. Please rebuild this module manually.`,type:constants_js_1.PLUGIN_LOG_TYPE}),new Error}function validateWatchScope(e,t){const a=(e="new files")=>{arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:`Importing ${e} is not supported in hot reload mode. Please rebuild this module manually.`,type:constants_js_1.PLUGIN_LOG_TYPE})};if(e.length>t.size)a();else for(const s of e)if(!t.has(s))return void a(s)}function updateTriggerTsWatchWithLastChangedFiles(e){for(const t of e.keys())if(willTriggerTsWatch(t)){triggerTsWatch=!0;break}triggerTsWatch=void 0===triggerTsWatch||triggerTsWatch,process.env.triggerTsWatch=String(triggerTsWatch)}function filterEvent(e,t){const a=t?.getUseTime();e&&t&&a&&a<1e7&&e.deleteChild(t.getId())}function getCacheModulesDir(e){return path.join(e,"modules")}exports.build=build;const cacheHandler={modules:{readCache:(e,t,a)=>{e.modules.push(t)},packCache:(e,t,a)=>{const s=new Map;return e.forEach((e=>{const c=e.id;if(c.startsWith("\0"))logger.debug(`Virtual file: ${c} is not written to cache.`);else if(void 0===a||a.has(c)){const a=t?.createSubEvent(`module '${path.basename(c)}' pack`).start();s.set(c,(new pack_js_1.Packr).pack(e)),(0,pack_js_1.resetPack)(),a?.stop(),filterEvent(t,a)}})),s},writeCache:(e,t,a,s)=>{const c=new Map,r=getCacheModulesDir(a);function o(e){return`${`${path.basename(e)}-${(0,hvigor_common_1.hash)(e,"md5")}`.slice(-241)}.msgpack`}fse.existsSync(r)&&fse.readdirSync(r).forEach((e=>{c.set(e,path.join(r,e))})),e.forEach(((e,s)=>{const c=o(s),r=Promise.resolve();t.push(r.then((()=>fse.outputFile(path.join(a,"modules",`new-${c}`),e))))})),s.forEach((e=>{c.has(o(e))&&c.delete(o(e))})),c.forEach((e=>{t.push(fse.remove(e))}))}},plugins:{readCache:(e,t)=>{e.plugins=t},packCache:(e,t)=>{if(e){const a=t?.createSubEvent("plugin pack").start(),s=(new pack_js_1.Packr).pack(e);return(0,pack_js_1.resetPack)(),a?.stop(),filterEvent(t,a),s}},writeCache:(e,t,a)=>{t.push(fse.outputFile(path.join(a,"plugins","plugins.msgpack"),e))}},other:{readCache:(e,t,a)=>{e[path.parse(a).name]=t},packCache:(e,t)=>{const a=new Map;return Object.keys(e).forEach((s=>{const c=t?.createSubEvent(`'${s}' pack`).start();a.set(s,(new pack_js_1.Packr).pack(e[s])),(0,pack_js_1.resetPack)(),c?.stop(),filterEvent(t,c)})),a},writeCache:(e,t,a)=>{e.forEach(((e,s)=>{t.push(fse.outputFile(path.join(a,"other",`${s}.msgpack`),e))}))}}};function readCache(e,t){if(!e.enableFileSystemCache)return;const a=getCacheDir(e.cacheDirectory);if(fs_1.default.existsSync(a)){if(t&&e.cacheDirectory){const s=t.mount(e.compileEnv).getCache(a);if(s)return void(e.cache=s)}try{e.cache||(e.cache={modules:[]}),fs_1.default.readdirSync(a).forEach((t=>{const s=path.join(a,t);fse.statSync(s).isDirectory()&&t in cacheHandler&&fs_1.default.readdirSync(s).forEach((a=>{const c=path.join(s,a),r=(new pack_js_1.Packr).unpack(fs_1.default.readFileSync(c));(0,pack_js_1.resetPack)(),cacheHandler[t].readCache(e.cache,r,c)}))}))}catch(e){logger.warn(`read cache file failed ${e.message}`)}(0,pack_js_1.resetPack)()}else t?.mount(e.compileEnv).delete(a)}function readCacheWithEvent(e,t){const a=e.startEvent("read build package cache");readCache(e,t),e.endEvent(a.getId())}function cleanEtsForTgz(e){const t=getCacheDir(e.cacheDirectory),a=path.resolve(e.arkCompileCachePath,constants_js_1.COMPILE_INFO);if(fs_1.default.existsSync(t)&&fs_1.default.existsSync(a)){fse.readJSONSync(a).buildMode!==e.buildMode&&e.declaredFilesPath&&fse.existsSync(e.declaredFilesPath)&&fse.removeSync(e.declaredFilesPath)}else e.declaredFilesPath&&fse.existsSync(e.declaredFilesPath)&&fse.removeSync(e.declaredFilesPath);e.buildMode&&(fse.ensureFileSync(a),fse.writeJsonSync(a,{buildMode:e.buildMode}))}function isBackupSourceRootExists(e,t=[]){return e.some((e=>!!(0,utils_js_1.findSuitableFilePath)(e,t)))}function removeUncacheableModules(e){const t=e.cache;if(!t||!t?.modules)return;const a=e.startEvent("remove uncacheable modules"),s=e.extensions,c=e.pkgName2SourceRoots;t.modules=t.modules.filter((e=>{const a=Object.values(e.resolvedIds||{}),r=e.meta.pkgName,o=c?.[r],n=t.pkgName2SourceRoots?.[r];return(n||[]).join(",")!==(o||[]).join(",")?!a.some((e=>!!e.meta?.resolvedBySourceRoot)):a.every((e=>{const t=e.meta;return!t?.resolvedBySourceRoot||!t?.backupSourceRoots?.length||!isBackupSourceRootExists(t.backupSourceRoots,s)}))})),e.endEvent(a.getId())}function updateCache(e,t,a){watchEnableFileSystemCache=e,watchCache=t,watchCacheDirectory=a}function getFinalCache(e,t){return e&&t?{...e,pkgName2SourceRoots:t}:e}async function writeCache({enableFileSystemCache:e,cache:t,cacheDirectory:a,pkgName2SourceRoots:s,cacheKey:c,cacheStoreManager:r,useTempFile:o=!0,parentEvent:n,changedModules:i}){if(e&&t){const e=getCacheDir(a);try{const a=n?.createSubEvent("get final cache").start(),l=getFinalCache(t,s);a?.stop();const h=n?.createSubEvent("pack cache").start(),{modules:d,plugins:u,...g}=l||{modules:[]},p=cacheHandler.modules.packCache(d,h,i),_=cacheHandler.plugins.packCache(u,h),f=cacheHandler.other.packCache(g,h);h?.stop();const m=n?.createSubEvent("write cache").start(),E=[];cacheHandler.modules.writeCache(p,E,e,new Set(d.map((e=>e.id)))),u&&cacheHandler.plugins.writeCache(_,E,e),cacheHandler.other.writeCache(f,E,e),await Promise.all(E),r&&c&&!o&&r.mount(c).setCache(e,l,!0),m?.stop()}catch(e){logger.debug(`write cache file failed ${e.message}`)}(0,pack_js_1.resetPack)()}}function removeCache(e){const t=getCacheDir(e);fse.removeSync(t)}function getCacheDir(e){return e?path.join(e,constants_js_1.MSGPACK_COMPILE_CACHE_DIR_NAME):constants_js_1.MSGPACK_COMPILE_CACHE_DIR_NAME}function willTriggerTsWatch(e){return extensionSet.has(path.extname(e))}function sendHotReloadWatchFileList(e){e&&watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_RESULT,content:JSON.stringify({isSuccess:!arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo(),watchFiles:e})})}function replaceModuleId(e){return e.replace(FILE_NAME_TRANSFORM,"%")}function getModuleCachePath(e,t){return path.join(getCacheModulesDir(e),`${t}.msgpack`)}function deleteModuleCache(e,t,a,s){if(!t)return;const c=getCacheDir(t),r=getModuleCachePath(c,replaceModuleId(e));if(fse.existsSync(r)&&fse.removeSync(r),a&&s){const t=a?.mount(s).getCache(c);if(t?.modules){const a=t.modules.indexOf(e);-1!==a&&t.modules.splice(a,1)}}}exports.deleteModuleCache=deleteModuleCache;