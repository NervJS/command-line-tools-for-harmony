"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.shouldTreatHarAsHap=exports.checkByteCodeHar=exports.collectByteCodeInfoAndOtherCompileEntrances=void 0;const hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),sdk_const_js_1=require("../const/sdk-const.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),inject_util_js_1=require("./inject-util.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),logger=ohos_logger_js_1.OhosLogger.getLogger("byte-code-har-utils"),isHsp=e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP,isHar=e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR,isNpmPackage=e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER,isByteCodeHar=e=>e.isByteCodeHarDependency(),isBundledDependency=e=>e.isBundleDependency(),isSourceCodeHar=e=>isHar(e)&&!e.isByteCodeHarDependency(),isBlockedByByteCodeHar=e=>!!e.parent&&isByteCodeHar(e.parent.npm),getPackageNameFromImportee=e=>{const t=e.startsWith("@"),o=e.split(/[/\\]/);return t?o.slice(0,2).join("/"):o[0]},getFinalNodes=e=>e.filter((e=>{const t=e.npm;return!isHsp(t)&&t.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES})),collectByteCodeHarInfo=(e,t)=>{const o=e.getPackageName(),n=e.getDependencyRootPath(),r=path_1.default.join(n,code_type_enum_js_1.CodeType.ETS,build_directory_const_js_1.BuildArtifactConst.MODULES_ABC);if(t.has(r))return;if(!fs_extra_1.default.existsSync(r))return void logger.debug(`Dependency [${o}] is byte-code HAR, but '${code_type_enum_js_1.CodeType.ETS}/${build_directory_const_js_1.BuildArtifactConst.MODULES_ABC}' does not exists.`);const s=path_1.default.join(n,code_type_enum_js_1.CodeType.ETS,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),d={abcPath:r,packageName:o,...fs_extra_1.default.existsSync(s)?{sourceMapsPath:s}:{}};t.set(n,d)},collectEntryPath=(e,t)=>{const o=e.getDependencyRootPath(),n=e.getDependencyMainFileRelativePath(),r=n?path_1.default.resolve(o,n):e.getDependencyMainFilePath();!t.has(r)&&fs_extra_1.default.existsSync(r)&&t.set(r,!1)},collectSourceCodeHarInfo=(e,t)=>{collectEntryPath(e,t);const o=e.getDependencyRootPath(),n=path_1.default.resolve(o,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,code_type_enum_js_1.CodeType.ETS);!t.has(n)&&fs_extra_1.default.existsSync(n)&&fs_extra_1.default.statSync(n).isDirectory()&&t.set(n,!0)},collectExtraImportees=(e,t)=>{var o;const n=e.getPackageJsonObj();((null===(o=null==n?void 0:n.metadata)||void 0===o?void 0:o.extraImportees)||[]).forEach((e=>{t.add(e)}))},processBundledNodeDependencies=e=>{var t;const{node:o,childrenPendingOrProcessed:n}=e,r=o.npm.getDependencyRootPath();if(n.has(r))return;n.add(r);const s=o.npm.getPackageJsonObj(),d=(null===(t=null==s?void 0:s.metadata)||void 0===t?void 0:t.compiledPackageNames)||[],c=getFinalNodes(o.children);for(;c.length;){const t=c.shift(),o=t.npm.getPackageName();d.includes(o)?c.push(...getFinalNodes(t.children)):processNode({...e,node:t,blockedByByteCodeHar:!0})}},processBundledNode=e=>{const{node:t,byteCodeInfo:o,extraImportees:n}=e,r=t.npm;return!!isBundledDependency(r)&&(collectByteCodeHarInfo(r,o),collectExtraImportees(r,n),processBundledNodeDependencies(e),!0)},enqueueChildren=e=>{const{node:t,childrenPendingOrProcessed:o,queue:n}=e,r=t.npm.getDependencyRootPath();o.has(r)||(o.add(r),n.push(...getFinalNodes(t.children)))},processByteCodeHarNode=e=>{const{node:t,byteCodeInfo:o,extraImportees:n}=e,r=t.npm;return!(!isByteCodeHar(r)||isBundledDependency(r))&&(collectByteCodeHarInfo(r,o),collectExtraImportees(r,n),enqueueChildren(e),!0)},processSourceCodeHarNode=e=>{const{node:t,queue:o,otherCompileEntrances:n,blockedByByteCodeHar:r}=e,s=t.npm;return!!isSourceCodeHar(s)&&((r||isBlockedByByteCodeHar(t))&&collectSourceCodeHarInfo(s,n),enqueueChildren(e),!0)},processNpmPackageNode=e=>{const{node:t,queue:o,otherCompileEntrances:n,blockedByByteCodeHar:r}=e,s=t.npm;return!!isNpmPackage(s)&&((r||isBlockedByByteCodeHar(t))&&collectEntryPath(s,n),!0)},chains=[processBundledNode,processByteCodeHarNode,processSourceCodeHarNode,processNpmPackageNode],processNode=e=>{chains.some((t=>t(e)))},processExtraImportees=(e,t,o)=>{const n=new Map;e.getModuleService().getOtherDependencies().forEach((e=>{n.set(e.getPackageName(),e)})),t.forEach((e=>{const t=getPackageNameFromImportee(e);if(!n.has(t))return void logger.debug(`Can not find dependency [${t}], make sure it has been installed successfully`);const r=n.get(t);if(t===e)return void collectEntryPath(r,o);const s=path_1.default.join(r.getDependencyRootPath(),e.substring(t.length)),d=(0,hvigor_arkts_compose_1.findSuitableFilePath)(s,hvigor_arkts_compose_1.SUPPORT_EXTENSIONS);d?o.set(d,!1):logger.debug(`Can not find file path by importee: ${e} [${t}]`)}))},collectByteCodeInfoAndOtherCompileEntrances=e=>{const t=e.getModuleService().getDirectPkgNodes(),o=getFinalNodes(t),n=new Set,r=new Set,s=new Map,d=new Map;for(;o.length;){const e=o.shift();processNode({node:e,queue:o,byteCodeInfo:d,extraImportees:n,childrenPendingOrProcessed:r,otherCompileEntrances:s})}return processExtraImportees(e,n,s),{byteCodeInfo:d,otherCompileEntrances:s}};exports.collectByteCodeInfoAndOtherCompileEntrances=collectByteCodeInfoAndOtherCompileEntrances;const checkByteCodeHar=({logger:e,compileApiVersion:t,compatibleApiVersion:o,useNormalizedOHMUrl:n})=>{(t<sdk_const_js_1.ApiVersion.API_VERSION_12||o<sdk_const_js_1.ApiVersion.API_VERSION_12)&&e._buildError("byteCodeHar not supported when below API version 12. ")._detail("Please check compileSdkVersion and compatibleSdkVersion in the project-level build-profile.json5 file.")._printErrorAndExit(),n||e._buildError("byteCodeHar not supported when useNormalizedOHMUrl is not true. ")._detail("Please check useNormalizedOHMUrl in the project-level build-profile.json5 file.")._printErrorAndExit()};exports.checkByteCodeHar=checkByteCodeHar;const shouldTreatHarAsHap=()=>inject_util_js_1.InjectUtil.isInTest()||inject_util_js_1.InjectUtil.isPreviewProcess();exports.shouldTreatHarAsHap=shouldTreatHarAsHap;