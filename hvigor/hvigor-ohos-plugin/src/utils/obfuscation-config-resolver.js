"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformRules=exports.resolveObfuscationDependencies=exports.resolveObfuscationOptions=void 0;const fs_1=__importDefault(require("fs")),promises_1=__importDefault(require("fs/promises")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),build_option_path_info_js_1=require("../common/build-option-path-info.js"),common_const_js_1=require("../const/common-const.js"),build_mode_manager_js_1=require("../project/build-option/build-mode-manager.js"),file_util_js_1=require("./file-util.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("obfuscation"),resolveObfuscationOptions=async(e,o,t)=>{var s,i,n;const r=e.getTargetData().getModuleModel(),l=e.getTargetData().getTargetName();if(!o)return;const a=await(0,exports.resolveObfuscationDependencies)(r);return o.ruleOptions={enable:null===(s=o.ruleOptions)||void 0===s?void 0:s.enable,rules:(null===(i=o.ruleOptions)||void 0===i?void 0:i.rules)||(0,exports.transformRules)(null===(n=o.ruleOptions)||void 0===n?void 0:n.files,r.getProjectDir(),r,l)},o.consumerRules=o.consumerRules||(0,exports.transformRules)(o.consumerFiles,r.getProjectDir(),r,l),{selfConfig:o,sdkApis:[],obfuscationCacheDir:t,exportRulePath:e.getTargetData().getPathInfo().getObfuscationExportRulePath(),dependencies:a}};exports.resolveObfuscationOptions=resolveObfuscationOptions;const resolveObfuscationDependencies=async e=>{const o={libraries:[],hars:[]};return await resolveDepObfuscationOptions(e,o),o};exports.resolveObfuscationDependencies=resolveObfuscationDependencies;const resolveDepObfuscationOptions=async(e,o)=>{var t,s,i;const n=e.getParentProject().isOhpmProject(),r=["version","devDependencies","dynamicDependencies","dependencies"],l=n?e.getOhPackageJson5Path():e.getPackageJsonPath();if(!fs_1.default.existsSync(l))return;const a=await hvigor_1.Json5Reader.readJson5File(l);if(n){const o=e.getParentProject().getParameterFileObj(),t={parameterFilePath:e.getParentProject().getParameterFileAbsolutePath(),ohPackageFilePath:l};file_util_js_1.FileUtil.resolveJsonObjWithoutParam(a,o,t,r)}if(!(null==a?void 0:a.name))return;const u=n?common_const_js_1.CommonConst.OH_MODULES:common_const_js_1.CommonNodeConst.NODE_MODULES;for(const n in a.dependencies){if(!Object.prototype.hasOwnProperty.call(null==a?void 0:a.dependencies,n))continue;const r=path_1.default.resolve(e.getProjectDir(),u,...n.split("/"));if(!fs_1.default.existsSync(r)){_log.warn(`Dependency ${n} not found.`);continue}let l;try{l=await promises_1.default.lstat(r)}catch(e){_log.warn(`Dependency ${n} not found or symbolic link is invalid.`);continue}const c=l.isSymbolicLink()?await promises_1.default.realpath(r):r,f=resolveModuleWithPath(c,e.getAllModules());if(!f){const e=path_1.default.resolve(c,common_const_js_1.CommonConst.OBFUSCATION_TXT);fs_1.default.existsSync(e)&&-1===o.hars.indexOf(e)&&(_log.debug(`Collect obfuscation config from dependency ${n}.`),o.hars.push(e));continue}if(!f.isHarModule())continue;const d=null===(t=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(f.getName(),"default").arkOptions)||void 0===t?void 0:t.obfuscation;if(d){if(o.libraries.find((e=>e.libDir===c)))continue;_log.debug(`Collect obfuscation config from library ${f.getName()}.`);const e={ruleOptions:{enable:null===(s=d.ruleOptions)||void 0===s?void 0:s.enable,rules:(0,exports.transformRules)(null===(i=d.ruleOptions)||void 0===i?void 0:i.files,c,f,"default")},consumerRules:(0,exports.transformRules)(d.consumerFiles,c,f,"default"),libDir:c};o.libraries.push(e)}await resolveDepObfuscationOptions(f,o)}},resolveModuleWithPath=(e,o)=>{for(const t of o.values()){if(""===path_1.default.relative(t.getProjectDir(),e))return t}},transformRules=(e,o,t,s)=>{if(!e)return[];const i=[];return"string"==typeof e?(checkObFile(e,o,i,t,s),i):(e.forEach((e=>checkObFile(e,o,i,t,s))),i)};exports.transformRules=transformRules;const checkObFile=(e,o,t,s,i)=>{const n=path_1.default.resolve(o,e),r=build_option_path_info_js_1.buildOptionPath.getTargetBuildOptPath(s,i,"files");fs_1.default.existsSync(n)||_log._buildError("The obfuscation file declared in configuration does not exist.")._detail(`Can not find obfuscation file at ${n}.`)._file(r)._printErrorAndExit(),t.push(n)};