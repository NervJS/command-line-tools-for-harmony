"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HarTargetUtil=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),task_util_js_1=require("@ohos/hvigor/src/base/util/task-util.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),ohos_plugin_id_js_1=require("../plugin/common/ohos-plugin-id.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),target_utils_js_1=require("./target-utils.js"),DEP_TARGET_CACHE_NAME="depTargetsCache";class HarTargetUtil{static getHarTargetName(e,t){const r=e.getModuleService().getProjectModel().getModuleSpecificTargets().get(t);if((null==r?void 0:r.length)&&r[0]!==common_const_js_1.DefaultTargetConst.ALL_TARGET)return r[0];const o=e.getTargetData().getTargetName();if(o===common_const_js_1.CommonConst.OHOS_TEST)return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET;const a=e.getModuleService().getProjectModel().getModuleModelByName(t);if(!a)return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET;const s=a.getTargetOptions().map((e=>e.name)),i=(0,task_util_js_1.getAlignTarget)();return i&&s.includes(i)?(0,task_util_js_1.getAlignTarget)():s.includes(o)?o:common_const_js_1.DefaultTargetConst.DEFAULT_TARGET}static calDepHarTargets(e){const t=new Map,r=e.getModuleService(),o=r.getModuleModel(),a=o.getName(),s=e.getTargetData().getTargetName(),i=hvigor_1.hvigorCore.getCache("depTargetsCache"),n=i.get(`${a}@${s}`);return n||(r.getHarModuleDependencies().forEach((r=>{const i=this.getHarTargetData(r,o,s,a,e);if(i)t.set(r[0],i);else{const a=r[1].getLastDependencyName();if(a){const s=t.get(a);if(s){const i=this.getHarTargetData(r,o,s,a,e);i&&t.set(r[0],i)}}}})),i.set(`${a}@${s}`,t),t)}static getHarTargetData(e,t,r,o,a){const s=e[0];if(e[1].getLastDependencyName()&&e[1].getLastDependencyName()!==o)return"";const i=t.getModule().findModuleByName(s);if(!i)return this._log._buildError(`Unable to find target '${r}' in module '${s}'. Make sure module '${s}' has the same target as module '${s}'.`)._printErrorAndExit(o),"";if(a.getModuleService().isFaMode())return this.getHarTargetName(a,s);const n=i.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAR_PLUGIN).getNeedExecTargetServiceList();n&&0!==n.length||this._log._buildError(`Unable to find target '${r}' in module '${s}'. Make sure module '${s}' has the same target as module '${s}'.`)._printErrorAndExit(o);const l=target_utils_js_1.TargetUtils.pushTryTargets({projectModel:a.getModuleService().getProjectModel(),moduleName:s,superTargetName:r});for(const e of l){if(n.find((t=>t.getTargetData().getTargetName()===e)))return e}return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET}static getDep2ConfigMap(e){if(!e)return;const t=e.getModuleService();if(!t)return;const r=new Map,o=new Map,a=new Map,s=new Map,i=new Map;return t.getHarModuleDependencies().forEach((t=>{var n,l,g;const c=this.getDepTargetService(e,t);c&&(this.collectWorkers(r,null===(n=c.getBuildOption().sourceOption)||void 0===n?void 0:n.workers,t[1]),this.collectRuntimeOnly(o,a,null===(l=c.getBuildOption().arkOptions)||void 0===l?void 0:l.runtimeOnly,t[1]),this.collectRouterMapPageSourceFiles(s,c.getTargetRouterMapObjList(c.getModuleService().getModuleModel()),t[1]),this.collectResources(i,null===(g=c.getTargetData().getTargetOpt().resource)||void 0===g?void 0:g.directories,t[1]))})),t.getRemoteHarDependencies().forEach((e=>{var t,n,l,g;if(e.isByteCodeHarDependency())return;const c=e.getPackageJsonObj();this.collectWorkers(r,null===(t=c.metadata)||void 0===t?void 0:t.workers,e),this.collectRuntimeOnly(o,a,null===(n=c.metadata)||void 0===n?void 0:n.runtimeOnly,e),this.collectRouterMapPageSourceFiles(s,dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e),e),this.collectResources(i,null===(g=null===(l=c.metadata)||void 0===l?void 0:l.resource)||void 0===g?void 0:g.directories,e)})),{dep2Workers:r,dep2RuntimeOnlyObj:{dep2RuntimeOnlySources:o,dep2RuntimeOnlyPackages:a},dep2RouterMapObjPageSourceFiles:s,dep2Resources:i}}static collectWorkers(e,t,r){(null==t?void 0:t.length)&&e.set(r,t)}static collectRuntimeOnly(e,t,r,o){r&&(r.sources&&e.set(o,r.sources),r.packages&&t.set(o,r.packages))}static collectRouterMapPageSourceFiles(e,t,r){if(!(null==t?void 0:t.length))return;const o=[];t.forEach((e=>{o.push(e.pageSourceFile)})),e.set(r,[...o])}static collectResources(e,t,r){const o=`${build_directory_const_js_1.BuildDirConst.SRC}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.MAIN}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.RESOURCES}`;e.set(r,(null==t?void 0:t.length)?[...t]:[o])}static getDepTargetService(e,t){if(!e)return;const r=e.getModuleService(),o=r.getProjectModel(),a=r.getModuleModel(),s=HarTargetUtil.getHarTargetData(t,a,e.getTargetData().getTargetName(),a.getName(),e),i=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(t[1],o);return i?o.getTarget(i.getName(),s):void 0}}exports.HarTargetUtil=HarTargetUtil,HarTargetUtil._log=ohos_logger_js_1.OhosLogger.getLogger("HarTargetUtil");