"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TaskService=void 0;const path_1=__importDefault(require("path")),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js"),copy_resources_util_js_1=require("../../utils/copy-resources-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),remote_hsp_utils_js_1=require("../../utils/remote-hsp-utils.js"),build_directory_const_js_1=require("../../const/build-directory-const.js");class TaskService{constructor(e,n,t,p){this.log=ohos_logger_js_1.OhosLogger.getLogger("TaskService"),this.hvigorNode=e,this._projectModel=n,this._dependencyManager=t,this._isFaMode=p}initDependencyInfo(){this.log.debug("Start to initialize dependency information."),this._moduleDependencyInfo=this._dependencyManager.createModelDependencyInfo()}isFaMode(){return this._isFaMode}getNode(){return this.hvigorNode}getProjectModel(){return this._projectModel}getDependencyMainPaths(){return this.getDependencyInfo().getNpmDependencies().map((e=>e.getDependencyMainFilePath()))}getDependencyRootPaths(){return this.getDependencyInfo().getNpmDependencies().map((e=>e.getDependencyRootPath()))}getDependencyName2RootPath(){const e=new Map;for(const n of this._dependencyManager.collectAllDependenciesForPkgInfo().npmDependencies){const t=n.getDependencyName();if(e.has(t))return!1;e.set(t,n.getDependencyRootPath())}return e}getDependencyName2DepInfo(){const e=new Map,n=this.getDependencyInfo().getSelfAsDependency();n.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR&&e.set(n.getDependencyName(),{pkgRootPath:n.getDependencyRootPath(),pkgName:n.getPackageName(),pkgVersion:n.getDependencyVersion()});for(const n of this._dependencyManager.collectAllDependenciesForPkgInfo().npmDependencies){const t=n.getDependencyName();if(e.has(t))return new Map;e.set(t,{pkgRootPath:n.getDependencyRootPath(),pkgName:n.getPackageName(),pkgVersion:n.getDependencyVersion()})}return e}getHarDependencies(){return this.getDependencyInfo().getNpmDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR))}getRemoteHarDependencies(){return this.getHarDependencies().filter((e=>!e.isLocal()))}getHspDependencies(){return this.getDependencyInfo().getNpmDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP))}getByteCodeHar2Hsp(){const e=new Map,n=this.getDependencyInfo().getNpmDependencies();return n.forEach((t=>{if(t.isByteCodeHarDependency()){const p=t.getDependencyName();e.set(p,this.getHspRecursion(p,n))}})),e}getHspRecursion(e,n,t=new Map){if(t.has(e))return t.get(e)||[];const p=[];t.set(e,p);const s=n.find((n=>n.getDependencyName()===e));if(!(null==s?void 0:s.getDependencies()))return this.log.debug(`No dependency is found: ${e}`),[];return Object.keys(s.getDependencies()).forEach((e=>{const s=n.find((n=>n.getDependencyName()===e));(null==s?void 0:s.getDependencyType())===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP?p.push(e):p.push(...this.getHspRecursion(e,n,t))})),p}getHspOrByteCodeHarDependencies(){return this.getDependencyInfo().getNpmDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||e.isByteCodeHarDependency()))}getSODependencies(){return this.getDependencyInfo().getAllDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_SO))}getOtherDependencies(){return this.getDependencyInfo().getAllDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER))}getAllDependencies(){return this.getDependencyInfo().getAllDependencies()}excludeChildrenWhenInDevDependencies(e){return e?e.children.filter((e=>e.npm.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES)):[]}getDirectPkgNodes(){const e=this.getDependencyInfo(),n=e.getModulePkgNode(),t=this.excludeChildrenWhenInDevDependencies(e.getModulePkgNode());let p=this.excludeChildrenWhenInDevDependencies(e.getProjectPkgNode());if(!p.length)return t;n.npm.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAP||(p=p.filter((e=>!e.npm.isLocal())));const s=new Set(t.map((e=>e.npm.getDependencyName())));return p=p.filter((e=>!s.has(e.npm.getDependencyName()))),t.concat(p)}getDirectDependencies(){return this.getDirectPkgNodes().map((e=>e.npm))}getHspDependencyPaths(){return this.getHspDependencies().filter((e=>e.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES)).map((e=>e.getDependencyRootPath()))}getModuleDependencies(){return[...this.getDependencyInfo().getModuleDependencyMap().values()]}getModuleDependenciesPaths(){return this.getModuleDependencies().map((e=>e.getDependencyRootPath()))}getHarModuleDependencies(){return[...this.getDependencyInfo().getModuleDependencyMap().entries()].filter((([,e])=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR))}getHarModuleDependenciesWithRootPath(){const e=new Map;return this.getDependencyInfo().getModuleDependenciesByType(dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR).forEach((([n,t])=>{e.set(t.getDependencyRootPath(),[n,t])})),e}getHarModuleDependencyNames(){return this.getHarModuleDependencies().map((([e])=>e))}getHarModuleDependencyPaths(){return this.getHarModuleDependencies().map((([,e])=>e.getDependencyRootPath()))}getHspModuleDependencies(){return[...this.getDependencyInfo().getModuleDependencyMap().entries()].filter((([,e])=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP))}getHspModuleDependencyNames(){return this.getHspModuleDependencies().map((([e])=>e))}getHspModuleDependencyPaths(){return this.getHspModuleDependencies().map((([,e])=>e.getDependencyRootPath()))}getHspModuleDependencyPathsWithOutDynamic(){return this.getHspModuleDependencies().filter((([,e])=>e.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES)).map((([,e])=>e.getDependencyRootPath()))}hasHspDependencies(){return this.getDependencyInfo().hasHspDependency()}getDependencyInfo(){return!this._moduleDependencyInfo&&this.initDependencyInfo(),this._moduleDependencyInfo}getOhpmDependencyInfo(){const e={};return this.getDependencyInfo().getNpmDependencies().forEach((n=>{e[n.getDependencyName()]={name:n.getPackageName(),version:n.getDependencyVersion(),dependencies:n.getDependencies(),packagePath:n.getDependencyRootPath()}})),e}getOhpmRemoteHspAllInfo(e,n,t){const p={},s=this._dependencyManager.collectAllDependencies().npmDependencies,d=(0,remote_hsp_utils_js_1.getRemoteHspPathMap)(e);return s.forEach((e=>{this.setDependencyInfo(e,d,t,n,p)})),p}setDependencyInfo(e,n,t,p,s){var d;if(e.isLocal()||e.getDependencyType()!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP)return;const c=this.getRemoteHspDirName(e.getDependencyRootPath()),o=n.get(e.getPackageName());if(!c||!o)return void this.log.debug(`${e.getDependencyRootPath()} does not exist oh_modules.`);let i;const r=e.getPackageJsonObj(),a=path_1.default.resolve(e.getDependencyRootPath(),"libs");if(t){const n=path_1.default.resolve(this._projectModel.getCacheRemoteHspPath(null!=p?p:"default"),c,o?o.replace(build_directory_const_js_1.BuildArtifactExtension.DOT_HSP,`-signed${build_directory_const_js_1.BuildArtifactExtension.DOT_HSP}`):`${e.getPackageName()}-signed.hsp`);s[e.getDependencyName()]={name:e.getPackageName(),version:e.getDependencyVersion(),dependencies:e.getDependencies(),packagePath:e.getDependencyRootPath(),signedRemoteHspPath:n,soPath:a}}else i=(null===(d=null==r?void 0:r.metadata)||void 0===d?void 0:d.integratedHsp)?path_1.default.resolve(this._projectModel.getCacheIntegratedHspPath(null!=p?p:"default"),c,o||`${e.getPackageName()}.hsp`):path_1.default.resolve(this.hvigorNode.getNodeDir(),"oh_modules",".hsp",c,o||`${e.getPackageName()}.hsp`),s[e.getDependencyName()]={name:e.getPackageName(),version:e.getDependencyVersion(),dependencies:e.getDependencies(),packagePath:e.getDependencyRootPath(),remoteHspPath:i,soPath:a}}getOhpmRemoteHspDependencies(e,n,t){const p=this.getOhpmRemoteHspAllInfo(e,n,t),s={};return Object.entries(p).forEach((([e,n])=>{s[e]=t?{name:n.name,version:n.version,dependencies:n.dependencies,packagePath:n.packagePath,signedRemoteHspPath:n.signedRemoteHspPath}:{name:n.name,version:n.version,dependencies:n.dependencies,packagePath:n.packagePath,remoteHspPath:n.remoteHspPath}})),s}getRemoteHspDirName(e){const n=(0,copy_resources_util_js_1.toUnixPath)(e).split("/"),t=n.lastIndexOf("oh_modules");if(t>0)return n[t-1]}}exports.TaskService=TaskService;