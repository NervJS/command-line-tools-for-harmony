"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,n)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyMergeProfile=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),merge_type_rule_js_1=require("../../enum/merge-type-rule.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),abstract_merge_profile_js_1=require("../abstract-merge-profile.js"),task_names_js_1=require("../common/task-names.js"),legacy_pre_build_js_1=require("./legacy-pre-build.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const device_type_const_1=require("../../const/device-type-const"),har_target_util_js_1=require("../../utils/har-target-util.js"),json_util_js_1=require("../../utils/json-util.js"),shell_utils_1=require("../../utils/shell-utils");class LegacyMergeProfile extends abstract_merge_profile_js_1.AbstractMergeProfile{constructor(e){super(e,LegacyFATask.MERGE_PROFILE),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyMergeProfile.name),this._harLibs=this.mergeDependsLibs(common_const_js_1.CommonConst.CONFIG_JSON);const t=this.service.getModuleModel().getSourceSetByTargetName(this._targetName);this._moduleTargetRes=t.getLegacyModuleTargetRes(),this._mergedModuleJson=this._pathInfo.getIntermediatesMergeLegacyProfile()}initTaskDepends(){this.declareDepends(legacy_pre_build_js_1.LegacyPreBuild.name)}initHarModuleDepends(){har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach(((e,t)=>this.declareDepends(`${e}@${LegacyFATask.MERGE_PROFILE.name}`,t)))}mergeDslConfig(e){var t,r,i;this._bundleName&&(e.app.bundleName=this._bundleName,this._appBundleName=this._bundleName,this._log.debug((0,hvigor_1.replaceBundleName)(`Change app bundleName with '${this._bundleName}'.`,this._bundleName))),this._vendor&&(e.app.vendor=this._vendor,this._log.debug(`Change app vendor with '${this._vendor}'.`));const n=this.targetData.getApiMeta(),o=!![n.compileSdkVersion.version,n.compatibleSdkVersion.version,null!==(r=null===(t=n.targetSdkVersion)||void 0===t?void 0:t.version)&&void 0!==r?r:n.compileSdkVersion.version].find((e=>e<=sdk_const_js_1.ApiVersion.API_VERSION_9)),s=null!==(i=n.targetSdkVersion)&&void 0!==i?i:n.compileSdkVersion,a=this.targetData.isHarmonyOS()?this.apiTransform(s):s.version,l=this.targetData.isHarmonyOS()?this.apiTransform(n.compatibleSdkVersion):n.compatibleSdkVersion.version,u=this.targetData.isHarmonyOS()?common_const_js_1.CommonConst.HARMONY_OS:common_const_js_1.CommonConst.OPEN_HARMONY,d=this.sdkInfo.getToolchainsComponentVersion();e.app.apiVersion={compileSdkVersion:d,compileSdkType:u,target:o?s.version:a,compatible:o?n.compatibleSdkVersion.version:l,releaseType:this.sdkInfo.getReleaseType()},this._log.debug(`Change app target API version with '${e.app.apiVersion.target}'`),this._log.debug(`Change app minimum API version with '${e.app.apiVersion.compatible}'`),this._log.debug(`Change app releaseType with '${this.sdkInfo.getReleaseType()}'`)}doTaskAction(){const e=(0,wdk_1.cloneDeep)(this._moduleTargetRes.getConfigJsonOpt());this.mergeAsanAndTsan(e),this.mergeAppEnvironmentConfig(e),this._appBundleName=e.app.bundleName;const t=this._harLibs.map((e=>fs.pathExistsSync(e)?(0,json_util_js_1.getJson5Obj)(e):(this._log.warn(`${e} not found, The library will not be merged.\n         Check the configuration of this module.`),null))),r=this.mergeAllConfigOpt(e,t);if(this.mergeDslConfig(r),this.targetService.isDebug()){void 0===r.deviceConfig.default&&(r.deviceConfig.default={}),r.deviceConfig.default.debug=!0}this.supportLiteDeviceModule(r)&&!r.module.package&&(r.module.package=shell_utils_1.ShellUtils.JS_SHELL_PACKAGE),fs.outputJSONSync(this._mergedModuleJson,r,{spaces:"\t"})}mergeAsanAndTsan(e){this.asanEnable&&(e.app.asanEnabled=this.asanEnable),this.tsanEnable&&(e.app.tsanEnabled=this.tsanEnable),this.hwAsanEnable&&(e.app.hwasanEnabled=this.hwAsanEnable),this.ubsanEnable&&(e.app.ubsanEnabled=this.ubsanEnable)}mergeAppEnvironmentConfig(e){var t;const r=this.parseToAppEnvironments(this.appEnvironments);if(void 0!==e.app.appEnvironments&&0!==e.app.appEnvironments.length){this._log.debug("Change app appEnvironment");const i=new Map;r.forEach((e=>{i.set(e.name,e.value)})),null===(t=e.app.appEnvironments)||void 0===t||t.forEach((e=>{i.set(e.name,e.value)})),e.app.appEnvironments=Array.from(i,(([e,t])=>({name:e,value:t})))}else this._log.debug("Use cli appEnvironment"),e.app.appEnvironments=r}supportLiteDeviceModule(e){const t=e.module.deviceType;return t&&(t.includes(device_type_const_1.DeviceTypeConst.LITE_WEARABLE)||t.includes(device_type_const_1.DeviceTypeConst.SMART_VISION))}mergeAllConfigOpt(e,t){var r,i,n,o;for(let s=0;s<t.length;s++){const a=t[s];null!==a&&((null===(r=a.app.apiVersion)||void 0===r?void 0:r.compatible)&&(null===(i=e.app.apiVersion)||void 0===i?void 0:i.compatible)&&(null===(n=a.app.apiVersion)||void 0===n?void 0:n.compatible)>(null===(o=e.app.apiVersion)||void 0===o?void 0:o.compatible)&&this._log._buildError(`The compatible version of the HAR module ${a.module.name} \n          cannot be lower than that of the HAP module.`)._printErrorAndExit(this.moduleModel.getName()),e=this.mergeModel(e,a,"config",s===t.length-1))}return e}mergeModel(e,t,r,i){if(LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepHapOptions,r)||void 0===t)return e;if(void 0===e)return t;return(0,wdk_1.union)(Object.keys(e),Object.keys(t)).forEach((n=>{const o=e[n],s=t[n];o&&s&&typeof o!=typeof s&&this._log._buildError(`Type of attribute ${n} in config.json/module.json5 of har\n                 is different from the one in hap. Correct the type in the config.json/module.json5 file.`)._printErrorAndExit(this.moduleModel.getName()),this.checkFieldRule(e,t,n,r);switch(void 0===o?typeof s:typeof o){case"boolean":LegacyMergeProfile.handleBooleanMerge(e,o,s,n);break;case"string":case"number":LegacyMergeProfile.handleStringOrNumberMerge(e,o,s,n,r);break;case"object":Array.isArray(o)||Array.isArray(s)?this.handleArrayMerge(e,o,s,n,r,i):LegacyMergeProfile.enumInclude(merge_type_rule_js_1.IsMapFields,n)?this.handleMapMerge(e,o,s,n,r,i):e[n]=this.mergeModel(o,s,n,i);break;default:this._log.error("An unrecognized type!")}})),e}mergeList(e,t,r,i){let n=[];if("skills"===r)return e;switch(0===e.length?typeof t[0]:typeof e[0]){case"string":n=(0,wdk_1.union)(e,t);break;case"object":LegacyMergeProfile.enumInclude(merge_type_rule_js_1.HasPlaceholderOptions,r)&&(e.forEach((e=>this.disposePlaceHolder(e,r))),t.forEach((e=>this.disposePlaceHolder(e,r)))),e.forEach((e=>{null===this.findObjectByUniqueKey(t,e,r)&&n.push(e)})),t.forEach((t=>{const o=this.findObjectByUniqueKey(e,t,r);if(null===o)n.push(t);else{const e=this.mergeModel(o,t,r,i);n.push(this.mergeRule(e,o))}}));break;default:this._log.error(`Other Type! ${r}`)}if(i)for(const e of n)Object.keys(e).includes("mergeRule")&&(e.mergeRule=void 0);return n}findObjectByUniqueKey(e,t,r){const i=LegacyMergeProfile.getUniqueKey(t,r);for(const n of e){const e=LegacyMergeProfile.getUniqueKey(n,r);if("abilities"===r){const e=t.targetAbility,r=n.targetAbility;!e&&r&&e===i&&this._log._buildError(`'${e}' conflict occurred when merging the config.json files in HAP and HAR packages. Verify the target function settings.`)._printErrorAndExit(this.moduleModel.getName())}if(i===e)return n}return null}static getUniqueKey(e,t){return LegacyMergeProfile.enumInclude(merge_type_rule_js_1.UniqueKeyEqualsName,t)?e.name:"shortcuts"===t?e.shortcutId:"abilities"===t?void 0===e.targetAbility?e.name:e.targetAbility:null}mergeRule(e,t){if(null===t||void 0===t.mergeRule)return e;const r=t.mergeRule;if(r.replace){r.replace.forEach((r=>{e[r]&&(e[r]=t[r])}))}if(r.remove){r.remove.forEach((t=>{e[t]&&(e[t]=void 0)}))}return e}mergeMap(e,t,r,i,n){if(void 0===e)return e;if(void 0===t)return t;const o=(0,wdk_1.cloneDeep)(e),s=Object.keys(e),a=Object.keys(t),l=(0,wdk_1.difference)(a,s);r&&l.forEach((e=>{o[e]=t[e]}));return(0,wdk_1.intersection)(a,s).forEach((r=>{Array.isArray(e[r])?o[r]=(0,wdk_1.union)(e[r],t[r]):"object"==typeof e[r]&&(o[r]=this.mergeModel(e[r],t[r],i,n))})),o}checkFieldRule(e,t,r,i){if(!LegacyMergeProfile.enumInclude(merge_type_rule_js_1.IsNeedMergeRule,i)||LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepAbilityMergeList,i)||"skills"===r)return;const n=e[r],o=t[r];if(void 0!==n&&void 0!==o&&!(0,wdk_1.isEqual)(n,o)){const t=e.mergeRule;if(!(0,wdk_1.union)(t.replace,t.remove).includes(r)){const e=`Unable to merge Config.json files. The value '${i}'${LegacyMergeProfile.getUniqueKey(n,i)}' conflicts with the value: '${r}' of a subtag in the HAR file. Verify and then add 'mergeRule' in the HAP.`;throw this._log._buildError(e)._printErrorAndExit(this.moduleModel.getName()),new Error(e)}}}disposePlaceHolder(e,t){return Object.keys(e).forEach((r=>{var i;if(LegacyMergeProfile.enumInclude(merge_type_rule_js_1.NeedDisposePlaceholder,r)&&("abilities"!==t||"name"!==r)){const t=e[r];if("string"==typeof t)e[r]=t.replace("{bundleName}",this._appBundleName);else if(Array.isArray(t)&&0!==t.length)if("string"==typeof t[0]){const t=[];for(const i of e[r])t.push(i.replace("{bundleName}",this._appBundleName));e[r]=t}else{const t=[];for(const n of e[r])n.name=null===(i=n.name)||void 0===i?void 0:i.replace("{bundleName}",this._appBundleName),t.push(n);e[r]=t}}})),e}static enumInclude(e,t){return Object.values(e).includes(t)}static handleBooleanMerge(e,t,r,i){LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepOneOfThem,i)&&(e[i]=void 0===t&&void 0!==r?r:t)}static handleStringOrNumberMerge(e,t,r,i,n){let o=void 0===t&&void 0!==r?r:t;"deviceConfig"!==n&&"module"!==n||(o=t),e[i]=o}handleArrayMerge(e,t,r,i,n,o){const s=Array.isArray(t)?t:[],a=Array.isArray(r)?r:[];let l;l="module"===n&&LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepModuleAttr,i)?[...s]:this.mergeList(s,a,i,o),0!==l.length&&(e[i]=l)}handleMapMerge(e,t,r,i,n,o){let s=!0;"config"===n&&(s=!1,void 0===t.default&&void 0!==r.default&&(void 0===r.default.allowComponentsProxy?r.default=void 0:t.default={})),e[i]=this.mergeMap(t,r,s,i,o)}declareInputFiles(){const e=new hvigor_1.FileSet;return e.addEntry(this._moduleTargetRes.getJsonPath()),this._harLibs.forEach((t=>{fs.existsSync(t)&&e.addEntry(t)})),e}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this._mergedModuleJson)}}exports.LegacyMergeProfile=LegacyMergeProfile;