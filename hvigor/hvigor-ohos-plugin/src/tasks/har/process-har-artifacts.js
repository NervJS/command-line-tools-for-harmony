"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessHarArtifacts=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),fs_extra_1=__importDefault(require("fs-extra")),common_util_js_1=require("../../common/common-util.js"),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js"),har_target_util_js_1=require("../../utils/har-target-util.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../../utils/ohmurl-utils.js"),validate_systemHsp_js_1=require("../../utils/validate/validate-systemHsp.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),cache_native_libs_js_1=require("../cache-native-libs.js"),task_names_js_1=require("../common/task-names.js"),compile_resource_js_1=require("../compile-resource.js"),process_obfuscation_files_js_1=require("./process-obfuscation-files.js"),dependency_manager_js_1=require("../../project/dependency/dependency-manager.js"),file_util_js_1=require("../../utils/file-util.js"),parameter_utils_js_1=require("../../utils/parameter-utils.js"),abstract_process_har_artifacts_js_1=require("../abstract/abstract-process-har-artifacts.js"),copy_resources_util_js_1=require("../../utils/copy-resources-util.js");var Task=task_names_js_1.TaskNames.Task;class ProcessHarArtifacts extends abstract_process_har_artifacts_js_1.AbstractProcessHarArtifacts{constructor(e){super(e,Task.PROCESS_HAR_ARTIFACTS),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ProcessHarArtifacts.name),this.abilities=common_const_js_1.AbilityConst.UI_ABILITY,this.extensionAbilities=common_const_js_1.AbilityConst.EXTENSION_ABILITY,this.compiledPackageNames=[],this.npmImportees=[],this.arkTsCompiledOutputDir=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath()),this.compiledAbcOutputDir=path_1.default.resolve(this.arkTsCompiledOutputDir,code_type_enum_js_1.CodeType.ETS),this.declaredFilesOutputDir=this.pathInfo.getIntermediatesEtsTgzPath(this.moduleName);const t=this.projectModel.getAppRes();this.appOptObj=t.getAppResOpt();const s=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetModuleOptObj=s.getModuleJsonOpt(),this.targetJsonPath=s.getJsonPath(),this.ohPkgMetadataResDir=[],this.nonEntryImportees=[]}get isBundledDependencies(){return this.targetService.isBundledDependencies()}get isNativeStripped(){var e,t,s,i;return null===(i=null===(s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.nativeLib)||void 0===t?void 0:t.debugSymbol)||void 0===s?void 0:s.strip)||void 0===i||i}declareInputs(){var e,t,s,i,r;const o=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt),a=super.declareInputs().set("bundleType",null!==(s=null!==(t=null==o?void 0:o.bundleType)&&void 0!==t?t:(0,find_target_product_js_1.findTargetProduct)(this.service.getProjectModel()).bundleType)&&void 0!==s?s:this.projectModel.getBundleType()).set("isByteCodeHar",this.targetService.isByteCodeHar()).set("harLocalDependencyCheck",!!(null===(i=this.targetService.getBuildOption().strictMode)||void 0===i?void 0:i.harLocalDependencyCheck)).set("isBundledDependencies",this.isBundledDependencies).set("nonEntryImportees",this.nonEntryImportees).set("isDebug",this.targetService.isDebug()).set("isNativeStripped",this.isNativeStripped),n=null===(r=this.targetService.getTargetData().getTargetOpt().resource)||void 0===r?void 0:r.directories;return n&&a.set("targetDirectories",n),a}declareInputFiles(){const e=super.declareInputFiles();return fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.collectNonEntryImportees(),this.collectCompiledAndNpmImportees()}initTaskDepends(){this.declareDependsList(cache_native_libs_js_1.CacheNativeLibs.name,compile_resource_js_1.CompileResource.name),this.addSpecialDepends()}addSpecialDepends(){if(this._harExtendInfo.isObfuscatedHar()){const e=this.sdkInfo.hasRollUpPluginInEtsLoader;this.declareDepends(e?"HarCompileArkTS":"HarBuildArkTS")}else this.declareDepends(common_const_js_1.ArktSTaskConst.LINT_ARKTS);this.declareDepends(this.moduleModel.isOhpmProject()?Task.PROCESS_OH_PACKAGE_JSON.name:Task.PROCESS_PACKAGE_JSON.name),this.declareDepends(process_obfuscation_files_js_1.ProcessObfuscationFiles.name)}copyCompiledSourceFileToTempDir(){if(this.targetService.isByteCodeHar()){if(fs_extra_1.default.existsSync(this.compiledAbcOutputDir)&&fs_extra_1.default.copySync(this.compiledAbcOutputDir,path_1.default.join(this.taskTmpDir,path_1.default.basename(this.compiledAbcOutputDir))),fs_extra_1.default.existsSync(this.declaredFilesOutputDir)){fs_extra_1.default.copySync(this.declaredFilesOutputDir,this.taskTmpDir);const e=path_1.default.resolve(this.taskTmpDir,this.pathInfo.getBuildRoot());fs_extra_1.default.existsSync(e)&&fs_extra_1.default.removeSync(e)}}else fs_extra_1.default.existsSync(this.arkTsCompiledOutputDir)&&fs_extra_1.default.copySync(this.arkTsCompiledOutputDir,this.taskTmpDir)}processBundleDepRes(){var e;if(!this.targetService.isBundledDependencies())return;const t=`${build_directory_const_js_1.BuildDirConst.SRC}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.MAIN}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.RESOURCES}`,s=null===(e=this.targetService.getTargetData().getTargetOpt().resource)||void 0===e?void 0:e.directories;(null==s?void 0:s.length)?this.ohPkgMetadataResDir.push(...s):this.ohPkgMetadataResDir.push(t);const i=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService);i&&i.dep2Resources.forEach(((e,t)=>{this.copyBundledDepRes(e,t)}))}copyBundledDepRes(e,t){const s=(0,json_util_js_1.getJson5Obj)(path_1.default.resolve(t.getDependencyRootPath(),common_const_js_1.CommonConst.OH_PACKAGE_JSON5));e.forEach((e=>{this.ohPkgMetadataResDir.push(`${e}-${s.name}`);const i=path_1.default.resolve(t.getDependencyRootPath(),e);if(fs_extra_1.default.existsSync(i)){const t=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,`${path_1.default.basename(e)}-${s.name}`);fs_extra_1.default.mkdirsSync(t),file_util_js_1.FileUtil.copyDir(i,t)}}))}copyOtherGenerateFiles(){if(this._harExtendInfo.isObfuscatedHar())fs_extra_1.default.readdirSync(this.generateDir).forEach((e=>{const t=path_1.default.resolve(this.generateDir,e);fs_extra_1.default.copySync(t,path_1.default.resolve(this.taskTmpDir,e))}));else try{fs_extra_1.default.copySync(oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.generateDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)),oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.taskTmpDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)))}catch(e){this.logger.warn(e.message)}}processHarRouterMap(){const e=this.moduleModel.getJsonPathByTargetName(this.targetName),t=res_model_loader_js_1.resModelLoader.getModuleJson(e).module.routerMap,s=(0,common_util_js_1.parsingProfileName)(t);if(!s)return;const i=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${s}.json`),r=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${s}.json`),o=(0,json_util_js_1.getJson5Obj)(i);this.targetService.isOpenSource()||o.routerMap.forEach((e=>{const t=this.getObfuscatedPageSourceFile(this.moduleModel,e,this.getObfNameCacheObj());t&&Object.assign(e,{pageSourceFile:t})})),o.routerMap.map((e=>delete e.originalSuffix)),fs_extra_1.default.writeFileSync(r,JSON.stringify(o))}processDeclarationEntry(e){var t,s,i,r,o,a,n,c;if(!this.targetService.isByteCodeHar())return void this.logger.debug("Since current module is not byte code har, just return.");const l=(null===(s=null===(t=e.metadata)||void 0===t?void 0:t.runtimeOnly)||void 0===s?void 0:s.sources)||[],d=(null===(i=e.metadata)||void 0===i?void 0:i.workers)||[];null===(r=e.metadata)||void 0===r||delete r.workers,null===(a=null===(o=e.metadata)||void 0===o?void 0:o.runtimeOnly)||void 0===a||delete a.sources;const _=this.pathInfo.getIntermediatesPkgContextInfoPath(),u=(0,json_util_js_1.getJson5Obj)(_),h=u[this.packageJsonObj.name];if(!h)return void this.logger.debug(`Can not find package context information with package name: ${this.packageJsonObj.name}`);const p=[];this.isBundledDependencies&&(this.collectConfigOhmurl(null===(n=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===n?void 0:n.dep2Workers,u,p),this.collectRuntimeOnlyOhmurl(u,p),this.collectConfigOhmurl(null===(c=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===c?void 0:c.dep2RouterMapObjPageSourceFiles,u,p)),this.collectByteCodeHarAbilityOhmurl(u,p);const g=[...d,...l];g.length&&g.forEach((e=>{p.push((0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(h,e.replace(/^\.\//,"")))})),e.metadata={...e.metadata,declarationEntry:p}}collectImportees(e,t,s){const i=this.moduleModel.getCompileMode(this.targetService.getTargetData().getProduct()),r=path_1.default.resolve(this.pathInfo.getModuleBuildCachePath(),`${this.targetName}@HarCompileArkTS`,i,this.targetService.getBuildMode().toLowerCase(),e);if(!fs_extra_1.default.existsSync(r))return;const o=(0,json_util_js_1.getJson5Obj)(r);Array.isArray(o)&&o.forEach((e=>{const i=t.find((t=>e===t.getDependencyName()||e.startsWith(`${t.getDependencyName()}/`)));i&&s(e,i.getDependencyType(),i)}))}collectNonEntryImportees(){if(!this.targetService.isByteCodeHar()||this.isBundledDependencies)return;const e=new Set;this.collectImportees(hvigor_arkts_compose_1.NON_ENTRY_IMPORTEE_CACHE_FILE_NAME,this.service.getDirectDependencies(),((t,s)=>{s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER&&e.add(t)}));const t=Array.from(e);t.sort(((e,t)=>e>t?1:-1)),this.nonEntryImportees=t}collectCompiledAndNpmImportees(){if(!this.isBundledDependencies)return;const e=this.service.getAllDependencies(),t=new Set,s=new Set;this.collectImportees(hvigor_arkts_compose_1.COMPILED_IMPORTEE_CACHE_FILE_NAME,e,((e,i,r)=>{i!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER?i!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR||r.isByteCodeHarDependency()||t.add(e):e!==r.getDependencyName()&&s.add(e)}));const i=Array.from(t),r=Array.from(s);i.sort(((e,t)=>e>t?1:-1)),r.sort(((e,t)=>e>t?1:-1)),this.compiledPackageNames=i,this.npmImportees=r}hasSoFile(){const e=[this.processedLibs];for(;e.length;){const t=e.pop();for(const s of fs_extra_1.default.readdirSync(t)){const i=path_1.default.resolve(t,s),r=fs_extra_1.default.lstatSync(i);if(r.isFile()&&!s.endsWith(".a"))return!0;r.isDirectory()&&e.push(i)}}return!1}copyPkgTypesFilePath(e){const t=e.types;if(t){const e=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),t),s=path_1.default.resolve(this.taskTmpDir,t);fs_extra_1.default.ensureDirSync(path_1.default.dirname(s)),fs_extra_1.default.existsSync(e)&&fs_extra_1.default.copyFileSync(e,s)}}forEachDependencies(e,t){e.forEach((e=>{const s=e.getDependencyType();s!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR&&s!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER||t(e.getDependencyName(),e.getDependencyVersion())}))}setDependencyPkgVersion(e){var t,s;const i={parameterFilePath:this.service.getProjectModel().getParameterFileAbsolutePath(),ohPackageFilePath:this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()};if(this.isBundledDependencies)return(t=e.metadata).dependencyPkgVersion||(t.dependencyPkgVersion={}),void this.forEachDependencies(this.targetService.getModuleService().getAllDependencies(),((t,s)=>{this.compiledPackageNames.includes(t)||(e.metadata.dependencyPkgVersion[t]=file_util_js_1.FileUtil.extracted(s,this.moduleModel.getParentProject().getParameterFileObj(),i))}));this.targetService.isByteCodeHar()&&((s=e.metadata).dependencyPkgVersion||(s.dependencyPkgVersion={}),this.forEachDependencies(this.targetService.getModuleService().getDirectDependencies(),((t,s)=>{e.metadata.dependencyPkgVersion[t]=file_util_js_1.FileUtil.extracted(s,this.moduleModel.getParentProject().getParameterFileObj(),i)})))}processPackageJson(){var e;const t=path_1.default.basename(this.packageManagerPath),s=path_1.default.resolve(this.taskTmpDir,t);if(!fs_extra_1.default.existsSync(s))return;const i=(0,json_util_js_1.getJson5Obj)(s);this.copyPkgTypesFilePath(i),i.metadata||(i.metadata={});const r=[...(null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots)||[],`./${build_directory_const_js_1.BuildDirConst.SRC}/${build_directory_const_js_1.BuildDirConst.MAIN}`];if(Object.assign(i.metadata,{sourceRoots:r,debug:this.targetService.isDebug()}),this.targetService.getModuleService().getOhpmDependencyInfo(),this.setDependencyPkgVersion(i),this.isBundledDependencies){if(Object.assign(i.metadata,{bundleDependencies:this.isBundledDependencies}),this.ohPkgMetadataResDir&&0!==this.ohPkgMetadataResDir.length){const e=[];this.ohPkgMetadataResDir.forEach((t=>{e.push(path_1.default.normalize(t))}));const t={directories:e};Object.assign(i.metadata,{resource:t})}i.dependencies&&this.deleteOhPkgDep(dependency_interface_js_1.DependencyEnum.DEPENDENCIES,i),i.devDependencies&&delete i.devDependencies;i.dynamicDependencies&&this.deleteOhPkgDep(dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES,i)}this.processDeclarationEntry(i),this.nonEntryImportees.length&&(i.metadata.extraImportees=this.nonEntryImportees),this.isBundledDependencies&&(i.metadata.compiledPackageNames=this.compiledPackageNames,i.metadata.extraImportees=this.npmImportees),this.hasSoFile()&&(i.metadata.nativeDebugSymbol=this.isNativeStripped),fs_extra_1.default.writeFileSync(s,JSON.stringify(i))}deleteOhPkgDep(e,t){if(!this.targetService.isByteCodeHar()||!this.isBundledDependencies||(0,parameter_utils_js_1.getPropertyKeepDependency)())return;const s=t[e];this.service.getAllDependencies().forEach((t=>{const i=t.getPackageJsonObj();i&&Object.assign(s,i[e])}));const i=this.service.getHspOrByteCodeHarDependencies().map((e=>e.getDependencyName()));for(const e in s)i.includes(e)||delete s[e]}collectRuntimeOnlyOhmurl(e,t){var s;const i=null===(s=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===s?void 0:s.dep2RuntimeOnlyObj;if(!i)return;this.collectConfigOhmurl(i.dep2RuntimeOnlySources,e,t);const r=[];i.dep2RuntimeOnlyPackages.forEach((t=>{t.forEach((t=>{const s=this.service.getHarDependencies().find((e=>e.getDependencyName()===t));if(!s)return;const i=dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s.getDependencyRootPath()),o=(0,json_util_js_1.getJson5Obj)(s.getPackageFilePath()).main?s.getDependencyMainFilePath():s.getDependencyTypesFilePath(),a=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(e[i],path_1.default.relative(`${i}`,o));r.push(a)}))})),t.push(...r)}collectConfigOhmurl(e,t,s){const i=[];(null==e?void 0:e.size)&&(e.forEach(((e,s)=>{const r=dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s.getDependencyRootPath());e.forEach((e=>{const s=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(t[r],e.replace(/^\.\//,""));i.push(s)}))})),s.push(...i))}async doTaskAction(){const e=this.service.getAllDependencies();return validate_util_js_1.ValidateUtil.validateLocalDependency(this.moduleModel,this.targetService.getBuildOption(),e),(0,validate_systemHsp_js_1.validatePackageBySystemHspModel)(this.service,this.appOptObj,this.targetJsonPath,this.targetModuleOptObj),super.doTaskAction()}getObfuscatedPageSourceFile(e,t,s){const i=e.getModule().getNodeDir().substring(this.projectModel.getProjectDir().length+1),r=`${i}${path_1.default.sep}${t.pageSourceFile}`,o=r.replace(path_1.default.extname(r),t.originalSuffix),a=file_util_js_1.FileUtil.normalizePathSeparator(o);if(!Object.prototype.hasOwnProperty.call(s,a))return;const n=s[a].obfName.substring(i.length+1);return n.replace(path_1.default.extname(n),this.hasUseTsHarField()?".ts":".js")}collectByteCodeHarAbilityOhmurl(e,t){var s;const i=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath);for(let r of[this.abilities,this.extensionAbilities]){const o=null===(s=null==i?void 0:i.module)||void 0===s?void 0:s[r];(null==o?void 0:o.length)&&o.forEach((s=>{if(!(null==s?void 0:s.srcEntry))return;const i=this.targetService.getAbsoluteSrcEntryPath(s.srcEntry,this.module.getNodeDir());if(!fs_extra_1.default.existsSync(i))return void this.logger.debug("The srcEntry path for obtaining the ability of the module is incorrect or the corresponding file does not exist.");const r=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(e[this.packageJsonObj.name],i.substring(this._moduleDir.length+1));t.push(r)}))}}processObfuscatedHarAbility(){var e;if(!this.moduleModel.isHarModule()||this.targetService.isOpenSource())return;const t=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,common_const_js_1.CommonConst.MODULE_JSON);if(!fs_extra_1.default.existsSync(t))return void this.logger.debug("Failed to obtain the module.json file from the module intermediate product.");const s=(0,json_util_js_1.getJson5Obj)(t);for(let t of[this.abilities,this.extensionAbilities]){const i=null===(e=null==s?void 0:s.module)||void 0===e?void 0:e[t];(null==i?void 0:i.length)&&i.forEach((e=>{if(!(null==e?void 0:e.srcEntry))return;const t=this.getObfuscatedHarAbilitySrcEntry(e.srcEntry,this.getObfNameCacheObj());Object.assign(e,{srcEntry:t})}))}fs_extra_1.default.writeJSONSync(t,s)}getObfuscatedHarAbilitySrcEntry(e,t){const s=this.targetService.getAbsoluteSrcEntryPath(e,this.module.getNodeDir());if(!fs_extra_1.default.existsSync(s))return void this.logger.debug("The srcEntry path for obtaining the ability of the module is incorrect or the corresponding file does not exist.");const i=(0,copy_resources_util_js_1.toUnixPath)(s).substring(this.projectDir.length+1);if(!Object.prototype.hasOwnProperty.call(t,i))return;const r=path_1.default.dirname(this.targetJsonPath),o=t[i].obfName;if(""===r||!r||""===o||!o)return;const a=`./${path_1.default.relative(r,path_1.default.resolve(this.projectDir,o)).replace(/\\/g,"/")}`;return a.replace(path_1.default.extname(a),this.hasUseTsHarField()?".ts":".js")}getObfNameCacheObj(){const e=path_1.default.resolve(this.pathInfo.getModuleBuildCachePath(),`${this.targetName}@HarCompileArkTS`,"esmodule","release","obfuscation","nameCache.json");return(0,json_util_js_1.getJson5Obj)(e)}}exports.ProcessHarArtifacts=ProcessHarArtifacts;