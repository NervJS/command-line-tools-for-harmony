"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessRouterMap=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),file_util_js_1=require("../utils/file-util.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),array_util_js_1=require("../utils/array-util.js");class ProcessRouterMap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t,r,o;super(e,task_names_js_1.TaskNames.Task.PROCESS_ROUTER_MAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessRouterMap.name),this.compileEntry=[],this.routerMapFileName=this.targetService.getRouterMapJsonFileName(this.moduleModel),this.intermediatesRouterMapObjs=[],this.intermediatesTempRouterMapFilePath=this.pathInfo.getIntermediatesRouterMap(null!==(t=this.routerMapFileName)&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.TEMP_ROUTER_MAP_FILE_NAME),this.intermediatesToLoaderRouterMap=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.LOADER_ROUTER_MAP_FILE_NAME),this.useNormalizedOHMUrl=!!(null===(o=null===(r=this.targetService.getBuildOption())||void 0===r?void 0:r.strictMode)||void 0===o?void 0:o.useNormalizedOHMUrl)}declareInputFiles(){const e=super.declareInputFiles(),t=this.projectModel.isOhpmProject();e.addEntry(t?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()).addEntry(t?this.projectModel.getOhPackageJson5Path():this.projectModel.getPackageJsonPath()).addEntry(this.moduleModel.getJsonPathByTargetName(this.targetName));const r=this.targetService.getRouterMapJsonPath(this.moduleModel);return r&&fs_extra_1.default.existsSync(r)&&e.addEntry(r),fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.intermediatesTempRouterMapFilePath).addEntry(this.intermediatesToLoaderRouterMap)}declareInputs(){const e=super.declareInputs();return e.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,this.useNormalizedOHMUrl),e.set("obfuscated",this.targetService.isOpenSource()),e.set("byteCodeHar",this.targetService.isByteCodeHar()),this.service.getHarDependencies().forEach((t=>{if(t.isLocal()){const r=dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(t,this.projectModel);r&&e.set("localDependencyRouterMapObjList",JSON.stringify(r))}else{const r=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(t);r&&e.set("remoteDependencyRouterMapObjList",JSON.stringify(r))}})),e}doTaskAction(){const e=this.targetService.getTargetRouterMapObjList(this.moduleModel);this.service.getModuleModel().getModuleType()!==module_type_enum_js_1.ModuleType.Har||this.targetService.isBundledDependencies()?this.processHapOrHspRouterMap(e):this.processHarRouterMap(e)}processHarRouterMap(e){if(!e)return;this.checkModuleRouterMapObj(e,this.moduleModel,!1),this.checkRouterMapObjName(e);const t=this.hasUseTsHarField()?".ts":".js";e.forEach((e=>{const r={name:e.name,pageSourceFile:path_1.default.resolve(this.module.getNodeDir(),e.pageSourceFile),buildFunction:e.buildFunction};if(this.intermediatesRouterMapObjs.push(r),this.compileEntry.push(r.pageSourceFile),!this.targetService.isOpenSource()||this.targetService.isByteCodeHar()){const r=e.pageSourceFile,o=file_util_js_1.FileUtil.getFileSuffix(r);common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(o)&&Object.assign(e,{pageSourceFile:`${r.substring(0,r.lastIndexOf("."))}${t}`,originalSuffix:`.${o}`})}})),this.generateTempRouterMap(e,this.intermediatesRouterMapObjs)}processHapOrHspRouterMap(e){const t=[];this.processModuleSelfRouterMap(t,e),this.processModuleDependencyRouterMap(t),this.checkRouterMapObjName(t),this.generateTempRouterMap(t,this.intermediatesRouterMapObjs)}processModuleSelfRouterMap(e,t){t&&(this.checkModuleRouterMapObj(t,this.moduleModel,!1),t.forEach((e=>{const t=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),e.pageSourceFile);this.compileEntry.push(t);let r="";if(this.useNormalizedOHMUrl){const t=this.pathInfo.getIntermediatesPkgContextInfoPath(),o=(0,json_util_js_1.getJson5Obj)(t)[this.packageJsonObj.name];r=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(o,e.pageSourceFile)}else r=this.generateModuleOhmurl(this.moduleName,e.pageSourceFile);Object.assign(e,{ohmurl:r,bundleName:this.getBundleName(),moduleName:this.moduleName});const o={ohmurl:r,name:e.name,pageSourceFile:t,buildFunction:e.buildFunction};this.intermediatesRouterMapObjs.push(o)})),e.push(...t))}processModuleDependencyRouterMap(e){const t=new Map;this.service.getHarDependencies().forEach((r=>{r.isLocal()?this.processLocalDependencyRouterMap(r,e,t):this.processRemoteDependencyRouterMap(r,e)}))}processLocalDependencyRouterMap(e,t,r){const o=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(e,this.projectModel),s=dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(e,this.projectModel);o&&s&&!r.has(o)&&(r.set(o,s),this.checkModuleRouterMapObj(s,o,!0),s.forEach((t=>{const r=path_1.default.resolve(e.getDependencyRootPath(),t.pageSourceFile),s=o.getModuleType();this.pushCompileEntry(s,r);let a="";this.useNormalizedOHMUrl?a=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(s===module_type_enum_js_1.ModuleType.Shared&&(a=this.generateModuleOhmurl(o.getName(),t.pageSourceFile)),s===module_type_enum_js_1.ModuleType.Har&&(a=this.generateHarOhmurl(this.moduleName,o.getName(),t.pageSourceFile,!0))),Object.assign(t,{ohmurl:a,bundleName:this.getBundleName(),moduleName:this.moduleName});const n={ohmurl:a,name:t.name,pageSourceFile:r,buildFunction:t.buildFunction};this.routerMapAddPackageName(t,e),this.intermediatesRouterMapObjs.push(n)})),this.checkDependencyRouterMap(e,s),t.push(...s))}processRemoteDependencyRouterMap(e,t){const r=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e);if(!r)return;const o=dependency_manager_js_1.DependencyManager.getModuleObjByRemoteDependency(e),s=o.module.type;r.forEach((t=>{var r;const a=t.pageSourceFile,n=path_1.default.resolve(e.getDependencyRootPath(),a);e.isByteCodeHarDependency()||this.pushCompileEntry(s,n);const i=o.module.name;let u;this.useNormalizedOHMUrl?u=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(s===module_type_enum_js_1.ModuleType.Shared&&(u=this.generateModuleOhmurl(i,t.pageSourceFile)),s===module_type_enum_js_1.ModuleType.Har&&(u=this.generateHarOhmurl(this.moduleName,i,n,!1,e.getDependencyName()))),Object.assign(t,{ohmurl:e.isBundleDependency()&&null!==(r=t.ohmurl)&&void 0!==r?r:u,bundleName:this.getBundleName(),moduleName:this.moduleName});const l={ohmurl:u,name:t.name,pageSourceFile:n,buildFunction:t.buildFunction};this.routerMapAddPackageName(t,e),this.intermediatesRouterMapObjs.push(l)})),this.checkDependencyRouterMap(e,r),t.push(...r)}routerMapAddPackageName(e,t){e.packageName=e.packageName||t.getPackageName()}checkModuleRouterMapObj(e,t,r){if(!e)return;const o=t.getName();e.forEach((e=>{const s=r?dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapJsonPath(t):this.targetService.getRouterMapJsonPath(t),a=this.getModulePageSourceFile(t,e);""!==e.pageSourceFile&&""!==a&&a&&fs_extra_1.default.existsSync(a)||this._log._buildError(`Unable to find the page source file '${null!=a?a:""}' in module '${o}' routerMap configuration.`)._detail(`Check the routerMap configuration of the module '${o}'.`)._file(null!=s?s:"")._printErrorAndExit(),common_const_js_1.ValidateRegExp.PAGE_SOURCE_FILE_REG_EXP.test(e.pageSourceFile)||this._log._buildError(`Invalid pageSourceFile format in the '${o}' routerMap configuration.`)._detail("PageSourceFile field in routerMap configuration must be defined as relative path starting with 'src/' format.")._file(null!=s?s:"")._printErrorAndExit()}))}getModulePageSourceFile(e,t){const r=t.pageSourceFile;if(""!==r)return path_1.default.resolve(e.getModule().getNodeDir(),r)}checkDependencyRouterMap(e,t){t&&t.forEach((t=>{const r=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(e,this.projectModel);if(!r)return;const o=null==r?void 0:r.getName(),s=dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapJsonPath(r),a=t.pageSourceFile,n=path_1.default.resolve(e.getDependencyRootPath(),a);""!==a&&""!==n&&n&&fs_extra_1.default.existsSync(n)||this._log._buildError(`Unable to find the page source file '${""===a?"":n}' in module '${o}' routerMap configuration.`)._detail(`Check the routerMap configuration of the module '${o}'.`)._file(null!=s?s:"")._printErrorAndExit()}))}checkRouterMapObjName(e){if(!e||e.length<=1)return;const t=new Map;e.forEach((e=>{const r=e.packageName;if(t.has(r)){const o=t.get(r);if(!o)return;o.includes(e.name)||(o.push(e.name),t.set(r,o))}else t.set(r,[e.name])}));const r=new Map;t.forEach(((e,o)=>{const s=(0,array_util_js_1.findDuplicateElement)(e);t.forEach(((t,r)=>{if(r===o)return;const a=(0,array_util_js_1.getIntersection)(t,e);0!==a.length&&s.push(...a)})),0!==s.length&&r.set(o,Array.from(new Set(s)))})),0!==r.size&&this._log.printErrorExit("DUPLICATE_ROUTERMAP_OBJECT_NAME_DETECTED",void 0,[[JSON.stringify(Object.fromEntries(r.entries()))]])}getBundleName(){var e;return null!==(e=this.targetData.getProduct().bundleName)&&void 0!==e?e:this.projectModel.getDefaultBundleName()}generateModuleOhmurl(e,t){const r=t.substring(0,t.indexOf(".")),o=r.includes("src/main/ets/")?r.replace("src/main/",""):r;return`@bundle:${this.getBundleName()}/${e}/${o}`}generateHarOhmurl(e,t,r,o,s){if(o){const o=r.substring(0,r.indexOf(".")),s=o.includes("src/main/ets/")?o.replace("src/main/",""):o;return`@bundle:${this.getBundleName()}/${e}@${t}/${s}`}const a=path_1.default.parse(r).name,n=`${r.substring(0,r.lastIndexOf(path_1.default.sep)+1)}${a}`,i=n.substring(n.indexOf(common_const_js_1.CommonConst.OH_MODULES)).replace(common_const_js_1.CommonConst.OH_MODULES,common_const_js_1.CommonConst.PKG_MODULES),u=i.indexOf(path_1.default.sep+(null==s?void 0:s.replace("/",path_1.default.sep))+path_1.default.sep),l=i.substring(0,u),d=l.replace(path_1.default.basename(l),common_const_js_1.CommonConst.PKG_MODULES)+i.substring(u),c=new RegExp("\\"+path_1.default.sep,"g");return`@package:${d.replace(c,"/")}`}pushCompileEntry(e,t){e!==module_type_enum_js_1.ModuleType.Shared&&this.compileEntry.push(t)}initTaskDepends(){}getOhmUrlWithNormalize(e,t){const r=e.getPackageName(),o=this.pathInfo.getIntermediatesPkgContextInfoPath(),s=(0,json_util_js_1.getJson5Obj)(o);s||this._log._buildError(`The pkgContextInfoPath ${o} is not available.`)._printErrorAndExit();const a=s[r];return a||this._log._buildError(`The pkgName ${r} does not exist in ${o}.`)._printErrorAndExit(),(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(a,t)}generateTempRouterMap(e,t){fs_extra_1.default.ensureFileSync(this.intermediatesTempRouterMapFilePath),fs_extra_1.default.writeFileSync(this.intermediatesTempRouterMapFilePath,JSON.stringify({routerMap:e})),fs_extra_1.default.ensureFileSync(this.intermediatesToLoaderRouterMap),fs_extra_1.default.writeFileSync(this.intermediatesToLoaderRouterMap,JSON.stringify({routerMap:t}))}}exports.ProcessRouterMap=ProcessRouterMap;